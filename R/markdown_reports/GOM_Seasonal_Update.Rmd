---
title: "Gulf of Maine Seasonal Update"
author: 
  - first_name: "Adam"
    last_name: "Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
    affiliation_url: https://www.gmri.org
description: | 
  Seasonal Patterns in Sea Surface Temperatures
date: "Updated on: `r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
# knitr options
knitr::opts_chunk$set(echo = FALSE, 
                      message = F, 
                      warning = F, 
                      comment = "", 
                      fig.align = "center")

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggforce)
library(geomtextpath)


# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# Box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")


# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     mac_os = "mojave")

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]

# Turn on the gmri font for plots
showtext::showtext_auto()
```


`r gmRi::use_gmri_style_rmd(css = "gmri_rmarkdown.css")`


```{r param setup}
#| echo = FALSE

# Parameters
params <- list(
  year = year(Sys.Date()),
  season = "Spring",
  `Save Data` = FALSE,
  `Save Figures` = TRUE)


#####  Parameter option switches:  ####
season_deets <- season_text_details(season_op = params$season, year_op = params$year)

# Set color for the season based on the parameter:
season_col <- season_deets$season_color

# Configure edges/centers of each season for label positioning
season_cent <- season_deets$center_date
season_left <- season_deets$left_lim
season_right <- season_deets$right_lim
season_end <- season_deets$season_end_doy

# Make names for the months to pull based on the season and current year
season_months <- season_deets$month_range

# Names of start and end month for text:
season_range <- season_deets$range_label


```


```{r region_ts prep}
# Load timeseries of SST for Region
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6) 


# Format timeseries for group estimates
region_timeseries <- region_timeseries %>% 
  mutate(time = as.Date(time)) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:2022))
```


```{r region_hw prep}
# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2011-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Set up heatwave status outcomes for fancy gtextras table features:
region_hw <- region_hw %>% 
  mutate(hw_outcomes = case_when(
    mhw_event == TRUE ~ 1,
    mcs_event == TRUE ~ 0,
    TRUE ~ 0.5))
```


```{r season_data prep}
# Subset data for the season were looking at
season_data <- region_hw %>% 
  dplyr::filter(season_eng == params$season,
                season_yr == params$year) 



# Set seasonal end date so weeks don't bleed over
first_day <- as.Date(min(season_data$time))
last_day  <- as.Date(max(season_data$time))

# Set week start in the data so we can merge labels in accordingly later
season_data <-  season_data %>% 
  mutate(wk_start = floor_date(time, unit = "week"),
         wk_start = if_else(wk_start < first_day, first_day, wk_start),
         wk_start = as.Date(wk_start))
```


```{r seasonal temp summary}

# 1. Get the overall averages across all years

# Set the start year to use 1981 for winter
ssn_year_start <- ifelse(params$season == "Winter", 1981, 1982)


# Get the average temperature for all years as a baseline
# all_year_szn_avg 
all_year_season_avg <- region_timeseries %>% 
  filter(season_yr %in% c(ssn_year_start:params$year),
         season_eng == params$season) %>% 
  group_by(season_eng) %>% 
  summarise(avg_temp_c = mean(area_wtd_sst),
            avg_anom_c = mean(area_wtd_anom),
            avg_clim_c = mean(area_wtd_clim),
            .groups = "drop") %>% 
  mutate(
    avg_temp_f = as_fahrenheit(avg_temp_c, data_type = "temperature"),
    temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))



# 2. Get Averages for each year, 
# uses the max date for the season as date cutoff
seasonal_avgs <- region_timeseries %>% 
  filter(season_eng == params$season,
         between(time, 
                 as.Date(str_c(ssn_year_start, "-01-01")), 
                 as.Date(last_day))) %>% 
  group_by(season_yr, season) %>% 
  summarise(
    # Uses Area Weighted SST
    mean_temp = mean(area_wtd_sst),
    mean_clim = mean(area_wtd_clim),
    mean_clim = median(mean_clim), # Makes sure any odd years are not different
    mean_anom = mean_temp - mean_clim,
    temp_f = as_fahrenheit(mean_temp),
    clim_f = as_fahrenheit(mean_clim),
    anom_f = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") %>% 
  mutate(
     year = season_yr,
     yr = season_yr,
     season_center = as.Date(str_c(yr, season_cent)),
     season_llim = as.Date(str_c(yr, season_left)),
     season_rlim = as.Date(str_c(yr, season_right)),
     anom_label = str_c(round(mean_anom, 2), " \u00b0C  |  ", round(anom_f, 2), " \u00b0F")
  )
  


# Rank the hottest years
seasonal_ranks <- seasonal_avgs %>% 
  mutate(yr = factor(yr),
         year_rank = fct_reorder(.f = yr, .x = mean_temp, .fun = median, .desc = TRUE)) %>% 
  arrange(year_rank) %>% 
  mutate(rank = row_number(),
         flag_year = ifelse(year_rank == params$year, "flag", "unflag")) %>% 
  filter(rank <= 5)

```


# About the Updates:

Over the past decade, scientists at [the Gulf of Maine Research Institute](https://www.gmri.org) have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To help keep you informed, we share seasonal updates about conditions in the Gulf of Maine.

**Note About the Data:** The figures in this report are creating using remotely-sensed satellite data as part of publicly funded research efforts. Satellite sea surface temperature data used was obtained from the National Center for Environmental Information (NCEI), with all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncei.noaa.gov/products/optimum-interpolation-sst).

**Note on Preliminary Data:** This dataset has a 2-week latency period, during which values may change due to quality control measures. Any data within 14 days of the current date may be subject to chenge.

## The Gulf of Maine

For analyses like this, it is important to be clear about the spatial extent that "defines" the Gulf of Maine (Figure 1), as different borders could produce different numbers. The spatial extent we use as the "Gulf of Maine" is displayed below. This area is consistent with reports done in previous years and in earlier publications.

```{r}

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)


# Map the Gulf of Maine with Bathymetry
gom_extent_p <- map_study_area(
  region_extent = region_extent,
  new_england_sf = new_england,
  canada_sf = canada,
  greenland_sf = greenland) +
  labs(title = "Gulf of Maine SST Study Region")

# Show figure
gom_extent_p

```

For the data within this seasonal report, we include data for `r params$season` that follows the meteorological definitions for the seasons. Under this system the first days of March, June, September, and December each mark the start of Meteorological Spring, Summer, Fall and Winter respectively.

```{r season circle}
#| eval = TRUE

# Plot the currently selected season:
plot_met_seasons(season_highlight = params$season)

```



# `r params$season` Highlights


```{r season highlights}

# Average Temp+Anom Stats
season_avg_temp <- round(mean(season_data$sst_f, na.rm = T), 2)
season_avg_anom <- round(mean(season_data$anom_f, na.rm = T), 1)


# What rank are we this year?
current_rank <- seasonal_ranks %>% filter(yr == params$year) %>% pull(rank)
rank_labs <- switch(current_rank,
  "1" = "new",
  "2" = "2nd",
  "3" = "3rd",
  "4" = "4th",
  "5" = "5th",
  "6" = "6th",
  "7" = "7th",
  "8" = "8th",
  "9" = "9th",
  "10" = "10th"
  )

# Get max anom year and max anom
max_anom_yr <- seasonal_avgs %>% arrange(desc(mean_anom)) %>% slice(1)
```

The average SST for the Gulf of Maine during the `r params$season` of `r params$year`  (`r season_range`) was `r season_avg_temp`°F, which is `r `season_avg_anom`°F above the long-term average. 

These facts makes it the `r rank_labs` hottest `r params$season` on record for the period of 1982-2022. Read on to learn more about what SST conditions were like in the Gulf of Maine during this `r params$season`.


## Weekly Temperatures: `r params$season`


Knowing how hot or cold it was in the past gives us a baseline against which we can compare temperatures we observe today. In Table 1, we highlight how the surface ocean temperature for each week this `r params$season` (observed SST) compares to a 30-year baseline period (climate average) that spans from 1982 to 2011. The table shows the absolute values as well as the departures from that long-term average (temperature anomaly). 

```{r seasonal table prep}


# Format the start/end dates for weekly subsets
week_labels <- season_data  %>% 
  # Determine bookends for weeks and trim to season bookends
  mutate(
    wk_end   = ceiling_date(time, unit = "week"),
    wk_end = if_else(wk_end > last_day, last_day, wk_end),
    wk_end = as.Date(wk_end) - 1) %>% 
  # pull distinct weeks
  distinct(time, wk_start, wk_end)  %>% 
  # Add the month and day labels
  mutate(
    start_month = month(wk_start, label = T, abbr = T),
    end_month = month(wk_end, label = T, abbr = T),
    start_day = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week` = str_c(start_month, ", ", start_day, " - ", end_month, ", ", end_day),
    `Week` = factor(`Week`)) %>%
  # Ensure distinct weeks only, and arrange in chronological order
  distinct(`Week`, .keep_all = T) %>% 
  arrange(wk_start) %>% 
  mutate(week_position = row_number())
    
    
# rejoin the temperatures to get weekly summaries
week_data <- season_data %>%
  select(time, sst, seas, sst_anom, hw_outcomes, wk_start) %>%
  left_join(week_labels, by = "wk_start") 


# Process mean temps
week_summaries <- week_data %>%
  group_by(`Week`, week_position) %>%
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    outcomes = list(hw_outcomes), # list column for showing what days were heatwaves
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .x = week_position)) %>% 
  arrange(week_position)


# Fahrenheit formatting and column labels
week_summaries <- week_summaries %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), signif, 3)) 


# Months covered by each season
month_range <- switch(params$season,
  "Winter" = "(Dec-Feb)",
  "Spring" = "(Mar-May)",
  "Summer" = "(Jun-Aug)",
  "Fall" =   "(Sep-Nov)"
)


# Display Table for the weeks in this season
week_summ_table <- week_summaries  %>% 
  select(
    Week, temp_f, temp_c, clim_f, clim_c, anom_f, anom_c#, outcomes
    ) %>%
   gt(rowname_col = "Week") %>% 
    tab_header(
    title = md(paste0("**Weekly Sea Surface Temperatures - ", params$season, "**")), 
    subtitle = paste("Meteorological", params$season, month_range)) %>%
    tab_stubhead(label = md("*One-Week Period*")) %>% 
    tab_spanner(label = md("*Observed Temperature*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
    cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C"#, 
      #outcomes = "Heatwave | Normal | Coldspell"
      ) %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatology Reference Period: 1982-2011.*"))


# # Display Table
week_summ_table

```

**Looking at the data this way reveals a stunning result:** SST's in the Gulf of Maine rose above 40°F in late February, 5-6 weeks sooner than it has historically.


##  Monthly Statistics

Looking at each month as a whole, May showed the largest difference from the long-term average, with an average temperature anomaly of 3.40°F. All days this season met the criteria to be considered a marine heatwave, and each month was 2.4°F or more above the 1982-2011 average. 

```{r}
# Recreate Table for Monthly Averages
monthly_avgs <- season_data %>% 
  group_by(month) %>% 
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies"),
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    temp_list = list(sst_f), # list column for sparkline anomalies
    outcomes = list(hw_outcomes),
    .groups = "drop") %>% 
  mutate(across(where(is.numeric), signif, 3)) 


# Create the Table
month_summ_table <- monthly_avgs %>% 
  mutate(month = factor(month, levels = c("Dec", month.abb[1:11]))) %>% #glimpse()
  gt(rowname_col = 'month') %>% 
     tab_stubhead(label = md("*Month*"))  %>% 
    tab_spanner(label = md("*Observed Temperature*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
  tab_spanner(label = md("*Temperature Progression*"), columns = c(`temp_list`)) %>%
  gt_sparkline(temp_list, range_colors = c(gmri_cols("gmri blue")[[1]], gmri_cols("orange")[[1]]), line_color = "gray50") %>%
  #tab_spanner(label = md("*Heatwave Status:*"), columns = c(outcomes)) %>% 
  gt_plt_winloss(column = outcomes, colors = c(gmri_cols("orange")[[1]], "gray", gmri_cols("gmri blue")[[1]])) %>% 
  cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C",
      temp_list = "High/Low \u00b0F",
      outcomes = md("**Heatwave Status:**")
      ) %>% 
   tab_source_note(source_note = md("*Heatwave statuses: HW = orange, gray = non-event, blue = cold spell.*")) %>% 
    # tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(source_note = md("*Climatology Reference Period: 1982-2011.*"))
   


# # Display Table
month_summ_table

```



## Seasonal Trends and Anomalies in Context

The Gulf of Maine is an area of particular interest to the scientific community because of the remarkable rate of warming that it has experienced in recent years.

When looking at the average `r tolower(params$season)` temperatures there is a clear long-term increase, but also a more pronounced increase that begins around 2008.

After this point both the seasonal average and the bulk of the daily temperatures remain several degrees above what we would have expected from the 30-year climatology.

```{r temp warming rates}
# Get the rates of change for dynamic text

# Decadal Rate
yr_mod <- lm(mean_temp ~ yr, seasonal_avgs)
annual_rate <- coef(yr_mod)[[2]]
decadal_rate <- round((annual_rate*10), 2)


# Grab the most recent temp and anomaly for this season for text
this_seas <- filter(seasonal_avgs, yr == params$year)
seas_temp <- round(this_seas$mean_temp, 2)
seas_anom <- round(this_seas$mean_anom, 2)
```


Over the period of 1982-2021, `r tolower(params$season)`'s in the Gulf of Maine have warmed at a rate of **`r decadal_rate`** $^oC/Decade$.

```{r seasonal temperature change}


# Seasonal Temperature Trend Plot:
seasonal_temp_p <- ggplot(seasonal_avgs, aes(yr, mean_temp)) +
  geom_line(color = "gray20", linetype = 3, size = 0.5, alpha = 0.5) +
  geom_point(color = "gray20", size = 1, alpha = 0.8) +
  geom_hline(data = all_year_season_avg, aes(yintercept = avg_temp_c), 
             color = "darkblue", linetype = 2) + 
  geom_mark_ellipse(data = data.frame(x = 2016, y = all_year_season_avg$avg_temp_c),
                    aes(x, y, label = all_year_season_avg$temp_label), 
                    description = str_c("1982-2021 Average ", params$season, " Temperature"), 
                    label.colour = "darkblue",
                    color = "transparent", 
                    con.colour = "darkblue", 
                    label.fill = "transparent", 
                    label.fontsize = 8, 
                    label.buffer = unit(0.25, "cm")) +
  geom_smooth(formula = y~x, 
              linetype = 1,
              method = "lm", 
              color = "darkred", 
              se = FALSE) +
  geom_mark_ellipse(aes(filter = yr == 1994, 
                        label = str_c(decadal_rate, " \u00b0C / Decade")), 
                    color = "transparent", 
                    description = str_c("40-Year ", params$season, " Warming Trend"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.buffer = unit(1.35, "cm"), 
                    label.fill = "transparent", 
                    label.fontsize = 8) +
  geom_mark_ellipse(aes(filter = yr == params$year, 
                        label = anom_label),
                    color = "darkred",
                    linetype = 2,
                    description = str_c("Temperature Above\n1982-2011 climatological average"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.fill = "transparent", 
                    label.buffer = unit(0.15, "cm"), 
                    label.fontsize = 8) +
  scale_y_continuous(
    expand = expansion(add = c(1, 2.5)),
    sec.axis = sec_axis(trans = ~ as_fahrenheit(.), 
                        labels =  number_format(suffix = " \u00b0F")),
    labels = number_format(suffix = " \u00b0C")) +
  scale_x_continuous(limits = c(1981, params$year+3)) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature")) 



# Display Plot
seasonal_temp_p 

```

This period of faster warming is part of what appears to be a distinct regime in the Gulf of Maine. The drivers of this (e.g., a weakening of the Atlantic Meridional Overturning Circulation and shifts in the path of the Gulf Stream) have been [well-documented in the peer-reviewed literature](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean), including through research by GMRI scientists.


```{r}

# Plotting Temperature Distribution with Climate Average
climate_baseline <- seasonal_avgs$mean_clim[1]

# Plot the summers, use box plots for yearly distribution
seasonal_temp_dist <- ggplot(
  data = filter(region_timeseries, season_eng == params$season), 
  aes(season_yr, area_wtd_sst, group = season_yr)) +
  geom_boxplot(color = "gray70") + 
  geom_boxplot(data = filter(region_timeseries, season_eng == params$season, 
                             season_yr >= 2010), color = "gray40") + 
  geom_segment(x = 1982, xend = 2011, y = 12.5, yend = 12.5, color = "black") +
  geom_segment(x = 1982, xend = 1982, y = 12, yend = 13, color = "black") +
  geom_segment(x = 2011, xend = 2011, y = 12, yend = 13, color = "black") +
  annotate(x = 1997, y = 13.25, label = "Climate-Reference Period", geom = "text", size = 3) +
  geom_hline(linetype = 1, size = 0.75, aes(yintercept = climate_baseline, color = "30-Year Climate Average")) + 
  scale_y_continuous(sec.axis = sec_axis(trans = ~ as_fahrenheit(.), 
                                         labels =  number_format(suffix = " \u00b0F")), 
                     labels = number_format(suffix = " \u00b0C")) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature"),
       title = str_c( params$season, " Temperatures Reflect a Regime Shift"),
       color = "") +
  scale_color_manual(values = c("30-Year Climate Average" = "darkred")) +
  theme(legend.position = c(0.8, 0.09), 
        legend.background = element_blank(),
        legend.key = element_blank())



# Display Plot
seasonal_temp_dist
```

The average temperature for this `r tolower(params$season)` was `r seas_temp`$^oC$ / `r round(as_fahrenheit(seas_temp), 2)`$^oF$. Compare that to the climate average of: `r round(climate_baseline, 2)`$^oC$ / `r round(as_fahrenheit(climate_baseline), 2)`$^oC$.

## Temperature Anomaly Record

The same trends can be seen when looking through the lens of temperature anomalies (departure from normal climate). We see the same patterns of steadily rising temperatures followed by an increase in warming in recent years.

`r params$season` temperatures since 2008 have not fallen below $0.5~^oC$ with `r max_anom_yr$yr` positioned as the hottest `r tolower(params$season)` at `r max_anom_yr$mean_anom`$~^oC$ above the 30-year summer average.

The average temperature anomaly for this `r tolower(params$season)` was `r seas_anom`$^oC$ / `r round(as_fahrenheit(seas_anom, "anomalies"), 2)`$^oF$.

```{r daily anomalies figure}
# Pull the details for the warmest year:
warmest_year <- as.numeric(seasonal_avgs[seasonal_avgs$mean_temp == max(seasonal_avgs$mean_temp), "season_yr"])



# Plot the daily anomaly patterns for the whole year:
regional_anom_p <- ggplot(region_timeseries, aes(time, area_wtd_anom)) +
  geom_line(alpha = 0.5, color = "gray") +
  geom_point(data = seasonal_avgs,
               aes(x = season_center,
                   y = mean_anom),
               size = 1, alpha = 0.8) +
    geom_line(data = seasonal_avgs, 
               aes(x = season_center, 
                   y = mean_anom), 
               size = 0.4, linetype = 3, color = gmri_cols("gmri blue")) +
  geom_smooth(data = filter(region_timeseries, season_eng == params$season),
              aes(x = time, y = area_wtd_anom),
              formula = y~x, method = "lm", se = FALSE,
              color = "darkred", linetype = 4, size = 1) +
  # Mark the Point
  geom_mark_ellipse(data = filter(seasonal_avgs, yr == warmest_year), 
                    aes(x = season_center, 
                        y = mean_anom), 
                    label.fill = "transparent", 
                    label.fontsize = 9, 
                    linetype = 2) +
  # Place the text manually
  geom_mark_ellipse(data = filter(seasonal_avgs, yr == warmest_year), 
                    aes(x = season_center-(365*8), 
                        y = mean_anom + 1.75, 
                        label = str_c(round(mean_temp, 2), "\u00b0", "C  |  ", round(temp_f, 2), "\u00b0", "F")), 
                    color = "transparent",
                    description = str_c("Warmest ", params$season, ": ", warmest_year), 
                    con.colour = "transparent", 
                    label.colour = "black",
                    label.fill = "transparent", 
                    label.fontsize = 9, 
                    label.buffer = unit(-0.75, "line")) +
  # Set limits for white space
  scale_x_date(limits = as.Date(c("1981-01-01", str_c(params$year+1, "-12-31")))) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"), 
                                         labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C"),
                     limits = c(-2.5, 4.5)) +
  labs(x = "", 
       y = str_c("Daily Temperature Anomaly"),
       title = str_c("Rise in ", params$season, " Temperatures"))


# Show figure
regional_anom_p
```

```{r}
# Hottest Daily Temperature
daily_peak <- region_timeseries %>% 
  filter(season_eng == params$season,
         season_yr == year(Sys.Date())) %>% 
  top_n(n = 1, wt = sst_anom) %>% 
  select(time, sst, area_wtd_sst, sst_clim, area_wtd_clim,  sst_anom, area_wtd_anom) %>%
  mutate(
    temp_f = as_fahrenheit(sst),
    area_wtd_temp_f = as_fahrenheit(area_wtd_sst),
    clim_f = as_fahrenheit(sst_clim),
    area_wtd_clim_f = as_fahrenheit(area_wtd_clim),
    anom_f = as_fahrenheit(sst_anom, data_type = "anomalies"),
    area_wtd_anom_f = as_fahrenheit(area_wtd_anom, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), .fns = round, 2))
```

Daily temperature anomalies this season peaked on `r daily_peak$time`, at `r daily_peak$area_wtd_anom`C \| `r daily_peak$area_wtd_anom_f`F degrees above the long-term average.

## Ranking `r params$year`'s Temperatures


`r params$year` is among the warmest years seen in the Gulf of Maine during this 40+ year period. When compared against all previous years (1982-2021), this year ranks **\# `r current_rank`** for hottest `r tolower(params$season)` on record.

```{r, fig.height = 3}


# Plot them
temp_rankings_p <- ggplot(seasonal_ranks, aes(color = flag_year)) +
  geom_link(aes(x = 0,
                xend = mean_anom,
                y = rank,
                yend = rank,
                size = stat(index)), show.legend = FALSE) +
  geom_label(aes(x = mean_anom, y = rank, label = year_rank)) +
  scale_y_reverse(breaks = seq(1, 5, 1), expand = expansion(add = c(0.5, 0.5))) +
  scale_x_continuous(
    sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"), 
                        labels =  number_format(suffix = " \u00b0F")),
    labels = number_format(suffix = " \u00b0C"), 
    expand = expansion(mult = c(0,0.15))) +
  scale_color_manual(values = c("flag" = "darkred", "unflag" = "gray60")) +
  labs(x = "Temperature Anomaly",
       y = "Rank",
       title = str_c(params$season, " Temperatures,  Ranked")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())


temp_rankings_p

```

## Marine Heatwave Timeline

A [marine heatwaves](http://www.marineheatwaves.org/all-about-mhws.html) (MHW) is defined as a situation when seawater temperatures exceeds a seasonally-varying threshold (usually the 90th percentile) for at least 5 consecutive days. Successive heatwaves with gaps of 2 days or less are considered part of the same event. The heatwave threshold used below was 90%.

```{r}
# Pull this year's data, up until end of the season
last_yr_heatwaves <- region_hw %>% 
  filter(
    doy <= season_end,
    yr == params$year)

# Special case for winter
if(params$season == "Winter"){
  last_yr_heatwaves <- region_hw %>% 
    filter(
      season_eng == params$season,
      season_yr == params$year
    )
}


# Get number of heatwave events and total heatwave days for this Season
num_events   <- max(last_yr_heatwaves$mhw_event_no, na.rm = T) - min(last_yr_heatwaves$mhw_event_no, na.rm = T)
num_hw_days <- sum(last_yr_heatwaves$mhw_event, na.rm = T)

```

Using this broadly accepted definition, **the Gulf of Maine has experienced MHW conditions for almost all of 2022**, with only a brief reprieve in mid-May which was followed by a sharp  climb in temperature soon-after. 

The Gulf of Maine began this year experiencing MHW conditions spilling over from an event the previous year. That event began at the start of 2021, lasting for the entirety of the year. The longest heatwave of `r params$year` is the tail end of that event, which persisted all the way through to mid-May.

```{r}

# Show figure
hw_temp_p <- year_hw_temps(year_hw_dat = last_yr_heatwaves, temp_units = "F")
hw_temp_p

```

Changing the axis to anomalies rather than temperature the magnitude of the anomalies become more clear. The most extreme anomalies of this `r params$season` occurred at the beginning of January and the second-half of May with temperatures exceeding $4~^oF$ above the climate average. Remember, the value of zero in this figure is the average daily temperature from the climate period of 1982-2011. Not a single day this year was within $1.5~^oF$ within that average temperature.

```{r}
hw_anom_p <- year_hw_anoms(year_hw_dat = last_yr_heatwaves, temp_units = "F")
hw_anom_p
```




## Seasonal Anomaly Map




```{r}

# Set time limits
season_dates <- c(min(season_data$time), max(season_data$time))

# Spatial Extent Info
x_buffer <- c(-2.25, 2.25)
y_buffer <- c(-0.75, 0.75)
crop_x   <- st_bbox(region_extent)[c(1,3)] + x_buffer
crop_y   <- st_bbox(region_extent)[c(2,4)] + y_buffer


# Make data window for season
data_window <- data.frame(lon = crop_x,
                          lat = crop_y,
                          time = season_dates)

# Load data
season_anoms <- oisst_window_load(data_window = data_window, anomalies = T, mac_os = "mojave")
season_anoms <- stack(season_anoms)
season_mean <- mean(season_anoms, na.rm = T)

# Map it
# Set palette limits to center it on 0 with scale_fill_distiller
max_daily  <- round(max(values(season_anoms), na.rm = T), 2)
max_season <- round(max(values(season_mean), na.rm = T), 2)
limit <- c(max_season * -1, max_season)
```

From an overhead look of the course of the `r params$season` season, the Gulf of Maine and surrounding areas experienced above average temperatures for much of the area, but with particularly warm patches to the East of Georges Bank. The peak daily temperature anomaly during this period was `r max_daily`$^oC$, with a peak seasonal average of `r max_season`$^oC$.

```{r}
# Make it a stars class to plot with ggplot
anoms_st <- st_as_stars(season_mean)

#### 1. Map the Anomalies in Space
season_map <- ggplot() +
  geom_stars(data = anoms_st) +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, size = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdYlBu", 
                       na.value = "transparent", 
                       limit = limit, 
                       oob = scales::oob_squish, 
                       labels = scales::number_format(suffix = "\u00b0C")) +
  map_theme(legend.position = "bottom") +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = T) +
  guides("fill" = guide_colorbar(
    title = expression("Seasonally Averaged Temperature Anomaly"),
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(title = str_c(params$season, ", ", params$year))

# Show figure
season_map


```

## Monthly Temperature Anomalies

Average monthly temperature anomalies are displayed below. From these we can see that were concentrated just south of the Gulf of Maine in March, but by April and May the waters East of Georges Bank and near the Northeast Passage were experiencing temperatures >5$^oC$ warmer than the climate of the recent past.

```{r month avgs, eval = TRUE}


# Get monthly averages
season_nums <- unique(str_sub(names(season_anoms), 7,8))
month_names <- month.name[as.numeric(season_nums)]
display_months <- map(season_nums, function(month_idx){
  
  which_dates <- which(str_sub(names(season_anoms), 7,8) == month_idx)
  month_mean <- mean(season_anoms[[which_dates]], na.rm = T)
  
}) %>% setNames(month_names)


# Clip to the study expanded area
# Expanded area
expanded_area <- structure(c(crop_x, crop_y),  
                           class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()


# Perform masking
months_masked <- map(display_months, mask_nc, expanded_area, rotate = FALSE)

# Make plots for each
month_plots <- imap(months_masked, function(month_avg_layer, month_id){
  
  
  # Set up text label  
  month_yr <- params$year
  month_label <- str_c(month_id, ", ", month_yr)
  
  
  # Make stars object for plot
  month_stars <- st_as_stars(month_avg_layer)
  
  # Color limit for palettes
  temp_limits <- c(-5, 5)
  temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
  temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0C")
  
  # build plot
  month_fig <- ggplot() +
    geom_stars(data = month_stars) +
    geom_sf(data = new_england, fill = "gray90", size = .25) +
    geom_sf(data = canada, fill = "gray90", size = .25) +
    geom_sf(data = greenland, fill = "gray90", size = .25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, size = 0.5,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdBu", 
                         na.value = "transparent", 
                         limit = temp_limits,
                         oob = scales::squish,
                         breaks = temp_breaks, 
                         labels = temp_labels) +
    map_theme(
      title = element_text(hjust = 0.5, size = 8),
      axis.text = element_text(size = 6)) +
    coord_sf(xlim = crop_x, 
             ylim = crop_y, 
             expand = F) +
    guides("fill" = guide_colorbar(
      title = expression("Temperature Anomaly"~degree*C),
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) +
      labs(title = str_c(month_label))
  return(month_fig)
  
  
})

# assemble plots
(month_plots[[1]] | month_plots[[2]] | month_plots[[3]]) + plot_layout(guides = "collect")  & theme(legend.position = 'bottom')

```



```{r}
# Export Figures
if(params$`Save Figures`){
  
  # # Folder for update - local
  # update_folder <- str_c(here("R/markdown_reports/seasonal_update_figs/"),
  #    params$season, "_", year(Sys.Date()), "/")
  
  # Folder for update - Box
  comm_folder <- cs_path("root", "GoM Seasonal Climate Update")
  update_folder <- str_c(
    comm_folder, 
    params$season, "_", year(Sys.Date()), "/")
  
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, 
         filename = str_c(update_folder, "GOM_Extent.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  
  # Weekly Report Table
  gtsave(data = week_summ_table, 
         filename = str_c(update_folder, "weekly_summary_table.png"))
  
  
  # Monthly Report Table
  gtsave(data = month_summ_table, 
         filename = str_c(update_folder, "monthly_summary_table.png"))
  
  
  # Seasonal Temperature Plot
  ggsave(plot = seasonal_temp_p, 
         filename = str_c(update_folder, "Seasonal_temp_plot.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  
  # Seasonal Anomalies Plot
  ggsave(plot = regional_anom_p, 
         filename = str_c(update_folder, "Seasonal_anom_plot.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  # Seasonal Temp Rankings
  ggsave(plot = temp_rankings_p, 
         filename = str_c(update_folder, "Seasonal_temp_ranks_plot.png"), 
         dpi = "retina", 
         bg = "transparent")

  
  # Heatwave Temperature Plot
  ggsave(plot = hw_temp_p, 
         filename = str_c(update_folder, "Heatwave_temp_plot.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  
  # Heatwave Anomaly Plot
  ggsave(plot = hw_anom_p, 
         filename = str_c(update_folder, "Heatwave_anom_plot.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  
  # Season Map
  ggsave(plot = season_map, 
         filename = str_c(update_folder, "Seasonal_anom_map.png"), 
         dpi = "retina", 
         bg = "transparent")
  
  
}

####  Saving the Data  ####



if(params$`Save Data`){
  

# Rename so there is 0 chance of confusion
save_season_avg <- seasonal_avgs %>% 
  select(
    year = yr,
    months = season,
    temp_c = mean_temp,
    temp_f = temp_f,
    climate_avg_c = mean_clim,
    climate_avg_f = clim_f,
    temp_anom_c = mean_anom,
    temp_anom_f = anom_f) %>% 
  mutate(season = params$season, .before = "months") %>% 
  mutate(across(where(is.numeric), round,2))
 

# Save locally
update_name <- str_c(here("R/markdown_reports/seasonal_update_data/"),
                     "Gulf-of-Maine_SST_",
                     params$season,
                     "_Averages_GMRI_",
                     str_remove_all(Sys.Date(), "[-]"),
                     ".csv")
write_csv(save_season_avg, 
          file = update_name)
}
```

`r insert_gmri_footer()`
