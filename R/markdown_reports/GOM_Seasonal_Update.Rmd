---
title: "Gulf of Maine Seasonal Sea Surface Temperature Update"
author: 
  - first_name: "Adam"
    last_name: "Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
    affiliation_url: https://www.gmri.org
description: | 
  Seasonal Patterns in Sea Surface Temperatures
date: "Updated on: `r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
# knitr options
knitr::opts_chunk$set(echo = FALSE, 
                      message = F, 
                      warning = F, 
                      comment = "", 
                      fig.align = "center")

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggforce)
library(geomtextpath)


# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# Box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")


# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     mac_os = "mojave")

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]

# Turn on the gmri font for plots
showtext::showtext_auto()
```


`r gmRi::use_gmri_style_rmd(css = "gmri_rmarkdown.css")`


```{r param setup}
#| echo = FALSE

# Parameters
params <- list(
  #year = 2021,
  year = year(Sys.Date()),
  season = "Spring",
  `Save Data` = FALSE,
  `Save Figures` = TRUE)


#####  Parameter option switches:  ####
season_deets <- season_text_details(season_op = params$season, year_op = params$year)

# Set color for the season based on the parameter:
season_col <- season_deets$season_color

# Configure edges/centers of each season for label positioning
season_cent  <- season_deets$center_date
season_left  <- season_deets$left_lim
season_right <- season_deets$right_lim
season_end   <- season_deets$season_end_doy

# Make names for the months to pull based on the season and current year
season_months <- season_deets$month_range

# Names of start and end month for text:
season_range <- season_deets$range_label


```


```{r region_ts prep}
# Load timeseries of SST for Region
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6) 


# Format timeseries for group estimates
region_timeseries <- region_timeseries %>% 
  mutate(
    time = as.Date(time),
    area_wtd_f = as_fahrenheit(area_wtd_sst),
    anom_f     = as_fahrenheit(area_wtd_anom, "anomalies")) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:2022))
```


```{r region_hw prep}
# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2011-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Set up heatwave status outcomes for fancy gtextras table features:
region_hw <- region_hw %>% 
  mutate(hw_outcomes = case_when(
    mhw_event == TRUE ~ 1,
    mcs_event == TRUE ~ 0,
    TRUE ~ 0.5))
```


```{r season_data prep}
# Subset data for the season were looking at
this_season_data <- region_hw %>% 
  dplyr::filter(season_eng == params$season,
                season_yr == params$year) 

# Set seasonal end date so weeks don't bleed over
first_day <- as.Date(min(this_season_data$time))
last_day  <- as.Date(max(this_season_data$time))

# Set week start in the data so we can merge labels in accordingly later
this_season_data <-  this_season_data %>% 
  mutate(wk_start = floor_date(time, unit = "week"),
         wk_start = if_else(wk_start < first_day, first_day, wk_start),
         wk_start = as.Date(wk_start))

# Months/Dates covered by each season for use as labels
month_range <- switch(params$season,
  "Winter" = "(December 1st - February 28th)",
  "Spring" = "(March 1st - May 31st)",
  "Summer" = "(June 1st - August 31st)",
  "Fall" =   "(September 1st - November 30th)"
)
```


```{r seasonal temp summary}

# 1. Get the overall averages across all years

# Set the start year, use 1981 if season is winter
ssn_year_start <- ifelse(params$season == "Winter", 1981, 1982)


# Get the average temperature for all years as a baseline
# all_year_szn_avg 
all_year_season_avg <- region_hw %>% 
  filter(season_yr %in% c(ssn_year_start:params$year),
         season_eng == params$season) %>% 
  group_by(season_eng) %>% 
  summarise(avg_temp_c = mean(sst),
            avg_anom_c = mean(sst_anom),
            avg_clim_c = mean(seas),
            avg_temp_f = mean(sst_f),
            avg_clim_f = mean(seas_f),
            avg_anom_f = mean(anom_f),
            .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))



# 2. Get Averages for each year individually, 
# Use region_hw and its climatology 
seasonal_avgs <- region_hw %>% 
  filter(season_eng == params$season, 
  season_yr %in% c(ssn_year_start:params$year)) %>% 
  group_by(season_yr, season) %>% 
  summarise(
    # Uses Area Weighted SST
    mean_temp = mean(sst),
    mean_clim = mean(seas),
    mean_clim = median(mean_clim), # Makes sure any odd years (leap year or incomplete) are not different
    mean_anom = mean(sst_anom),
    temp_f    = as_fahrenheit(mean_temp),
    clim_f    = as_fahrenheit(mean_clim),
    anom_f    = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") %>% 
  mutate(
     year = season_yr,
     yr = season_yr,
     season_center = as.Date(str_c(yr, season_cent)),
     season_llim   = as.Date(str_c(yr, season_left)),
     season_rlim   = as.Date(str_c(yr, season_right)),
     anom_label    = str_c(round(anom_f, 2), " \u00b0F  |  ", round(mean_anom, 2), " \u00b0C")
  )
  
  
  
# Rank the hottest years
seasonal_ranks <- seasonal_avgs %>% 
  mutate(yr = factor(yr),
         year_rank = fct_reorder(.f = yr, .x = mean_temp, .fun = median, .desc = TRUE)) %>% 
  arrange(year_rank) %>% 
  mutate(rank = row_number(),
         flag_year = ifelse(year_rank == params$year, "flag", "unflag")) 

```


# About the Updates:

Over the past decade, scientists at [the Gulf of Maine Research Institute](https://www.gmri.org) have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To keep you informed, we share seasonal updates about conditions in the Gulf of Maine.

**Note About the Data:** The figures in this report are creating using remotely-sensed satellite data as part of publicly funded research efforts. Satellite SST data was obtained from NOAA's National Center for Environmental Information (NCEI), with all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncei.noaa.gov/products/optimum-interpolation-sst).

**Note on Preliminary Data:** This dataset has a 2-week latency period, during which values may change due to quality control measures. Any data within 14 days of the publishing date may be subject to change.

# The Gulf of Maine Region

For analyses like these, it is important to be clear about the spatial extent that "defines" the Gulf of Maine (Figure 1), as different borders could produce different numbers. The spatial extent we use as the "Gulf of Maine" is displayed below. This area is consistent with previous reports and publications GMRI has produced.

```{r}
#| fig.width = 8,
#| fig.height = 8,
#| fig.alt = "A overhead view of the Gulf of Maine region. Landmasses and political boundaries for the United States and Canada are displayed. A blue dotted line outlining a box with a transparent blue fill is shown to demark where satellite data for the analysis has been used."


# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)


# Map the Gulf of Maine with Bathymetry
gom_extent_p <- map_study_area_color(
  region_extent = region_extent,
  new_england_sf = new_england,
  canada_sf = canada,
  greenland_sf = greenland) +
  labs(title = "Gulf of Maine Study Area")

# Show figure
gom_extent_p

```

For this seasonal report, we present an analysis of SST for `r params$season` `r month_range`.

```{r season circle, eval = FALSE}
#| fig.alt = "A circular plot with the twelve months around the border displays the currently selected season which is indicated by a curved bar with a highlight color to identify which months are included in the meteorological season selected."

# Plot the currently selected season:
(season_polar <- plot_met_seasons(season_highlight = params$season))

```



## Highlights


```{r season highlights}


# Why is the math not adding up!?

#--- 1. Calculation 1: Filters year, and filters time between the season start and season end
# Grab the most recent temp and anomaly for this season for text
this_seas <- filter(seasonal_avgs, yr == params$year)
# season_temp <- mean(this_seas$temp_f)
# season_anom <- mean(this_seas$anom_f)

# What is the climatological average temperature
climate_baseline <- mean(this_seas$clim_f)

# Average Temp+Anom Stats for that season Used ib Text
season_avg_temp <- round(mean(this_season_data$sst_f, na.rm = T), 2) # same as season_temp
season_avg_anom <- round(mean(this_season_data$anom_f, na.rm = T), 2) # same as season_anom
season_avg_clim <- mean(this_season_data$seas_f, na.rm = T) # Same as climate_baseline


# What rank are we this year?
current_rank <- seasonal_ranks %>% 
  filter(yr == params$year) %>% pull(rank)

# In-Text friendly version
rank_labs <- switch(current_rank,
  "1" = "new",
  "2" = "2nd",
  "3" = "3rd",
  "4" = "4th",
  "5" = "5th",
  "6" = "6th",
  "7" = "7th",
  "8" = "8th",
  "9" = "9th",
  "10" = "10th")

# Get max anom year and max anom
max_anom_yr <- seasonal_avgs %>% 
  arrange(desc(mean_anom)) %>% 
  slice(1) %>% 
  mutate(across(where(is.numeric), round, 3))
```

The average SST for the Gulf of Maine during the `r tolower(params$season)` of `r params$year` was `r season_avg_temp`°F, which is `r season_avg_anom`°F above the long-term average across all years (1982-2022) of `r round(climate_baseline, 3)`°F.

It was the `r rank_labs` hottest `r tolower(params$season)` on record for the period of 1982-2022. 

## Weekly Temperatures

In the below table, we highlight how the SST for each week this `r tolower(params$season)` compares to a 30-year baseline period (climatological averages from 1982 through 2011).

The observed SST, long-term average SST, as well as departures from the long-term average (SST anomalies) are shown.


```{r seasonal table prep}


# Format the start/end dates for weekly subsets
week_labels <- this_season_data  %>% 
  # Determine bookends for weeks and trim to season bookends
  mutate(
    wk_end = ceiling_date(time, unit = "week"),
    wk_end = if_else(wk_end > last_day, last_day, wk_end),
    wk_end = as.Date(wk_end) - 1) %>% 
  # pull distinct weeks
  distinct(time, wk_start, wk_end)  %>% 
  # Add the month and day labels
  mutate(
    start_month = month(wk_start, label = T, abbr = T),
    end_month = month(wk_end, label = T, abbr = T),
    start_day = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week` = str_c(start_month, " ", start_day, " - ", end_month, " ", end_day),
    `Week` = factor(`Week`)) %>%
  # Ensure distinct weeks only, and arrange in chronological order
  distinct(`Week`, .keep_all = T) %>% 
  arrange(wk_start) %>% 
  mutate(week_position = row_number())
    
    
# rejoin the temperatures to get weekly summaries
week_data <- this_season_data %>%
  select(time, sst, seas, sst_anom, hw_outcomes, wk_start) %>%
  left_join(week_labels, by = "wk_start") 


# Process mean temps
week_summaries <- week_data %>%
  group_by(`Week`, week_position) %>%
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    outcomes = list(hw_outcomes), # list column for showing what days were heatwaves
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .x = week_position)) %>% 
  arrange(week_position)


# Fahrenheit formatting and column labels
week_summaries <- week_summaries %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), signif, 3)) 





# Display Table for the weeks in this season
week_summ_table <- week_summaries  %>% 
  select(
    Week, temp_f, temp_c, clim_f, clim_c, anom_f, anom_c#, outcomes
    ) %>%
   gt(rowname_col = "Week") %>% 
    tab_header(
    title = md(paste0("**Weekly Sea Surface Temperatures - ", params$season, "**")), 
    subtitle = paste(params$season, month_range)) %>%
    tab_stubhead(label = md("*One-Week Period*")) %>% 
    tab_spanner(label = md("*Observed Temperature*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
    cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C"#, 
      #outcomes = "Heatwave | Normal | Coldspell"
      ) %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatology Reference Period: 1982-2011.*"))


# # Display Table
week_summ_table

```


##  Monthly Statistics

Looking at monthly averages (as opposed to week-by-week conditions), we see that May showed the largest deviation from the long-term average, with an average SST anomaly of 3.40°F. All days this season met the criteria to be considered a marine heatwave, and each month was 2.4°F or more above the 1982-2011 average. 

```{r}
# Recreate Table for Monthly Averages
monthly_avgs <- this_season_data %>% 
  group_by(month) %>% 
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies"),
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    temp_list = list(sst_f), # list column for sparkline anomalies
    outcomes = list(hw_outcomes),
    .groups = "drop") %>% 
  mutate(across(where(is.numeric), signif, 3)) 


# Create the Table
month_summ_table <- monthly_avgs %>% 
  select(-outcomes) %>% 
  mutate(month = factor(month, levels = c("Dec", month.abb[1:11]))) %>% #glimpse()
  gt(rowname_col = 'month') %>% 
     tab_stubhead(label = md("*Month*"))  %>% 
    tab_spanner(label = md("*Observed Temperature*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
  tab_spanner(label = md("*Temperature Progression*"), columns = c(`temp_list`)) %>%
  gt_sparkline(temp_list, range_colors = c(gmri_cols("gmri blue")[[1]], gmri_cols("orange")[[1]]), line_color = "gray50") %>%
  #tab_spanner(label = md("*Heatwave Status:*"), columns = c(outcomes)) %>% 
  # gt_plt_winloss(column = outcomes, colors = c(gmri_cols("orange")[[1]], "gray", gmri_cols("gmri blue")[[1]])) %>% 
  cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C",
      temp_list = "High/Low \u00b0F"#,
      #outcomes = md("**Heatwave Status:**")
      ) %>% 
   #tab_source_note(source_note = md("*Heatwave statuses: HW = orange, gray = non-event, blue = cold spell.*")) %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(source_note = md("*Climatology Reference Period: 1982-2011.*"))
   


# # Display Table
month_summ_table

```



## Seasonal Trends and Anomalies in Context

```{r temp warming rates}
# Get the rates of change for dynamic text

# Decadal Rate
yr_mod         <- lm(temp_f ~ yr, seasonal_avgs)
annual_rate    <- coef(yr_mod)[[2]]
decadal_rate_f   <- round((annual_rate*10), 2)

```

The Gulf of Maine is an area of particular interest to the scientific community because of the remarkable rate of warming it has experienced in recent years.

When looking at average `r tolower(params$season)` temperatures, there is a clear long-term increase, with SSTs warming at a rate of `r decadal_rate_f`°F per decade. A major factor driving this trend is a shift in the thermal regime that we began to observe around 2010.


```{r seasonal temperature change}


# Seasonal Temperature Trend Plot:
seasonal_temp_p <- ggplot(seasonal_avgs, 
                          aes(yr, temp_f)) +
  # Box for new regime
  #annotate(geom = "rect", xmin = 2010, xmax = Inf, ymin = -Inf, ymax = Inf, color = "transparent", fill = "darkred", alpha = 0.1) +
  geom_line(color = "gray20", linetype = 3, size = 0.5, alpha = 0.5) +
  geom_point(color = "gray20", size = 1, alpha = 0.8) +
  # # Benchmark the average across all years
  # geom_hline(data = all_year_season_avg, aes(yintercept = avg_temp_f), 
  #            color = "darkblue", linetype = 2) + 
  # # Text noting the average across all years
  # geom_mark_ellipse(data = data.frame(x = 2016, y = all_year_season_avg$avg_temp_f),
  #                   aes(x, y, label = all_year_season_avg$temp_label), 
  #                   description = str_c(ssn_year_start, "-", params$year," Average ", params$season, " Temperature"), 
  #                   label.colour = "darkblue",
  #                   color = "transparent", 
  #                   con.colour = "darkblue", 
  #                   label.fill = "transparent", 
  #                   label.fontsize = 8, 
  #                   label.buffer = unit(0.25, "cm")) +
  geom_smooth(formula = y~x, 
              linetype = 1,
              method = "lm", 
              color = "darkred", 
              se = FALSE) +
  # Annotation for Warming Rate
  geom_mark_ellipse(aes(filter = yr == 1994, 
                        label = str_c(decadal_rate_f, " \u00b0F / Decade")), 
                    color = "transparent", 
                    description = str_c("40-Year ", params$season, " Warming Trend"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.fill = "transparent", 
                    label.fontsize = 8) +
  # Annotation for the current year
  geom_mark_ellipse(aes(filter = yr == params$year, 
                        label = anom_label),
                    color = "darkred",
                    linetype = 1,
                    description = str_c(params$year, "'s Temperature Above the\n1982-2011 climatological average"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.fill = "transparent", 
                    expand = unit(.15, "cm"), # circle radius
                    label.fontsize = 8) +
  scale_y_continuous(
    expand = expansion(add = c(1, 3)),
    labels = number_format(suffix = " \u00b0F")) +
  scale_x_continuous(limits = c(1981, params$year+3)) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature")) 



# Display Plot
seasonal_temp_p 

```

This period of faster warming is part of what appears to be a distinct regime in the Gulf of Maine. The drivers of this (e.g., a weakening of the Atlantic Meridional Overturning Circulation and shifts in the path of the Gulf Stream) have been [well-documented in the peer-reviewed literature](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean), including through research by GMRI scientists.


```{r}

# Plotting Temperature Distribution with Climate Average

# Plot the summers, use box plots for yearly distribution
seasonal_temp_dist <- ggplot(
  data = filter(region_timeseries, season_eng == params$season), 
  aes(season_yr, area_wtd_f, group = season_yr)) +
  geom_boxplot(color = "gray70") + 
  geom_boxplot(data = filter(region_timeseries, season_eng == params$season, 
                             season_yr >= 2010), color = "gray40") + 
  geom_segment(x = 1982, xend = 2011, y = 58.5, yend = 58.5, color = "black") +
  geom_segment(x = 1982, xend = 1982, y = 58,   yend = 59, color = "black") +
  geom_segment(x = 2011, xend = 2011, y = 58,   yend = 59, color = "black") +
  annotate(x = 1997, y =60.25, label = "Climate-Reference Period", geom = "text", size = 3) +
  geom_hline(linetype = 1, size = 0.75, 
             aes(yintercept = climate_baseline, 
                 color = "30-Year Climate Average")) + 
  scale_y_continuous(labels = number_format(suffix = " \u00b0F")) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature"),
       title = str_c("Regime Shift in Distribution of ", params$season, " SST"),
       color = "") +
  scale_color_manual(values = c("30-Year Climate Average" = "darkred")) +
  theme(legend.position = c(0.8, 0.09), 
        legend.background = element_blank(),
        legend.key = element_blank())



# Display Plot
seasonal_temp_dist
```


## How Does `r params$year` Compare

`r params$year` is among the warmest `r tolower(params$season)`s seen in the Gulf of Maine during this 40+ year period. When compared against all previous `r tolower(params$season)`s for which we have reliable satellite data (i.e., back to 1982), this year ranks **`r rank_labs`** among the hottest on record.

```{r, fig.height = 3}


# Plot them
temp_rankings_p <- seasonal_ranks %>% 
  filter(rank <= 5) %>% 
  ggplot(aes(color = flag_year)) +
  geom_link(aes(x = 0,
                xend = anom_f,
                y = rank,
                yend = rank,
                #size = stat(index)/2, 
                alpha = stat(index)), 
            show.legend = FALSE,
            size = 2) +
  geom_label(aes(x = anom_f, y = rank, label = year_rank)) +
  scale_y_reverse(breaks = seq(1, 5, 1), expand = expansion(add = c(0.5, 0.5))) +
  scale_x_continuous(
    labels = number_format(suffix = " \u00b0F"), 
    expand = expansion(mult = c(0,0.15))) +
  scale_color_manual(values = c("flag" = as.character(gmri_cols("orange")), "unflag" = "gray60")) +
  labs(x = "Temperature Anomaly",
       y = "Rank",
       title = str_c(params$season, " Temperature Anomalies,  Ranked")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())


temp_rankings_p

```





## Marine Heatwave Timeline

The most commonly used definition of a ["marine heatwave" (MHW)](http://www.marineheatwaves.org/all-about-mhws.html) is when daily average SSTs exceed the 90th percentile of a climatological (i.e., 30-year) average for at least 5 consecutive days. Successive heatwave gaps of 2 days or less are considered part of the same event.



```{r}
# Pull this year's data, up until end of the season
last_yr_heatwaves <- region_hw %>% 
  filter(
    doy <= season_end,
    yr == params$year)

# Special case for winter
if(params$season == "Winter"){
  last_yr_heatwaves <- region_hw %>% 
    filter(
      season_eng == params$season,
      season_yr == params$year
    )
}


# Get number of heatwave events and total heatwave days for this Season
num_events   <- max(last_yr_heatwaves$mhw_event_no, na.rm = T) - min(last_yr_heatwaves$mhw_event_no, na.rm = T)
num_hw_days <- sum(last_yr_heatwaves$mhw_event, na.rm = T)

```

Using this broadly accepted definition, **the Gulf of Maine has experienced MHW conditions through `r tolower(params$season)` `r params$year`** A brief reprieve in mid-May lasted less than two days, so it did not constitute a break in the heatwave event.

```{r}

# Show figure
hw_temp_p <- year_hw_temps(year_hw_dat = last_yr_heatwaves, temp_units = "F")
hw_temp_p

```


## Heatwave Anomaly Timeline

Presenting SST conditions in terms of anomalies (figure below) as opposed to absolute values (figure above) illustrates in greater detail the magnitude of MHW conditions throughout the `r tolower(params$season)`. The most extreme anomalies the `r tolower(params$spring)` occurred in the second half of May, with temperatures exceeding $5°$F above the climatological average.


```{r}
hw_anom_p <- year_hw_anoms(year_hw_dat = last_yr_heatwaves, temp_units = "F")
hw_anom_p

# Still a hw, only 2 days
# last_yr_heatwaves %>% filter(sst < mhw_thresh)
```


## Heatmap of Temperature Anomalies and Heatwave Events

Looking at the full record of daily SST anomalies in the Gulf of Maine (figure below), the distinct thermal regime shift beginning around 2010 is evident. Indeed, since 2012, the Gulf of Maine has experienced far more persistent MHW conditions (indicated by solid black lines) than at any other point in the satellite record. 

```{r}
#| fig.height = 8
base_date <- as.Date("2000-01-01")
grid_dat <- region_hw %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev)) 


# All years:
heatmap_p <- grid_dat %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2022) +
  labs(title = "Gulf of Maine Heatwave Record") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black"))

heatmap_p + labs(caption = "")
```

```{r}
#| fig.height = 2
# Just the current year on its own:
heatmap_current <- grid_dat %>% 
  #filter(yr == 2022) %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 2021, end_yr = 2022) +
  scale_y_continuous(labels = "2022", 
                     breaks = 2022, 
                     limits = c(2021.5, 2022.5),
                     expand = expansion(add = c(0,0))) +
  theme(legend.position = "none",
        legend.title = element_text(angle = 0)) +
  labs(title = "2022 Conditions")

heatmap_current
```





## Longest Heatwave on Record

The heatwave event of 2022 was actually a continuation of an historical event, the longest heatwave in the region's history. 

```{r}
#| eval = TRUE,
#| fig.height = 8,
#| fig.width = 8

# Pull out the heatwave event - most recent
longest_hw <- region_hw %>% 
  #filter(mhw_event_no == max(region_hw$mhw_event_no, na.rm = T))
  filter(mhw_event_no == 97)

# Event number = 97

# How many days was it
hw_length <- length(unique(longest_hw$time))
avg_hw_temp <- round(mean(longest_hw$anom_f), 2)

# Plot it out:
event_temps <- year_hw_temps(year_hw_dat = longest_hw, temp_units = "F") +
  scale_x_date(
    date_labels = "%b %y", 
    date_breaks = "2 month", 
    expand = expansion(mult = c(0,0)), 
    guide = guide_axis(n.dodge = 1)) +
  labs(title = "Gulf of Maine's Record Heatwave",
       subtitle = str_c("MHW lasting ", hw_length, " days sets new record as longest single heatwave event.")) +
  guides(color = guide_legend(ncol = 2))

event_anoms <- year_hw_anoms(year_hw_dat = longest_hw, temp_units = "F") +
  scale_x_date(
    date_labels = "%b %y", 
    date_breaks = "2 month", 
    expand = expansion(mult = c(0,0)), 
    guide = guide_axis(n.dodge = 1)) +
  theme(legend.position = "none") +
  labs(title = NULL, subtitle = NULL)

hw_showcase <- event_temps / event_anoms
hw_showcase

```

The full heatwave event lasted a total of `r hw_length`, and during that period temperatures were on average `r avg_hw_temp`°F what they were compared to the climate reference period.




## Spatial Distribution of Seasonal Anomalies



```{r}

# Set time limits
season_dates <- c(min(this_season_data$time), max(this_season_data$time))

# Spatial Extent Info
x_buffer <- c(-2.75, 2.75)
y_buffer <- c(-0.75, 0.75)
crop_x   <- st_bbox(region_extent)[c(1,3)] + x_buffer
crop_y   <- st_bbox(region_extent)[c(2,4)] + y_buffer

# Expanded area as bbox
expanded_area <- structure(c(crop_x, crop_y),  
                           class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()


# Make data window for season
data_window <- data.frame(lon = crop_x,
                          lat = crop_y,
                          time = season_dates)

# Load data
season_anoms <- oisst_window_load(
  data_window = data_window, 
  anomalies = T, 
  mac_os = "mojave")

# Stack the years
season_anoms <- stack(season_anoms)


# Convert to F
season_anoms <- as_fahrenheit(season_anoms, data_type = "anomalies")


# Calculate the average for the season
season_mean <- mean(season_anoms, na.rm = T)


####  Records for the Text  ####

# Get the Maximum Daily Temperature Value
max_daily_actual  <- max(values(season_anoms), na.rm = T)
max_daily  <- round(max(values(season_anoms), na.rm = T), 2)

# Get the maximum seasonal average temperature
max_season <- round(max(values(season_mean), na.rm = T), 2)

# Where did the max daily temp happen?
f <- function(x) which(x == max_daily_actual)[1] 
x <- calc(season_anoms, f)
#plot(x)

# When did that happen?
peak_date_lyr <- as.data.frame(x) %>% 
  filter(!is.na(layer)) %>% 
  as.numeric()
peak_date <- names(season_anoms)[peak_date_lyr] %>% 
  str_replace("X", "") %>% str_replace_all("[.]", "-")

# Plot the map to confirm
# plot(season_anoms[[peak_date_lyr]], main = peak_date)


# # Make data window for Peak Temperatures
# temp_data_window <- data.frame(lon = crop_x,
#                           lat = crop_y,
#                           time = c(as.Date(peak_date) - 2, as.Date(peak_date) +3))
# 
# # Load data
# peak_temps <- oisst_window_load(
#   data_window = temp_data_window, 
#   anomalies = T, 
#   mac_os = "mojave")

#plot(as_fahrenheit(peak_temps$`2022`$X2022.05.16), main = "Observed Temperature")


```

From a spatial perspective, the Gulf of Maine and surrounding areas experienced above average SSTs for much of the region during `r tolower(params$season)` `r params$year`, but with particularly warm patches to the south and east of Georges Bank. The highest seasonally averaged anomaly of any location was  `r max_season`°F.

```{r contour details}
# Add the bottom contours:
bathy <- raster("~/Documents/Repositories/Points_and_contours/NEShelf_Etopo1_bathy.tiff")

# Contours for geom_contour()
bathy_df <- as.data.frame(raster::coordinates(bathy))
bathy_df$depth <- raster::extract(bathy, bathy_df)
bathy_df$depth <- bathy_df$depth * -1
contours_make <- c(200)

```


```{r}
#| fig.width = 8,
#| fig.height = 8

# Make it a stars class to plot with ggplot
anoms_st <- st_as_stars(season_anoms)


# Set Plot legend limits
temp_limits <- c(-8, 8)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")



#### 1. Map the Anomalies in Space
season_map <- ggplot() +
  geom_stars(data = anoms_st) +
  geom_contour(data = bathy_df, aes(x, y, z = depth),
                     breaks = contours_make,
                     color = "gray20", size = 0.25) +
  # metR::geom_text_contour(data = bathy_df, aes(x, y, z = depth),
  #                breaks = contours_make,
  #                color = "gray20",
  #                size = 1.5, min.size = 10) +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, size = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits,
                       breaks = temp_breaks,
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  map_theme(legend.position = "bottom") +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = F) +
  guides("fill" = guide_colorbar(
    title = expression("Surface Temperature Anomaly"),
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(title = str_c("Seasonal Temperature Anomaly\n", params$season, ", ", params$year),
       caption = "200m contour overlaid to show topographic details.")

# Show figure
season_map

```

## Monthly Temperature Anomalies

Average monthly temperature anomalies are displayed below. The warmest anomalies were concentrated just south of the domain studied in this analysis in March, but by April and May the waters south and east of Georges Bank and near the Northeast Channel were experiencing monthly-averaged SSTs >8°F warmer than during our climate reference period (1982-2011).

```{r month avgs, eval = TRUE}
#| fig.width = 8,
#| fig.height = 6


# Show less contours b/c smaller
contours_make <- c(200)

# Get monthly averages
season_nums    <- unique(str_sub(names(season_anoms), 7,8))
month_names    <- month.name[as.numeric(season_nums)]



# Pull the layers for each and average them:
display_months <- map(season_nums, function(month_idx){
  
  which_dates <- which(str_sub(names(season_anoms), 7,8) == month_idx)
  month_mean <- mean(season_anoms[[which_dates]], na.rm = T)
  }) %>% setNames(month_names)




# Perform masking
months_masked <- map(display_months, mask_nc, expanded_area, rotate = FALSE)

# Make plots for each
month_plots <- imap(months_masked, function(month_avg_layer, month_id){
  
  
  # Set up text label  
  month_yr <- params$year
  month_label <- str_c(month_id, ", ", month_yr)
  
  # Convert to F
  month_avg_layer <- as_fahrenheit(month_avg_layer, data_type = "anomalies")
  
  
  # Make stars object for plot
  month_stars <- st_as_stars(month_avg_layer)
  
  # Color limit for palettes
  temp_limits <- c(-8, 8)
  temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
  temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")
  
  # build plot
  month_fig <- ggplot() +
    geom_stars(data = month_stars) +
    geom_sf(data = new_england, fill = "gray90", size = .25) +
    geom_sf(data = canada, fill = "gray90", size = .25) +
    geom_sf(data = greenland, fill = "gray90", size = .25) +
    geom_contour(data = bathy_df, aes(x, y, z = depth),
                     breaks = contours_make,
                     color = "gray20", size = 0.25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, size = 0.5,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdBu", 
                         na.value = "transparent", 
                         limit = temp_limits,
                         oob = scales::squish,
                         breaks = temp_breaks, 
                         labels = temp_labels) +
    map_theme(
      title = element_text(hjust = 0.5, size = 8),
      axis.text = element_text(size = 6)) +
    coord_sf(xlim = crop_x, 
             ylim = crop_y, 
             expand = F) +
    guides("fill" = guide_colorbar(
      title = expression("Temperature Anomaly"~degree*F),
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) +
      labs(title = str_c(month_label))
  return(month_fig)
  
  
})

# assemble plot
monthly_maps <- (month_plots[[1]] | month_plots[[2]] | month_plots[[3]]) + plot_layout(guides = "collect")  & theme(legend.position = 'bottom') 


monthly_maps + plot_annotation(caption = "200m contour overlaid to show topographic details.")
```



```{r}
# Export Figures
if(params$`Save Figures`){
  
  # # Folder for update - local
  # update_folder <- str_c(here("R/markdown_reports/seasonal_update_figs/"),
  #    params$season, "_", year(Sys.Date()), "/")
  
  # Folder for update - Box
  comm_folder <- cs_path("root", "GoM Seasonal Climate Update")
  update_folder <- str_c(
    comm_folder, 
    params$season, "_", year(Sys.Date()), "/")
  
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, 
         filename = str_c(update_folder, "GOM_Extent.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Weekly Report Table
  gtsave(data = week_summ_table, 
         filename = str_c(update_folder, "weekly_summary_table.png"))
  
  
  # Monthly Report Table
  gtsave(data = month_summ_table, 
         filename = str_c(update_folder, "monthly_summary_table.png"))
  
  
  # Seasonal Temperature Plot
  ggsave(plot = seasonal_temp_p, 
         filename = str_c(update_folder, "Seasonal_temp_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Seasonal Temp Rankings
  ggsave(plot = temp_rankings_p, 
         filename = str_c(update_folder, "Seasonal_temp_ranks_plot.png"), 
         height = unit(4, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")

  
  # Heatwave Temperature Plot
  ggsave(plot = hw_temp_p, 
         filename = str_c(update_folder, "Heatwave_temp_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Heatwave Anomaly Plot
  ggsave(plot = hw_anom_p, 
         filename = str_c(update_folder, "Heatwave_anom_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # heatwave_showcase
  ggsave(plot = hw_showcase, 
         filename = str_c(update_folder, "Longest_Heatwave.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # heatmap_p
  ggsave(plot = heatmap_p, 
         filename = str_c(update_folder, "Heatwave_Heatmap.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # Season Map
  ggsave(plot = season_map, 
         filename = str_c(update_folder, "Seasonal_anom_map.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # monthly maps
  ggsave(plot = monthly_maps,
         filename = str_c(update_folder, "Monthly_anom_maps.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
}

####  Saving the Data  ####



if(params$`Save Data`){
  

  # Rename so there is 0 chance of confusion
  save_season_avg <- seasonal_avgs %>% 
    select(
      year = yr,
      months = season,
      temp_c = mean_temp,
      temp_f = temp_f,
      climate_avg_c = mean_clim,
      climate_avg_f = clim_f,
      temp_anom_c = mean_anom,
      temp_anom_f = anom_f) %>% 
    mutate(season = params$season, .before = "months") %>% 
    mutate(across(where(is.numeric), round,2))
   
  
  # Save locally
  update_name <- str_c(here("R/markdown_reports/seasonal_update_data/"),
                       "Gulf-of-Maine_SST_",
                       params$season,
                       "_Averages_GMRI_",
                       str_remove_all(Sys.Date(), "[-]"),
                       ".csv")
  write_csv(save_season_avg, 
            file = update_name)
}
```

`r insert_gmri_footer()`
