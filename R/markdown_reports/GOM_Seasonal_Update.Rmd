---
title: "Gulf of Maine Seasonal Update"
author: 
  - first_name: "Adam"
    last_name: "Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
    affiliation_url: https://www.gmri.org
description: | 
  Sea Surface Temperature Warming Update for the Gulf of Maine
date: "Updated on: `r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
# knitr options
knitr::opts_chunk$set(echo = FALSE, 
                      message = F, 
                      warning = F, 
                      comment = "", 
                      fig.align = "center")

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggstream)
library(ggforce)
library(geomtextpath)


# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

#box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")


# Set ggplot theme for figures
theme_set(theme_bw() + 
            theme(
              # Titles
              plot.title = element_text(hjust = 0.5),
              # Axes
              axis.line.y = element_line(),
              axis.ticks.y = element_line(), 
              axis.line.x = element_line(),
              axis.ticks.x = element_line(), 
              axis.text = element_text(size = 11),
              # Facets
              strip.text = element_text(color = "white", 
                                        face = "bold",
                                        size = 11),
              strip.background = element_rect(
                color = "white", 
                fill = "#36454F", 
                size = 1, 
                linetype="solid"))
          )


# Set theme up for maps
map_theme <- list(
  theme(
    panel.border       = element_rect(color = "black", fill = NA),
    plot.background    = element_rect(color = "transparent", fill = "transparent"),
    line               = element_blank(),
    axis.ticks         = element_line(size = 0.25),
    axis.title.x       = element_blank(), # turn off titles
    axis.title.y       = element_blank(),
    legend.position    = "bottom", 
    legend.title.align = 0.5))


# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world       <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     mac_os = "mojave")

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
```

`r gmRi::use_gmri_style_rmd(css = "gmri_rmarkdown.css")`


```{r param setup, echo = FALSE}

# Parameters
params <- list(
  season = "Fall",
  `Save Data` = FALSE,
  `Save Figures` = TRUE)


# Current date checking:
reporting_date <- Sys.Date()
#this_yr <- year(reporting_date)
this_yr <- 2021

#####  Parameter switches:  ####

# Set color for the season based on the parameter:
season_col <- switch(params$season,
  "Spring" = gmri_cols("teal"),
  "Summer" = gmri_cols("green"),
  "Fall" = gmri_cols("orange"),
  "Winter" = "lightblue",
)

# Configure edges/centers of each season for label positioning
season_cent <- switch(params$season,
                      "Spring" = "-04-15",
                      "Summer" = "-07-15",
                      "Fall"   = "-10-15",
                      "Winter" = "-01-15")

season_left <- switch(params$season,
                      "Spring" = "-03-01",
                      "Summer" = "-06-01",
                      "Fall"   = "-09-01",
                      "Winter" = "-12-01")

season_right <- switch(params$season,
                       "Spring" = "-05-30",
                       "Summer" = "-08-30",
                       "Fall"   = "-11-30",
                       "Winter" = "-01-28")


# Make names for the months to pull based on the season and current year
season_months <- switch(params$season,
  "Spring" = str_c("X", this_yr, ".", c("03", "04", "05")),
  "Summer" = str_c("X", this_yr, ".", c("06", "07", "08")),
  "Fall" = str_c("X", this_yr, ".", c("09", "10", "11")),
  "Winter" = map2(c(this_yr-1, this_yr, this_yr), c("12","01","02"), ~ str_c("X", .x, ".", .y))
)


# Turn on the gmri font for plots
showtext::showtext_auto()
```


# About:

Over the past decade, scientists at [the Gulf of Maine Research Institute](https://www.gmri.org) have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To help keep you informed, we share seasonal updates about conditions in the Gulf of Maine.

By sharing these seasonal updates of sea surface temperatures (SST) in the Gulf of Maine, we hope to provide the public with a greater understanding of the conditions in our cherished waters, contextualize them historically and globally, and give a little insight into why it all matters.

**Note About the Data:**
The figures in this report are creating using remotely-sensed satellite data as part of publicly funded research efforts. Satellite sea surface temperature data used was obtained from the National Center for Environmental Information (NCEI), with all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncei.noaa.gov/products/optimum-interpolation-sst).


## The Gulf of Maine Region {.tabset .tabset-pills}

For analyses like this, it is important to be clear about the spatial extent that “defines” the Gulf of Maine (Figure 1), as different borders could produce different numbers. It's also important to note where we are getting our data, which is derived from satellite measurements compiled by NOAA’s National Centers for Environmental Information.

The spatial extent that we've used as the "Gulf of Maine" is displayed below. This area is consistent with reports done in previous years and in earlier publications.

```{r}

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)

# Pull extents for the region for crop
crop_x <- st_bbox(region_extent)[c(1,3)]
crop_y <- st_bbox(region_extent)[c(2,4)]

# Expand the area out to see the larger patterns
crop_x <- crop_x + c(-2.25, 2.25)
crop_y <- crop_y + c(-0.75, 0.75)


# Add the bottom contours:
bathy <- raster("~/Documents/Repositories/Points_and_contours/NEShelf_Etopo1_bathy.tiff")

# Contours for geom_contour()
bathy_df <- as.data.frame(raster::coordinates(bathy))
bathy_df$depth <- raster::extract(bathy, bathy_df)
bathy_df$depth <- bathy_df$depth * -1
contours_make <- c(50, 100, 250)


# Full map of GOM
gom_extent_p <- ggplot() +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_contour(data = bathy_df, aes(x, y, z = depth),
               breaks = contours_make,
               color = "gray80") +
  geom_sf(data = region_extent, 
          color = gmri_cols("gmri blue"), 
          fill = gmri_cols("gmri blue"), alpha = 0.2, linetype = 2, size = 0.5) +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, expand = T) +
  map_theme


# Show figure
gom_extent_p



# If we want contours as sf:
# contours_make <- c(-50, -100, -250)
# bathy_contours <- rasterToContour(bathy, levels = contours_make) %>% st_as_sf()
# bathy_contours$level <- factor(bathy_contours$level, levels = as.character(contours_make))

# Put in plot:
# metR::geom_text_contour(data = bathy_df, aes(x, y, z = depth),
#                   breaks = contours_make,
#                   color = "gray40",
#                   size = 1.4,
#                   min.size = 10,
#                   stroke = 0.2,
#                   rotate = FALSE,
#                   check_overlap = TRUE) +

```


For the data within this seasonal report, we include data for `r params$season` that follows the meteorological definitions for the seasons. Under this system the first days of March, June, September, and December each mark the start of Meteorological Spring, Summer, Fall and Winter respectively.

```{r season circle, eval = TRUE}



# make a dataframe of where the seasons align
met_seasons_df <- data.frame(
  startdate  = as.Date(c("2016-03-03", "2016-06-03", "2016-09-03", "2015-12-02=3")),
  labeldate = as.Date(c("2016-04-16", "2016-07-16", "2016-10-16", "2016-01-16")),
  finishdate = as.Date(c("2016-05-29", "2016-08-29", "2016-11-28", "2016-02-28")),
  season = c("Spring", "Summer", "Fall", "Winter"),
  y = rep(5,4)) %>% 
  mutate(y_orig = y,
         y = ifelse(season == params$season, y + 0.5, y),
         y_high = y + 1.5,
         label_y = y_orig + 4,
         current_season = ifelse(season == params$season, season_col, "gray70"))




# Plot
ggplot(met_seasons_df) +
  geom_rect(aes(xmin = startdate, 
                xmax = finishdate,
                ymin = y,
                ymax = y_high),
            fill = met_seasons_df$current_season) +
  geom_textpath(aes(x = labeldate, y = label_y, label = season), 
                color = met_seasons_df$current_season, size = 6) +
  scale_x_date(date_breaks = "1 month", date_labels = month.abb,
               limits = range(as.Date(c("2015-12-01", "2016-11-30")))) +
  ylim(0,13) +
  coord_curvedpolar() +
  labs(title = "The Meteorological Seasons", 
       x = "", y = "") +
  theme(panel.background = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.border = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        title = element_text(size = 14, face = "bold"))


```




## Weekly Temperatures: `r params$season` 

Knowing how hot or cold it was in the past gives us a baseline that we can compare against temperatures we observe today. In the below table, we highlight how the surface ocean temperature for each week this summer (observed SST) compares to a 30-year baseline period (climate average) that spans from 1982 to 2011. The table shows the absolute values as well as the departures from that long-term average (temperature anomalies).

We can learn two important lessons by looking at data this way:

 1. The SST anomalies in September were lower than they were in October or November, meaning the month of September was relatively cooler than the rest of `r tolower(params$season)`.   
 2. **Even in that “cool” month of September, the Gulf of Maine was still between to 1.6 & 2.9°C warmer than normal** (and as much as 3°C warmer than normal for a week in October).   

```{r heatwave timeseries setup}
# Load timeseries of SST for Region
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6) 

# Format timeseries for group estimates
region_timeseries <- region_timeseries %>% 
  distinct(time, .keep_all = T) %>% 
  mutate(time = as.Date(time),
         yr = year(time),
         month_num = month(time),
         month = month(time, label = T, abbr = T),
         week = lubridate::week(time),
         doy = yday(time),
         season = metR::season(month_num, lang = "en"),
         season_eng = case_when(
           season == "SON" ~ "Fall",
           season == "DJF" ~ "Winter",
           season == "MAM" ~ "Spring",
           season == "JJA" ~ "Summer"),
         #Set up correct year for winters, they carry across into next year
         season_yr = ifelse(
           (season_eng == "Winter" & month_num %in% c(1,2)), yr - 1, yr)
         )


# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(temperature_timeseries = region_timeseries)

# Format dates and seasons and heatwave outcomes
region_hw <- region_hw %>% 
  mutate(time = as.Date(time),
         yr = year(time),
         month_num = month(time),
         month = month(time, label = T, abbr = T),
         week = lubridate::week(time),
         doy = yday(time),
         season = metR::season(month_num, lang = "en"),
         season_eng = case_when(
           season == "SON" ~ "Fall",
           season == "DJF" ~ "Winter",
           season == "MAM" ~ "Spring",
           season == "JJA" ~ "Summer"),
         #Set up correct year for winters, they carry across into next year
         season_yr = ifelse(
           (season_eng == "Winter" & month_num %in% c(1,2)), yr - 1, yr)
         )

# Set up heatwave status outcomes for fancy table features:
region_hw <- region_hw %>% 
  mutate(hw_outcomes = case_when(
    mhw_event == TRUE ~ 1,
    mcs_event == TRUE ~ 0,
    TRUE ~ 0.5))
```



```{r seasonal table prep}
# Subset data for the season were looking at
season_data <- region_hw %>% 
  dplyr::filter(season_eng == params$season,
                season_yr == this_yr) 

# Set end date so weeks don't bleed over
first_day <- as.Date(min(season_data$time))
last_day <- as.Date(max(season_data$time))

# Set week start in the data so we can merge labels in accordingly later
season_data <-  season_data %>% 
  mutate(wk_start = floor_date(time, unit = "week"),
         wk_start = if_else(wk_start < first_day, first_day, wk_start),
         wk_start = as.Date(wk_start))


# Format the start/end dates for weekly subsets
week_labels <- season_data  %>% 
  # Determine bookends for weeks and trim to season bookends
  mutate(
    wk_end   = ceiling_date(time, unit = "week"),
    wk_end = if_else(wk_end > last_day, last_day, wk_end),
    wk_end = as.Date(wk_end) - 1) %>% 
  # pull distinct weeks
  distinct(time, wk_start, wk_end)  %>% 
  # Add the month and day labels
  mutate(
    start_month = month(wk_start, label = T, abbr = T),
    end_month = month(wk_end, label = T, abbr = T),
    start_day = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week` = str_c(start_month, ", ", start_day, " - ", end_month, ", ", end_day),
    `Week` = factor(`Week`)) %>%
  # Ensure distinct weeks only, and arrange in chronological order
  distinct(`Week`, .keep_all = T) %>% 
  arrange(wk_start) %>% 
  mutate(week_position = row_number())
    
    
# rejoin the temperatures to get weekly summaries
week_data <- season_data %>%
  select(time, sst, seas, sst_anom, hw_outcomes, wk_start) %>%
  left_join(week_labels, by = "wk_start") 


# Process mean temps
week_summaries <- week_data %>%
  group_by(`Week`, week_position) %>%
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    outcomes = list(hw_outcomes), # list column for showing what days were heatwaves
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .x = week_position)) %>% 
  arrange(week_position)


# Fahrenheit formatting and column labels
week_summaries <- week_summaries %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), signif, 3)) 



# Display Table for the weeks in this season
week_summ_table <- week_summaries  %>% 
  select(
    Week, temp_f, temp_c, clim_f, clim_c, anom_f, anom_c#, outcomes
    ) %>%
   gt(rowname_col = "Week") %>% 
    tab_header(
    title = md(paste0("**Weekly Sea Surface Temperatures - ", params$season, "**")), 
    subtitle = paste("Meteorological", params$season, "(Sep-Nov)")) %>%
    tab_stubhead(label = md("*One-Week Period*")) %>% 
    tab_spanner(label = md("*Observed SST*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climate Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
  #tab_spanner(label = md("*Heatwave Status:*"), columns = c(`outcomes`)) %>% 
    # gt_sparkline(outcomes, range_colors = c("blue", "red"), line_color = "gray50", ) %>% 
    #gt_plt_winloss(column = outcomes, colors = c(as.character(gmri_cols("orange")), "gray", as.character(gmri_cols("gmri blue")))) %>% 
    cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C"#, outcomes = "Heatwave | Normal | Coldspell"
      ) %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatology Reference Period: 1982-2011.*"))


# # Display Table
week_summ_table

```


## Seasonal Trends and Anomalies

The Gulf of Maine is an area of particular interest to the scientific community because of the remarkable rate of warming that it has experienced in recent years.

When looking at the average `r tolower(params$season)` temperatures there is a clear long-term increase, but also a more pronounced increase that begins around 2008.

After this point both the seasonal average and the bulk of the daily temperatures remain several degrees above what we would have expected from the 30-year climatology.

```{r seasonal temp summary}


# All year fall average
# all_year_szn_avg 
all_year_season_avg <- region_timeseries %>% 
  filter(yr %in% c(1982:2021),
         season_eng == params$season) %>% 
  group_by(season_eng) %>% 
  summarise(avg_temp_c = mean(area_wtd_sst),
            avg_anom_c = mean(area_wtd_anom),
            avg_clim_c = mean(area_wtd_clim),
            .groups = "drop") %>% 
  mutate(
    avg_temp_f = as_fahrenheit(avg_temp_c, data_type = "temperature"),
    temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))



# Get Seasonal Averages for each year, 
# uses the max date for the season as date cutoff
seasonal_avgs <- region_timeseries %>% 
  filter(season_eng == params$season,
         between(time, as.Date("1982-01-01"), as.Date(last_day))) %>% 
  group_by(season_yr, season) %>% 
  summarise(
    # Uses Area Weighted SST
    mean_temp = mean(area_wtd_sst),
    mean_clim = mean(area_wtd_clim),
    mean_clim = median(mean_clim), # Makes sure any odd years are not different
    mean_anom = mean_temp - mean_clim,
    temp_f = as_fahrenheit(mean_temp),
    clim_f = as_fahrenheit(mean_clim),
    anom_f = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") %>% 
  mutate(
     yr = season_yr,
     season_center = as.Date(str_c(yr, season_cent)),
     season_llim = as.Date(str_c(yr, season_left)),
     season_rlim = as.Date(str_c(yr, season_right)),
     anom_label = str_c(round(mean_anom, 2), " \u00b0C  |  ", round(anom_f, 2), " \u00b0F")
  )
  


# generate a smoothed temperature line using splines
season_temp_smooth <-  as.data.frame(spline(seasonal_avgs$yr, seasonal_avgs$mean_temp))
```




```{r temp warming rates}

# Get the rates of change for dynamic text

# Decadal Rate
yr_mod <- lm(mean_temp ~ yr, seasonal_avgs)
annual_rate <- coef(yr_mod)[[2]]
decadal_rate <- round((annual_rate*10), 2)

# Last Decade
tenyr_mod <- lm(mean_temp ~ yr, filter(seasonal_avgs, yr %in% c(2011:2021)))
tenyr_rate <- coef(tenyr_mod)[[2]]
tenyr_decadal <- round((tenyr_rate*10), 2)


# Grab the most recent temp and anomaly for this season for text
this_seas <- filter(seasonal_avgs, yr == this_yr)
seas_temp <- round(this_seas$mean_temp, 2)
seas_anom <- round(this_seas$mean_anom, 2)
```


Over the period of 1982-2020 the `r tolower(params$season)`'s in the Gulf of Maine have warmed at a rate of **`r decadal_rate`** $^oC/Decade$, and more recently at a rate of **`r tenyr_decadal`** $^oC/Decade$ over the last ten years (2011-2021). 



```{r seasonal temperature change}


# Seasonal Temperature Trend Plot:
seasonal_temp_p <- ggplot(seasonal_avgs, aes(yr, mean_temp)) +
  # geom_line(color = "gray20", linetype = 1, size = 0.5, alpha = 0.8) +
  geom_line(data = season_temp_smooth, aes(x = x, y = y), linetype = 3, size = 0.5, alpha = 0.5) +
  geom_point(color = "gray20", size = 1, alpha = 0.8) +
  geom_hline(data = all_year_season_avg, aes(yintercept = avg_temp_c), color = "darkblue", linetype = 2) + 
  geom_mark_ellipse(data = data.frame(x = 2016, y = all_year_season_avg$avg_temp_c),
                    aes(x, y, label = all_year_season_avg$temp_label), 
                    description = str_c("1982-2021 Average ", params$season, " Temperature"), 
                    label.colour = "darkblue",
                    color = "transparent", 
                    con.colour = "darkblue", 
                    label.fill = "transparent", 
                    label.fontsize = 8, 
                    label.buffer = unit(0.25, "cm")) +
  geom_smooth(formula = y~x, 
              linetype = 1,
              method = "lm", 
              color = "darkred", 
              se = FALSE) +
  geom_mark_ellipse(aes(filter = yr == 1995, 
                        label = str_c(decadal_rate, " \u00b0C / Decade")), 
                    color = "transparent", 
                    description = str_c("40-Year ", params$season, " Warming Trend"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.buffer = unit(1.35, "cm"), 
                    label.fill = "transparent", 
                    label.fontsize = 8) +
  geom_mark_ellipse(aes(filter = yr == 2021, 
                        label = anom_label),
                    color = "darkred",
                    linetype = 2,
                    description = str_c("Temperature Above\n1982-2011 climatological average"), 
                    label.colour = "darkred",
                    con.colour =  "darkred",
                    label.fill = "transparent", 
                    label.buffer = unit(0.15, "cm"), 
                    label.fontsize = 8) +
  scale_y_continuous(limits = c(12, 16.5),
                     sec.axis = sec_axis(trans = ~ as_fahrenheit(.), labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C")) +
  scale_x_continuous(limits = c(1981, this_yr+3)) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature")) 



# Display Plot
seasonal_temp_p 

```




This period of faster warming is part of what appears to be a distinct regime in the Gulf of Maine. The drivers of this (e.g., a weakening of the Atlantic Meridional Overturning Circulation and shifts in the path of the Gulf Stream) have been [well-documented in the peer-reviewed literature](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean), including through research by GMRI scientists.

Since 2007, average `r  tolower(params$season)` SST in the Gulf of Maine has not fallen below $15^oC$. Prior to 2007, average `r  tolower(params$season)` SST in the Gulf of Maine only *exceeded* $15^oC$ seven times in 25 years (1982-2007). In other words, temperatures this high were not the norm a couple decades ago, but they are now.


```{r}

# Plotting Temperature Distribution with Climate Average
climate_baseline <- seasonal_avgs$mean_clim[1]

# Plot the summers, use box plots for yearly distribution
seasonal_temp_dist <- ggplot(
  data = filter(region_timeseries, season_eng == params$season), 
  aes(yr, area_wtd_sst, group = yr)) +
  geom_boxplot(color = "gray70") + 
  geom_boxplot(data = filter(region_timeseries, season_eng == params$season, 
                             season_yr >= 2010), color = "gray40") + 
  geom_segment(x = 1982, xend = 2011, y = 20.5, yend = 20.5, color = "black") +
  geom_segment(x = 1982, xend = 1982, y = 20, yend = 21, color = "black") +
  geom_segment(x = 2011, xend = 2011, y = 20, yend = 21, color = "black") +
  annotate(x = 1997, y = 21.25, label = "Climate-Reference Period", geom = "text", size = 3) +
  geom_hline(linetype = 1, size = 0.75, aes(yintercept = climate_baseline, color = "30-Year Climate Average")) + 
  scale_y_continuous(sec.axis = sec_axis(trans = ~ as_fahrenheit(.), 
                                         labels =  number_format(suffix = " \u00b0F")), 
                     labels = number_format(suffix = " \u00b0C")) +
  labs(x = "",
       y = str_c(params$season, " Sea Surface Temperature"),
       subtitle = str_c("Above Average ", params$season, " Temperatures the New Normal"),
       color = "") +
  scale_color_manual(values = c("30-Year Climate Average" = "darkred")) +
  theme(legend.position = c(0.8, 0.09), 
        legend.background = element_blank(),
        legend.key = element_blank())



# Display Plot
seasonal_temp_dist
```



The average temperature for this `r tolower(params$season)` was `r seas_temp`$^oC$ / `r round(as_fahrenheit(seas_temp), 2)`$^oF$. Compare that to the climate average of: `r round(climate_baseline, 2)`$^oC$ / `r round(as_fahrenheit(climate_baseline), 2)`$^oC$.




## `r params$season` Temperature Anomaly Record

The same trends can be seen when looking through the lens of temperature anomalies (departure from normal climate). We see the same patterns of steadily rising temperatures followed by an increase in warming in recent years.

```{r}
# Get max anom year and max anom
max_anom_yr <- seasonal_avgs %>% arrange(desc(mean_anom)) %>% slice(1)
```

`r params$season` temperatures since 2008 have not fallen below $0.5~^oC$ with `r max_anom_yr$yr` positioned as the hottest `r tolower(params$season)` at `r max_anom_yr$mean_anom`$~^oC$ above the 30-year summer average.


The average temperature anomaly for this `r tolower(params$season)` was `r seas_anom`$^oC$ / `r round(as_fahrenheit(seas_anom, "anomalies"), 2)`$^oF$.



```{r daily anomalies figure}
# Pull the details for the warmest year:
warmest_year <- as.numeric(seasonal_avgs[seasonal_avgs$mean_temp == max(seasonal_avgs$mean_temp), "season_yr"])



# Plot the daily anomaly patterns for the whole year:
regional_anom_p <- ggplot(region_timeseries, aes(time, area_wtd_anom)) +
  geom_line(alpha = 0.5, color = "gray") +
  geom_point(data = seasonal_avgs,
               aes(x = season_center,
                   y = mean_anom),
               size = 1, alpha = 0.8) +
    geom_line(data = seasonal_avgs, 
               aes(x = season_center, 
                   y = mean_anom), 
               size = 0.4, linetype = 3, color = gmri_cols("gmri blue")) +
  geom_smooth(data = filter(region_timeseries, season_eng == params$season),
              aes(x = time, y = area_wtd_anom),
              formula = y~x, method = "lm", se = FALSE,
              color = "darkred", linetype = 4, size = 1) +
  # Mark the Point
  geom_mark_ellipse(data = filter(seasonal_avgs, yr == warmest_year), 
                    aes(x = season_center, 
                        y = mean_anom), 
                    label.fill = "transparent", 
                    label.fontsize = 9, 
                    linetype = 2) +
  # Place the text manually
  geom_mark_ellipse(data = filter(seasonal_avgs, yr == warmest_year), 
                    aes(x = season_center-(365*8), 
                        y = mean_anom + 1.75, 
                        label = str_c(round(mean_temp, 2), "\u00b0", "C  |  ", round(temp_f, 2), "\u00b0", "F")), 
                    color = "transparent",
                    description = str_c("Warmest ", params$season, " on Record"), 
                    con.colour = "transparent", 
                    label.colour = "black",
                    label.fill = "transparent", 
                    label.fontsize = 9, 
                    label.buffer = unit(0, "cm")) +
  # Set limits for white space
  scale_x_date(limits = as.Date(c("1981-01-01", str_c(this_yr+2, "-12-31")))) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"), 
                                         labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C"),
                     limits = c(-2.5, 4.5)) +
  labs(x = "", 
       y = str_c("Daily Temperature Anomaly"))


# Show figure
regional_anom_p
```






```{r}
# Hottest Daily Temperature
daily_peak <- region_timeseries %>% 
  filter(season_eng == params$season,
         season_yr == year(Sys.Date())) %>% 
  top_n(n = 1, wt = sst_anom) %>% 
  select(time, sst, area_wtd_sst, sst_clim, area_wtd_clim,  sst_anom, area_wtd_anom) %>% 
  mutate(
    temp_f = as_fahrenheit(sst),
    area_wtd_temp_f = as_fahrenheit(area_wtd_sst),
    clim_f = as_fahrenheit(sst_clim),
    area_wtd_clim_f = as_fahrenheit(area_wtd_clim),
    anom_f = as_fahrenheit(sst_anom, data_type = "anomalies"),
    area_wtd_anom_f = as_fahrenheit(area_wtd_anom, data_type = "anomalies")
    
  ) %>% 
  mutate(across(where(is.numeric), .fns = round, 2))
```

Daily temperature anomalies this season peaked on `r daily_peak$time`, at `r daily_peak$area_wtd_anom`C | `r daily_peak$area_wtd_anom_f`F degrees above the long-term average.

## How Does `r this_yr` Compare?



```{r}
# Rank the hottest years
seasonal_ranks <- seasonal_avgs %>% 
  mutate(yr = factor(yr),
         year_rank = fct_reorder(.f = yr, .x = mean_temp, .fun = median, .desc = TRUE)) %>% 
  arrange(year_rank) %>% 
  mutate(rank = row_number(),
         flag_year = ifelse(year_rank == this_yr, "flag", "unflag")) %>% 
  filter(rank <= 5)

# What rank are we this year?
current_rank <- seasonal_ranks %>% filter(yr == this_yr) %>% pull(rank)
```


`r this_yr` is among the warmest years seen in the Gulf of Maine during this 40+ year period. When compared against all previous years (1982-2020), this year ranks **# `r current_rank`** for hottest `r tolower(params$season)` on record.


```{r, fig.height = 3}


# Plot them
temp_rankings_p <- ggplot(seasonal_ranks, aes(x = mean_anom, 
                           xend = 0, 
                           y = rank,
                           yend = rank, 
                          color = flag_year) ) +
  geom_segment(size = 1) +
  geom_label(aes(label = year_rank, size  = flag_year)) +
  scale_y_reverse(breaks = seq(1, 5, 1), expand = c(0, 0.5)) +
  scale_x_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"), 
                                         labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C"), 
                     expand = c(0,0.15)) +
  scale_color_manual(values = c("flag" = "darkred", "unflag" = "gray60")) +
  scale_size_manual(values = c("flag" = 4, "unflag" = 3)) +
  labs(x = "Temperature Anomaly",
       y = "Rank",
       title = str_c(params$season, " Temperatures,  Ranked")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())


temp_rankings_p

```




## Full-Year Warming Trend

If we look at the pattern for year-round temperature we can see that the Gulf of Maine has been warming at a rate higher than the global average of $0.15~^oC$ per decade. 


```{r yearly summaries}
# Summarize by year to return mean annual anomalies and variance
annual_summary <- region_timeseries %>% 
  mutate(year = year(time)) %>% 
  filter(year %in% c(1982:2020)) %>% 
  group_by(year) %>% 
  summarise(sst = mean(sst, na.rm = T),
            sst_anom = mean(sst_anom, na.rm = T), 
            area_wtd_sst = mean(area_wtd_sst),
            area_wtd_anom = mean(area_wtd_anom),
            .groups = "keep") %>% 
  ungroup() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")))


# # Global Temperature Anomaly Rates
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time))

global_summary <- global_anoms %>% 
  group_by(year) %>% 
  summarise(sst = mean(sst, na.rm = T), 
            sst_anom = mean(sst_anom),
            area_wtd_sst = mean(area_wtd_sst),
            area_wtd_anom = mean(area_wtd_anom),
            .groups = "keep") %>% 
  ungroup() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")))
```

```{r annual regressions}

# Build Regression Equation Labels

# 1. All years 
lm_all <- lm(area_wtd_sst ~ year, 
             data = filter(annual_summary, year %in% c(1982:2020))) %>% 
  coef() %>% 
  round(3)

# 2. Last 10 years
lm_10  <- lm(area_wtd_sst ~ year, 
             data = filter(annual_summary, year %in% c(2011:2020))) %>% 
  coef() %>% 
  round(3)

# 3. Global - Area-weighted
lm_global <- lm(area_wtd_sst ~ year, 
                data = filter(global_summary, year %in% c(1982:2020))) %>% 
  coef() %>% 
  round(3)


# Convert yearly rate to decadal
decade_all    <- lm_all['year'] * 10
decade_10     <- lm_10['year'] * 10
decade_global <- lm_global["year"] * 10


# Equation to paste in
eq_all    <- paste0(decade_all,    "\u00b0", "C / Decade")
eq_10     <- paste0(decade_10,     "\u00b0", "C / Decade")
eq_global <- paste0(decade_global, "\u00b0", "C / Decade")

```

```{r annual trend plot}
####  Annual Trend Plot  ####
annual_trend_p <- ggplot(data = annual_summary, aes(yr_as_dtime, area_wtd_anom)) +
  
  # Add daily data
  geom_line(data = region_timeseries,
            aes(time, area_wtd_anom),
            alpha = 0.5, color = "gray") +
  
  # Overlay yearly means
  geom_line(alpha = 0.7, color = "gray20") +
  geom_point(alpha = 0.7, size = 0.75) +
  
  # Add regression lines 
  geom_smooth(data = filter(global_summary, year <= 2020),
              method = "lm", 
              aes(color = "1982-2020 Global Trend"),
              formula = y ~ x, se = F, 
              linetype = 3) +
  geom_smooth(data = filter(annual_summary, year <= 2020),
              method = "lm",
              aes(color = "1982-2020 Regional Trend"),
              formula = y ~ x, se = F,
              linetype = 1) +
  # Manually add equations so they show yearly not daily coeff
  geom_text(data = data.frame(), 
            aes(label = eq_all, x = min(region_timeseries$time), y = Inf),
            hjust = 0, vjust = 2, color = gmri_cols("gmri blue")) +
  geom_text(data = data.frame(), 
            aes(label = eq_global, x = min(region_timeseries$time), y = Inf),
            hjust = 0, vjust = 3.5, color = gmri_cols("green")) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"),
                                         labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C")) +
  
  # Colors
  scale_color_manual(values = c(
    "1982-2020 Regional Trend" = as.character(gmri_cols("gmri blue")),
    "1982-2020 Global Trend"   = as.character(gmri_cols("green")))) +
  
  # labels + theme
  labs(x = "", 
       y = "Sea Surface Temperature Anomaly",
       caption = paste0("Anomalies calculated using 1982-2011 reference period.")) +
  # theme
   theme(legend.title = element_blank(),
        legend.position = c(0.8, 0.1),
        legend.background = element_rect(fill = "transparent"),
        legend.key = element_rect(fill = "transparent", color = "transparent"),
        panel.grid = element_blank())



# Show figure
annual_trend_p

```

## Marine Heatwave Timeline

A [marine heatwaves](http://www.marineheatwaves.org/all-about-mhws.html) (MHW) is defined as a situation when seawater temperatures exceeds a seasonally-varying threshold (usually the 90th percentile) for at least 5 consecutive days. Successive heatwaves with gaps of 2 days or less are considered part of the same event. The heatwave threshold used below was 90%. 


```{r}

# Season End cutoff using day of the year
season_end <- switch (params$season,
  "Winter" = yday("2000-02-28"),
  "Spring" = yday("2000-05-30"),
  "Summer" = yday("2000-08-30"),
  "Fall"   = yday("2000-11-30")
)

# Pull this year's data, up until end of the season
last_yr_heatwaves <- region_hw %>% 
  filter(
    doy <= season_end,
    yr == this_yr)

# Get number of heatwave events and total heatwave days for this Season
num_events   <- max(last_yr_heatwaves$mhw_event_no, na.rm = T) - min(last_yr_heatwaves$mhw_event_no, na.rm = T)
num_hw_days <- sum(last_yr_heatwaves$mhw_event, na.rm = T)

```

Using this broadly accepted definition, **the Gulf of Maine has experienced MHW conditions for almost all of 2021**, with only brief reprieves in mid-March, late April, and during the transition from July to August. We started the year off with a MHW event in January that persisted through March. The longest heatwave of the year began at the very end of April, and lasted until the end of July, peaking at nearly $4~^oC$ above “normal” at the beginning of July and throughout the latter half of August.


```{r}
# Set colors by name
color_vals <- c(
  "Sea Surface Temperature" = "royalblue",
  "Heatwave Event"          = "darkred",
  "MHW Threshold"           = "coral3",
  "Daily Climatology"       = "gray30")

linetype_key <- c(
  "Sea Surface Temperature" = 1,
  "Heatwave Event"          = 1,
  "MHW Threshold"           = 3,
  "Daily Climatology"       = 2)



# Plot the last 365 days as heatwave events
hw_temp_p <- ggplot(last_yr_heatwaves, aes(x = time)) +
    geom_segment(aes(x = time, xend = time, y = seas, yend = sst), 
                 color = "royalblue", alpha = 0.25) +
    geom_segment(aes(x = time, xend = time, y = mhw_thresh, yend = hwe), 
                 color = "darkred", alpha = 0.25) +
    geom_line(aes(y = sst, color = "Sea Surface Temperature", linetype = "Sea Surface Temperature")) +
    geom_line(aes(y = hwe, color = "Heatwave Event", linetype = "Heatwave Event")) +
    geom_line(aes(y = mhw_thresh, color = "MHW Threshold", linetype = "MHW Threshold"), size = .5) +
    geom_line(aes(y = seas, color = "Daily Climatology", linetype = "Daily Climatology"), size = .5) +
    scale_color_manual(values = color_vals) +
    scale_linetype_manual(values = linetype_key, guide = "none") +
    scale_x_date(date_labels = "%b", date_breaks = "1 month") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(.), 
                                           labels =  number_format(suffix = " \u00b0F")),
                     labels = number_format(suffix = " \u00b0C")) +
    guides(color = guide_legend(override.aes = list(linetype = linetype_key), nrow = 2)) +
    theme(legend.title = element_blank(),
          legend.position = "bottom") +
    labs(x = "", 
         y = "Sea Surface Temperature", 
         subtitle = "2021: Heatwave Conditions") #+
  
    # # Anomalies on same plot
    # geom_segment(aes(x = time, xend = time, 
    #                    y = 0, yend = sst_anom), 
    #              color = "darkred", alpha = 0.25) +
    # geom_line(aes(y = sst_anom), color = "darkred") +
    # geom_line(aes(y = 0), color = "gray30", linetype = 2) +


# Show figure
hw_temp_p

```

Changing the axis to anomalies rather than temperature the magnitude of the anomalies become more clear. The most severe marine heatwave event of this `r params$season` occurred during the month of June, when temperatures rose above $3.5~^oC$ above the climate average. Remember, the value of zero in this figure is the average daily temperature from the climate period of 1982-2011. Not a single day this year was within $0.5~^oC$ within that average temperature.

```{r}

# Color & linetype keys
color_vals <- c(
  "Sea Surface Temperature Anomaly" = "royalblue",
  "Heatwave Event"                  = "darkred",
  "MHW Threshold"                   = "coral3",
  "Daily Climatology"               = "gray30")

linetype_key <- c(
  "Sea Surface Temperature Anomaly" = 1,
  "Heatwave Event"                  = 1,
  "MHW Threshold"                   = 3,
  "Daily Climatology"               = 2)



# Plot the last 365 days - anomaly scale
hw_anom_p <- last_yr_heatwaves %>% 
  mutate(
    sst = sst,
    seas = seas,
    sst_anom = sst_anom,
    mhw_thresh = mhw_thresh,
    anom_thresh = mhw_thresh - seas,
    anom_hwe = hwe - seas) %>% 
ggplot(aes(x = time)) +
    geom_segment(aes(x = time, xend = time, 
                     y = 0, yend = sst_anom), 
                 color = "royalblue", alpha = 0.25) +
    geom_segment(aes(x = time, xend = time, 
                       y = anom_thresh, yend = anom_hwe), 
                 color = "darkred", alpha = 0.25) +
    geom_line(aes(y = sst_anom, color = "Sea Surface Temperature Anomaly")) +
    geom_line(aes(y = anom_hwe, color = "Heatwave Event")) +
    geom_line(aes(y = anom_thresh, color = "MHW Threshold"), lty = 3, size = .5) +
    geom_line(aes(y = 0, color = "Daily Climatology"), lty = 2, size = .5) +
    scale_color_manual(values = color_vals) +
    scale_linetype_manual(values = linetype_key, guide = "none") +
    scale_x_date(date_labels = "%b", date_breaks = "1 month") +
    scale_y_continuous(sec.axis = sec_axis(trans = ~as_fahrenheit(., data_type = "anomalies"), 
                                           name = expression(degree*F))) +
    guides(color = guide_legend(override.aes = list(linetype = linetype_key), nrow = 2)) + 
    labs(x = "", 
         y = expression("Temperature Anomaly"~~degree*C), 
         subtitle = "Temperature Anomalies for an Exceptionally Warm Year",
         caption = paste0("Climate reference period :  1982-2011")) +
    theme(legend.title = element_blank(),
          legend.position = "bottom")
   


# Show figure
hw_anom_p

```

## Marine Heatwave Record

Perhaps a clearer way to see the progression away from the temperature regime of the 1980s and 1990s and into the warmer conditions in recent years, is through a *heatmap plot*. In this *heatmap*, each row represents a year and each day within the year is colored in accordance to how hot or cold it was relative to the 30-year baseline period. The increasing prevalence and darker shades of red in recent years highlight the persistence of exceptional deviance from the long-term average temperatures. The black lines illustrate MHW events, highlighting the increasing frequency of periods in heatwave conditions in recent years.

```{r}

# Prep the legend title
guide_lab <- expression("Sea Surface Temperature Anomaly"~degree*C)

# Set new axis dimensions, y = year, x = day within year
# use a flate_date so that they don't stair step
base_date <- as.Date("2000-01-01")
grid_data <- region_hw %>% 
  mutate(flat_date = as.Date(doy-1, origin = base_date)) 


# Set palette limits to center it on 0 with scale_fill_distiller
limit <- max(abs(grid_data$sst_anom)) *c(-1,1)


# Assemble heatmap plot
heatwave_heatmap <- ggplot(grid_data, aes(x = flat_date, y = yr)) +
  
  # background box fill for missing dates
  geom_rect(xmin = base_date, xmax = base_date + 365, 
            ymin = min(grid_data$yr) - .5, ymax = max(grid_data$yr) + .5, 
            fill = "gray75", color = "transparent") +
  
  # tile for sst colors
  geom_tile(aes(fill = sst_anom)) +
  
  # points for heatwave events
  geom_point(data = filter(grid_data, mhw_event == TRUE),
             aes(x = flat_date, y = yr), size = .25)  +
  scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = c(0,0)) +
  scale_y_continuous(limits = c(1981.5, 2021.5), 
                     expand = c(0,0),
                     breaks = seq(1980, 2020, by = 5)) +
  labs(x = "Date Within the Year", 
       y = "Year",
       "\nClimate reference period : 1982-2011") +
  
  #scale_fill_gradient2(low = "blue", mid = "white", high = "red") +
  scale_fill_distiller(palette = "RdYlBu", 
                       na.value = "transparent", 
                       limit = limit) +
  
  #5 inches is default rmarkdown height for barheight
  guides("fill" = guide_colorbar(title = guide_lab, 
                                 title.position = "right", 
                                 title.hjust = 0.5,
                                 barheight = unit(4, "inches"), 
                                 frame.colour = "black", 
                                 ticks.colour = "black")) +  
  theme(legend.position = "right",
        panel.border = element_rect(color = "black", fill = NA),
        legend.title = element_text(angle = 90))





# Assemble pieces
heatwave_heatmap

```


##  The Transition to a Warmer Climate

As we move further away from our baseline climate period it becomes clear to see both: (1.) A reduction in the amount of days that the temperature is below the climate average, and (2.) A simultaneous reduction in the amount of days that temperatures are within half a degree of that average. With temperatures for much of the last decade are above $1~^oC$ the 30-year average from 1982-2011.

```{r}

# Set Factor Order
bin_order <- c(
  "Less than -1", 
  "-1 to -0.5",
  "Within 0.5",
  "0.5 to 1", 
  "Greater than 1")

# Set Colors
bin_colors <- RColorBrewer::brewer.pal(n = length(bin_order), name = "RdBu")
bin_colors <- rev(bin_colors)

# Count Days in Bins
day_types <- region_hw %>% 
  mutate(
    `Less than -1`   = if_else(sst_anom <= -1, TRUE, FALSE),
    `-1 to -0.5`     = if_else(between(sst_anom, -1, -0.5), TRUE, FALSE),
    `Within 0.5`     = if_else(between(sst_anom, -0.5, 0.5), TRUE, FALSE),
    `0.5 to 1`       = if_else(between(sst_anom, 0.5, 1), TRUE, FALSE),
    `Greater than 1` = if_else(sst_anom >= 1, TRUE, FALSE)) %>% 
  group_by(yr) %>% 
  summarise(
    `Less than -1`   = sum(`Less than -1`, na.rm = T),
     `-1 to -0.5`    = sum(`-1 to -0.5`, na.rm = T),
    `Within 0.5`     = sum(`Within 0.5`, na.rm = T),
    `0.5 to 1`       = sum(`0.5 to 1`, na.rm = T),
    `Greater than 1` = sum(`Greater than 1`, na.rm = T),
    .groups = "drop") %>% 
  pivot_longer(cols = "Less than -1":"Greater than 1", names_to = "Anomaly Strength", values_to = "day_total", values_drop_na = FALSE) %>% 
  mutate(day_total = if_else(is.na(day_total), 0L, day_total),
         `Anomaly Strength` = factor(`Anomaly Strength`, levels = bin_order))


# Plot the Streamplot
hw_streamplot <- ggplot(day_types, aes(yr, y = day_total, fill = `Anomaly Strength`)) +
  geom_stream(type = "proportion") +
  #geom_segment(y = .5, yend = 0.5, linetype = 3, color = "gray50", x = 1981, xend = 2021, size = 0.25) +
  scale_x_continuous(breaks = seq(1980,2030, by = 10), 
                     minor_breaks = seq(1975, 2030, by = 5), 
                     expand = c(.03,0)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0,0)) + 
  scale_fill_manual(values = setNames(bin_colors, bin_order)) + 
  labs(y = "", x = "", fill = "", 
       title = "A Warmer Gulf of Maine",
       subtitle = "Fractions of Each Year Experienced as Hot/Cold Anomalies",
       caption = "1981 & 2021 not complete years in the data*") +
  theme_minimal(base_size = 10) +
  theme(
    axis.line.x = element_line(),
    axis.ticks.x = element_line(),
    axis.line.y = element_line(),
    axis.ticks.y = element_line(),
    legend.position = "top",
    legend.key.height = unit(.5, "lines"),
    legend.key.width = unit(3.75, "lines"),
    panel.grid.minor = element_blank(),
    panel.grid = element_line(size = 0.2),
    plot.margin = unit(c(.5,1,.3,.5), "cm"),
    plot.title.position = "plot",
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 9),
    plot.caption = element_text(size = 7.2, margin = margin(t = 20)),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 7.5),
    legend.margin = margin(c(7,0,0,0)),
    legend.justification = "center") +
   guides(fill = guide_legend(title = "Anomaly Strength \u00b0C",
                             title.hjust = 0.5, 
                             title.position = "left",
                             label.position = "bottom", 
                             nrow = 1, 
                             byrow = T))


# Show figure
hw_streamplot

```



## Seasonal Anomaly Map

```{r}

# Set time limits
season_dates <- c(min(season_data$time), max(season_data$time))

# Make data window for season
data_window <- data.frame(lon = crop_x,
                          lat = crop_y,
                          time = season_dates)

# Load data
season_anoms <- oisst_window_load(data_window = data_window, anomalies = T, mac_os = "mojave")
season_anoms <- stack(season_anoms)
season_mean <- mean(season_anoms, na.rm = T)

# Map it
# Set palette limits to center it on 0 with scale_fill_distiller
max_daily  <- round(max(values(season_anoms), na.rm = T), 2)
max_season <- round(max(values(season_mean), na.rm = T), 2)
limit <- c(max_season * -1, max_season)
```

Over the course of the `r params$season` season the Gulf of Maine and surrounding areas experienced above average temperatures for much of the area, with particularly warm patches South and Southeast of Georges Banks. The peak daily temperature anomaly was `r max_daily`$^oC$, with a peak seasonal average of `r max_season`$^oC$.

```{r}
# Plot Heatwave 1 day at a time as a GIF
anoms_st <- st_as_stars(season_mean)

#### 1. Map the Anomalies in Space
season_map <- ggplot() +
  geom_stars(data = anoms_st) +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, size = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdYlBu", 
                       na.value = "transparent", 
                       limit = limit, 
                       oob = scales::oob_squish) +
  map_theme +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = T) +
  guides("fill" = guide_colorbar(
    title = expression("Seasonally Averaged Temperature Anomaly"~degree*C),
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
season_map


```

## Monthly Temperature Anomalies

Average monthly temperature anomalies are displayed below. From these we can see that warm temperature anomalies along the Southeastern edge of Georges Bank were very clear, but that the region as a whole was warmer than the climate of the recent past.

```{r month avgs, eval = TRUE, layout="l-body-outset", fig.width=6, fig.height=4}


# Load the monthly average array
monthly_avgs <- stack(str_c(oisst_path, "monthly_averages/oisst_monthly.nc"), varname = "sst_anom")

# Drop days from name
monthly_avgs <- setNames(monthly_avgs, str_sub(names(monthly_avgs), 1, -4))


# pull months
display_months <- unstack(monthly_avgs[[season_months]])
display_months <- setNames(display_months, season_months)



# Clip to the study expanded area
# Expanded area
expanded_area <- structure(c(crop_x, crop_y),  
                           class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()

# function to mask
mask_ranks <- function(ras_obj, mask_shape){
  
  # Get stats from ranks
  m1 <- raster::mask(rotate(ras_obj), mask_shape)
  m1 <- raster::crop(m1, mask_shape)
  return(m1)
}

# Perform masking
months_masked <- map(display_months, mask_ranks, expanded_area)

# Make plots for each
month_plots <- imap(months_masked, function(month_avg_layer, month_id){
  
  
  # Set up text label  
  month_yr <- str_sub(month_id, 2, 5)
  month_number <- as.numeric(str_sub(month_id, -2, -1))
  month_label <- str_c(month.name[month_number], ", ", month_yr)
  
  
  # Make stars object for plot
  month_stars <- st_as_stars(month_avg_layer)
  
  # build plot
  month_fig <- ggplot() +
    geom_stars(data = month_stars) +
    geom_sf(data = new_england, fill = "gray90", size = .25) +
    geom_sf(data = canada, fill = "gray90", size = .25) +
    geom_sf(data = greenland, fill = "gray90", size = .25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, size = 0.5,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdYlBu", 
                         #limit = c(10, 30),
                         limit = limit,
                         oob = scales::squish) +
    map_theme +
    theme(title = element_text(hjust = 0.5, size = 8),
          axis.text = element_text(size = 6)) +
    coord_sf(xlim = crop_x, 
             ylim = crop_y, 
             expand = F) +
    guides("fill" = guide_colorbar(
      title = expression("Temperature Anomaly"~degree*C),
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) +
      labs(title = str_c(month_label))
  return(month_fig)
  
  
})

# assemble plots
(month_plots[[1]] | month_plots[[2]] | month_plots[[3]]) + plot_layout(guides = "collect")  & theme(legend.position = 'bottom')

```


## Warming Rate Ranking

If we look at the rates of change for each grid cell on Earth’s surface, rather than a plot of SST over time, it is possible to rank how each location on Earth is warming relative to others. By ranking those warming rates, and then taking the average ranking across the Gulf of Maine, we can obtain the average warming rank for our area compared to the rest of the globe.

Prior GMRI research found that the Gulf of Maine had been warming at a faster rate than 99% of the world's oceans. This is still true when comparing warming rates across certain timescales, such as from 2004 to 2013 (when our initial warming study took place).

Over a longer reference period, from 1982 to 2021, the warming rate of the Gulf of Maine, as a whole is still among the highest in the world — increasing at a rate of almost 0.05 °C per year, and faster than 96.2% of the world's oceans.

However there can be significant spatial variability in this “ranked warming rate” across the Gulf of Maine. Warming rates across the region range from 0.014 °C per year to as high as 0.097 °C per year, meaning some locations over this longer time frame are still warming faster than 99.5% of the world’s oceans.

This variability reflects the various physical oceanographic drivers influencing SST in the region, and in particular the [significant interannual variability in the Gulf Stream’s influence on Georges Bank](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean).

```{r load warming rates}
# 1. Warming Rates and Rankings
oisst_path <- cs_path("res", "OISST/oisst_mainstays")
rates_path <- paste0(oisst_path, "warming_rates/annual_warming_rates")
rates_stack_all <- stack(str_c(rates_path, "1982to2020.nc"), 
                         varname = "annual_warming_rate")
ranks_stack_all <- stack(str_c(rates_path, "1982to2020.nc"), 
                         varname = "rate_percentile")


# Make a new extent for cropping to larger area
sfc <- st_sfc(st_polygon(list(
  rbind(c(crop_x[[1]], crop_y[[1]]),  
        c(crop_x[[1]], crop_y[[2]]), 
        c(crop_x[[2]], crop_y[[2]]), 
        c(crop_x[[2]], crop_y[[1]]), 
        c(crop_x[[1]], crop_y[[1]])))))
sfc <- st_as_sf(sfc)
```

```{r warming rates masking}

# Clip to the study area
mask_ranks <- function(stars_obj, mask_shape){
  
  # Get stats from ranks
  m1 <- mask(rotate(stars_obj), mask_shape)
  m1 <- crop(m1, mask_shape)
  return(m1)
}



# Get the average warming rates for each area
get_masked_vals <- function(masked_ranks, masked_rates){
  m1 <- masked_ranks
  rank_mean <- cellStats(m1, mean)
  rank_min <- cellStats(m1, min)
  rank_max <- cellStats(m1, max)
  
  # Get stats from rates
  m2 <- masked_rates
  rate_mean <- cellStats(m2, mean)
  rate_min <- cellStats(m2, min)
  rate_max <- cellStats(m2, max)
  
  # put in table
  table_out <- tibble("Mean Rank" = rank_mean,
                "Min Rank"  = rank_min,
                "Max Rank"  = rank_max,
                "Mean Rate" = rate_mean,
                "Min Rate"  = rate_min,
                "Max Rate"  = rate_max) %>% 
    mutate_all(round, 3)
  
  # spit them out
  return(table_out)
}
```


```{r mask warming rates}

# Get the rank information that go with each area
ranks_masked <- mask_ranks(ranks_stack_all, sfc)
rates_masked <- mask_ranks(rates_stack_all, sfc)
region_ranks <- get_masked_vals(ranks_masked, rates_masked)

# Prep it for text input.
avg_rank <- region_ranks$`Mean Rank` *100
avg_rate <- region_ranks$`Mean Rate`
low_rank <- region_ranks$`Min Rank` *100
low_rate <- region_ranks$`Min Rate`
top_rank <- region_ranks$`Max Rank` *100
top_rank <- ifelse(top_rank == 100, "greater than or equal to 99.5", top_rank)
top_rate <- region_ranks$`Max Rate`

```

Based on data from 1982-2020, the warming rates of Gulf of Maine have been some of the highest in the world. The area as a whole has been increasing at a rate of `r avg_rate`$^{\circ}C/year$ which is faster than `r avg_rank`% of the world's oceans.

Over that same period locations within the Gulf of Maine have been warming at rates as low as `r low_rate`$^{\circ}C/year$ and as rapidly as `r top_rate`$^{\circ}C/year$, corresponding to ranks as low as `r low_rank`% and as high as `r top_rank`%.

```{r map warming rates, eval = FALSE}
# # Make stars object
# rank_stars <- st_as_stars(ranks_masked)
# 
# # Make Contours
# ranks_contour <-  st_contour(x = rank_stars, na.rm = T, breaks = seq(0.85, 1, by = 0.02))
# 
# 
# # ranks map
# ranks_map <- ggplot() +
#   geom_stars(data = rank_stars) +
#   geom_sf(data = ranks_contour, fill = "transparent", color = "gray25", size = 0.25) +
#   geom_sf(data = new_england, fill = "gray90", size = .25) +
#   geom_sf(data = canada, fill = "gray90", size = .25) +
#   geom_sf(data = greenland, fill = "gray90", size = .25) +
#   geom_sf(data = region_extent,
#           color = "black",
#           fill = "transparent", linetype = 2, size = 0.5) +
#   scale_y_continuous(breaks = seq(-90, 90, by = 2)) +
#   scale_fill_viridis_c(limit = c(0.95, 1),  #option = "plasma",
#                        oob = scales::oob_squish, 
#                        na.value = "transparent") +
#   map_theme +
#   coord_sf(
#     xlim = crop_x,
#     ylim = crop_y,
#     expand = F) +
#   guides("fill" = guide_colorbar(
#     title = expression("Global Percentile of Warming Rates"),
#     title.position = "top", 
#     title.hjust = 0.5,
#     barwidth = unit(2.5, "in"),
#     frame.colour = "black",
#     ticks.colour = "black")) +
#   labs(caption = "Ranking color scale truncated to display ranges of 0.5-1 
#                   Contours shown for every 2% change")
# 
# # plot map
# ranks_map

```


```{r highlighting gom warming rate, eval = TRUE, layout="l-body-outset", fig.width=6, fig.height=4}
# for an expanded view need to use the global ranks
world_rank_stars <- st_as_stars(rotate(ranks_stack_all))


# ranks map
global_ranks_zoom <- ggplot() +
  geom_stars(data = world_rank_stars) +
  geom_sf(data = new_england, color = "gray80", fill = "#36454F", size = .075) +
  geom_sf(data = canada, color = "gray80", fill = "#36454F", size = .075) +
  geom_sf(data = greenland, color = "gray80", fill = "#36454F", size = .075) +
  # geom_sf(data = region_extent,
  #         color = "white",
  #         fill = "transparent", linetype = 1, size = 0.75) +
  scale_y_continuous(breaks = seq(-90, 90, by = 5)) +
  scale_x_continuous(breaks = seq(-90, 40, by = 10)) +
  scale_fill_viridis_c(limit = c(0.95, 1),  
                       option = "inferno",
                       na.value = "black") +
  map_theme +
  coord_sf(
    xlim = c("xmin" = -77, "xmax" = -50),
    ylim = c("ymin" = 32, "ymax" = 48),
    expand = T) +
  guides("fill" = guide_colorbar(
    title = expression("Global Percentile of Warming Rates"),
    title.position = "top", 
    title.hjust = 0.5,
    barwidth = unit(2.5, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 


# ranks zoomed_out
global_ranks <- ggplot() +
  geom_stars(data = world_rank_stars) +
  geom_sf(data = world, color = "gray80", fill = "#36454F", size = .1) +
  scale_fill_viridis_c(limit = c(0.95, 1),  
                       option = "inferno",
                       #oob = scales::oob_squish, 
                       na.value = "black") +
  map_theme +
  coord_sf(expand = F) +
  scale_y_continuous(breaks = seq(-90, 90, by = 30)) +
  guides("fill" = guide_colorbar(title = expression("Global Percentile of Warming Rates"),
                                 title.position = "top", 
                                 title.hjust = 0.5,
                                 barwidth = unit(2.5, "in"),
                                 frame.colour = "black",
                                 ticks.colour = "black"))  +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


# plot map
ranks_global_figure <- (global_ranks_zoom | global_ranks ) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")


ranks_global_vertical <- (global_ranks_zoom / global_ranks ) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")


# plot patchwork
ranks_global_figure

```




```{r}
# Export Figures
if(params$`Save Figures`){
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, filename = here("R/markdown_reports/seasonal_update_figs/GOM_extent_map.png"), dpi = "retina", bg = "transparent")
  
  
  # Weekly Report Table
  gtsave(data = week_summ_table, filename = here("R/markdown_reports/seasonal_update_figs/weekly_summary_table.png"))
  
  
  # Seasonal Temperature Plot
  ggsave(plot = seasonal_temp_p, filename = here("R/markdown_reports/seasonal_update_figs/Seasonal_temp_plot.png"), dpi = "retina", bg = "transparent")
  
  
  # Seasonal Anomalies Plot
  ggsave(plot = regional_anom_p, filename = here("R/markdown_reports/seasonal_update_figs/Seasonal_anom_plot.png"), dpi = "retina", bg = "transparent")
  
  # Seasonal Temp Rankings
  ggsave(plot = temp_rankings_p, filename = here("R/markdown_reports/seasonal_update_figs/Seasonal_temp_ranks_plot.png"), dpi = "retina", bg = "transparent")

  
  # Annual Temperature Trend Plot
  ggsave(plot = annual_trend_p, filename = here("R/markdown_reports/seasonal_update_figs/annual_trend_plot.png"), dpi = "retina", bg = "transparent")
  
  
  # Heatwave Temperature Plot
  ggsave(plot = hw_temp_p, filename = here("R/markdown_reports/seasonal_update_figs/Heatwave_temp_plot.png"), dpi = "retina", bg = "transparent")
  
  
  # Heatwave Anomaly Plot
  ggsave(plot = hw_anom_p, filename = here("R/markdown_reports/seasonal_update_figs/Heatwave_anom_plot.png"), dpi = "retina", bg = "transparent")
  
  
  # Heatwave Event Heatmap
  ggsave(plot = heatwave_heatmap, filename = here("R/markdown_reports/seasonal_update_figs/Heatwave_heatmap_plot.png"), dpi = "retina", bg = "transparent")
  
  
  # Heatwave Streamplot
  ggsave(plot = hw_streamplot, filename = here("R/markdown_reports/seasonal_update_figs/Heatwave_streamplot.png"), dpi = "retina", bg = "transparent")
  
  # Season Map
  ggsave(plot = season_map, filename = here("R/markdown_reports/seasonal_update_figs/Seasonal_anom_map.png"), dpi = "retina", bg = "transparent")
  
  # # Ranks Map
  # ggsave(plot = ranks_map, filename = here("R/markdown_reports/seasonal_update_figs/Warming_rates_map.png"), dpi = "retina", bg = "transparent")
  
  
  # ranks global
  ggsave(plot = ranks_global_figure, 
         filename = here("R/markdown_reports/seasonal_update_figs/Warming_ranks_global_map.png"), 
         dpi = "retina", bg = "transparent"
  )
  
  # Vertical version
  ggsave(plot = ranks_global_vertical, 
         filename = here("R/markdown_reports/seasonal_update_figs/Warming_ranks_global_vert.png"), 
         dpi = "retina", bg = "transparent"
  )
}
```



```{r saving seasonal averages}


if(params$`Save Data`){
  

# Rename so there is 0 chance of confusion
save_season_avg <- seasonal_avgs %>% 
  select(
    year = yr,
    months = season,
    temp_c = mean_temp,
    temp_f = temp_f,
    climate_avg_c = mean_clim,
    climate_avg_f = clim_f,
    temp_anom_c = mean_anom,
    temp_anom_f = anom_f) %>% 
  mutate(season = params$season, .before = "months") %>% 
  mutate(across(where(is.numeric), round,2))
 

  # # Check plots:
  # ggplot(save_season_avg, aes(year, temp_f)) +
  #   geom_point() + 
  #   geom_line(linetype = 3) +
  #   geom_smooth(method = "lm", se = FALSE, show.legend = FALSE, formula = y ~ x, linetype = 4)


# Save locally
update_name <- str_c(here("R/markdown_reports/seasonal_update_data/"),
                     "Gulf-of-Maine_SST_",
                     params$season,
                     "_Averages_GMRI_",
                     str_remove_all(Sys.Date(), "[-]"),
                     ".csv")
write_csv(save_season_avg, 
          file = update_name)
}
```

`r insert_gmri_footer()`
