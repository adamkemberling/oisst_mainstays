---
title: "Gulf of Maine Seasonal Update"
author: "Adam A. Kemberling"
date: "Updated on: `r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
editor_options: 
  chunk_output_type: console
params: 
  season: 
    label: "Select a Season to Update:" 
    value: "Summer"
    input: select
    choices: !r c("Winter", "Spring", "Summer", "Fall")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = F, 
                      warning = F, 
                      comment = "", 
                      fig.align = "center")

# Packages
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(patchwork)
library(tidyverse)

# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# # Conflict prefer
# conflicted::conflict_prefer("filter", "dplyr", quiet = T)
# conflicted::conflict_prefer("select", "dplyr", quiet = T)
# conflicted::conflict_prefer("area", "patchwork", quiet = T)

#box paths
box_paths <- research_access_paths()
oisst_path <- box_paths$oisst_mainstays


# Set ggplot theme for figures
theme_set(theme_bw())


# Set theme up for maps
map_theme <- list(
  theme(
    panel.border       = element_rect(color = "black", fill = NA),
    plot.background    = element_rect(color = "transparent", fill = "transparent"),
    line               = element_blank(),
    axis.title.x       = element_blank(), # turn off titles
    axis.title.y       = element_blank(),
    legend.position    = "bottom", 
    legend.title.align = 0.5))


# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world       <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas")

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path     <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
```


#  Gulf of Maine Seasonal Sea Surface Temperature Report

This report was created to track the seasonal patterns in sea surface temperature regimes for the Gulf of Maine as part of efforts by [the Gulf of Maine Research Institute](https://www.gmri.org). 

Satellite sea surface temperature data used was obtained from the National Center for Environmental Information (NCEI). With all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncdc.noaa.gov/oisst).

## Gulf of Maine Extent {.tabset .tabset-pills}

The spatial extent that we've used for any "regional" analyses or figures is displayed below. This bounding box is the same bounding box coordinates used to clip the OISST data when constructing the time series data from the array.



```{r}

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)

# Pull extents for the region for crop
crop_x <- st_bbox(region_extent)[c(1,3)]
crop_y <- st_bbox(region_extent)[c(2,4)]

# Full plot
ggplot() +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = gmri_cols("gmri blue"), 
          fill = gmri_cols("gmri blue"), alpha = 0.2, linetype = 2, size = 0.5) +
  map_theme +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, expand = T) 


```


##  Weekly `r params$season` Temperature Anomalies

Area-specific time series are the most basic building block for relaying temporal trends. For the Gulf of Maine (and other areas around the world!) we can generate a time series of the mean sea surface temperature within that area for each day. 

By knowing how hot or cold it was in the past we can compare how observed temperatures compare with what the expected conditions are using a climatology from a specified reference period. 

This section highlights how the surface ocean temperatures of recent weeks compare to the climatological average spanning 1982-2011.


```{r}
# Load timeseries
region_timeseries <- read_csv(timeseries_path, col_types = cols(), guess_max = 1e6)


# format dates and seasons
region_timeseries <- region_timeseries %>% 
  mutate(time = as.Date(time),
         yr = year(time),
         month_num = month(time),
         month = month(time, label = T, abbr = T),
         doy = yday(time),
         season = metR::season(month_num, lang = "en"),
         season_eng = case_when(
           season == "SON" ~ "Fall",
           season == "DJF" ~ "Winter",
           season == "MAM" ~ "Spring",
           season == "JJA" ~ "Summer")) 




# Subset data for the season, format date span for weeks
season_data <- region_timeseries %>% 
  dplyr::filter(season_eng == params$season,
                yr == year(Sys.Date())) %>% 
  mutate(week = week(time))


# Process weekly subsets
week_data <- season_data  %>% 
  group_by(week) %>% 
  summarise(
    wk_start = floor_date(time, unit = "week"),
    wk_end   = ceiling_date(time, unit = "week"),
    start_month = month(wk_start, label = T, abbr = T),
    end_month = month(wk_end, label = T, abbr = T),
    start_day = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week` = str_c(start_month, ", ", start_day, " - ", end_month, ", ", end_day),
    `Week` = factor(`Week`),
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .fun = median, .x = week))
    
    
# rejoin the temperatures to get weekly summaries
week_summaries <- season_data %>%
  select(week, area_wtd_sst, area_wtd_clim, area_wtd_anom) %>%
  left_join(week_data, by = "week") %>%
  group_by(`Week`) %>%
  summarise(
    temp_c = mean(area_wtd_sst),
    clim_c = mean(area_wtd_clim),
    anom_c = mean(area_wtd_anom),
    .groups = "drop") %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), signif, 3)) %>% 
  mutate(
    temp_both = str_c(temp_f, "\u00b0 (", temp_f,"\u00b0)"),
    clim_both = str_c(clim_f, "\u00b0 (", clim_f,"\u00b0)"),
    anom_both = str_c(anom_f, "\u00b0 (", anom_f,"\u00b0)"))



# Display Table for the weeks in this season
week_summaries  %>% 
  select(
    Week,
    temp_f,
    temp_c,
    clim_f,
    clim_c,
    anom_f,
    anom_c) %>%
   gt(rowname_col = "Week") %>% 
   # gt() %>% 
    tab_header(
    title = md(paste0("**Weekly Sea Surface Temperatures - ", params$season, "**")), 
    subtitle = paste("Meteorological Summer (Jun-Aug)")) %>%
    tab_stubhead(label = md("*One-Week Period*")) %>% 
    tab_spanner(label = md("*Observed SST*"), 
                columns = vars(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climate Average*"), 
                columns = vars(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = vars(`anom_f`, `anom_c`)) %>% 
    cols_label(
      # Week = md("**7-Day Period**"),
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C") %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatology Reference Period: 1982-2011.*"))


 ```



## `r params$season` Temperature Record


```{r}
# Get Seasonal Averages
seasonal_avgs <- region_timeseries %>% 
  filter(season_eng == params$season,
         yr %in% c(1982:2020)) %>% 
  group_by(yr, season) %>% 
  summarise(
    mean_temp = mean(area_wtd_sst),
    mean_clim = mean(area_wtd_clim),
    mean_anom = mean(area_wtd_anom),
    temp_f = as_fahrenheit(mean_temp),
    clim_f = as_fahrenheit(mean_clim),
    anom_f = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") 
  
# Decadal Rate
yr_mod <- lm(mean_temp ~ yr, seasonal_avgs)
annual_rate <- coef(yr_mod)[[2]]
decadal_rate <- round((annual_rate*10), 2)

# Last Decade
tenyr_mod <- lm(mean_temp ~ yr, filter(seasonal_avgs, yr %in% c(2010:2020)))
tenyr_rate <- coef(tenyr_mod)[[2]]
tenyr_decadal <- round((tenyr_rate*10), 2)


# Figure
ggplot(seasonal_avgs, aes(yr, mean_temp)) +
  geom_line(color = "gray20", linetype = 3) +
  geom_point(color = "gray20") +
  geom_smooth(formula = y~x, method = "lm", color = gmri_cols("orange"), se = FALSE) +
  geom_smooth(data = filter(seasonal_avgs, yr %in% c(2010:2020)),
              aes(yr, mean_temp), linetype = 2,
              formula = y~x, method = "lm", color = gmri_cols("gmri blue"), se = FALSE) +
  labs(x = "Year",
       y = expression("Sea Surface Temperature"~~degree*C),
       subtitle = str_c("Average ", params$season, " Sea Surface Temperature"))

```

Over the period of 1982-2020 the Gulf of Maine has warmed at a rate of `r decadal_rate`$\frac{^oC}{Decade}$, and more recently at a rate of `r tenyr_decadal`$\frac{^oC}{Decade}$ for the last decade (since 2010). While the rate of summer warming has slowed, the average temperature over the three-month period has not fallen below $15^oC$ since 2007. Prior to 2007 this had only occurred seven times in 25 years (1982-2007).


## `r params$season` Temperature Anomaly Record


When looking at the temperature anomalies (departure from normal climate), we see the same pattern of rapid increase followed by a leveling off at temperatures $1-2~^oC$ above what they were previously.

```{r}
# Figure
ggplot(seasonal_avgs, aes(yr, mean_anom)) +
  geom_line(color = "gray20", linetype = 3) +
  geom_point(color = "gray20") +
  geom_smooth(formula = y~x, method = "lm", color = gmri_cols("orange"), se = FALSE) +
  geom_smooth(data = filter(seasonal_avgs, yr %in% c(2010:2020)),
              aes(yr, mean_anom), linetype = 2,
              formula = y~x, method = "lm", color = gmri_cols("gmri blue"), se = FALSE) +
  labs(x = "Year",
       y = expression("Sea Surface Temperature Anomaly"~~degree*C),
       subtitle = str_c("Average ", params$season, " Sea Surface Temperature Anomaly"))
```


## Annual Trend

If we look at the pattern for year-round temperature we can see that the Gulf of Maine has been warming at a rate higher than the global average of $0.15~^oC$ per decade. We can also see that that pause in summer temperature increase is less pronounced, an indication that other seasons are continuing to warm.

```{r yearly summaries}
# Summarize by year to return mean annual anomalies and variance
annual_summary <- region_timeseries %>% 
  mutate(year = year(time)) %>% 
  group_by(year) %>% 
  summarise(sst = mean(sst, na.rm = T),
            sst_anom = mean(sst_anom, na.rm = T), 
            area_wtd_sst = mean(area_wtd_sst),
            area_wtd_anom = mean(area_wtd_anom),
            .groups = "keep") %>% 
  ungroup() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")))


# # Global Temperature Anomaly Rates
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time))

global_summary <- global_anoms %>% 
  group_by(year) %>% 
  summarise(sst = mean(sst, na.rm = T), 
            sst_anom = mean(sst_anom),
            area_wtd_sst = mean(area_wtd_sst),
            area_wtd_anom = mean(area_wtd_anom),
            .groups = "keep") %>% 
  ungroup() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")))
```



```{r annual regressions}

# Build Regression Equation Labels

# 1. All years 
lm_all <- lm(area_wtd_sst ~ year, data = filter(annual_summary, year %in% c(1982:2020))) %>% 
  coef() %>% 
  round(3)

# 2. Last 15 years
lm_15  <- lm(area_wtd_sst ~ year, data = filter(annual_summary, year %in% c(2006:2020))) %>% 
  coef() %>% 
  round(3)

# 3. Global - Area-weighted
lm_global <- lm(area_wtd_sst ~ year, data = filter(global_summary, year %in% c(1982:2020))) %>% 
  coef() %>% 
  round(3)


# Convert yearly rate to decadal
decade_all    <- lm_all['year'] * 10
decade_15     <- lm_15['year'] * 10
decade_global <- lm_global["year"] * 10


# Equation to paste in
eq_all    <- paste0(decade_all,    "\u00b0", "C / Decade")
eq_15     <- paste0(decade_15,     "\u00b0", "C / Decade")
eq_global <- paste0(decade_global, "\u00b0", "C / Decade")

```





```{r annual trend plot}
####  Annual Trend Plot  ####
ggplot(data = annual_summary, aes(yr_as_dtime, area_wtd_anom)) +
  
  # Add daily data
  geom_line(data = region_timeseries,
            aes(time, area_wtd_anom),
            alpha = 0.5, color = "gray") +
  
  # Overlay yearly means
  geom_line(alpha = 0.7, color = "gray20") +
  geom_point(alpha = 0.7, size = 0.75) +
  
  # Add regression lines 
  geom_smooth(data = filter(global_summary, year <= 2020),
              method = "lm", 
              aes(color = "1982-2020 Global Trend"),
              formula = y ~ x, se = F, 
              linetype = 3) +
  geom_smooth(data = filter(annual_summary, year <= 2020),
              method = "lm",
              aes(color = "1982-2020 Regional Trend"),
              formula = y ~ x, se = F,
              linetype = 1) +
  geom_smooth(data = filter(annual_summary, year %in% c(2006:2020)),
              method = "lm", 
              aes(color = "2006-2020 Regional Trend"),
              formula = y ~ x, se = F, 
              linetype = 2) +

  
  # Manually add equations so they show yearly not daily coeff
  geom_text(data = data.frame(), 
            aes(label = eq_all, x = min(region_timeseries$time), y = Inf),
            hjust = 0, vjust = 2, color = gmri_cols("gmri blue")) +
  geom_text(data = data.frame(), 
            aes(label = eq_15, x = min(region_timeseries$time), y = Inf),
            hjust = 0, vjust = 3.5, color = gmri_cols("orange")) +
  geom_text(data = data.frame(), 
            aes(label = eq_global, x = min(region_timeseries$time), y = Inf),
            hjust = 0, vjust = 5, color = gmri_cols("green")) +

  # Colors
  scale_color_manual(values = c(
    "1982-2020 Regional Trend" = as.character(gmri_cols("gmri blue")),
    "2006-2020 Regional Trend" = as.character(gmri_cols("orange")),
    "1982-2020 Global Trend"   = as.character(gmri_cols("green")))) +
  
  # labels + theme
  labs(x = "", 
       y = expression("Sea Surface Temperature Anomaly"~degree*C),
       caption = paste0("Anomalies calculated using 1982-2011 reference period.")) +
  # theme
   theme(legend.title = element_blank(),
        legend.position = c(0.85, 0.1),
        legend.background = element_rect(fill = "transparent"),
        legend.key = element_rect(fill = "transparent", color = "transparent"),
        panel.grid = element_blank())


```


## Marine Heatwaves

A marine heatwave is defined as a situation when seawater temperatures exceeds a seasonally-varying threshold (usually the 90th percentile) for at least 5 consecutive days. Successive heatwaves with gaps of 2 days or less are considered part of the same event. The heatwave threshold used below was 90%. Note, the climate reference period is 1982-2011, so the second figure really illustrates just how anomalously warm the most recent decade has been in a climatological context.

```{r}
# Use function to process heatwave data for plotting
region_heatwaves <- pull_heatwave_events(region_timeseries, threshold = 90) 

# Grab data from the most recent year through present day to plot
last_year <- Sys.Date() - 365
#last_year <- last_year - yday(last_year) + 1
last_yr_heatwaves <- region_heatwaves %>% 
  filter(time >= last_year)


# Get number of heatwave events and total heatwave days for last year
# How many heatwave events:
last_full_yr <- last_yr_heatwaves %>% filter(year(time) == year(last_year))
num_events   <- max(last_full_yr$mhw_event_no, na.rm = T) - min(last_full_yr$mhw_event_no, na.rm = T)

# How many heatwave days
num_hw_days <- sum(last_full_yr$mhw_event, na.rm = T)

```


Over the course of 2021 the Gulf of Maine has been in heatwave conditions for much of the year. Beginning with a marine heatwave event in January that persisted through until march. Another brief event happened mid-march, before a third event which ended in the end of April. The longest heatwave of the year began at the very end of April, lasting until the end of July, peaking at nearly $4^oC$ above what we would have considered "normal" for that time of year. Now back in August we again are in heatwave conditions in the $2-3~^oC$ range for temperature anomalies.


```{r}


# Set colors by name
color_vals <- c(
  "Sea Surface Temperature" = "royalblue",
  "Heatwave Event"          = "darkred",
  "MHW Threshold"           = "coral3",
  "Daily Climatology"       = "gray30")


# Set the label with degree symbol
ylab <- expression("Sea Surface Temperature"~degree*C)



# Plot the last 365 days
ggplot(last_yr_heatwaves, aes(x = time)) +
    geom_segment(aes(x = time, xend = time, y = seas, yend = sst), 
                 color = "royalblue", alpha = 0.25) +
    geom_segment(aes(x = time, xend = time, y = mhw_thresh, yend = hwe), 
                 color = "darkred", alpha = 0.25) +
    geom_line(aes(y = sst, color = "Sea Surface Temperature")) +
    geom_line(aes(y = hwe, color = "Heatwave Event")) +
    geom_line(aes(y = mhw_thresh, color = "MHW Threshold"), lty = 3, size = .5) +
    geom_line(aes(y = seas, color = "Daily Climatology"), lty = 2, size = .5) +
    scale_color_manual(values = color_vals) +
    scale_x_date(date_labels = "%b", date_breaks = "1 month") +
    guides(color = guide_legend(nrow = 2)) +
    theme(legend.title = element_blank(),
          legend.position = "bottom") +
    labs(x = "", 
         y = ylab, 
         subtitle = "Current Year Heatwave Tracking",
         caption = paste0("Climate reference period :  1982-2011"))
```

Changing the axis to anomalies rather than temperature the magnitude of the anomalies become more clear.


```{r}

color_vals <- c(
  "Sea Surface Temperature Anomaly" = "royalblue",
  "Heatwave Event"          = "darkred",
  "MHW Threshold"           = "coral3",
  "Daily Climatology"        = "gray30")


# Plot the last 365 days - anomaly scale
ggplot(last_yr_heatwaves, aes(x = time)) +
    geom_segment(aes(x = time, xend = time, 
                     y = 0, yend = sst_anom), 
                 color = "royalblue", alpha = 0.25) +
    geom_segment(aes(x = time, xend = time, 
                     y = mhw_thresh - seas, yend = hwe - seas), 
                 color = "darkred", alpha = 0.25) +
    geom_line(aes(y = sst_anom, color = "Sea Surface Temperature Anomaly")) +
    geom_line(aes(y = hwe - seas, color = "Heatwave Event")) +
    geom_line(aes(y = mhw_thresh - seas, color = "MHW Threshold"), lty = 3, size = .5) +
    geom_line(aes(y = 0, color = "Daily Climatology"), lty = 2, size = .5) +
    scale_color_manual(values = color_vals) +
    scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  guides(color = guide_legend(nrow = 2)) +
    theme(legend.title = element_blank(),
          legend.position = "bottom") +
    labs(x = "", 
         y = expression("Sea Surface Temperature Anomaly"~~degree*C), 
         subtitle = "Current Year Heatwave Tracking",
         caption = paste0("Climate reference period :  1982-2011"))
```

## Marine Heatwave Record


 

```{r}

# Prep the legend title
guide_lab <- expression("Sea Surface Temperature Anomaly"~degree*C)

# Set new axis dimensions, y = year, x = day within year
# use a flate_date so that they don't stair step
base_date <- as.Date("2000-01-01")
grid_data <- region_heatwaves %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date))


# Set palette limits to center it on 0 with scale_fill_distiller
limit <- max(abs(grid_data$sst_anom)) *c(-1,1)


# Assemble heatmap plot
heatwave_heatmap <- ggplot(grid_data, aes(x = flat_date, y = year)) +
  
  # background box fill for missing dates
  geom_rect(xmin = base_date, xmax = base_date + 365, 
            ymin = min(grid_data$year) - .5, ymax = max(grid_data$year) + .5, 
            fill = "gray75", color = "transparent") +
  
  # tile for sst colors
  geom_tile(aes(fill = sst_anom)) +
  
  # points for heatwave events
  geom_point(data = filter(grid_data, mhw_event == TRUE),
             aes(x = flat_date, y = year), size = .25)  +
  scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = c(0,0)) +
  scale_y_continuous(limits = c(1980.5, 2021.5), expand = c(0,0), breaks = seq(1980, 2020, by = 5)) +
  labs(x = "Date Within the Year", 
       y = "Year",
       "\nClimate reference period : 1982-2011") +
  
  #scale_fill_gradient2(low = "blue", mid = "white", high = "red") +
  scale_fill_distiller(palette = "RdYlBu", 
                       na.value = "transparent", 
                       limit = limit) +
  
  #5 inches is default rmarkdown height for barheight
  guides("fill" = guide_colorbar(title = guide_lab, 
                                 title.position = "right", 
                                 title.hjust = 0.5,
                                 barheight = unit(4, "inches"), 
                                 frame.colour = "black", 
                                 ticks.colour = "black")) +  
  theme(legend.position = "right",
        panel.border = element_rect(color = "black", fill = NA),
        legend.title = element_text(angle = 90))





# Assemble pieces
heatwave_heatmap
```


## Warming Rate Ranking

If we look at the rates of change for each grid cell, rather than the observed temperature, its possible to rank how hot each location on earth is warming relative to others.

If we take the average ranking within the Gulf of Maine we can obtain the average warming rank for the area compared to the rest of the globe.

```{r load warming rates}
# 1. Warming Rates and Rankings
rates_path <- paste0(oisst_path, "warming_rates/annual_warming_rates")
rates_stack_all <- stack(str_c(rates_path, "1982to2020.nc"), 
                         varname = "annual_warming_rate")
ranks_stack_all <- stack(str_c(rates_path, "1982to2020.nc"), 
                         varname = "rate_percentile")


# Expand the area out to see the larger patterns
crop_x <- crop_x + c(-2.5, 2.5)
crop_y <- crop_y + c(-1.5, 1)

# Make a new extent for cropping
sfc <- st_sfc(st_polygon(list(
  rbind(c(crop_x[[1]], crop_y[[1]]),  
        c(crop_x[[1]], crop_y[[2]]), 
        c(crop_x[[2]], crop_y[[2]]), 
        c(crop_x[[2]], crop_y[[1]]), 
        c(crop_x[[1]], crop_y[[1]])))))
sfc <- st_as_sf(sfc)
```



```{r warming rates}

# Clip to the study area
mask_ranks <- function(stars_obj, mask_shape){
  
  # Get stats from ranks
  m1 <- mask(rotate(stars_obj), mask_shape)
  m1 <- crop(m1, mask_shape)
  return(m1)
}



# Get the average warming rates for each area
get_masked_vals <- function(masked_ranks, masked_rates){
  m1 <- masked_ranks
  rank_mean <- cellStats(m1, mean)
  rank_min <- cellStats(m1, min)
  rank_max <- cellStats(m1, max)
  
  # Get stats from rates
  m2 <- masked_rates
  rate_mean <- cellStats(m2, mean)
  rate_min <- cellStats(m2, min)
  rate_max <- cellStats(m2, max)
  
  # put in table
  table_out <- tibble("Mean Rank" = rank_mean,
                "Min Rank"  = rank_min,
                "Max Rank"  = rank_max,
                "Mean Rate" = rate_mean,
                "Min Rate"  = rate_min,
                "Max Rate"  = rate_max) %>% 
    mutate_all(round, 3)
  
  # spit them out
  return(table_out)
}
```




```{r mask warming rates}

# Get the rank information that go with each area
ranks_masked <- mask_ranks(ranks_stack_all, sfc)
rates_masked <- mask_ranks(rates_stack_all, sfc)
region_ranks <- get_masked_vals(ranks_masked, rates_masked)

# Prep it for text input.
avg_rank <- region_ranks$`Mean Rank` *100
avg_rate <- region_ranks$`Mean Rate`
low_rank <- region_ranks$`Min Rank` *100
low_rate <- region_ranks$`Min Rate`
top_rank <- region_ranks$`Max Rank` *100
top_rank <- ifelse(top_rank == 100, "greater than or equal to 99.5", top_rank)
top_rate <- region_ranks$`Max Rate`

```

Based on data from 1982-2020, the warming rates of Gulf of Maine have been some of the highest in the world. The area as a whole has been increasing at a rate of `r avg_rate`$^{\circ}C/year$ which is faster than `r avg_rank`% of the world's oceans. 

Over that same period locations within the Gulf of Maine have been warming at rates as low as `r low_rate`$^{\circ}C/year$ and as rapidly as `r top_rate`$^{\circ}C/year$, corresponding to ranks as low as `r low_rank`% and as high as `r top_rank`%.


```{r map warming rates}
# Make stars object
rank_stars <- st_as_stars(ranks_masked)

# Make Contours
ranks_contour <-  st_contour(x = rank_stars, na.rm = T, breaks = seq(0.85, 1, by = 0.02))


# ranks map
ranks_map <- ggplot() +
  geom_stars(data = rank_stars) +
  geom_sf(data = ranks_contour, fill = "transparent", color = "gray25", size = 0.25) +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          fill = "transparent", linetype = 2, size = 0.5) +
  scale_fill_viridis_c(limit = c(0.5, 1), 
                       oob = scales::oob_squish, 
                       na.value = "transparent") +
  map_theme +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = F) +
  guides("fill" = guide_colorbar(
    title = expression("Global Percentile of Warming Rates"),
    title.position = "top", 
    title.hjust = 0.5,
    barwidth = unit(2.5, "in"),
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(caption = "Ranking color scale truncated to display ranges of 0.5-1 
                  Lower values will display as 0.5 or 50%
                  Contours shown for every 2% change")

# plot map
ranks_map

```
