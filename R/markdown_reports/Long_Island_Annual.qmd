---
title: "Long Island Nice Tea"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  A Top-Five Hottest Year Despite Relief from Major Storm Systems 
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
execute: 
  echo: false
  warning: false
  message: false
  comment: ""
  fig.align: center
params: 
  report_year: 2023
  in_celsius: FALSE
---

```{r}
#| label: code-setup
#| include: false

####  Packages  ####
{
  library(ggpubr)
  library(lubridate)
  library(raster)
  library(here)
  library(rnaturalearth)
  library(rgeoboundaries)
  library(scales)
  library(sf)
  library(stars)
  library(gmRi)
  library(heatwaveR)
  library(gt)
  library(gtExtras)
  library(patchwork)
  library(tidyverse)
  library(ggthemes)
  library(ggstream)
  library(ggforce)
  library(geomtextpath)
  library(ggHoriPlot)
  library(sysfonts)
  library(gtable)
  
}

#---------- Support Functions
suppressPackageStartupMessages( source(here("R/oisst_support_funs.R"), verbose = FALSE) )
suppressPackageStartupMessages( source(here("R/temp_report_support.R"), verbose = FALSE) )


#----------- Paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# File paths for various products for long island sound shapefile
region_paths <- get_timeseries_paths(
  region_group = "gmri_sst_focal_areas", 
  box_location = "cloudstorage")



#----------- Parameters

# Set the year for the report:
report_yr <- params$report_year

# Pick the region of interest
shape_name <- "long_island_sound"


#----------- Components

# Timeseries Path
timeseries_path <- region_paths[[shape_name]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[[shape_name]][["shape_path"]]
region_extent <- read_sf(poly_path)

# Pull extents for the region for cropping
crop_x <- st_bbox(region_extent)[c(1,3)]
crop_y <- st_bbox(region_extent)[c(2,4)]

# Expand the area out to see the larger patterns, Used as plot limits
crop_x_expanded <- crop_x + c(-2.25, 2.25)
crop_y_expanded <- crop_y + c(-0.75, 0.75)

# Make a new extent for cropping to larger area
sfc <- make_cropbox(xlims = crop_x_expanded, ylims = crop_y_expanded)

# Projection to use for everything
master_crs <- st_crs("EPSG:4326")

# Coastline Shapes
canada      <- ne_states("canada", returnclass = "sf") %>% st_transform(master_crs)
new_england <- ne_states("united states of america", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")  %>% st_transform(master_crs)
greenland   <- ne_states(country = "greenland", returnclass = "sf") %>% st_transform(master_crs)

# Adding Logo to plots
logo_path <- paste0(system.file("stylesheets", package = "gmRi"), "/gmri_logo.png")
lab_logo <- magick::image_read(logo_path)

# Bathymetric Contour Data
bathy <- raster(str_c(cs_path("res","Bathy/"), "ETOPO1/NEShelf_Etopo1_bathy.tiff")) 

# Make a terra copyfor ggplot using tidyterra
elev_terra <- terra::rast(bathy)


# Map Tags
area_labs<- tribble(
  ~"label",              ~"lat", ~"lon", ~"angle", ~"color",
  "Georges\nBank",       41.15,  -67.75, 0,        "black",        
  "Jordan\nBasin",       43.5,   -67.5,  0,        "black", 
  "Wilkinson\nBasin",    42.29,  -69.2,  0,        "black", 
  "Northeast\nChannel",  42.385, -66.2,  0,        "black", 
  "Scotian\nShelf",      43.675, -63.2,  0,        "black", 
  "Mid-Atlantic\nBight", 40,     -72.6,  0,        "black", 
  "Laurentian Channel",  46.3,   -58.2,  310,      "black" )
```


```{r}
#| label: style-config
#| results: asis

# Use GMRI style
use_gmri_style_rmd()

```


```{r}
#| label: fonts-config
#| echo: false

# Using Raleway Font because it works

# Path to the directory containing the font file (replace with your actual path)
font_dir <- paste0(system.file("stylesheets", package = "gmRi"), "/GMRI_fonts/Avenir/")

# Register the font
font_add(
  family = "Avenir",
  file.path(font_dir, "LTe50342.ttf"),
  bold = file.path(font_dir, "LTe50340.ttf"),
  italic = file.path(font_dir, "LTe50343.ttf"),
  bolditalic = file.path(font_dir, "LTe50347.ttf"))


# Why is the gt package able to add it wtf!!
# google_font(name = "Avenir")

# Load the font
showtext::showtext_auto()

```



## The Importance of the Long Island Sound Region



For analyses like these that characterize environmental conditions for a particular area—in this case, the Long Island Sound—it is important to be clear about the spatial extent that defines the region of study; different domain boundaries could produce different results. The spatial area we use to define the “Long Island Sound” is displayed in @fig-map, and has remained consistent throughout our seasonal and annual warming updates. 



```{r}
#| label: fig-map
#| fig.width: 8
#| fig.height: 8
#| fig.cap: "Spatial domain used for Long Island Sound SST analyses. Dotted line denotes region of study for this analysis.  Depth contours are colored at 100m intervals to a maximum of 600m, deeper blues indicate deeper water depths."
#| fig.alt: "An overhead view of the Long Island Sound region. Landmasses and political boundaries for the United States and Canada are displayed. A blue dotted line outlining a box with a transparent blue fill is shown to demark where satellite data for the analysis has been used."
#| 

# Load the shapefile
region_extent <- st_read(poly_path, quiet = TRUE)



# Map the Long Island Sound with Bathymetry
long_island_extent_p <- map_study_area_color(
  region_extent  = region_extent,
  new_england_sf = new_england,
  canada_sf      = canada,
  greenland_sf   = greenland) +
  labs(title     = "Long Island Sound Study Area") +
  geom_sf(data = region_extent, color = "orange", linewidth = 1, fill = "transparent") +
  coord_sf(xlim = crop_x_expanded, ylim = crop_y_expanded)


# Show figure
long_island_extent_p
```




```{r}
#| label: load-timeseries-data



#---------  Long Island Sound Timeseries  --------#

# Load the timeseries
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6)


# Clean up the data - add labels
region_timeseries <- region_timeseries %>% 
  mutate(time = as.Date(time)) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:report_yr))



# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries, 
  threshold = 90, 
  clim_ref_period = c("1991-01-01", "2020-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Summarize by year to return mean annual anomalies and variance
annual_summary <- region_hw %>% 
  group_by(year = yr) %>% 
  temperature_summaries_hw() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(sst_anom > 0, "Hot", "Cold"))



# Data for the Report Year Only
report_yr_only <- region_hw %>% 
  filter(year(time) == report_yr)

# Set up the date within a year for Heatmap
base_date <- as.Date("2000-01-01")
region_hw <- region_hw %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev),
         hw_thresh_f = as_fahrenheit(mhw_thresh-seas, data_type = "anomalies"),
         cs_thresh_f = as_fahrenheit(mcs_thresh-seas, data_type = "anomalies"))


#---------  Global Oceans Timeseries  --------#

# # Global Temperature Anomalies
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time)) %>% 
  filter(between(year, 1982, report_yr)) %>% 
  supplement_season_info()

# summarize by year again
global_summary <- global_anoms %>% 
  group_by(year) %>% 
  temperature_summaries() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(sst_anom > 0, "Hot", "Cold"))
```



```{r}
#| label: code-all-year-temp-summary

# Get the overall average and build labels
all_year_avgs <- annual_summary %>% 
  summarise(
    avg_temp_c = mean(sst),
    avg_temp_f = mean(sst_f),
    avg_anom_c = mean(sst_anom),
    avg_anom_f = mean(anom_f),            
    .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))



#------- Report Year Text -----------------
# Values I need up front for text

# average annual sst, its anomaly value:
report_annual_temp <- round(mean(report_yr_only$sst_f, na.rm = T), 2)
report_annual_anom <- round(mean(report_yr_only$anom_f, na.rm = T), 2)

# What rank this year was
report_rank <- filter(annual_summary, year == report_yr) %>% pull(sst_rank)
global_report_rank <- filter(global_summary, year == report_yr) %>% pull(sst_rank)

# Record holder year's temperature
record_year_temp <- filter(annual_summary, sst_rank == 1) %>% pull(sst_f)

# Note on how the seasons ranked:
month_ranks <- region_timeseries %>% 
  supplement_season_info() %>% 
  split(.$month) %>% 
  map_dfr(~ .x %>% 
    group_by(year, month) %>% 
    temperature_summaries()) %>% 
    filter(year == report_yr)


# How many days in this year meet mhw criteria
# add some acknowledgement of the extreme characteristics:
hw_criteria <- report_yr_only %>% pull(mhw_event) %>% sum()
```




## Highlights from Another Remarkably Warm Year


Over the past decade, scientists at the Gulf of Maine Research Institute have led a body of research that highlights the rapid pace of warming in the Long Island Sound. To keep you informed, we share seasonal and annual updates about conditions in the Long Island Sound.



 * With an annual average sea surface temperature (SST) of `r report_annual_temp`°F — more than `r report_annual_anom`°F above normal — the Long Island Sound experienced its `r report_rank`th warmest year on record in `r report_yr`. This year fell short of the previous warmest year on record — 2021 — `r round(record_year_temp-report_annual_temp, 2)`°F, but was record-breaking in a number of regards. 

 * The first four months this year average monthly SST was within the top 3 warmest among all years on record. With February, March, and April all the warmest on record. 
 
 * The most extreme temperatures in 2023 occurred in February and March, each setting new records for highest monthly average SST in the Long Island Sound.

 * The “coolest” monthly average temperature anomalies for 2023 occurred during September, November, and December. Each of last five months this year had SSTs below the top ten warmest.
 
 * SSTs in 2023 were consistent with the long-term trend of increasingly warm conditions driven primarily by anthropogenic climate change. 



## 2023 Sea Surface Temperature in the Long Island Sound


```{r}
#| label: fig-gom-record-temps

#----- Plot how unusual this year was:
region_hw <- region_hw %>% 
  mutate(
    is_23 = ifelse(yr == 2023, TRUE, FALSE),
    yr_col   = ifelse(is_23, gmri_cols("orange"), "gray90"),
    yr_lw    = ifelse(is_23, 1.5, 0.8),
    yr_alpha = ifelse(is_23, 1, 0.5),
    flat_date = as.Date("2000-01-01") + doy-1,
         
  )


# Flag when temperatures were records
hottest_days <- region_hw %>% 
  group_by(doy) %>% 
  slice_max(order_by = sst_anom, n = 1) %>% 
  ungroup() 

# Get some visual controls for when they are records

# Pull some of the hottest years
long_island_23 <- filter(region_hw, yr == 2023)  %>% mutate(
  record_temp_alpha = ifelse(time %in% hottest_days$time, 1, 0.4),
  record_temp_lw = ifelse(time %in% hottest_days$time, 1.2, 0.7))
long_island_22 <- filter(region_hw, yr == 2022)  %>% mutate(
  record_temp_alpha = ifelse(time %in% hottest_days$time, 1, 0.4),
  record_temp_lw = ifelse(time %in% hottest_days$time, 1.2, 0.7))
long_island_21 <- filter(region_hw, yr == 2021)  %>% mutate(
  record_temp_alpha = ifelse(time %in% hottest_days$time, 1, 0.4),
  record_temp_lw = ifelse(time %in% hottest_days$time, 1.2, 0.7))


# Make a similar plotfor the  Long Island Sound
long_island_23 %>% 
  ggplot(aes(flat_date, anom_f)) +
  geom_ribbon(
    aes(ymin = cs_thresh_f, ymax = hw_thresh_f), 
    fill = "lightgray", alpha = 0.4) +
  geom_texthline(yintercept = 0, label = "1991-2020 Climatological Average &\n10th - 90th Percentile Range", linewidth = 1, size = 5, family = "Avenir") +
  geom_line(aes(group = yr, linewidth = I(record_temp_lw), alpha = I(record_temp_alpha), 
                color = I(yr_col))) +
  geom_text(
    data = long_island_23 %>% slice(yday(min(long_island_23$time))+50),
    label = "2023", vjust = -3, size = 5,
    fontface = "bold", color = gmri_cols("orange"), family = "Avenir") +
  scale_x_date(date_breaks = "1 month", labels = date_format("%b"), 
               expand = expansion(add = c(0,0))) +
  # Tropical Storm Callout
  annotate(
    'text',
    x = as.Date("2000-01-01") +310, # Play around with the coordinates until you're satisfied
    y = 6.3,
    label = "Passage of\nExtratropical Storm\nLee",
    family = "Avenir") +
  annotate(
    'curve',
    x = as.Date("2000-01-01") +310, # Play around with the coordinates until you're satisfied
    y = 5,
    yend = 2.3,
    xend = as.Date("2000-01-01") + 264,
    linewidth = 0.8,
    curvature = -0.5,
    arrow = arrow(length = unit(0.5, 'cm'))) +
  scale_y_continuous(labels = number_format(suffix = deg_f),
                     expand = expansion(mult = c(0.2, 0.2))) +
  labs(x = "Day of Year", y = "Sea Surface Temperature Anomaly",
       title = "Record Warm SST for 22 Days of 2023 in Long Island Sound",
       subtitle = "(40-45.125N, 65.375-70.875W)")  +
  coord_cartesian(clip = "off") +
  
  theme(text = element_text(family = "Avenir")) +
  geom_logo(x_npc = 0.875, y_npc = -.125, logo_height = 1, height_units = "cm")


```



## Comparing Annual SST to Historical Conditions

When we compare the annual average SST in the Long Island Sound for `r report_yr` (`r str_c(report_annual_temp, deg_f)`) to other years, we can see it narrowly beat out 2012 as the second warmest year on record. When we look at the deviation from the long-term average SST (i.e., the annual SST anomaly), the last decade stands out for its exceptional warmth (@fig-yr-ranks). `r report_yr` extends a pattern that began in 2010 of sustained above-average temperatures. With the exception of 2019 (ranked 13th), every one of the last ten years remains in the top 10 warmest years on record.



### Annual Ranks


```{r}
#| label: fig-yr-ranks
#| fig-cap: "A ranking of the top 10 annual SST values [bars] and those years' respective SST anomalies [x-axis]."


# Do some data prep
rank_plot_data <- annual_summary %>% 
  filter(sst_rank <= 10) %>% 
  mutate(
    year_rank = fct_reorder(factor(year), sst_rank, .desc = T),
    rank = fct_rev(factor(sst_rank)),
    flag_col = ifelse(year == 2023, gmri_cols("orange"), gmri_cols("blue")),
    temp_label    = str_c(round(sst_f, 2), " \u00b0F  |  ", round(sst, 2), " \u00b0C"),
    anom_label    = str_c(round(anom_f, 2), " \u00b0F  |  ", round(sst_anom, 2), " \u00b0C")) 


# Plot them
temp_rankings_p <- rank_plot_data %>% 
  ggplot() +
  geom_col(aes(x = anom_f, y = rank, fill = I(flag_col)))+
  # Year Labels
  geom_text(
    mapping = aes(
      x = 0, 
      y = rank, 
      label = str_c( year_rank)), # No numbering WINTER Control
      #label = str_c(rank, ".  ", year_rank)), # WINTER Control
    fontface = "bold",
    family = "Avenir",
    hjust = -.05,
    color = 'white',
    size = 5) +
 # Temperature Labels - Outside Bars
  geom_text(
    mapping = aes(
      x = anom_f, y = rank, 
      label = temp_label, group = rank, color = I(flag_col)),
    family = "Avenir",
    hjust = -.05, size = 4, show.legend = F) +
  scale_x_continuous(
    labels = number_format(suffix = " \u00b0F"), 
    expand = expansion(mult = c(0,0.25))) +
  labs(
    x = "Average Annual SST Anomaly",
    y = "Rank",
    caption = "",
    title = str_c("Long Island Sound Warmest Sea Surface Temperatures")) +
  theme(
    plot.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    axis.line.x = element_blank(),
    legend.position = "none", 
    plot.margin = margin(t = 20, l = 10, r = 5, b = 5)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.88, y_npc = -.13, logo_height = 1, height_units = "cm")


temp_rankings_p





```


###  Monthly Rankings

```{r}
#| label: tbl-monthly-avgs

# Would be cool to do a big table here of all months
# use formattable or whatever the package is.
# want a button style number indicating rank relative to past months
# want a sparkline indicating anomaly strength
# Indicat e % record temps or % HW

monthly_avgs <- region_hw %>% 
  filter(yr == 2023) %>% 
  group_by(yr, month) %>% 
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies"),
    anom_list = list(anom_f), # list column for sparkline anomalies
    .groups = "drop") %>% 
  mutate(across(c(temp_c:anom_f), \(x) signif(x, digits = 3))) 

# Grab info on peak temps
peak_month <- monthly_avgs %>% slice_max(order_by = anom_f, n = 1)
peak_month_full <- month.name[which(month.abb == peak_month$month)]


# Do some benchmarking, where do they all rank by anomalies
month_rankings <- region_hw %>% 
  group_by(yr = year(time), month) %>% 
  summarise(mean_anom = mean(sst_anom), .groups = "drop") %>% 
  group_by(month) %>% 
  arrange(desc(mean_anom)) %>% 
  mutate(rank = rank(-mean_anom)) %>% 
  ungroup() %>% 
  arrange(rank, month)

# Add rankings back
monthly_avgs <- monthly_avgs %>% left_join(
  select(month_rankings, -c(mean_anom)),
  by = join_by(yr, month)) 


# Create the Monthly Summary Table
month_names <- data.frame("month" = month.abb, "month_full" = month.name)
month_summ_table <- monthly_avgs %>% 
  left_join(month_names) %>% 
  mutate(across(c(temp_c:anom_f),\(x) sprintf(x, fmt = '%#.1f'))) %>% 
  mutate(
    temp = md(str_c(temp_f, deg_f, " *(", temp_c, deg_c, ")*")),
    clim = str_c(clim_f, deg_f, " *(", clim_c, deg_c, ")*"),
    anom = str_c(anom_f, deg_f, " *(", anom_c, deg_c, ")*"),
    month = str_c("*", month_full, "*")) %>% 
  select(month, rank, temp, clim, anom) %>%
   gt(rowname_col = "month") %>% 
  tab_header(
    title = md(paste0("Table 1. Monthly Average Sea Surface Temperatures - ", params$report_year))) %>%
    tab_stubhead(label = md("Month")) %>% 
  fmt_markdown(
  columns = everything(),
  rows = everything(),
  md_engine = c("markdown", "commonmark")) %>% 
  cols_label( # Change the column names to the units
    rank = md("Rank (1982-2023)"),
    temp = md("Observed Temperature"),
    clim = md("Climatological Average"),
    anom = md("Temperature Anomaly")) %>% 
  tab_source_note(md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
  tab_source_note(md("*Climatological Reference Period: 1991-2020.*")) %>% 
  opt_table_font(font = list(google_font(name = "Raleway")))

# # Display Table
month_summ_table



```







### Annual Trends



```{r}
#| label: code-warming-rates


####  Run Warming Rate regressions  ####
rate_data <- list(
  "GoM All F" = get_decadal_rates(
    temp_df = annual_summary, 
    temp_col = "sst_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "GoM", 
    degree_c = F),
  "GoM All C" = get_decadal_rates(
    temp_df = annual_summary, 
    temp_col = "sst", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "GoM", 
    degree_c = T),
  "Global All F" = get_decadal_rates(
    temp_df = global_summary, 
    temp_col = "area_wtd_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "Global Ocean", 
    degree_c = F),
  "Global All C" = get_decadal_rates(
    temp_df = global_summary, 
    temp_col = "area_wtd_sst", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "Global Ocean", 
    degree_c = T))



# Build Regression Equation Labels
eq_all_f    <- rate_data[["GoM All F"]][["eq_label"]]
eq_global_f <- rate_data[["Global All F"]][["eq_label"]]

```


Since the early 1980s, the rate of warming in the Long Island Sound `r str_c(rate_data[["GoM All F"]][["decadal_rate"]], "\u00b0F / Decade")` has been more than triple that of the world’s oceans (`r str_c(rate_data[["Global All F"]][["decadal_rate"]], "\u00b0F / Decade")` @fig-global-comparison). The precise causes of the pronounced jump in annual average SSTs in the region from 2009 to 2012 remains an area of active research, but the sustained warm conditions suggest a regime shift in the influence of major ocean currents (i.e., Gulf Stream vs Labrador Current) in the Long Island Sound. While a long-term increase in SSTs is expected as a result of human-caused climate change, we also expect each year to be influenced by large-scale patterns of natural variability, particularly on sub-global (i.e., regional) scales. SST conditions in the Long Island Sound for `r report_yr` retain the region’s distinction as being one of the fastest warming ocean regions on the planet; including the `r report_yr` data shows that the Long Island Sound is warming faster than 97% of the world’s ocean surface. 


```{r}
#| label: fig-global-comparison
#| fig-cap: "A timeseries of annual average sea surface temperature anomalies for the Long Island Sound (solid black line) from 1982 through 2023, illustrating that 2023 was the 2nd warmest year on record. Long-term trendlines for the Long Island Sound (blue) and the entire globe (green) show how much more quickly the Long Island Sound is warming compared to the rest of the world."


# Fahrenheit plot
temp_simplified <- global_rate_comparison(
  annual_summary_dat = annual_summary, 
  global_summary_dat = global_summary, 
  eq_all = str_remove(eq_all_f, "1982-2023"), 
  eq_global = str_remove(eq_global_f, "1982-2023"), 
  temp_units = "F",
  region_label = "Long Island Sound") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.115, y_npc = -0.175, logo_height = 1, height_units = "cm")

# Add a new legend for the points
l2 <- ggplot() +
  geom_point(
    data = annual_summary, 
    aes(year, anom_f, shape = "Long Island Sound Annual SST Anomaly"), 
    color = "gray20", 
    size = 2,
    alpha = 0.8) +
  labs(shape = NULL) + 
  guides(shape = guide_legend(label.position = "left",label.hjust = 1))
leg2 <- gtable_filter(ggplot_gtable(ggplot_build(l2)), "guide-box") 



# add second legend
temp_simplified <- temp_simplified +
  annotation_custom(grob = leg2, xmin = 2009, xmax = 2020, ymin = -2, ymax = -1)
temp_simplified


#------------

# eq_all_c    <- rate_data[["GoM All C"]][["eq_label"]]
# eq_global_c <- rate_data[["Global All C"]][["eq_label"]]
# 
# # Celsius Version
# temp_simplified_c <- global_rate_comparison(
#   annual_summary_dat = annual_summary, 
#   global_summary_dat = global_summary, 
#   eq_all = str_remove(eq_all_c, "1982-2023"), 
#   eq_global = str_remove(eq_global_c, "1982-2023"), 
#   temp_units = "C",
#   region_label = "Long Island Sound") +
#   coord_cartesian(clip = "off") +
#   geom_logo(x_npc = 0.115, y_npc = -0.175, logo_height = 1, height_units = "cm")
# 
# # add logo
# temp_simplified_c
```


### Quarterly Trends


Zooming in to sub-annual timescales reveals some interesting patterns: the observed rate of warming in the Long Island Sound varies throughout the year. Comparisons across the four quarters of the year  (@fig-seasons-comparison) reveal that the Long Island Sound is warming fastest during July-September (~4x the global ocean average)—almost twice the rate seen during January-June (~3x the global ocean average).



```{r}
#| label: fig-seasons-comparison
#| fig-cap: "Four timeseries panels of the annual averages for 3-month periods (solid black lines) for the Long Island Sound. Decadal trends are overlaid to compare decadal trends in the Long Island Sound (blue) and the entire globe (green). Rates are much faster in the Long Island Sound across all periods, with the smallest difference in rates during January-March."
#| fig.width: 8
#| fig.height: 7


# Pull the data out by season: annual_summary steps but for each season
season_summary <- region_timeseries %>% 
  mutate(
    month_groups = case_when(
      month %in% c("Jan", "Feb", "Ma")   ~ "January - March",
      month %in% c("Apr", "May", "Jun")  ~ "April - June",
      month %in% c("Jul", "Aug", "Sep")  ~ "July - September",
      month %in% c("Oct", "Nov", "Dec")  ~ "October - December")) %>% 
  group_by(yr, month_groups) %>% 
  temperature_summaries()

global_season_summary <- global_anoms %>% 
  mutate(
    month_groups = case_when(
      month %in% c("Jan", "Feb", "Ma")   ~ "January - March",
      month %in% c("Apr", "May", "Jun")  ~ "April - June",
      month %in% c("Jul", "Aug", "Sep")  ~ "July - September",
      month %in% c("Oct", "Nov", "Dec")  ~ "October - December")) %>% 
  group_by(yr, month_groups) %>% 
  temperature_summaries() 




# Think we can Facet, but then the stupid rates won't be there...
season_avgs <- bind_rows(
  list(
    "Long Island Sound" = season_summary,
    "Global Ocean" = global_season_summary), 
  .id = "Region") %>% 
  mutate(month_groups = factor(month_groups,
    levels = c("January - March", "April - June", "July - September", "October - December")))


# Decadal Rates Function
rate_calc <- function(.data){
   annual_lm <- lm(anom_f ~ yr, data = .data)
    rate_x <- round(coef(annual_lm)["yr"] * 10, 2)
    eq_lab <- paste0(": ", rate_x, deg_f, " / Decade")
    mutate(.data, rate_eq = eq_lab)
}


# Run the numbers to make the label
season_avgs <- season_avgs %>% 
  group_by(Region, month_groups) %>% 
  group_map( ~rate_calc(.), .keep = TRUE) %>% 
  bind_rows() %>% 
  mutate(rate_eq = str_c(Region, rate_eq))



# Make the four panels:
season_panels <- season_avgs %>% 
  split(.$month_groups) %>% 
  imap(function(x, y){
    
    season_p <- ggplot(x, aes(yr, anom_f)) +
      geom_line( data = filter(x, Region == "Long Island Sound"), color = "gray20", alpha = 0.5, linewidth = .5, linetype = 3) +
      geom_point(data = filter(x, Region == "Long Island Sound"), color = "gray20", size = 2, alpha = 0.8) +
      stat_smooth(
        aes(color = rate_eq), 
        method = "lm", 
        formula = y~x, 
        linetype = 1, 
        linewidth = 1.5, 
        alpha = 0.8,
        se = FALSE) +
      facet_wrap(~month_groups, ncol = 2) +
      scale_color_manual(values = c(gmri_cols("gmri green"), gmri_cols("blue"))) +
      scale_y_continuous(labels = number_format(suffix = deg_f)) +
      theme(
        legend.position = "bottom",
        legend.background = element_rect(color = "black", fill = "white")) +
      guides(color = guide_legend(title.position = "top", title.hjust = 0.5, direction = "vertical")) +
      labs(
        x = NULL, 
        y = "SST Anomaly",
        color = str_c(y, " Trend (1982-2023)"))
    
    # Signal that winter isn't over...
    if(y == "October - December"){
      season_p <- season_p +
        geom_point(data = filter(x, yr == 2023, Region == "Long Island Sound"), aes(yr, anom_f),
                   shape = 21, color = "black", fill = "white", size = 1.5)}
    
    
    # Return the plot for that season
    season_p
      
  })


# Assemble the plot
panel_plot <- (season_panels$`January - March` |season_panels$`April - June`) / (season_panels$`July - September` | season_panels$`October - December`) + plot_annotation(caption = "") &
  theme(plot.margin = margin(t = 5, b = 5, r = 2, l = 2))

panel_plot
grid::grid.raster(lab_logo, x = 0.08, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
```





## Daily Sea Surface Temperatures

```{r}
#| label: txt-extreme-events

# typical range
seasonal_cycle_min <- min(report_yr_only$seas_f)
seasonal_cycle_max <- max(report_yr_only$seas_f)
seasonal_range     <- round(seasonal_cycle_max - seasonal_cycle_min, 2)

# report_yr range
report_yr_min <- min(report_yr_only$sst_f)
report_yr_min_anom <- round(min(report_yr_only$anom_f), 2)
report_yr_min_date <- format(report_yr_only$time[report_yr_only$sst_f == report_yr_min], "%b-%d")
report_yr_max <- max(report_yr_only$sst_f)
report_yr_max_date <- format(report_yr_only$time[report_yr_only$sst_f == report_yr_max], "%b-%d")
report_yr_max_anom <- max(report_yr_only$anom_f)
report_yr_max_anom_date <- format(report_yr_only$time[report_yr_only$anom_f == report_yr_max_anom], "%b-%d")
report_yr_range <- round(report_yr_max - report_yr_min, 2)
report_yr_max <- round(report_yr_max, 2)
report_yr_max_anom <- round(report_yr_max_anom, 2)
report_yr_min <- round(report_yr_min, 2)
```


The annual cycle of SST in the Long Island Sound exhibits a pattern common to regions in the Northern Hemisphere, with the lowest temperatures observed in March and the highest values observed in August (@fig-annual-hw-timeseries). Daily SST anomalies in `r report_yr` never fell below +`r report_yr_min_anom` °F compared to the long-term (1991-2020) average and reached as high as high as `r floor(report_yr_max_anom)` °F above the long-term average. 

The largest temperature anomalies were observed during November, which also turned out to be the warmest November on record (as highlighted in our [Fall 2022 update](https://www.gmri.org/stories/gulf-of-maine-warming-update-fall-2022/)). @fig-annual-hw-timeseries also illustrates that, in `r report_yr`, 353 days experienced SST anomalies that exceeded the threshold for being considered marine heatwaves, or MHW (more on MHWs below, including @fig-mhw-heatmap)

### MHW Temps


A marine heatwave (MHW) is defined as a period when there are five or more consecutive days when the observed SST is greater than the 90th percentile of the long-term average for that day. Gaps of 2 days or less in this threshold do not constitute a break in the MHW event. @fig-annual-hw-timeseries  illustrates that the Long Island Sound met the criteria for experiencing a MHW for `r hw_criteria` days in `r report_yr` (or 97% of the year). Superimposing MHW status (black line) over the full timeseries of daily SST anomalies (blue/white/red shading) (@fig-annual-hw-timeseries) reveals that the frequency, duration, and intensity of MHWs has increased in the past decade. 


```{r}
#| label: fig-annual-hw-timeseries
#| fig.height: 4
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Long Island Sound extending from January 1 through December 301 2022. Black lines representing the long-term (i.e., 1991 – 2020) average SST, the 10th percentile (i.e., cold spell threshold), and 90th percentile (i.e., heatwave threshold) for a given day in the Long Island Sound are labeled to indicate climatological reference points. A solid line (red for marine heatwave or blue for a non-heatwave day) indicate the observed SST for each day; red and blue shading illustrates whether each day is considered part of a MHW event."
#| fig-alt: "A line chart shows the average sea surface temperature for each day of the year, and overlaid against it are notably smoother black lines representing the long-term mean, 10th percentile, and 90th percentile temperatures for those same days of the year. The area between the mean and the observed temperature is filled in with a solid color to indicate whether that day meets marine heatwave criteris. The observed temperatures for 2022 are above the 90th percentile for nearly the entire year, with the exception of two periods less than a week long in June and October."


# annual heatwave timeseries


# # Show MHW Status Through the Year:
# hw_temp_p <- year_hw_temps_two(year_hw_dat = report_yr_only, temp_units = "F") + 
#   labs(
#     title = str_c("Long Island Sound SST: ", params$report_year))  +
#   scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = expansion(add = c(0,0))) +
#   coord_cartesian(clip = "off") +
#   geom_logo(x_npc = 0.9, y_npc = 1.125, logo_height = 1, height_units = "cm")
# hw_temp_p



# Build a new one from scratch ------------

year_hw_dat <- report_yr_only
temp_units <- "F"

# Augment Data
  year_hw_dat <- mutate(
    year_hw_dat, 
    cs_thresh_f = as_fahrenheit(mcs_thresh),
    mhw_event_txt = if_else(mhw_event, "Marine Heatwave", "Non-Heatwave"))
  
  
  # Handling Temperature Units:
  temp_ops <- switch (
    EXPR = temp_units,
    "C" = list(
      temp_col  = expr(sst),
      anom_col  = expr(sst_anom),
      seas_col  = expr(seas),
      hw_thresh = expr(mhw_thresh),
      cs_thresh = expr(mcs_thresh),
      hw_temp   = expr(hwe),
      temp_suff = " \u00b0C"),
    "F" = list(
      temp_col  = expr(sst_f),
      anom_col  = expr(anom_f),
      seas_col  = expr(seas_f),
      hw_thresh = expr(mhw_thresh_f),
      cs_thresh = expr(cs_thresh_f),
      hw_temp   = expr(hwe_f),
      temp_suff = " \u00b0F"))
  
  # Assign to shorter names
  temp_col      <- temp_ops$temp_col
  anom_col      <- temp_ops$anom_col
  clim_col      <- temp_ops$seas_col
  hw_thresh_col <- temp_ops$hw_thresh
  cs_thresh_col <- temp_ops$cs_thresh
  hw_temp_col   <- temp_ops$hw_temp
  
  # Set colors by name
  color_vals <- c("Non-Heatwave" = "#0571B0", "Marine Heatwave" = "darkred")
  
  # Flag heatwave Events:
  hw_events <- year_hw_dat %>% 
    filter(mhw_event == T) %>% 
    group_split(mhw_event_no) %>% 
    map_dfr(function(x){
      data.frame(
        id = unique(x$mhw_event_no),
        llim = min(x$time),
        rlim = max(x$time),
        ymax = max(x$sst_f),
        min_anom = min(x$anom_f),
        max_anom = max(x$anom_f),
        mean_anom = mean(x$anom_f),
        len  = nrow(x))
    })

  



# Build the Plot
hw_temp_p <- ggplot(year_hw_dat) +
    geom_path(aes(x = time, y = {{temp_col}}, color = mhw_event_txt, group = 1), linewidth = 0.8, key_glyph = "timeseries") +
    geom_segment(aes(x = time, xend = time, y = {{clim_col}}, yend = {{temp_col}}, color = mhw_event_txt), alpha = 0.25,
                 show.legend = F) +
    geom_textpath(
      aes(x = time, y = {{hw_thresh_col}}), 
      color = "gray10", label = "90th Percentile", 
      hjust = 1.15, lty = 1, vjust = 0, family = "Avenir") + 
    geom_textpath(
      aes(x = time, y = {{clim_col}}), 
      color = "gray10", label = "Climatological Avg.", 
      hjust = 1.25, lty = 1, family = "Avenir") +
    geom_textpath(
      aes(x = time, y = {{cs_thresh_col}}), 
      color = "gray10", label = "10th Percentile", 
      hjust = 1.15, lty = 1, vjust = .9, straight = T, family = "Avenir") +
    geom_bracket(
      data = hw_events, 
      aes(xmin = llim, xmax = rlim, y.position = ymax + 2, label = str_c(len, " Days")), 
      family = "Avenir") +
    scale_color_manual(values = color_vals) +
    scale_x_date(
      date_labels = "%b", 
      date_breaks = "1 month", 
      expand = expansion(add = c(0,110)),
      limits = as.Date(str_c(params$report_year, c("-01-01", "-12-31")))) +
    scale_y_continuous(
      labels =  number_format(suffix = temp_ops$temp_suff),
      expand = expansion(mult = c(0.2, .2))) +
    theme(legend.position = "bottom") +
    labs(
      title = str_c("Long Island Sound SST and MHW Events"),
      x = NULL, 
      color = "Sea Surface Temperature & Heatwave Status:",
      fill = "Difference from Average SST",
      y = "Sea Surface Temperature") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")

# Show plot
hw_temp_p

```

### MHW Anomalies

```{r}
#| label: fig-season-mhw-timeline
#| fig-height: 5
#| eval: false
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Long Island Sound extending from January 1, 2023 through August  31, 2023. Black lines represent the long-term (i.e., 1991 – 2020) average SST, the 10th percentile, and 90th percentile for a given day in the Long Island Sound; a solid line (red for marine heatwave or blue for a non-event) indicate the observed SST this year; red (above 90th percentile) and blue (below 90th percentile) shading illustrates how far the observed SST autumns from the MHW threshold."


# Do this one over again:
hw_anom_p <- year_hw_dat %>% 
  mutate(
      hw_anom_thresh = {{ hw_thresh_col }} - {{ clim_col }},
      cs_anom_thresh    = {{ cs_thresh_col }} - {{ clim_col }}) %>% 
  ggplot() +
  geom_ribbon(aes(x = time, ymin = cs_anom_thresh, ymax = hw_anom_thresh), fill = "lightgray", alpha = 0.4) +
    geom_path(aes(x = time, y = {{anom_col}}, color = mhw_event_txt, group = 1), linewidth = 0.8, key_glyph = "timeseries") +
    geom_textpath(
      aes(x = time, y = 0), 
      color = "gray10", 
      label = "Climatological Avg. & \n 10th-90th Percentile Range", 
      hjust = .05, lty = 1, family = "Avenir") +
    geom_bracket(
      data = hw_events, 
      aes(xmin = llim, xmax = rlim, y.position = max_anom + 1, label = str_c(len, " Days")), 
      family = "Avenir", ) +
    scale_color_manual(values = color_vals) +
    scale_x_date(
      date_labels = "%b", 
      #date_labels = "%b %y", 
      date_breaks = "1 month", 
      expand = expansion(add = c(0,0))) +
    scale_y_continuous(
      labels =  number_format(suffix = temp_ops$temp_suff),
      expand = expansion(mult = c(0.05, .2))) +
    theme(legend.position = "bottom", legend.title = element_text(face = "bold")) +
    labs(title = str_c("Long Island Sound SST Anomalies"),
         x = NULL, 
         color = "SST Anomalies & Heatwave Status:",
         fill = "Difference from Average SST",
         y = "Sea Surface Temperature Anomaly") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")

# Show plot
hw_anom_p
  
```



### MHW Heatmap



In a world without human-caused climate change, we would expect, positive (warm) and negative (cool) SST anomalies to more or less balance out over the span of several years, as various patterns of natural climate variability alternate having a dominant influence on Earth’s climate (e.g., La Niña vs El Niño). What is being observed in the Long Island Sound (and elsewhere around the world), however, is a loss of that balance: larger fractions of recent years are experiencing above average temperatures and cold spells are becoming vanishingly rare.




```{r}
#| label: fig-mhw-heatmap
#| fig-cap: "Heat map of daily SST anomalies from the beginning of 1982 through the end of 2022. Not only do more large warm anomalies (darker reds) appear more frequently in recent years, but the frequency and duration of marine heatwave events (black lines) in the Long Island Sound has become more pronounced in the past decade."
#| fig-alt: "A figure displays the temperatures for each day of year as a colored stripe, organized with a row for each day such that the day of year aligns vertically. The lower two-thirds has a roughly equal balance between colors for warm (red) and cold (blue) temperature anomalies. The top third of the image is almost completely red as temperature anomalies rarely fall below the long-term average. Black dots are overlaid onto days that meet the criteria for a heatwave, they are rare in the lower section and common in the red section."
#| fig.height: 8


# Heatmap: All years:
heatmap_p <- region_hw %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2023) +
  labs(title = "Long Island Sound Heatwave Record",
       y = "Year",
       x = "Month") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.05, logo_height = 1, height_units = "cm")

heatmap_p + labs(caption = "")
```





### Record Temp Bars



Daily SST values in `r report_yr` were some of the highest ever recorded in the Long Island Sound. Record high SSTs were set for more than half of all days during the months of February, March, & April. February saw the most new records, with 86% of days setting new daily record highs.


```{r}
#| label: fig-percent-record-bars
#| fig-cap: "An illustration of the percentage of days during each month in 2022 when a record-high temperature was observed in the Long Island Sound (e.g., 80% — 24 days — of November were new record-setting high temperatures)."
#| fig.height: 4
#| eval: true

# New hottest daily temps - maybe scratch
# Grab the hottest day for each day of the year
hottest_days <- region_hw %>% 
  group_by(doy) %>% 
  slice_max(order_by = sst_anom, n = 1) %>% 
  ungroup() 

# Total Number in report_yr
hottest_report_yr <- hottest_days %>% 
  count(yr) %>% 
  filter(yr == report_yr) %>% 
  pull(n)

# # Daily Record Temperatures
hottest_days <- hottest_days %>%
  mutate(
    record_period = case_when(
      yr == report_yr ~ as.character(report_yr),
      yr < report_yr & yr > 2000 ~ "Since 2010",
      yr < 2000 ~ "Before 2000"),
    flat_date = as.Date(str_c(report_yr, "-01-01")) + (doy - 1))


# What days set records in report_yr
records_report_yr <- hottest_days %>% 
  filter(yr == report_yr) %>% #count(month)
  mutate(record_temp = TRUE) %>% 
  select(yr, time, sst, seas, sst_anom, record_temp)


# What percent of days in month were records:
record_percents <- region_hw %>% 
  filter(yr == report_yr) %>% 
  full_join(records_report_yr) %>% 
  mutate(record_temp = ifelse(record_temp == TRUE, TRUE, FALSE)) %>% 
  group_by(yr, month) %>% 
  summarise(n_days = n(),
            n_records = sum(record_temp, na.rm = T),
            .groups = "drop") %>% 
  mutate(percent_records = (n_records / n_days),
         highlight_oct = ifelse(month %in% c("Feb", "Mar", "Apr"), "flag", "filler"))
  

# Build the plot
fig_percents <- ggplot(record_percents, aes(month, percent_records, alpha = highlight_oct)) +
  geom_col() +
  geom_col(fill = as.character(gmri_cols("orange"))) +
  geom_text(
    aes(x = month, y = percent_records, 
        label = str_c(round(percent_records,2)*100, "%")),
    vjust = -.5, color = 'black',
    fontface = "bold", family = "Avenir") +
  scale_alpha_manual(values = c("flag" = 1, "filler" = 0.4)) +
  scale_y_continuous(labels = percent_format(), limits = c(0,1), expand = expansion(add = c(0,0))) +
  theme(legend.position = "none") +
  labs(x = "Month", 
       y = "Fraction of the Month", 
       title = str_c(report_yr, ": Record Warm Daily Temperatures"),
       subtitle = "Large fraction of Nov. & Dec. dates set all-time highs for the Long Island Sound ")   +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.125, logo_height = 1, height_units = "cm")


# Show plot
fig_percents

```



### SST Map

In addition to the sub-annual (or temporal) variation, there can also be significant spatial variability in annually-averaged SST patterns. The Long Island Sound illustrated this fact, with the region southeast of Georges Bank exhibiting the highest annual average SST anomalies (@fig-new-england-map). This area is more susceptible than other areas in the region of study to large-scale variability in major oceanic currents, such as the relative influence of the Gulf Stream versus the Labrador Current.


```{r}
#| label: fig-new-england-map
#| fig-cap: "Map of annual average sea surface temperature anomalies in 2021. The box outlined by the black dashed line denotes the region of study for the analysis presented throughout this report."
#| fig.height: 6


# Set time limits to get data
annual_dates <- as.Date(
  c(str_c(report_yr,"-01-01"), str_c(report_yr,"-12-31")))

# Make data window for the year
data_window <- data.frame(
  lon = crop_x_expanded,
  lat = crop_y_expanded,
  time = annual_dates)

# Load data, stack and tidy
ne_anoms <- oisst_window_load(
    data_window = data_window,
    anomalies = T,
    box_location = "cloudstorage", climate_ref = "1991-2020") %>%  
  stack()

# Convert to F
ne_anoms_f <- calc(ne_anoms, function(x) as_fahrenheit(x, data_type = "anomalies")) %>% 
  setNames(names(ne_anoms))

# Process the yearly average
ne_annual_anom_f <- mean(ne_anoms_f, na.rm = T)



# Color limit for palettes
temp_limits <- c(-6, 6)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")


# Make it a stars class to plot with ggplot
ne_anoms_st <- st_as_stars(ne_annual_anom_f)



#### 1. Map the Anomalies in Space
annual_long_island_map <- ggplot() +
  geom_stars(data = ne_anoms_st) +
  tidyterra::geom_spatraster_contour(
    data = elev_terra,
    breaks = seq(0,-200,-100),
    alpha = 0.75) +
  geom_sf(data = new_england, fill = "gray90", linewidth = .15) +
  geom_sf(data = canada, fill = "gray90", linewidth = .15) +
  geom_sf(data = region_extent,
          color = "black",
          linetype = 1, linewidth = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(
    palette = "RdBu", 
    na.value = "transparent", 
    limit = temp_limits, 
    labels = temp_labels,
    oob = scales::oob_squish) +
  coord_sf(xlim = crop_x_expanded, ylim = crop_y_expanded) +
  labs(title = str_c(report_yr, ": Average Temperature Anomalies"),
       caption = "Anomalies calculated using 1991-2020 climatology.\n100m & 200m contours overlaid to show bathymetric details.") +
  map_theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0))+
  guides("fill" = guide_colorbar(
    title = "Average Temperature Anomaly ",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
annual_long_island_map
grid::grid.raster(lab_logo, x = 0.1, y = 0.06, just = c('left', 'bottom'), height = unit(1, "cm"))


```


### Quarterly Map

Looking at these spatial patterns across the annual quarters of `r report_yr` (@fig-four-season-maps) shows not only the large spatial variability in SST conditions, but also how that spatial variability can, itself, vary significantly over the course of the year. While the open ocean beyond Georges Bank exhibits significant spatial and temporal variability, @fig-four-season-maps also illustrates that the Long Island Sound experiences more consistent SST conditions spatially and temporally (i.e., the entire region is anomalously warm throughout the year and the warmest areas tend to be those that are most heavily influenced by inflow from the Northeast Channel—the deep valley south of Nova Scotia and just off the northeast tip of Georges Bank). 


```{r}
#| label: fig-four-season-maps
#| fig-cap: "Maps of the  3-month averages in sea surface temperature anomalies in 2023."
#| fig.width: 8
#| fig.height: 6

# Four Season Panels

# Process the stack into the four 3-month averages
# Set time limits
season_dates <- list(
  "January - March" = distinct(filter(report_yr_only, month %in% c("Jan", "Feb", "Mar")), time) %>% pull(time),
  "April - June" = distinct(filter(report_yr_only, month %in% c("Apr", "May", "Jun")), time) %>% pull(time),
  "July - September"   = distinct(filter(report_yr_only, month %in% c("Jul", "Aug", "Sep")), time) %>% pull(time),
  "October - December" = distinct(filter(report_yr_only, month %in% c("Oct", "Nov", "Dec")), time) %>% pull(time)
)

# Grab the dates for each, process the mean 
season_stacks <- map(season_dates, function(x){
  dates_x <- str_c("X", str_replace_all(x, "-", "."))
  which_dates <- which(names(ne_anoms_f)  %in% dates_x)
  month_mean <- mean(ne_anoms_f[[which_dates]], na.rm = T)
  
})


# Assemble Panels Again:
season_panel_maps <- imap(season_stacks, function(x, seasn){
  
  season_df <- data.frame("season" = seasn)
  ne_season_st <- st_as_stars(x)
  season_map <- ggplot(data = season_df) +
    geom_stars(data = ne_season_st) +
    tidyterra::geom_spatraster_contour(
      data = elev_terra,
      breaks = seq(0,-200,-100),
      alpha = 0.75) +
    geom_sf(data = new_england, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = canada, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = greenland, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, 
            linewidth = 1,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdBu", 
                         na.value = "transparent", 
                         limit = temp_limits, 
                         labels = temp_labels,
                         oob = scales::oob_squish) +
    coord_sf(xlim = c(-78, -56.5), ylim = c(37.8, 48)) +
    facet_wrap(~season) +
    map_theme(
      legend.position = "bottom",
      legend.title = element_text(angle = 0))+
    guides("fill" = guide_colorbar(
      title = "Average Temperature Anomaly ",
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) 

# Show figure
season_map
})



# Put them together and format them
season_panels_all <- (season_panel_maps$`January - March` | season_panel_maps$`April - June`)/(season_panel_maps$`July - September` | season_panel_maps$`October - December`) +
  plot_layout(guides = "collect") & 
  theme(legend.position = 'bottom', 
        plot.margin = margin(t = 1, b = 1, r = 1, l = 1)) 

# Display them
season_panels_all + plot_annotation(caption = "100m & 200m contours overlaid to show bathymetric details.")
grid::grid.raster(lab_logo, x = 0.08, y = 0.04, just = c('left', 'bottom'), height = unit(1, "cm"))

```










 

---

**A Note on Data Sources**    

The figures in this report are created using remotely-sensed satellite data as part of publicly funded research efforts. Satellite SST data was obtained from NOAA’s National Center for Environmental Information (NCEI), with all maps and figures displaying NOAA’s Optimum Interpolation Sea Surface Temperature Data.


 * NOAA High Resolution SST data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.highres.html.    





---




```{r}
#| results: asis
insert_gmri_footer()
```

