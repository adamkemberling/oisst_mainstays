---
title: "Gulf of Maine Seasonal Sea Surface Temperature Update"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  Seasonal Patterns in Sea Surface Temperatures
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
    css:
      - https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css
execute: 
  echo: false
  warning: false
  message: false
  comment: ""
  fig.align: center
params: 
  year: 2023
  season: "Winter"
  save_data: FALSE
  save_figures: TRUE
editor: source
---

```{r}
#| label: packages
#| include: false
#| echo: false
#| warning: false

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggforce)
library(geomtextpath)

# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# Box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     box_location = "cloudstorage")

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
```

```{r}
#| label: param-setup
#| echo: false
#| results: asis

# Use GMRI style
use_gmri_style_rmd()

# # Fonts for plots if they worked
# sysfonts::font_add_google("lato")
# showtext::showtext_auto()
# showtext::showtext_opts(dpi = 300)


#####  Parameter option switches:  ####
season_deets <- season_text_details(season_op = params$season, year_op = params$year)

# Set color for the season based on the parameter:
season_col <- season_deets$season_color

# Configure edges/centers of each season for label positioning
season_cent  <- season_deets$center_date
season_left  <- season_deets$left_lim
season_right <- season_deets$right_lim
season_start   <- season_deets$season_start_doy
season_end   <- season_deets$season_end_doy

# Make names for the months to pull based on the season and current year
season_months <- season_deets$month_range

# Names of start and end month for text:
season_range <- season_deets$range_label


```

```{r}
#| label: region-ts-prep

# Timeseries Path +
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]


# Load timeseries of SST for Region
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e5) 


# Format timeseries for group estimates
region_timeseries <- region_timeseries %>% 
  mutate(
    time = as.Date(time),
    area_wtd_f = as_fahrenheit(area_wtd_sst),
    anom_f     = as_fahrenheit(area_wtd_anom, "anomalies")) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:params$year))



####  Get heatwave statuses for each day:

# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1991-01-01", "2020-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366, # handle leap years
         time <= as.Date(str_c(params$year, season_right))) # remove dates past the seasonal update

# Set up heatwave status outcomes for fancy gtextras table features:
region_hw <- region_hw %>% 
  mutate(
    hw_outcomes = case_when(
      mhw_event == TRUE ~ 1,
      mcs_event == TRUE ~ 0,
      TRUE ~ 0.5))



####  Season Data Prep

# Subset data for the season were looking at
this_season_data <- region_hw %>% 
  dplyr::filter(season_eng == params$season,
                season_yr == params$year-1) # Works for winter
                #season_yr == params$year) # Messed up for winter

# Set seasonal end date so weeks don't bleed over
first_day <- as.Date(min(this_season_data$time))
last_day  <- as.Date(max(this_season_data$time))

# Set week start in the data so we can merge labels in accordingly later
this_season_data <-  this_season_data %>% 
  mutate(wk_start = floor_date(time, unit = "week"),
         wk_start = if_else(wk_start < first_day, first_day, wk_start),
         wk_start = as.Date(wk_start))

# Months/Dates covered by each season for use as labels
month_range <- switch(params$season,
  "Winter" = "(December 1st - February 28th)",
  "Spring" = "(March 1st - May 31st)",
  "Summer" = "(June 1st - August 31st)",
  "Fall" =   "(September 1st - November 30th)")
```

```{r}
#| label: seasonal-temp-summary

# 1. Get the overall averages across all years

# Set the start year, use 1981 if season is winter
ssn_year_start <- ifelse(params$season == "Winter", 1981, 1982)


# Get the average temperature for all years as a baseline
all_year_season_avg <- region_hw %>% 
  filter(season_yr %in% c(ssn_year_start:params$year),
         season_eng == params$season) %>% 
  group_by(season_eng) %>% 
  summarise(avg_temp_c = mean(sst),
            avg_anom_c = mean(sst_anom),
            avg_clim_c = mean(seas),
            avg_temp_f = mean(sst_f),
            avg_clim_f = mean(seas_f),
            avg_anom_f = mean(anom_f),
            .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))



# 2. Get Averages for each year individually, 
seasonal_avgs <- region_hw %>% 
  filter(
    season_eng == params$season, 
    season_yr %in% c(ssn_year_start:params$year)) %>% 
  group_by(season_yr, season) %>% 
  summarise(
    # Uses Area Weighted SST
    mean_temp = mean(sst),
    mean_clim = mean(seas),
    mean_clim = median(mean_clim), # Makes sure any odd years (leap year or incomplete) are not different
    mean_anom = mean(sst_anom),
    temp_f    = as_fahrenheit(mean_temp),
    clim_f    = as_fahrenheit(mean_clim),
    anom_f    = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") %>% 
  mutate(
     year = season_yr,
     yr = season_yr,
     season_center = as.Date(str_c(yr, season_cent)),
     season_llim   = as.Date(str_c(yr, season_left)),
     season_rlim   = as.Date(str_c(yr, season_right)),
     temp_label    = str_c(round(temp_f, 2), " \u00b0F  |  ", round(mean_temp, 2), " \u00b0C"),
     anom_label    = str_c(round(anom_f, 2), " \u00b0F  |  ", round(mean_anom, 2), " \u00b0C")
  )
  
  
  
# Rank the hottest years
seasonal_ranks <- seasonal_avgs %>% 
  mutate(yr = factor(yr),
         year_rank = fct_reorder(.f = yr, .x = mean_temp, .fun = median, .desc = TRUE)) %>% 
  arrange(year_rank) %>% 
  mutate(rank = row_number(),
         #flag_year = ifelse(year_rank == params$year, "flag", "unflag")) 
         flag_year = ifelse(year_rank == 2022, "flag", "unflag")) 

```

# About the Updates:

Over the past decade, scientists at [the Gulf of Maine Research Institute](https://www.gmri.org) have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To keep you informed, we share seasonal updates about conditions in the Gulf of Maine.

## New in 2023: Moving the Climatological Reference Period

In the field of climate science, 30-year time periods are a standard measure for a "climatological reference period". Such a timescale adequately captures the natural inter-annual variability of the Earth system to enable rigorous statistical analysis of trends in environmental conditions. This is particularly relevant when presenting statistics such as temperature "anomalies"---or deviations from these 30-year climatological averages. To date, when we present temperature anomaly data in our seasonal and annual warming updates, we have used a climatological reference period of 1982-2011. In part, this is motivated by the fact that reliable satellite data for sea surface temperatures (SST) in the Gulf of Maine became available in 1982 (and 30 years hence brought us to 2011). Beginning with this winter 2022-23 Gulf of Maine warming report, we are using a new 30-year climatological reference period, 1991-2020, reflecting the fact that an additional decade's worth of data has been collected, enabling us to update our baseline reference period. This change is consistent with best practices used by the international science community. For more information on 30-year climatological (or baseline) reference periods, the motivation for, and implications of updating it to 1991-2020, visit the [U.S. "Climate Normals"](https://www.ncei.noaa.gov/products/land-based-station/us-climate-normals) database or [this explainer](https://www.ncei.noaa.gov/news/noaa-delivers-new-us-climate-normals) from the National Oceanic and Atmospheric Administration (NOAA).

```{ojs}
//| output: false
require("https://cdn.jsdelivr.net/npm/juxtaposejs@1.1.6/build/js/juxtapose.min.js")
  .catch(() => null)
```


```{r}
#| label: climatology-shift-prep


# Run climatology for old reference period
sst_old <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2011-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)

# Run climatology for new reference period
sst_new <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1991-01-01", "2020-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Pull one year's data so we can plot the climatology and example data
clim_only_old <- sst_old %>% filter(yr == 2012)%>% 
  mutate(clim_ref = "Climatological Reference Period: 1982-2011",
         mcs_thresh_f = as_fahrenheit(mcs_thresh))
clim_only_new <- sst_new %>% filter(yr == 2012)%>% 
  mutate(clim_ref = "Climatological Reference Period: 1991-2020",
         mcs_thresh_f = as_fahrenheit(mcs_thresh))


# Make table of the differences
change_df <- tibble(
  "time" = clim_only_new$time,
  "clim_82" = clim_only_old$seas,
  "clim_91" = clim_only_new$seas,
  "clim_change" = clim_only_new$seas - clim_only_old$seas
)






```


```{r}
#| eval: false
#| label: monthly-climatology-change-consequences


# Get monthly average of these changes - all in F
month_diff <- change_df %>% 
  mutate(clim_82 = as_fahrenheit(clim_82),
         clim_91 = as_fahrenheit(clim_91),
         clim_change = as_fahrenheit(clim_change, data_type = "anomaly")) %>%
  group_by(mnth = month(time, label = T, abbr = T)) %>% 
  summarise(
    min_82 = min(clim_82), # Monthly lows
    min_91 = min(clim_91),
    max_82 = max(clim_82), # Monthly highs
    max_91 = max(clim_91),
    mean_82 = mean(clim_82), # monthly means
    mean_91 = mean(clim_91)) %>% 
  mutate(
    min_change = min_91 - min_82, # Change in monthly low
    max_change = max_91 - max_82, # Change in monthly high
    mean_change = mean_91 - mean_82) %>% ungroup() # change in monthly mean


# the annual monthly min temp (March) increased by XX deg F in shifting the CRP from 1982-2011 to 1991-2020
month_diff %>% filter(mnth == "Mar") %>% pull(min_change)

# the annual monthly max temp (August) increased by XX deg F in shifting the CRP from 1982-2011 to 1991-2020
month_diff %>% filter(mnth == "Aug") %>% pull(max_change)


# the month with the largest change in updating the CRP is YYY (XX deg F); the season (MAM vs JJA vs SON vs DJF) with the largest change is ZZZ (XX deg F)

# a.
month_diff %>% arrange(desc(mean_change)) %>% slice(1) 

# b.
season_label_df <- data.frame(
      "mnth" = month.abb,
      "szn" = c("Winter", "Winter", "Spring", "Spring", "Spring", "Summer", "Summer", "Summer", "Fall", "Fall", "Fall", "Winter"))
month_diff %>% 
  left_join(season_label_df) %>% 
  group_by(szn) %>% 
  summarise(mean_change = mean(mean_change))

# How different is it if I do the mean on daily values...
change_df %>% 
  mutate(clim_change = as_fahrenheit(clim_change, data_type = "anomaly"),
         mnth = month(time, label = T, abbr = T)) %>%
  left_join(season_label_df) %>% 
  group_by(szn) %>% 
  summarise(mean_change = mean(clim_change))

# the month with the smallest change in updating the CRP is YYY (XX deg F); the season with the smallest change is ZZZ (XX deg F)

# a.
month_diff %>% arrange(mean_change) %>% slice(1) 

#b. 
month_diff %>% 
  left_join(season_label_df) %>% 
  group_by(szn) %>% 
  summarise(mean_change = mean(mean_change))

```



For the Gulf of Maine, the update of the seasonal climatology can be seen most clearly in February and March as temperatures no longer reach peak-lows. As well as in August and September where temperatures are setting new records. SST is higher throughout the year with this new climatology, and this will be reflected in all figures and tables as anomalies from this CRP will be lowered. However, underlying trends will remain unchanged, as will warming rates.



::: {.juxtapose data-startingposition="65%" style="margin-bottom:2em; width = 70%; height =70%"}
```{r}
# Old climatological cycle

# Create figures for the old and new reference cycles:

(clim_cycle_old <- clim_only_old %>% 
  ggplot() +
    geom_ribbon(aes(x = time, 
                    ymin = mcs_thresh_f, 
                    ymax = mhw_thresh_f), 
                alpha = 0.3, fill = "royalblue", color = "royalblue") +
    geom_line(aes(time, y = seas_f), linewidth = 1 ) +
    scale_x_date(date_breaks = "1 month", 
                 labels = date_format("%b"), 
                 expand = expansion(add = c(0,0))) +
    scale_y_continuous(labels = label_number(suffix = deg_f), limits = c(38,67)) +
    facet_wrap(~ clim_ref) +
    theme_gmri() +
    labs(y = "Sea Surface Temperature", x = NULL))


ggsave(plot = clim_cycle_old,
       filename =  here::here("R/markdown_reports/tech_report_imgs", "climatology_old.png"), 
       height = unit(5, "in"),
       width = unit(8, "in"),
       dpi = "retina")
```


```{r}
# New climatological cycle

(clim_cycle_new <- clim_only_new %>% 
  ggplot() +
   geom_ribbon(
     data = select(clim_only_old, -clim_ref),
     aes(x = time, 
         ymin = mcs_thresh_f, 
         ymax = mhw_thresh_f), 
     alpha = 0.3, fill = "royalblue",
     color = "royalblue") +
   geom_ribbon(aes(x = time, 
                   ymin = mcs_thresh_f, 
                   ymax = mhw_thresh_f), 
                alpha = 0.5, fill = "orange", color = "orange") +
    geom_line(aes(time, y = seas_f), linewidth = 1 ) +
    scale_x_date(date_breaks = "1 month", 
                 labels = date_format("%b"), 
                 expand = expansion(add = c(0,0))) +
    scale_y_continuous(labels = label_number(suffix = deg_f), limits = c(38,67)) +
    facet_wrap(~ clim_ref) +
    theme_gmri() +
    labs(y = "Sea Surface Temperature", x = NULL))


ggsave(plot = clim_cycle_new, 
       filename = here::here("R/markdown_reports/tech_report_imgs", "climatology_new.png"), 
       height = unit(5, "in"),
       width = unit(8, "in"),
       dpi = "retina")
```

:::



Learn more about how scientists study climate, and the details of this transition, in our marine heatwaves technical report.

> **Note About the Data:** The figures in this report are created using remotely-sensed satellite data as part of publicly funded research efforts. Satellite SST data was obtained from NOAA's National Center for Environmental Information (NCEI), with all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncei.noaa.gov/products/optimum-interpolation-sst).

# The Gulf of Maine Region

For analyses like these, it is important to be clear about the spatial extent that "defines" the Gulf of Maine (@fig-map), as different borders could produce different results. The spatial domain we use as the "Gulf of Maine" is displayed below. This area is consistent with previous seasonal and annual Gulf of Mainereports GMRI has produced.

```{r}
#| label: fig-map
#| fig.width: 8
#| fig.height: 8
#| fig.cap: "Spatial domain used for Gulf of Maine SST analyses. Deeper blues indicate deeper water depths."
#| fig.alt: "An overhead view of the Gulf of Maine region. Landmasses and political boundaries for the United States and Canada are displayed. A blue dotted line outlining a box with a transparent blue fill is shown to demark where satellite data for the analysis has been used."

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)


# Map the Gulf of Maine with Bathymetry
gom_extent_p <- map_study_area_color(
  region_extent = region_extent,
  new_england_sf = new_england,
  canada_sf = canada,
  greenland_sf = greenland) +
  labs(title = "Gulf of Maine Study Area")


# Show figure
gom_extent_p

```

# Season Highlights

```{r}
#| label: season-highlights

# Average Temp+Anom Stats for that season Used in Text
season_avg_temp <- round(mean(this_season_data$sst_f, na.rm = T), 2)
season_avg_anom <- round(mean(this_season_data$anom_f, na.rm = T), 2)
season_avg_clim <- round(mean(this_season_data$seas_f, na.rm = T), 2)

# What rank are we this year?
if(params$season == "Winter"){
  current_rank <- seasonal_ranks %>% 
    filter(yr == params$year-1) %>% 
    pull(rank) } else{
  current_rank <- seasonal_ranks %>% 
    filter(yr == params$year) %>% 
    pull(rank)
}


# In-Text friendly version
rank_labs <- switch(current_rank,
  "1" = "new",
  "2" = "2nd",
  "3" = "3rd",
  "4" = "4th",
  "5" = "5th",
  "6" = "6th",
  "7" = "7th",
  "8" = "8th",
  "9" = "9th",
  "10" = "10th")

# Get max anom year and max anom
max_anom_yr <- seasonal_avgs %>% 
  arrange(desc(mean_anom)) %>% 
  slice(1) %>% 
  mutate(across(where(is.numeric), \(x) round(x, 3)))
```

For this seasonal report we present an analysis of SST for `r tolower(params$season)` 2022-23 `r month_range`. During this season, the average SST for the Gulf of Maine was `r season_avg_temp`°F, making it the `r rank_labs` hottest `r tolower(params$season)` on record for the period of 1982-2023 --- the period over which the satellite data used are available. 

## Weekly Temperatures

In (@tbl-season-temps), we highlight how the SST for each week this `r tolower(params$season)` compares to the 30-year CRP period (i.e., climatological averages from 1991 through 2020) for the area shown in @fig-map.

The observed SST, long-term average SST trends, and SST anomalies (i.e., departures from the long-term average SST) are shown. Departures from the long-term average hovered around `r floor(mean(this_season_data$anom_f))`°F above normal with a few weeks punctuated by anomalies in excess of 4F in early- to mid-December and from late January through most of February with the last of 2022 and first week of 2023 experiencing temperatures closest to the long-term average.

```{r}
#| label: tbl-season-temps
#| tbl-cap: "Observed, climatological average, and deviation from the climatological average (i.e., temperature anomaly) for SST at a weekly resolution in the Gulf of Maine during winter 2022."

# Format the start/end dates for weekly subsets
week_labels <- this_season_data  %>% 
  # Determine bookends for weeks and trim to season bookends
  mutate(
    wk_end = ceiling_date(time, unit = "week"),
    wk_end = if_else(wk_end >= last_day, last_day, wk_end - 1)) %>% 
  # pull distinct weeks
  distinct(time, wk_start, wk_end)  %>% 
  # Add the month and day labels
  mutate(
    start_month = month(wk_start, label = T, abbr = T),
    end_month   = month(wk_end, label = T, abbr = T),
    start_day   = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day     = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week`      = str_c(start_month, " ", start_day, " - ", end_month, " ", end_day),
    `Week`      = factor(`Week`)) %>%
  # Ensure distinct weeks only, and arrange in chronological order
  distinct(`Week`, .keep_all = T) %>% 
  arrange(wk_start) %>% 
  mutate(week_position = row_number())
    
    
# rejoin the temperatures to get weekly summaries
week_data <- this_season_data %>%
  select(time, sst, seas, sst_anom, hw_outcomes, wk_start) %>%
  left_join(week_labels, by = "wk_start") 


# Process mean temps
week_summaries <- week_data %>%
  group_by(`Week`, week_position) %>%
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    outcomes = list(hw_outcomes), # list column for showing what days were heatwaves
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .x = week_position)) %>% 
  arrange(week_position)


# Fahrenheit formatting and column labels
week_summaries <- week_summaries %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, 3))) 


# Display Table for the weeks in this season
week_summ_table <- week_summaries  %>% 
  select(Week, temp_f, temp_c, clim_f, clim_c, anom_f, anom_c) %>%
   gt(rowname_col = "Week") %>% 
    tab_header(
    title = md(paste0("**Weekly Sea Surface Temperatures - ", params$season, "**")), 
    #subtitle = paste(month_range)) %>%
    subtitle = "(December 1, 2022 - February 28th, 2023)") %>%
    tab_stubhead(label = md("*One-Week Period*")) %>% 
    tab_spanner(label = md("*Observed Temperature*"), columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), columns = c(`anom_f`, `anom_c`)) %>% 
    fmt_number(columns = c(temp_c, temp_f, clim_f, clim_c, anom_f, anom_c), decimals = 2) %>% 
    cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C") %>% 
    tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatological Reference Period: 1991-2020.*"))


# # Display Table
week_summ_table

```

## Monthly Statistics

```{r}
#| label: monthly-temps
#| tbl-cap: "Observed, climatological average, and deviation from the climatological average (i.e., temperature anomaly) for SST at a monthly resolution in the Gulf of Maine during winter 2022 (defined as Dember 1st - February 28th)"

# Recreate Table for Monthly Averages
monthly_avgs <- this_season_data %>% 
  group_by(yr, month) %>% 
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies"),
    #anom_list = list(sst_anom), # list column for sparkline anomalies
    temp_list = list(sst_f), # list column for sparkline anomalies
    outcomes = list(hw_outcomes),
    .groups = "drop") %>% 
  mutate(across(c(temp_c:anom_f), signif, digits = 3)) 

# Grab info on peak temps
peak_month <- monthly_avgs %>% slice_max(order_by = anom_f, n = 1)
peak_month_full <- month.name[which(month.abb == peak_month$month)]


# Do some benchmarking, where do they all rank by anomalies
month_rankings <- region_hw %>% 
  group_by(yr = year(time), month) %>% 
  summarise(mean_anom = mean(sst_anom), .groups = "drop") %>% 
  group_by(month) %>% 
  arrange(desc(mean_anom)) %>% 
  mutate(rank = rank(-mean_anom)) %>% 
  ungroup() %>% 
  arrange(rank, month)

# Add rankings back
monthly_avgs <- monthly_avgs %>% left_join(
  select(month_rankings, -c(mean_anom)),
  by = join_by(yr, month))
```

@tbl-monthly-temps shows monthly average SST for winter 2022-23, where we see each month was nearly `r ceiling(min(monthly_avgs$anom_f))`°F or more above the 1991-2020 CRP. `r peak_month_full` showed the largest deviation from the long-term climatological average, with an average SST anomaly of `r peak_month$anom_f`°F.

```{r}
#| label: tbl-monthly-temps
#| tbl-cap: "Observed, climatological average, and deviation from the climatological average (i.e., temperature anomaly) for SST at a monthly resolution in the Gulf of Maine during spring 2022 (defined as March 1 through May 31)."

# Create the Monthly Summary Table
month_summ_table <- monthly_avgs %>% 
  select(-c(yr, outcomes)) %>% 
  relocate(rank, .before = temp_c) %>% 
  rename(`Monthly SST Ranking` = rank) %>% 
  mutate(month = factor(month, levels = c("Dec", month.abb[1:11]))) %>% #glimpse()
  gt(rowname_col = 'month') %>% 
     tab_stubhead(label = md("*Month*"))  %>% 
    tab_spanner(label = md("*Observed Temperature*"), 
                columns = c(`temp_f`, `temp_c`)) %>% 
    tab_spanner(label = md("*Climatological Average*"), 
                columns = c(`clim_f`, `clim_c`)) %>% 
    tab_spanner(label = md("*Temperature Anomaly*"), 
                columns = c(`anom_f`, `anom_c`)) %>% 
  tab_spanner(label = md("*Temperature Progression*"), columns = c(`temp_list`)) %>%
  fmt_number(columns = c(temp_c, temp_f, clim_f, clim_c, anom_f, anom_c), decimals = 2) %>% 
  gt_plt_sparkline(
    temp_list,
    palette = c(
      "black",  # sparkline
      "black",  # final value
      gmri_cols("gmri blue")[[1]], # range color low
      gmri_cols("orange")[[1]], # range color high
      "black" # "type" color
  )) %>%
  cols_label(
      temp_f = "\u00b0F",
      temp_c = "\u00b0C",
      clim_f = "\u00b0F",
      clim_c = "\u00b0C",
      anom_f = "\u00b0F",
      anom_c = "\u00b0C",
      temp_list = "High/Low \u00b0F"
      ) %>% 
   tab_source_note(source_note = md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
   tab_source_note(source_note = md("*Climatological Reference Period: 1991-2020.*"))
   


# # Display Table
month_summ_table

```

## Seasonal Trends and Anomalies in Context

```{r}
#| label: seasonal-warming-rates

#---------- Regional Rates

# Decadal Rate
yr_mod         <- lm(temp_f ~ yr, seasonal_avgs)
annual_rate    <- coef(yr_mod)[[2]]
decadal_rate_f <- round((annual_rate*10), 2)


#---------  Global Rates

# # Global Temperature Anomaly Rates
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time)) %>% 
  filter(between(year, 1981, 2023))  %>% 
  pull_heatwave_events(clim_ref_period = c("1991-01-01", "2020-12-23"))
  

# Pull the season, summarize by year
global_season_summary <- global_anoms %>% 
  supplement_season_info() %>% 
  filter(season_eng == params$season) %>% 
  group_by(yr, season_yr, season) %>% 
  summarise(
    sst             = mean(sst, na.rm = T),
    sst_anom        = mean(sst_anom, na.rm = T), 
    sst_f           = as_fahrenheit(sst, "temperature"),
    anom_f          = as_fahrenheit(sst_anom, "anomalies"),
    .groups         = "drop") %>% 
  arrange(desc(sst)) %>%
  #temperature_summaries() %>% 
  mutate(
    yr_as_dtime = as.Date(paste0(yr, "-07-02")),
    anom_direction = ifelse(sst_anom > 0, "Hot", "Cold"))


# Get the global temperature warming rate
# Decadal Rate
global_yr_mod         <- lm(anom_f ~ yr, global_season_summary)
global_annual_rate    <- coef(global_yr_mod)[[2]]
global_decadal_rate_f <- round((global_annual_rate*10), 2)



# Join the data we need together,
# Put the description into the dataframe so we can call it using one geom call
glob_plot_dat <- bind_rows(
  list(
    # 1. Global Ocean Seasonal Data
    "Global Oceans" = select(global_season_summary, yr, season, season_yr, temp_f = sst_f, anom_f) %>% 
      mutate(
        rate = str_c(global_decadal_rate_f, " \u00b0F / Decade"),
        rate_lab = str_c(season_range,  "Global Ocean Warming")),
    
    # 2. Gulf of Maine Seasonal Data
    "Gulf of Maine" = select(seasonal_avgs, yr, season, season_yr, temp_f, anom_f)  %>% 
      mutate(
        rate = str_c(decadal_rate_f, " \u00b0F / Decade"),
        rate_lab = str_c(season_range, " Gulf of Maine Warming"))
  ), .id = "region")


```

The Gulf of Maine is an area of particular interest to the scientific community because of the remarkable rate of warming it has experienced in recent years coupled with its importance as a major driver for the regional economy.

When looking at average `r tolower(params$season)` temperatures from the beginning of the satellite record in 1982 @fig-global-rates, there is a clear long-term increase, with SST's warming at a rate of `r decadal_rate_f`°F per decade. This rate of seasonal wintertime warming is \~4x the rate that global ocean temperatures are warming (`r global_decadal_rate_f`°F per decade).

```{r}
#| label: fig-global-rates
#| eval: true
#| fig-cap: "Average annual winter SSTs in the Gulf of Maine from 1982 through 2022 (black dots). The orange line indicates the trend for the full time series for the Gulf of Maine. The blue line indicates the trend for the full time series for the global oceans."

# Compare warming rates
global_rate_plot <- ggplot(glob_plot_dat) +
  geom_line(data = filter(glob_plot_dat, region == "Gulf of Maine"), 
            aes(yr, anom_f), 
            color = "gray20", linetype = 3, linewidth = 0.5, alpha = 0.5) +
  geom_point(data = filter(glob_plot_dat, region == "Gulf of Maine"), 
            aes(yr, anom_f), 
            color = "gray20", alpha = 0.8) +
  # All year warming rate for GOM
  geom_smooth(aes(yr, anom_f, color = rate), 
              formula = y~x, 
              linetype = 1,
              method = "lm",
              se = FALSE) +
  # Annotation for Warming Rate
  geom_mark_ellipse(aes(filter = region == "Global Oceans" & yr == 2014,
                        x = yr, 
                        y = anom_f,
                        label = region), 
                    label.colour = gmri_cols("gmri blue"),
                    con.colour =  gmri_cols("gmri blue"),
                    label.fill = "transparent", 
                    color = "transparent",
                    label.fontsize = 10) +
  # Annotation for Warming Rate
  geom_mark_ellipse(aes(filter = region == "Gulf of Maine" & yr == 2016,
                        x = yr, 
                        y = anom_f,
                        label = region), 
                    label.colour = gmri_cols("orange"),
                    con.colour =  gmri_cols("orange"),
                    label.fill = "transparent", 
                    color = "transparent",
                    label.fontsize = 10) +
  scale_color_gmri() +
  # Scales
  scale_y_continuous(
    expand = expansion(add = c(1.5, 1.5)),
    labels = number_format(suffix = " \u00b0F")) +
  scale_x_continuous(limits = c(1981, params$year+3)) +
  labs(title = str_c("Gulf of Maine & Global ", params$season, " Warming Rates"),
       x = "Year",
       y = str_c("Average Temperature Anomalies\n(", season_range, ")"),
       color = "1982-2023 Warming Rate")  +
  theme(legend.position = c(0.2, 0.85), legend.title = element_text(face = "bold")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = -0.15, logo_height = 1, height_units = "cm")



global_rate_plot
```

The unprecedented levels of warmth over the past decade or so are consistent with what researchers believe has been a distinct regime shift in terms of the major influences on SSTs in the Gulf of Maine. The drivers of this (e.g., a potential weakening of the Atlantic Meridional Overturning Circulation, widening of the Gulf Stream, changes in the characteristics of the Labrador Current) have been [well-documented in the peer-reviewed literature](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean), including through research by GMRI scientists.

## How Does this `r params$season` Compare?

`r params$year` 2022-23 is the **`r rank_labs`** warmest `r tolower(params$season)` season observed in the Gulf of Maine during the 41 years we have satellite data to analyze. The top 5 warmest `r tolower(params$season)` seasons have all occurred in the last decade.

```{r}
#| label: fig-season-rank
#| fig.height: 4
#| fig-cap: "A ranking of the 5 warmest winter seasons for the Gulf of Maine in the satellite record (1982-2023). 2022-23 was the warmest winter on record; the past three winters were each the warmest until that point; and the five warmest winters have all occurred since 2015."


# Plot them
temp_rankings_p <- seasonal_ranks %>% 
  filter(rank <= 5) %>% 
  mutate(year_rank = fct_reorder(year_rank, rank, .desc = T)) %>% 
  ggplot() +
  geom_col(aes(x = anom_f, y = year_rank, fill = flag_year)) +
  # Year Labels
  geom_text(
    mapping = aes(x = 0, y = year_rank, label = str_c(rank, ".  ", year_rank, " - ", as.numeric(as.character(year_rank))+1)),
    hjust = -.1,
    color = 'white',
    size = 5) +
  # Temperature Labels
  geom_text(
    mapping = aes(x = anom_f, y = year_rank, label = anom_label, group = rank),
    hjust = 1.05,
    color = 'white') +
  scale_x_continuous(
    labels = number_format(suffix = " \u00b0F"), 
    expand = expansion(mult = c(0,0.15))) +
  scale_fill_manual(values = c("flag" = as.character(gmri_cols("orange")), 
                                "unflag" = as.character(gmri_cols("gmri blue")))) +
  labs(x = "Seasonal Temperature Anomaly",
       y = "",
       caption = "",
       title = str_c("Warmest ", params$season, " Temperature Anomalies in the Gulf of Maine")) +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(hjust = 1, face = "bold"),
        axis.ticks.y = element_blank(),
        plot.margin = margin(t = 20, l = 10, r = 5, b = 5)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.14, logo_height = 1, height_units = "cm")


temp_rankings_p

```

## Marine Heatwave Conditions

The most commonly used definition of a ["marine heatwave" (MHW)](http://www.marineheatwaves.org/all-about-mhws.html) is when daily average SSTs exceeded the 90th percentile of a climatological (i.e., 30-year) average for at least 5 consecutive days. Gaps of 2 days or less in this threshold do not constitute a break in the MHW event.

```{r}
#| label: season-mhw-data

# Pull this full year's data, up until end of the season
last_yr_heatwaves <- region_hw %>% 
  filter(
    time >= as.Date(str_c(2022, "-01-01")) + season_start-1)


# Get number of heatwave events and total heatwave days for this year
num_hw_days <- sum(last_yr_heatwaves$mhw_event, na.rm = T)

# Fraction of year in hw?
hw_frac <- round(sum(this_season_data$mhw_event)/nrow(this_season_data) * 100, 2) 

# Dates that aren't hw:
# this_season_data %>% filter(!mhw_event) %>% pull(time)

```


Using this broadly accepted definition, **the Gulf of Maine has experienced MHW conditions for `r round(hw_frac)`% of this `r tolower(params$season)`**. A 16 day period over the New-Year's transition (Dec 27th - January 11th) were the only dates where SST was below the threshold of a MHW. 


```{r}
#| label: fig-season-mhw-timeline
#| eval: true
#| fig-height: 4
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Gulf of Maine extending from December 1, 2022 through February 28, 2023. Black lines represent the long-term (i.e., 1991 – 2020) average SST, the 10th percentile, and 90th percentile for a given day in the Gulf of Maine are labelled to indicate climatological reference points; a solid line (red for marine heatwave or blue for a non-event) indicate the observed SST this year; red and blue shading illustrates how far the observed SST falls from the climatological mean."



# Show MHW Status Through the Year:
hw_temp_p <- year_hw_temps_two(year_hw_dat = last_yr_heatwaves, temp_units = "F") + 
  labs(title = str_c("Winter 2022-23 Gulf of Maine SST"),
       subtitle = str_c("Temperatures through the end of ", tolower(params$season)))  +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.2, logo_height = 1, height_units = "cm")
hw_temp_p


# Number of consecutive days above largest (or closest) integer anomaly
max_int <- max(floor(this_season_data$anom_f))


```

Presenting SST conditions in terms of anomalies (@fig-season-anoms-rework) as opposed to absolute values (@fig-season-mhw-timeline) illustrates in greater detail the magnitude of MHW conditions throughout the `r tolower(params$season)`. The most extreme daily SST anomalies occurred in December, with temperatures exceeding `r max_int`°F above the climatological average. Temperatures fell closer to the CRP average towards the end of December, before rising to the +3 to +4°F range for the second half of January and through February.

```{r}
#| label: fig-season-anoms-rework
#| fig-height: 4
#| eval: true
#| fig-cap: "A timeseries of daily average SST anomalies in the Gulf of Maine (solid red line) compared to marine heatwave (MHW) conditions (dashed black line) in the Gulf of Maine for the period December 1, 2022 through February 28, 2023."


# Show MHW Status Through the Year:
hw_anom_p <- year_hw_anoms_two(year_hw_dat = last_yr_heatwaves, temp_units = "F") + 
  labs(title = str_c("Winter 2022-23 Gulf of Maine SST Anomalies"),
       subtitle = str_c("Temperature anomalies through the end of ", tolower(params$season))) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.2, logo_height = 1, height_units = "cm")
hw_anom_p
```

## Heatmap of Temperature Anomalies and Heatwave Events

Looking at the full record of daily SST anomalies in the Gulf of Maine (@fig-mhw-heatmap), the distinct thermal regime shift beginning around 2010 is evident. Indeed, since 2012, the Gulf of Maine has experienced far more persistent MHW conditions (indicated by solid black lines) than at any other point in the satellite record.

```{r}
#| fig.height: 8
#| label: fig-mhw-heatmap
#| fig-cap: "Heat map of daily SST anomalies from the beginning of 1982 through Winter 2022-23. Not only do more large warm anomalies (darker reds) appear more frequently in recent years, but the frequency, duration, and intensity of marine heatwave events (black lines) in the Gulf of Maine has become more pronounced in the past decade."


base_date <- as.Date("2000-01-01")
# grid_dat <- region_hw %>% 
grid_dat <- sst_new %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev)) 


# All years:
heatmap_p <- grid_dat %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2023) +
  labs(title = "Gulf of Maine Heatwave Record",
       y = "Year",
       x = "Month") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.05, logo_height = 1, height_units = "cm")

heatmap_p + labs(caption = "")
```

## The Visual Impact of a New Climate Reference Period

The identification and communication surrounding marine heatwaves is an area of active scientific discussion. Using our heatmap figure (@fig-mhw-heatmap) as a visual guide, we can compare what the competing MHW methodologies say is the MHW record for the region. The transition to a full climatological reference period that covers all years (1982-2022) and the removal of the long-term trend brings a focus onto only the most "extreme" events. Using the slider below, we can showcase what a transition from the fixed-baseline methodology used in this report (and previous reporting), to an approach that removes long-term trends. 

::: {.juxtapose data-startingposition="65%" style="margin-bottom:2em; width = 70%; height =70%"}

```{r}
#| fig.height: 8
#| label: fig-heatmap-comparison-old

base_date <- as.Date("2000-01-01")
grid_old <- sst_new %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev),
         clim_ref = "MHW Method: 1991-2020 Fixed Basline MHW") 


# All years:
grid_old %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2023) +
  labs(y = "Year",
       x = "Month",
       title = NULL,
       caption = "") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  facet_wrap(~clim_ref) + 
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black"))
```



```{r}
#| fig.height: 8
#| label: fig-heatmap-comparison-new

# Run climatology for new reference period
sst_detrend <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2022-12-31"), detrend = T) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)

# Same thing but with the different heatwave method:
base_date <- as.Date("2000-01-01")
grid_new <- sst_detrend %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev),
         clim_ref = "MHW Method: 1982-2022 De-Trended MHW") 


# All years:
grid_new %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2023) +
  labs(y = "Year",
       x = "Month",
       title = NULL,
       caption = "") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  facet_wrap(~clim_ref) + 
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black"))
```
:::

From this view we can reveal that the transition has removed the majority of marine heatwave events, solving a communication challenge of the "year long heatwave". By adopting this new method scientists have succeeded in identifying the extreme temperature swings, but there is ongoing debate on when to apply this method, and on some of the unintended consequences of doing so. Among the concerns that scientists have voiced is that this new method retroactively changes the history of past events by accommodating all the more recent (often more extreme) conditions. This makes it difficult to preserve the significance that these events had during their own times. 

A second major concern surrounds removing the "trend", and methodological choices scientists must make to achieve this. This new MHW methodology portrays this step in its simplest form, a linear trend. This structure may not be appropriate across all areas and at varying lengths of temporal coverage. The selection choices of the years to include or exclude and how best to model the observed trends create more "knobs" for practitioners to tune and with them more challenges for clarity of communication. To learn more about these tradeoffs and the discussion around Marine Heatwaves, please check out our technical report on the subject.


## Spatial Distribution of Seasonal Anomalies

```{r}
#| label: fig-seasonal-anom-stack

# Set time limits
season_dates <- c(min(this_season_data$time), max(this_season_data$time))

# Spatial Extent Info
x_buffer <- c(-2.75, 3.5)
y_buffer <- c(-2, 1)
crop_x   <- st_bbox(region_extent)[c(1,3)] + x_buffer
crop_y   <- st_bbox(region_extent)[c(2,4)] + y_buffer

# Expanded area as bbox
expanded_area <- structure(c(crop_x, crop_y),  
                           class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()


# Make data window for season
data_window <- data.frame(lon = crop_x,
                          lat = crop_y,
                          time = season_dates)

# Load data - Temperatures
season_anoms_c <- oisst_window_load(
  data_window = data_window, 
  anomalies = T, 
  climate_ref = "1991-2020",
  box_location = "cloudstorage")


# Stack the years
season_anoms_c <- stack(season_anoms_c)


# Convert to F
season_anoms_f <- as_fahrenheit(season_anoms_c, data_type = "anomalies")


####  Records for the Text  ####

# Calculate the average for the season
season_mean <- mean(season_anoms_f, na.rm = T)

# Get the maximum seasonal average temperature for each pixel
max_season <- round(max(values(season_mean), na.rm = T), 2)

# Get the Maximum Daily Temperature Value
max_daily_actual  <- max(values(season_anoms_f), na.rm = T)
max_daily  <- round(max(values(season_anoms_f), na.rm = T), 2)


# Where was it seasonally the highest:
# Flag the exact location
idx <- which.max(season_mean)
pos <- as.data.frame(xyFromCell(season_mean, idx))

# Make some table with context
set.seed(123)
peak_temp_df <- data.frame(
  max_val = str_c(round(max_season, 2), deg_f),
  lon = pos$x,
  lat = pos$y,
  do_circle = T) %>% 
  mutate(descr = "Largest Seasonally-Averaged SST Anomaly") %>% 
  bind_rows(
    data.frame(
      max_val = rep(NA, 25),
      lon = rnorm(25,mean = -68.25, sd = 2),
      lat = rnorm(25,mean = 43, sd = 2),
      do_circle = rep(F, 25),
      descr = rep("", 25)
    )
  )
```



```{r}
#| label: fig-warmest-anom-map
#| eval: false
#| echo: false

#### Where did the Most Extreme Heat Occur:

# Where did the max daily temp happen?
f <- function(x) which(x == max_daily_actual)[1] 
x <- calc(season_anoms_f, f)
#plot(x)

# When did that happen?
peak_date_lyr <- as.data.frame(x) %>% 
  filter(!is.na(layer)) %>% 
  as.numeric()

# Get the date back
peak_date <- names(season_anoms_f)[peak_date_lyr] %>% 
  str_replace("X", "") %>% str_replace_all("[.]", "-")

# Plot the map to confirm
#plot(season_anoms_f[[peak_date_lyr]], main = peak_date)

# Flag the exact location
max_val <- round(cellStats(x = season_anoms_f[[peak_date_lyr]], stat = max), 2)
idx <- which.max(season_anoms_f[[peak_date_lyr]])
pos <- as.data.frame(xyFromCell(season_anoms_f[[peak_date_lyr]], idx))

# Make some table with context
set.seed(123)
peak_temp_df <- data.frame(
  "date" = peak_date,
  max_val = max_val,
  lon = pos$x,
  lat = pos$y,
  do_circle = T) %>% 
  mutate(descr = str_c("Highest single day SST anomaly: ", round(max_val, 2), deg_f)) %>% 
  bind_rows(
    data.frame(
      "date" = rep(NA, 25),
      max_val = rep(NA, 25),
      lon = rnorm(25,mean = -68.25, sd = 2),
      lat = rnorm(25,mean = 43, sd = 2),
      do_circle = rep(F, 25),
      descr = rep("", 25)
    )
  )

```

From a spatial perspective, the Gulf of Maine and (most) surrounding areas experienced above average SSTs during `r tolower(params$season)` 2022-23, but the warmest patches were to the south and east of Georges Bank, mostly outside the domain analyzed in preceding sections. The highest seasonally averaged anomaly of any location above was `r max_season`°F - along the southern edge of the domain analyzed.

```{r}
#| label: contour-details
# Add the bottom contours:
bathy <- raster("~/Documents/Repositories/Points_and_contours/NEShelf_Etopo1_bathy.tiff")

# Contours for geom_contour()
bathy_df <- as.data.frame(raster::coordinates(bathy))
bathy_df$depth <- raster::extract(bathy, bathy_df)
bathy_df$depth <- bathy_df$depth * -1
contours_make <- c(200)

```



```{r}
#| label: fig-season-anom-map
#| fig.width: 8
#| fig.height: 8
#| fig-cap: "Map of average SST anomalies for each grid cell in the satellite record for winter 2022-23. The box outlined by the black dashed line denotes the region of study for the analysis (see @fig-map). Darker red regions indicate warmer anomalies."

# Make the seasonal average a stars class to plot with ggplot
anoms_st <- st_as_stars(season_mean)


# Set Plot legend limits
temp_limits <- c(-8, 8)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")



#### 1. Map the Anomalies in Space
season_map <- ggplot() +
  geom_stars(data = anoms_st) +
  geom_contour(data = bathy_df, aes(x, y, z = depth),
                     breaks = contours_make,
                     color = "gray20", 
               linewidth = 0.25) +
  geom_sf(data = new_england, fill = "gray90", linewidth = .25) +
  geom_sf(data = canada, fill = "gray90", linewidth = .25) +
  geom_sf(data = greenland, fill = "gray90", linewidth = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, 
          linewidth = 1,
          fill = "transparent") +
  geom_point(
    data = drop_na(peak_temp_df),
    aes(lon, lat), color = "black", shape = 22, fill = "transparent", size = 5) +
  geom_mark_ellipse(
    data = peak_temp_df,
    aes(lon, lat, 
        filter = do_circle == T,
        label = max_val, description = descr), 
    color = "black", 
    label.fill = "#FAFAFA90") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits,
                       breaks = temp_breaks,
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  map_theme(legend.position = "bottom") +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = F) +
  guides("fill" = guide_colorbar(
    title = expression("Surface Temperature Anomaly"),
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(title = str_c("Seasonal Temperature Anomaly\n", params$season, ", 2022-", params$year),
       caption = "200m contour overlaid to show topographic details.")

# Show figure
season_map

```

## Monthly Temperature Anomalies

Average monthly SST anomalies are shown in @fig-monthly-avg-map. The warmest anomalies were observed in December and February and were largely confined to areas just beyond the region of study (i.e, beyond the continental shelf where the Gulf Stream and Labrador Current have significantly more influence on oceanic conditions).

```{r}
#| label: fig-monthly-avg-map
#| eval: true
#| fig.width: 8
#| fig.height: 4
#| fig.align: center
#| fig-cap: "This series of maps shows the average monthly SST anomaly for December 2022, January 2023, and February 2023. The box outlined by the black dashed line denotes the region of study for the analysis. Darker red regions indicate warmer anomalies."


# Get monthly averages
season_nums    <- unique(str_sub(names(season_anoms_f), 7,8))
month_names    <- month.name[as.numeric(season_nums)]


# Pull the layers for each and average them:
display_months <- map(season_nums, function(month_idx){
  
  which_dates <- which(str_sub(names(season_anoms_f), 7,8) == month_idx)
  month_mean <- mean(season_anoms_f[[which_dates]], na.rm = T)
  }) %>% setNames(month_names)



# Perform masking
months_masked <- map(display_months, mask_nc, expanded_area, rotate = FALSE)


# Set contours to show
# Show less contours b/c smaller map
contours_make <- c(200)

# Make plots for each
month_plots <- imap(months_masked, 
                    monthly_sst_map, 
                    plot_yr = params$year,
                    depth_contours = contours_make, 
                    temp_lim = 8,
                    convert_to_f = FALSE)


# assemble aggregate plot
monthly_maps <- (
  month_plots[[1]] + labs(title = "December 2022")| 
    month_plots[[2]] | 
    month_plots[[3]]) + 
  plot_layout(guides = "collect")  & 
  theme(
    legend.position = 'bottom', 
    plot.margin = margin(t = 0, b = 0, r = 0.5, l = 0.5)) 


monthly_maps + plot_annotation(caption = "200m contour overlaid to show topographic details.")
```

## A Note on Data Sources:

> NOAA_ERSST_V5 data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.ersst.v5.html.

> NOAA High Resolution SST data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.highres.html.

### Citing This Work

If you would like to cite this report, please use:

> Gulf of Maine Research Institute. 2022. Gulf of Maine Warming Update: `r params$season` `r params$year`

```{r}
#| label: figure-saving
#| echo: false


# Export Figures
if(params$save_figures){
  
  # Folder for Comms Team Update
  comm_folder <- cs_path("root", "Program Communications/Climate Center — Program Communications/Warming Updates/Visuals/")
  update_folder <- str_c(
    comm_folder, 
    params$season, " ", params$year, "/")
  
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, 
         filename = str_c(update_folder, "GOM_Extent.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Weekly Report Table
  gtsave(data = week_summ_table, 
         filename = str_c(update_folder, "weekly_summary_table.png"))
  
  
  # Monthly Report Table
  gtsave(data = month_summ_table, 
         filename = str_c(update_folder, "monthly_summary_table.png"))
  
  
  # # Seasonal Temperature Plot
  # ggsave(plot = seasonal_temp_p, 
  #        filename = str_c(update_folder, "Seasonal_temp_plot.png"), 
  #        height = unit(5, "in"),
  #        width = unit(8, "in"),
  #        dpi = "retina", 
  #        bg = "transparent")
  
  # Seasonal Rates Plot
  ggsave(plot = global_rate_plot, 
         filename = str_c(update_folder, "Seasonal_rates_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Seasonal Temp Rankings
  ggsave(plot = temp_rankings_p, 
         filename = str_c(update_folder, "Seasonal_temp_ranks_plot.png"), 
         height = unit(4, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")

  
  # Heatwave Temperature Plot
  ggsave(plot = hw_temp_p, 
         filename = str_c(update_folder, "Heatwave_temp_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Heatwave Anomaly Plot
  ggsave(plot = hw_anom_p, 
         filename = str_c(update_folder, "Heatwave_anom_plot.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # heatwave heatmap
  ggsave(plot = heatmap_p, 
         filename = str_c(update_folder, "Heatwave_Heatmap.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # # monthly heatmap
  # ggsave(plot = month_heatmap,
  #        filename = str_c(update_folder, "monthly_heatwave_heatmap.png"), 
  #        height = unit(4, "in"),
  #        width = unit(8, "in"),
  #        dpi = "retina", 
  #        bg = "transparent")
  
  
  # Season Map
  ggsave(plot = season_map, 
         filename = str_c(update_folder, "Seasonal_anom_map.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  # monthly maps
  ggsave(plot = monthly_maps,
         filename = str_c(update_folder, "Monthly_anom_maps.png"), 
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
}
```

```{r}
#| label: data-save
#| echo: false

####  Saving the Data  ####

if(params$save_data){
  

  # Rename so there is 0 chance of confusion
  save_season_avg <- seasonal_avgs %>% 
    select(
      year = yr,
      months = season,
      temp_c = mean_temp,
      temp_f = temp_f,
      climate_avg_c = mean_clim,
      climate_avg_f = clim_f,
      temp_anom_c = mean_anom,
      temp_anom_f = anom_f) %>% 
    mutate(season = params$season, .before = "months") %>% 
    mutate(across(where(is.numeric), round,2))
   
  
  # Save locally
  update_name <- str_c(here("R/markdown_reports/seasonal_update_data/"),
                       "Gulf-of-Maine_SST_",
                       params$season,
                       "_Averages_GMRI_",
                       str_remove_all(Sys.Date(), "[-]"),
                       ".csv")
  write_csv(save_season_avg, 
            file = update_name)
}
```

```{r}
#| results: asis
insert_gmri_footer()
```
