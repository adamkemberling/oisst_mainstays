---
title: "Gulf of Maine Seasonal Sea Surface Temperature Update"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  Seasonal Patterns in Sea Surface Temperatures
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
    css:
      - https://cdn.knightlab.com/libs/juxtapose/latest/css/juxtapose.css
execute: 
  echo: false
  warning: false
  message: false
  comment: ""
  fig.align: center
params: 
  year: 2023
  season: "Fall"
  save_data: FALSE
  save_figures: TRUE
---

```{r}
#| label: packages
#| include: false
#| echo: false
#| warning: false

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggforce)
library(geomtextpath)
library(showtext)
library(gtable)
library(ggpubr)
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("lag", "dplyr")
conflicted::conflict_prefer("rotate", "raster")

# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# Box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")
canada      <- ne_states("canada", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")


# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     box_location = "cloudstorage")

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
```

```{r}
#| label: style-sheet
#| results: asis

# Use GMRI style
use_gmri_style_rmd()

```

```{r}
#| label: fonts-config
#| echo: false

# # Using Raleway Font because it works
# sysfonts::font_add_google("Raleway")

# Path to the directory containing the font file (replace with your actual path)
font_dir <- paste0(system.file("stylesheets", package = "gmRi"), "/GMRI_fonts/Avenir/")

# Register the font
font_add(
  family = "Avenir",
  file.path(font_dir, "LTe50342.ttf"),
  bold = file.path(font_dir, "LTe50340.ttf"),
  italic = file.path(font_dir, "LTe50343.ttf"),
  bolditalic = file.path(font_dir, "LTe50347.ttf"))


# Why is the gt package able to add it wtf!!
# google_font(name = "Avenir")

# Load the font
showtext::showtext_auto()

```

```{r}
#| label: param-setup
#| echo: false

#####  Parameter option switches:  ####
season_deets <- season_text_details(season_op = params$season, year_op = params$year)

# Set color for the season based on the parameter:
season_col <- season_deets$season_color

# Configure edges/centers of each season for label positioning
season_cent  <- season_deets$center_date
season_left  <- season_deets$left_lim
season_right <- season_deets$right_lim
season_start <- season_deets$season_start_doy
season_end   <- season_deets$season_end_doy

# Make names for the months to pull based on the season and current year
season_months <- season_deets$month_range

# Names of start and end month for text:
season_range <- season_deets$range_label

# Months/Dates covered by each season for use as labels
month_range <- switch(params$season,
  "Winter" = str_c("(December 1, ", params$year-1," - February 28, ", params$year,")"),
  "Spring" = str_c("(March 1, ", params$year," - May 31, ", params$year,")"),
  "Summer" = str_c("(June 1, ", params$year," - August 31, ", params$year,")"),
  "Fall" =   str_c("(September 1, ", params$year," - November 30, ", params$year,")"))
```

```{r}
#| label: region-ts-prep

# Timeseries Path +
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Load timeseries of SST for Region
region_timeseries <- read_csv(
  timeseries_path, 
  col_types = cols(), 
  guess_max = 1e5) 

# Format timeseries for group estimates
region_timeseries <- region_timeseries %>% 
  mutate(
    time = as.Date(time),
    area_wtd_f = as_fahrenheit(area_wtd_sst),
    anom_f     = as_fahrenheit(area_wtd_anom, "anomalies")) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:params$year))


####  Get heatwave statuses for each day:

# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries,
  threshold = 90, 
  clim_ref_period = c("1991-01-01", "2020-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366, # handle leap years
         time <= as.Date(str_c(params$year, season_right))) # remove dates past the seasonal update

# Set up heatwave status outcomes for fancy gtextras table features:
region_hw <- region_hw %>% 
  mutate(
    hw_outcomes = case_when(
      mhw_event == TRUE ~ 1,
      mcs_event == TRUE ~ 0,
      TRUE ~ 0.5))


####  Prepare Data for This Seasonal Summary

# Subset data for the season were looking at
this_season_data <- region_hw %>% 
  dplyr::filter(season_eng == params$season,
                #season_yr == params$year-1) # Works for winter
                season_yr == params$year) # Messed up for winter

# Set seasonal end date so weeks don't bleed over
first_day <- as.Date(min(this_season_data$time))
last_day  <- as.Date(max(this_season_data$time))

# Set week start in the data so we can merge labels in accordingly later
this_season_data <-  this_season_data %>% 
  mutate(wk_start = floor_date(time, unit = "week"),
         wk_start = if_else(wk_start < first_day, first_day, wk_start),
         wk_start = as.Date(wk_start))
```

```{r}
#| label: seasonal-temp-summary

# 1. Get the overall all year averages

# Set the start year, use 1981 if season is winter
ssn_year_start <- ifelse(params$season == "Winter", 1981, 1982)

# Get the average temperature for all years as a baseline
all_year_season_avg <- region_hw %>% 
  filter(season_yr %in% c(ssn_year_start:params$year),
         season_eng == params$season) %>% 
  group_by(season_eng) %>% 
  summarise(avg_temp_c = mean(sst),
            avg_anom_c = mean(sst_anom),
            avg_clim_c = mean(seas),
            avg_temp_f = mean(sst_f),
            avg_clim_f = mean(seas_f),
            avg_anom_f = mean(anom_f),
            .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))


# 2. Get Averages for each year individually, 
seasonal_avgs <- region_hw %>% 
  filter(
    season_eng == params$season, 
    season_yr %in% c(ssn_year_start:params$year)) %>% 
  group_by(season_yr, season) %>% 
  summarise(
    # Uses Area Weighted SST
    mean_temp = mean(sst),
    mean_clim = mean(seas),
    mean_clim = median(mean_clim), # Makes sure any odd years (leap year or incomplete) are not different
    mean_anom = mean(sst_anom),
    temp_f    = as_fahrenheit(mean_temp),
    clim_f    = as_fahrenheit(mean_clim),
    anom_f    = as_fahrenheit(mean_anom, data_type = "anomalies"),
    .groups = "drop") %>% 
  mutate(
     year = season_yr,
     yr = season_yr,
     season_center = as.Date(str_c(yr, season_cent)),
     season_llim   = as.Date(str_c(yr, season_left)),
     season_rlim   = as.Date(str_c(yr, season_right)),
     temp_label    = str_c(round(temp_f, 2), " \u00b0F  |  ", round(mean_temp, 2), " \u00b0C"),
     anom_label    = str_c(round(anom_f, 2), " \u00b0F  |  ", round(mean_anom, 2), " \u00b0C")
  )
  
# Ranking the hottest years - on seasonal temperature
seasonal_ranks <- seasonal_avgs %>% 
  mutate(
    yr = factor(yr),
    year_rank = fct_reorder(.f = yr, .x = mean_temp, .fun = median, .desc = TRUE)) %>% 
  arrange(year_rank) %>% 
  mutate(rank = row_number(),
         flag_year = ifelse(year_rank == params$year, "flag", "unflag")  
         #flag_year = ifelse(year_rank == 2022, "flag", "unflag") # WINTER control
)

```



```{r}
#| label: seasonal-warming-rates

#---------- Regional Rates

# Decadal Rate
yr_mod         <- lm(temp_f ~ yr, seasonal_avgs)
annual_rate    <- coef(yr_mod)[[2]]
decadal_rate_f <- round((annual_rate*10), 2)


#---------  Global Rates

# Global Temperature Anomaly Rates
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time)) %>% 
  filter(between(year, 1981, 2023))  %>% 
  pull_heatwave_events(clim_ref_period = c("1991-01-01", "2020-12-23"))
  

# Pull the season, summarize by year
global_season_summary <- global_anoms %>% 
  supplement_season_info() %>% 
  filter(season_eng == params$season) %>% 
  group_by(yr, season_yr, season) %>% 
  summarise(
    sst             = mean(sst, na.rm = T),
    sst_anom        = mean(sst_anom, na.rm = T), 
    sst_f           = as_fahrenheit(sst, "temperature"),
    anom_f          = as_fahrenheit(sst_anom, "anomalies"),
    .groups         = "drop") %>% 
  arrange(desc(sst)) %>%
  #temperature_summaries() %>% 
  mutate(
    yr_as_dtime = as.Date(paste0(yr, "-07-02")),
    anom_direction = ifelse(sst_anom > 0, "Hot", "Cold"))


# Get the global temperature warming rate
# Decadal Rate
global_yr_mod         <- lm(anom_f ~ yr, global_season_summary)
global_annual_rate    <- coef(global_yr_mod)[[2]]
global_decadal_rate_f <- round((global_annual_rate*10), 2)


# Join the data we need together,
# Put the description into the dataframe so we can call it using one geom call
glob_plot_dat <- bind_rows(
  list(
    
    # 1. Global Ocean Seasonal Data
    "Global Oceans" = select(global_season_summary, yr, season, season_yr, temp_f = sst_f, anom_f) %>% 
      mutate(
        rate = str_c(global_decadal_rate_f, " \u00b0F / Decade"),
        rate_lab = str_c(season_range,  "Global Ocean Warming")),
    
    # 2. Gulf of Maine Seasonal Data
    "Gulf of Maine" = select(seasonal_avgs, yr, season, season_yr, temp_f, anom_f)  %>% 
      mutate(
        rate = str_c(decadal_rate_f, " \u00b0F / Decade"),
        rate_lab = str_c(season_range, " Gulf of Maine Warming"))), 
  
  # Label what area the rates are for
  .id = "region")

```

# About the Updates:

Over the past decade, scientists at [the Gulf of Maine Research Institute](https://www.gmri.org) have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To keep you informed, we share seasonal updates about conditions in the Gulf of Maine.

> **Note About the Data:** The figures in this report are created using remotely-sensed satellite data as part of publicly funded research efforts. Satellite SST data was obtained from NOAA's National Center for Environmental Information (NCEI), with all maps and figures displaying [NOAA's Optimum Interpolation Sea Surface Temperature Data](https://www.ncei.noaa.gov/products/optimum-interpolation-sst).

# The Gulf of Maine Region

For analyses like these, it is important to be clear about the spatial extent that "defines" the Gulf of Maine (@fig-map), as different borders could produce different results. The spatial domain we use as the "Gulf of Maine" is displayed below. This area is consistent with previous seasonal and annual reports that scientists at GMRI have produced.

```{r}
#| label: bathy-contour-details

# Add the bottom contours:
bathy <- raster("~/Documents/Repositories/Points_and_contours/NEShelf_Etopo1_bathy.tiff")

# Contours for geom_contour()
bathy_df <- as.data.frame(raster::coordinates(bathy))
bathy_df$depth <- raster::extract(bathy, bathy_df)
bathy_df$depth <- bathy_df$depth * -1
contours_make <- c(200)


# Or make terra for ggplot using tidyterra
elev_terra <- terra::rast(bathy)

```

```{r}
#| label: fig-map
#| fig.width: 8
#| fig.height: 8
#| fig.cap: "Spatial domain used for Gulf of Maine SST analyses. Depth contours are colored at 100 m intervals up to 600 m; deeper blues indicate deeper water depths"
#| fig.alt: "An overhead view of the Gulf of Maine region. Landmasses and political boundaries for the United States and Canada are displayed. A blue dotted line outlining a box with a transparent blue fill is shown to demark where satellite data for the analysis has been used."

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)

# Map the Gulf of Maine with Bathymetry
gom_extent_p <- map_study_area_color(
  region_extent = region_extent,
  new_england_sf = new_england,
  canada_sf = canada,
  greenland_sf = greenland) +
  labs(
    title = "Gulf of Maine Study Area",
    caption = NULL) +
  theme(text = element_text(family = "Avenir"))


# Show figure
gom_extent_p

```

# `r params$season` Highlights

```{r}
#| label: season-highlights

# Average Temp+Anom Stats for that season Used in Text
season_avg_temp <- round(mean(this_season_data$sst_f, na.rm = T), 2)
season_avg_anom <- round(mean(this_season_data$anom_f, na.rm = T), 2)
season_avg_clim <- round(mean(this_season_data$seas_f, na.rm = T), 2)

# What rank are we this year?
if(params$season == "Winter"){
  current_rank <- seasonal_ranks %>% 
    filter(yr == params$year-1) %>% 
    pull(rank) } else{
  current_rank <- seasonal_ranks %>% 
    filter(yr == params$year) %>% 
    pull(rank)
}


# In-Text friendly version
rank_labs <- switch(current_rank,
  "1" = "new",
  "2" = "2nd",
  "3" = "3rd",
  "4" = "4th",
  "5" = "5th",
  "6" = "6th",
  "7" = "7th",
  "8" = "8th",
  "9" = "9th",
  "10" = "10th",
  "11" = "11th",
  "12" = "12th",
  "13" = "13th",
  "14" = "14th",
  "15" = "15th"
  )

# Get max anom year and max anom
max_anom_yr <- seasonal_avgs %>% 
  arrange(desc(mean_anom)) %>% 
  slice(1) %>% 
  mutate(across(where(is.numeric), \(x) round(x, 3)))

```

For this seasonal report we present an analysis of SST for `r tolower(params$season)` `r month_range`. During this season, the average SST for the Gulf of Maine was `r season_avg_temp`°F, making it the `r rank_labs` hottest `r tolower(params$season)` on record for the period of 1982-2023 --- the period over which the satellite data used are available. This seasonal average temperature is `r season_avg_anom`°F above the 1991--2020 climatological reference period (CRP) `r params$season` average of `r season_avg_clim`°F.

## Weekly Temperatures

In @tbl-season-temps we highlight how the SST for each week this `r tolower(params$season)` compares to the 1991-2020 CRP for the area shown in @fig-map. The observed SST, long-term average SST, and SST anomalies (i.e., departures from the long-term average SST) are shown. 

SST departures from that long-term average were on average `r round(mean(this_season_data$anom_f),2)`°F or more above normal during the fall. With weekly averaged SST anomalies ranging from -1.79°F to +3.85°F.

```{r}
#| label: week-summary-data-prep

# Format the start/end dates for weekly subsets
# Determine bookends for weeks and trim to season bookends
week_labels <- this_season_data  %>% 
  mutate(
    wk_end = ceiling_date(time, unit = "week"),
    wk_end = if_else(wk_end >= last_day, last_day, wk_end - 1)) %>% 
  
  # pull distinct weeks
  distinct(time, wk_start, wk_end)  %>% 
  
  # Add the month and day labels
  mutate(
    start_month = month(wk_start, label = T, abbr = T),
    end_month   = month(wk_end, label = T, abbr = T),
    start_day   = str_pad(day(wk_start), pad = "0", side = "left", width = 2),
    end_day     = str_pad(day(wk_end), pad = "0", side = "left", width = 2),
    `Week`      = str_c(start_month, " ", start_day, " - ", end_month, " ", end_day),
    `Week`      = factor(`Week`)) %>%
  
  # Ensure distinct weeks only, and arrange in chronological order
  distinct(`Week`, .keep_all = T) %>% 
  arrange(wk_start) %>% 
  mutate(week_position = row_number()) %>% 
  select(-time)
    
    
# rejoin the temperatures to get weekly summaries
week_data <- this_season_data %>%
  select(time, sst, seas, sst_anom, hw_outcomes, wk_start) %>%
  left_join(week_labels, by = "wk_start") 


# Process mean temps
week_summaries <- week_data %>%
  group_by(`Week`, week_position) %>%
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    outcomes = list(hw_outcomes), # list column for showing what days were heatwaves
    .groups = "drop") %>% 
  mutate(`Week` = fct_reorder(`Week`, .x = week_position)) %>% 
  arrange(week_position)


# Fahrenheit formatting and column labels
week_summaries <- week_summaries %>%
  mutate(
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, 3)))

```



```{r}
#| label: tbl-season-temps
#| #| tbl-cap-location: bottom
#| tbl-cap: "Average weekly sea surface temperatures in the Gulf of Maine"

week_summ_table <- week_summaries %>% 
  mutate(
    temp = md(str_c(temp_f, deg_f, " *(", temp_c, deg_c, ")*")),
    clim = str_c(clim_f, deg_f, " *(", clim_c, deg_c, ")*"),
    anom = str_c(anom_f, deg_f, " *(", anom_c, deg_c, ")*"),
    Week = str_c("*", Week, "*")) %>% 
  select(Week, temp, clim, anom) %>%
   gt(rowname_col = "Week") %>% 
  tab_header(
    title = md(paste0("Table 1. Weekly Averaged Sea Surface Temperatures - ", params$season)), 
    subtitle = month_range) %>%
    tab_stubhead(label = md("One-Week Period")) %>% 
  fmt_markdown(
  columns = everything(),
  rows = everything(),
  md_engine = c("markdown", "commonmark")) %>% 
  # Change the column names to the units
    cols_label(
      temp = md("Observed Temperature"),
      clim = md("Climatological Average"),
      anom = md("Temperature Anomaly")) %>% 
    tab_source_note(md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
    tab_source_note(md("*Climatological Reference Period: 1991-2020.*")) %>%    
    #opt_table_font(font = list(google_font(name = "Avenir")))
    opt_table_font(font = list(google_font(name = "Raleway")))

# Show Table
week_summ_table
  

# How to spit out the raw html:
# # | eval: false
# # | results: asis
# # | label: table-html-isolation

#week_summ_table %>% gt::as_raw_html()
```

## Monthly Statistics

```{r}
#| label: monthly-temps

# Recreate Table for Monthly Averages
monthly_avgs <- this_season_data %>% 
  group_by(yr, month) %>% 
  summarise(
    temp_c = mean(sst),
    clim_c = mean(seas),
    anom_c = mean(sst_anom),
    temp_f = as_fahrenheit(temp_c),
    clim_f = as_fahrenheit(clim_c),
    anom_f = as_fahrenheit(anom_c, data_type = "anomalies"),
    temp_list = list(sst_f), # list column for sparkline anomalies
    outcomes = list(hw_outcomes),
    .groups = "drop") %>% 
  mutate(across(c(temp_c:anom_f), \(x) signif(x, digits = 3))) 

# Grab info on peak temps
peak_month <- monthly_avgs %>% slice_max(order_by = anom_f, n = 1)
peak_month_full <- month.name[which(month.abb == peak_month$month)]


# Do some benchmarking, where do they all rank by anomalies
month_rankings <- region_hw %>% 
  group_by(yr = year(time), month) %>% 
  summarise(mean_anom = mean(sst_anom), .groups = "drop") %>% 
  group_by(month) %>% 
  arrange(desc(mean_anom)) %>% 
  mutate(rank = rank(-mean_anom)) %>% 
  ungroup() %>% 
  arrange(rank, month)

# Add rankings back
monthly_avgs <- monthly_avgs %>% left_join(
  select(month_rankings, -c(mean_anom)),
  by = join_by(yr, month))

```

@tbl-monthly-temps shows monthly average SST for `r tolower(params$season)` `r params$year`, where we see each month was nearly `r ceiling(min(monthly_avgs$anom_f))`°F or more above the 1991-2020 CRP. `r peak_month_full` showed the largest deviation from the long-term climatological average, with an average SST anomaly of `r peak_month$anom_f` °F.

```{r}
#| label: tbl-monthly-temps
#| tbl-cap-location: bottom
#| tbl-cap: "Average monthly sea surface temperatures in the Gulf of Maine"

# Create the Monthly Summary Table
month_summ_table <- monthly_avgs %>% 
  mutate(
    temp = md(str_c(temp_f, deg_f, " *(", temp_c, deg_c, ")*")),
    clim = str_c(clim_f, deg_f, " *(", clim_c, deg_c, ")*"),
    anom = str_c(anom_f, deg_f, " *(", anom_c, deg_c, ")*"),
    month = str_c("*", month, "*")) %>% 
  select(month, rank, temp, clim, anom) %>%
   gt(rowname_col = "month") %>% 
  tab_header(
    title = md(paste0("Table 2. Monthly Averaged Sea Surface Temperatures - ", params$season, "")), 
    subtitle = month_range) %>%
    tab_stubhead(label = md("Month")) %>% 
  fmt_markdown(
  columns = everything(),
  rows = everything(),
  md_engine = c("markdown", "commonmark")) %>% 
  # Change the column names to the units
    cols_label(
      rank = md("Rank (1982-2023)"),
      temp = md("Observed Temperature"),
      clim = md("Climatological Average"),
      anom = md("Temperature Anomaly")) %>% 
  tab_source_note(md("*Data Source: NOAA OISSTv2 Daily Sea Surface Temperature Data.*") ) %>% 
  tab_source_note(md("*Climatological Reference Period: 1991-2020.*")) %>% 
  #opt_table_font(font = list(google_font(name = "Avenir")))
  opt_table_font(font = list(google_font(name = "Raleway")))

# # Display Table
month_summ_table

```

## How Does this `r params$season` Compare?

`r params$year` is the **`r rank_labs`** warmest `r tolower(params$season)` season observed in the Gulf of Maine during the 41 years we have satellite data to analyze, a departure from a recent trend in above average fall temperatures in the last decade. Seasonal SST in 2023 fell 2.75F when compared to 2022. This marks the largest single-year decline in year-over-year fall temperatures. 

```{r}
#| label: fig-season-rank
#| fig.height: 6
#| fig-cap: "A ranking of the 10 warmest summer seasons for the Gulf of Maine in the satellite record (1982-2023). 2023 was the eighth warmest summer on record."

# usually this height
# fig.height: 6

# Do some data prep
rank_plot_data <- seasonal_ranks %>% 
  filter(rank <= 15) %>% 
  mutate(
    year_rank = fct_reorder(year_rank, rank, .desc = T),
    rank = fct_rev(factor(rank)),
    flag_col = ifelse(flag_year == "flag", gmri_cols("orange"), gmri_cols("blue"))) 


# Plot them
temp_rankings_p <- rank_plot_data %>% 
  ggplot() +
  geom_col(aes(x = anom_f, y = rank, fill = I(flag_col)))+
  # Year Labels
  geom_text(
    mapping = aes(
      x = 0, 
      y = rank, 
      label = str_c( year_rank)), # No numbering WINTER Control
      #label = str_c(rank, ".  ", year_rank)), # WINTER Control
    fontface = "bold",
    hjust = -.05,
    color = 'white',
    size = 5) +
  # # Temperature Labels - Inside Bars
  # geom_text(
  #   mapping = aes(x = anom_f, y = year_rank, label = anom_label, group = rank),
  #   hjust = 1.05,
  #   color = 'white',
  #   size = 4) +
  # Temperature Labels - Outside Bars
  geom_text(
    mapping = aes(
      x = anom_f, y = rank, 
      label = anom_label, group = rank, color = I(flag_col)),
    hjust = -.05, size = 4, show.legend = F) +
  scale_x_continuous(
    labels = number_format(suffix = " \u00b0F"), 
    expand = expansion(mult = c(0,0.25))) +
  labs(
    x = "Seasonal SST Anomaly",
    y = "Rank",
    caption = "",
    title = str_c("Gulf of Maine's Warmest ", params$season, " SST Anomalies")) +
  theme(
    #panel.grid.major.x = element_line(color = "gray90"),
    plot.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    axis.line.x = element_blank(),
    legend.position = "none", 
    plot.margin = margin(t = 20, l = 10, r = 5, b = 5)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.875, y_npc = 1.075, logo_height = 1, height_units = "cm")


temp_rankings_p

```



## Seasonal Trends and Long-Term Global Context

The Gulf of Maine is an area of particular interest to the scientific community because of the remarkable rate of warming it has experienced in recent years coupled with its importance as a major driver for the regional economy.

When looking at average `r tolower(params$season)` temperatures from the beginning of the satellite record in 1982 @fig-global-rates, there is a clear long-term increase, with SST's warming at a rate of `r decadal_rate_f`°F per decade. This rate of seasonal spring warming is ~4x the rate that global ocean temperatures are warming (`r global_decadal_rate_f`°F per decade).

```{r}
#| label: fig-global-rates
#| eval: true
#| fig-cap: "Average annual spring SSTs in the Gulf of Maine from 1982 through 2022 (black dots). The orange line indicates the trend for the full time series for the Gulf of Maine. The blue line indicates the trend for the full time series for the global oceans."

# Make a standalon legend for the points:
l2 <- ggplot(glob_plot_dat) +
  geom_point(
    data = filter(glob_plot_dat, region == "Gulf of Maine"), 
    aes(yr, anom_f, shape = "Gulf of Maine Seasonal Average SST"), 
    color = "gray20", 
    size = 2,
    alpha = 0.8) +
  labs(shape = NULL) +
  theme(text = element_text(family = "Avenir"))
leg2 <- gtable_filter(ggplot_gtable(ggplot_build(l2)), "guide-box") 


# Compare warming rates
global_rate_plot <- ggplot(glob_plot_dat) +
  geom_line(
    data = filter(glob_plot_dat, region == "Gulf of Maine"), 
    aes(yr, anom_f), 
    color = "gray20", linetype = 3, linewidth = 0.5, alpha = 0.5) +
  geom_point(
    data = filter(glob_plot_dat, region == "Gulf of Maine"), 
    aes(yr, anom_f), 
    color = "gray20", 
    size = 2,
    alpha = 0.8) +
  annotation_custom(grob = leg2, xmin = 2010, xmax = 2021, ymin = -3.6, ymax = -3.3) +
  # All year warming rate for GOM
  geom_smooth(
    aes(yr, anom_f, color = str_c(region, " Trend\n", rate)), 
    formula = y~x, 
    linetype = 1,
    method = "lm",
    se = FALSE) +
  scale_color_gmri() +
  # Scales
  scale_y_continuous(
    expand = expansion(add = c(1.5, 1.5)),
    labels = number_format(suffix = " \u00b0F")) +
  scale_x_continuous(limits = c(1981, params$year+3)) +
  theme(
    legend.position = c(0.35, 0.85), 
    legend.background = element_rect(fill = "white", color = "black")) +
  guides(color = guide_legend(title.position = "top", title.hjust = 0.5, nrow = 1)) +
  labs(title = str_c(params$season, " SST Warming Rates"),
       x = "Year",
       y = str_c("Sea Surface Temperature Anomalies\n(", season_range, ")"),
       color = "1982-2023 Warming Rates")  +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")



 global_rate_plot
```

The unprecedented levels of warmth over the past decade or so are consistent with what researchers describe as a distinct regime shift in terms of the major influences on SSTs in the Gulf of Maine. The drivers of this (e.g., a potential weakening of the Atlantic Meridional Overturning Circulation, widening of the Gulf Stream, changes in the characteristics of the Labrador Current) have been [well-documented in the peer-reviewed literature](https://eos.org/features/why-is-the-gulf-of-maine-warming-faster-than-99-of-the-ocean), including through research by GMRI scientists.

Sea surface temperatures are also impacted by atmospheric weather patterns which can act to amplify warming or cool surface waters. Sustained periods of low cloud cover and the consequent direct sunlight can rapidly warm the ocean at the surface. Winds can act as a fan, advecting heat away and cooling the surface. Storm systems and any strong and/or sustained winds will also cool surface temperatures through mixing, as wave action stirs up cooler water from beneath the warmer surface layer, dispersing the heat through more of the water column.

In September the Gulf of Maine was crossed by extratropical storm Lee, which weakened from hurricane strength as it crossed over Georges Bank on September 16th. The impacts of this storm on the region’s SSTs can be seen in the declines observed this fall as the storm passed through the region and the persistent lows that followed. Similar storm crossings have occurred in the past, including during 2019 when hurricane Dorian passed through the Gulf of Maine after working its way up the US East Coast. Each of these years had some of the fewest fall heatwave days seen in recent years (2019: 0 days, 2023: 6 days).




## Marine Heatwave Conditions

The most commonly used definition of a ["marine heatwave" (MHW)](http://www.marineheatwaves.org/all-about-mhws.html) is when daily average SSTs exceeded the 90th percentile of a climatological (i.e., 30-year) average for at least 5 consecutive days. Gaps of 2 days or less in this threshold do not constitute a break in the MHW event.

```{r}
#| label: season-mhw-data

# Pull this full year's data, up until end of the season
last_yr_heatwaves <- region_hw %>% 
  filter(
    #time >= as.Date(str_c(params$year-1, "-01-01")) + season_start-1) # WINTER control
    time >= as.Date(str_c(params$year, "-01-01")))


# Get number of heatwave events and total heatwave days for this year
num_hw_days <- sum(last_yr_heatwaves$mhw_event, na.rm = T)

# Fraction of year in hw?
hw_frac <- round(sum(this_season_data$mhw_event)/nrow(this_season_data) * 100, 2) 

# Dates that aren't hw:
# this_season_data %>% filter(!mhw_event) %>% pull(time)
# this_season_data %>% filter(!mhw_event) %>% select(time, month, sst_anom)
# Dates That Are
# this_season_data %>% filter(mhw_event) %>% select(time, month, sst_anom)
```




```{r}
#| label: seasonal-hw-fraction
#| eval: false

region_hw %>% 
  filter(season_eng == "Fall") %>% 
  group_by(season_yr, season_eng) %>% 
  summarise(hw_days = sum(mhw_event, na.rm = T),
            tot_days = n(),
            hw_frac = hw_days/tot_days,
            cs_days = sum(mcs_event, na.rm = T),
            cs_frac = -1*(cs_days/tot_days)) %>% 
  mutate(yr_alpha = ifelse(season_yr == params$year, 1, 0.3)) %>% 
  ggplot() +
  geom_col(aes(season_yr, hw_frac, alpha = I(yr_alpha), fill = "Above 90th Percentile"), color = "transparent") +
  geom_col(aes(season_yr, cs_frac, alpha = I(yr_alpha), fill = "Below 10th Percentile"), color = "transparent") +
  scale_fill_gmri(reverse = T) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    x = "Year", 
    y = "Fraction of Fall Days", 
    title = "High Percentile Fall Warmth More Prevalent Since 2010",
    fill = "SST Extremes")
  


```




Using this broadly accepted definition, **the Gulf of Maine has experienced MHW conditions for `r round(hw_frac)`% of this `r tolower(params$season)`**. September was the only month this Fall where SST was above the threshold of a MHW (90th Percentile) long enough to meet standards for a MHW, but only for a total of six days.



```{r}
#| label: fig-season-mhw-timeline
#| fig-height: 5
#| eval: true
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Gulf of Maine extending from January 1, 2023 through August  31, 2023. Black lines represent the long-term (i.e., 1991 – 2020) average SST, the 10th percentile, and 90th percentile for a given day in the Gulf of Maine; a solid line (red for marine heatwave or blue for a non-event) indicate the observed SST this year; red (above 90th percentile) and blue (below 90th percentile) shading illustrates how far the observed SST falls from the MHW threshold."


year_hw_dat <- last_yr_heatwaves
temp_units <- "F"

# Augment Data
  year_hw_dat <- mutate(
    year_hw_dat, 
    cs_thresh_f = as_fahrenheit(mcs_thresh),
    mhw_event_txt = if_else(mhw_event, "Marine Heatwave", "Non-Heatwave"))
  
  
  # Handling Temperature Units:
  temp_ops <- switch (
    EXPR = temp_units,
    "C" = list(
      temp_col = expr(sst),
      anom_col = expr(sst_anom),
      seas_col = expr(seas),
      hw_thresh = expr(mhw_thresh),
      cs_thresh = expr(mcs_thresh),
      hw_temp = expr(hwe),
      temp_suff = " \u00b0C"),
    "F" = list(
      temp_col = expr(sst_f),
      anom_col = expr(anom_f),
      seas_col = expr(seas_f),
      hw_thresh = expr(mhw_thresh_f),
      cs_thresh = expr(cs_thresh_f),
      hw_temp = expr(hwe_f),
      temp_suff = " \u00b0F")
    )
  
  # Assign to shorter names
  temp_col <- temp_ops$temp_col
  anom_col <- temp_ops$anom_col
  clim_col <- temp_ops$seas_col
  hw_thresh_col <- temp_ops$hw_thresh
  cs_thresh_col <- temp_ops$cs_thresh
  hw_temp_col <- temp_ops$hw_temp
  
  # Set colors by name
  color_vals <- c(
    "Non-Heatwave"    = "#0571B0",
    "Marine Heatwave" = "darkred")
  
  
  # Flag heatwave Events:
  hw_events <- year_hw_dat %>% 
    filter(mhw_event == T) %>% 
    group_split(mhw_event_no) %>% 
    map_dfr(function(x){
      data.frame(
        id = unique(x$mhw_event_no),
        llim = min(x$time),
        rlim = max(x$time),
        ymax = max(x$sst_f),
        min_anom = min(x$anom_f),
        max_anom = max(x$anom_f),
        mean_anom = mean(x$anom_f),
        len  = nrow(x))
    })
  
  
  
# # Make new breaks so expanded area text doesn't ruin everything...
# end_cap <- as.Date(str_c(params$year, season_deets$right_lim), format = "%Y-%m-%d")
# end_cap_breaks <- end_cap - 5 - months(0:29) # subtract a couple days before the months to not lose feb

  
  
# Build the Plot
hw_temp_p <- ggplot(year_hw_dat) +
    geom_path(aes(x = time, y = {{temp_col}}, color = mhw_event_txt, group = 1), linewidth = 0.8, key_glyph = "timeseries") +
    geom_segment(aes(x = time, xend = time, y = {{clim_col}}, yend = {{temp_col}}, color = mhw_event_txt), alpha = 0.25,
                 show.legend = F) +
    geom_textpath(
      aes(x = time, y = {{hw_thresh_col}}), 
      color = "gray10", label = "90th Percentile", 
      hjust = 1.15, lty = 1, vjust = 0, family = "Avenir") + 
    geom_textpath(
      aes(x = time, y = {{clim_col}}), 
      color = "gray10", label = "Climatological Avg.", 
      hjust = 1.33, lty = 1, family = "Avenir") +
    geom_textpath(
      aes(x = time, y = {{cs_thresh_col}}), 
      color = "gray10", label = "10th Percentile", 
      hjust = 1, lty = 1, vjust = .9, straight = T, family = "Avenir") +
    geom_bracket(
      data = hw_events, 
      aes(xmin = llim, xmax = rlim, y.position = ymax + 2, label = str_c(len, " Days")), 
      family = "Avenir", ) +
    scale_color_manual(values = color_vals) +
    scale_x_date(
      date_labels = "%b", 
      date_breaks = "1 month", 
      expand = expansion(add = c(0,90)),
      limits = as.Date(str_c(params$year, c("-01-01", "-12-31")))) +
    scale_y_continuous(
      labels =  number_format(suffix = temp_ops$temp_suff),
      expand = expansion(mult = c(0.05, .2))) +
    theme(legend.position = "bottom") +
    labs(title = str_c("Gulf of Maine SST and MHW Events"),
         x = NULL, 
         color = "Sea Surface Temperature & Heatwave Status:",
         fill = "Difference from Average SST",
         y = "Sea Surface Temperature") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")

# Show plot
hw_temp_p

# Number of consecutive days above largest (or closest) integer anomaly
max_int <- max(floor(this_season_data$anom_f))
  
```



Presenting SST conditions in terms of anomalies ( @fig-season-anoms ) as opposed to absolute values ( @fig-season-mhw-timeline ) illustrates in greater detail the magnitude of MHW conditions throughout the `r tolower(params$season)`. The most extreme daily SST anomalies for fall 2023 occurred towards the start of September, with temperatures building to over `r max_int`°F above the climatological average above the climatological average before rapidly dropping to cooler for the remainder of the fall. This rapid drop in SST coincided with Hurricane Lee’s passage through the area, demonstrating how atmospheric conditions can alter ocean surface conditions.


```{r}
#| label: fig-season-anoms
#| fig-height: 5
#| eval: true
#| fig-cap: "A timeseries of daily average SST anomalies in the Gulf of Maine (solid colored line) compared to the long-term climatological mean, 10th, and 90th percentiles (solid black lines) in the Gulf of Maine for the period January 1, 2023 through August 31, 2023. Red portions denote when temperatures have exceeded the 90th percentile, the threshold beyond which conditions can start to be categorized as a MHW"



# Do this one over again:
hw_anom_p <- year_hw_dat %>% 
  mutate(
      hw_anom_thresh = {{ hw_thresh_col }} - {{ clim_col }},
      cs_anom_thresh    = {{ cs_thresh_col }} - {{ clim_col }}) %>% 
  ggplot() +
  geom_ribbon(aes(x = time, ymin = cs_anom_thresh, ymax = hw_anom_thresh), fill = "lightgray", alpha = 0.4) +
    geom_path(aes(x = time, y = {{anom_col}}, color = mhw_event_txt, group = 1), linewidth = 0.8, key_glyph = "timeseries") +
    geom_textpath(
      aes(x = time, y = 0), 
      color = "gray10", 
      label = "Climatological Avg. & \n 10th-90th Percentile Range", 
      hjust = .125, lty = 1, family = "Avenir") +
    geom_bracket(
      data = hw_events, 
      aes(xmin = llim, xmax = rlim, y.position = max_anom + 1, label = str_c(len, " Days")), 
      family = "Avenir", ) +
    scale_color_manual(values = color_vals) +
    scale_x_date(
      date_labels = "%b", 
      #date_labels = "%b %y", 
      date_breaks = "1 month", 
      expand = expansion(add = c(0,0))) +
    scale_y_continuous(
      labels =  number_format(suffix = temp_ops$temp_suff),
      expand = expansion(mult = c(0.05, .2))) +
    theme(legend.position = "bottom", legend.title = element_text(face = "bold")) +
    labs(title = str_c("Gulf of Maine SST Anomalies"),
         x = NULL, 
         color = "SST Anomalies & Heatwave Status:",
         fill = "Difference from Average SST",
         y = "Sea Surface Temperature Anomaly") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")

# Show plot
hw_anom_p




# # Show MHW Status Through the Year:
# hw_anom_p <- year_hw_anoms_two(year_hw_dat = last_yr_heatwaves, temp_units = "F") + 
#   labs(title = str_c(params$season, " ", params$year, " Gulf of Maine SST Anomalies")) +
#   
#   theme(text = element_text(family = "Avenir")) +
#   coord_cartesian(clip = "off") +
#   labs(title = str_c("Gulf of Maine SST Anomalies")) +
#   geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")
# hw_anom_p
```

## Heatmap of Temperature Anomalies and Heatwave Events

Looking at the full record of daily SST anomalies in the Gulf of Maine (@fig-mhw-heatmap), the distinct thermal regime shift beginning around 2010 is evident. Indeed, since 2012, the Gulf of Maine has experienced far more persistent MHW conditions (indicated by solid black lines) than at any other point in the satellite record.

Conditions in the Gulf of Maine this fall were unusually cool when compared to recent years. Fall SST in the previous 3 years had been noteworthy for their extended MHW conditions, part of a long-term trend of unseasonably warm fall and fall temperatures since 2012. The relatively mild fall of 2023 stands in contrast to the preceding spring and summer seasons, which were the 2nd & 8th warmest on record. 

```{r}
#| fig.height: 8
#| label: fig-mhw-heatmap
#| fig-cap: "Heat map of daily SST anomalies from the beginning of 1982 through spring 2023. Not only do more large warm anomalies (darker reds) appear more frequently in recent years, but the frequency, duration, and intensity of marine heatwave events (black lines) in the Gulf of Maine has become more pronounced in the past decade."


base_date <- as.Date("2000-01-01")
grid_dat <- region_hw %>% 
# grid_dat <- sst_new %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev)) 


# All years:
heatmap_p <- grid_dat %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2023) +
  labs(title = "Gulf of Maine Heatwave Record",
       y = "Year",
       x = "Month",
       caption = NULL) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0, size = 11, face = "bold"),
    plot.margin = margin(b = 0, t = 20)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.05, logo_height = 1, height_units = "cm")

#Remove caption
heatmap_p
```

## Spatial Distribution of Seasonal Anomalies

```{r}
#| label: fig-seasonal-anom-stack

# Set time limits
season_dates <- c(min(this_season_data$time), max(this_season_data$time))

# Spatial Extent Info
x_buffer <- c(-2.75, 3.5)
y_buffer <- c(-2, 1)
crop_x   <- st_bbox(region_extent)[c(1,3)] + x_buffer
crop_y   <- st_bbox(region_extent)[c(2,4)] + y_buffer

# Expanded area as bbox
expanded_area <- structure(
    c(crop_x, crop_y),  
    class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()


# Make data window for season
data_window <- data.frame(
  lon = crop_x,
  lat = crop_y,
  time = season_dates)

# Load data - Temperatures
season_anoms_c <- oisst_window_load(
  data_window = data_window, 
  anomalies = T, 
  climate_ref = "1991-2020",
  box_location = "cloudstorage")


# Stack the years
season_anoms_c <- stack(season_anoms_c)


# Convert to F
season_anoms_f <- as_fahrenheit(season_anoms_c, data_type = "anomalies")


####  Records for the Text  ####





# Calculate the average for the season
season_mean <- mean(season_anoms_f, na.rm = T)




# Get the Maximum Daily Temperature Value
max_daily_actual  <- max(values(season_anoms_f), na.rm = T)
max_daily  <- round(max(values(season_anoms_f), na.rm = T), 2)



# Where was it seasonally the highest:
# Flag the exact location

# If we wanted it to be in box we have to use this:
season_mean_within <- crop(season_mean, region_extent)

# Get the location
idx <- which.max(crop(season_mean_within, region_extent))
pos <- as.data.frame(xyFromCell(season_mean_within, idx))


# Get the values
# Get the maximum seasonal average temperature for each pixel
max_season <- round(max(values(season_mean_within), na.rm = T), 2)



# Make some table with context
set.seed(123)
peak_temp_df <- data.frame(
  max_val = str_c(round(max_season, 2), deg_f),
  lon = pos$x,
  lat = pos$y,
  do_circle = T) %>% 
  mutate(descr = "Largest Seasonally-Averaged SST Anomaly") %>% 
  bind_rows(
    data.frame(
      max_val = rep(NA, 25),
      lon = rnorm(25, mean = -68.25, sd = 2),
      lat = rnorm(25, mean = 43, sd = 2),
      do_circle = rep(F, 25),
      descr = rep("", 25)
    )
  )


```


From an aerial perspective, the Gulf of Maine experienced mild above-average SSTs during `r tolower(params$season)` of `r params$year``, while surrounding areas experienced either extreme highs or extreme lows for the season. During the fall a large area of below average sea surface temperatures developed just south of Georges Bank. Further to the south a large patch of above-average SST anomalies had formed, located to the east of New Jersey just off the continental shelf and outside the domain analyzed in preceding sections (Figure 7). The highest seasonally averaged SST anomaly of any location in this broader region was `r max_season`°F - part of the large patch of positive anomalies to the east of New Jersey, south of Long Island Sound.



```{r}
#| label: fig-season-anom-map
#| fig.width: 8
#| fig.height: 8
#| fig-cap: "Map of average SST anomalies for each grid cell in the satellite record for spring 2023. The box outlined by the black dashed line denotes the region of study for the analysis (see @fig-map). Darker red regions indicate warmer anomalies."

# Make the seasonal average a stars class to plot with ggplot
anoms_st <- st_as_stars(season_mean)


# Set Plot legend limits
temp_limits <- c(-6, 6)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")



#### 1. Map the Anomalies in Space
season_map <- ggplot() +
  geom_stars(data = anoms_st) +
  tidyterra::geom_spatraster_contour(
    data = elev_terra,
    breaks = seq(0,-200,-100),
    alpha = 0.75,
    linewidth = 0.25,
    color = "gray20") +
  geom_sf(data = new_england, fill = "gray90", linewidth = .25) +
  geom_sf(data = canada, fill = "gray90", linewidth = .25) +
  geom_sf(data = greenland, fill = "gray90", linewidth = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, 
          linewidth = 1,
          fill = "transparent") +
  geom_point(
    data = drop_na(peak_temp_df),
    aes(lon, lat), color = "black", shape = 22, fill = "transparent", size = 5) +
  geom_mark_ellipse(
    data = peak_temp_df,
    aes(lon, lat, 
        filter = do_circle == T,
        label = max_val, description = descr), 
    label.family = "Avenir",
    color = "black", 
    label.fill = "#FAFAFA90") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits,
                       breaks = temp_breaks,
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  map_theme(
    text = element_text(family = "Avenir"),
    legend.position = "bottom",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 9)) +
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           expand = F) +
  guides("fill" = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(4.5, "in"),
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(
    title = str_c("Seasonal Sea Surface Temperature Anomaly\n", params$season, " ", params$year),
    caption = "100m & 200m contours overlaid to show topographic details.",
    fill = "Surface Temperature Anomaly")

# Show figure
season_map

```

## Monthly Temperature Anomalies

Average monthly SST anomalies are shown in @fig-monthly-avg-map. The warmest anomalies were observed in March and April and were largely confined to areas just beyond the region of study (i.e, beyond the continental shelf where the Gulf Stream and Labrador Current have significantly more influence on oceanic conditions).

```{r}
#| label: fig-monthly-avg-map
#| eval: true
#| fig.width: 8
#| fig.height: 4
#| fig.align: center
#| fig-cap: "This series of maps shows the average monthly SST anomaly for March 2023, April 2023, and May 2023. The box outlined by the black dashed line denotes the region of study for the analysis. Darker red regions indicate warmer anomalies."


# Get monthly averages
season_nums    <- unique(str_sub(names(season_anoms_f), 7,8))
month_names    <- month.name[as.numeric(season_nums)]


# Pull the layers for each and average them:
display_months <- map(season_nums, function(month_idx){
  
  which_dates <- which(str_sub(names(season_anoms_f), 7,8) == month_idx)
  month_mean <- mean(season_anoms_f[[which_dates]], na.rm = T)
  }) %>% setNames(month_names)



# Perform masking
months_masked <- map(display_months, mask_nc, expanded_area, rotate = FALSE)


# Set contours to show
# Show less contours b/c smaller map
contours_make <- c(200)



# Make plots for each
month_plots <- imap(
  months_masked, 
  function(x,y){
    monthly_sst_map(
      month_avg_layer = x, 
      month_id = y,
      plot_yr = params$year,
      depth_contours = contours_make, 
      temp_lim = 6,
      convert_to_f = FALSE) + 
      theme(text = element_text(family = "Avenir"))
  }
) 
  
                    


# assemble aggregate plot
monthly_maps <- (
  month_plots[[1]] |#+ labs(title = "December 2022")| # WINTER control
    month_plots[[2]] | 
    month_plots[[3]]) + 
  plot_layout(guides = "collect")  & 
  theme(
    text = element_text(family = "Avenir"),
    legend.position = "bottom",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 9),
    plot.margin = margin(t = 0, b = 0, r = 0.5, l = 0.5)) 


monthly_maps + plot_annotation(caption = "200m contour overlaid to show topographic details.")
```

```{r}
#| eval: false
#Rt walk
month_plots[[1]] + 
  coord_sf(xlim = crop_x, 
           ylim = crop_y, 
           clip = "off") +
  geom_logo(x_npc = 0.85, y_npc = 1.05, logo_height = 1, height_units = "cm") +
  theme(
    text = element_text(family = "Avenir"),
    legend.position = 'bottom', 
    plot.margin = margin(t = 0, b = 0, r = 0.5, l = 0.5)) 
```

## North Atlantic Heat

2023 was a year with headline temperatures for the North Atlantic. A dramatic figure that was shared widely on social media was a version of figure 11. which captures just how profoundly hot this year's temperatures were across the N. Atlantic. SST in the North Atlantic have been off the charts hot for much of the year drawing attention and concerns for the rapidly changing ocean environment.

```{r}
#| label: fig-natl-timeseries
#| fig-cap: " Light gray lines illustrate annual time series for SST anomalies in the North Atlantic from 1982-2023. North Atlantic SST anomalies for 2023 are shown in orange. Dashed black lines denote the 90th and 10th percentile SST anomalies (for the 1991-2020 CRP)."

# Load the timeseries for the spaghetti plot
natl_ts <- read_csv(here("notebooks/nb_testing_data/north_atlantic_sst_1982to2023.csv"))

# Get the heatwave situation
natl_ts <- pull_heatwave_events(natl_ts, clim_ref_period = c("1991-01-01", "2020-12-31"), temp_col = "area_wtd_sst")

natl_ts <- natl_ts %>% 
  mutate(yr = year(time),
         is_23 = ifelse(yr == 2023, TRUE, FALSE),
         yr_col   = ifelse(is_23, gmri_cols("orange"), "gray90"),
         yr_lw    = ifelse(is_23, 1.5, 0.8),
         yr_alpha = ifelse(is_23, 1, 0.5),
         flat_date = as.Date("2000-01-01") + doy-1,
         anom_f = as_fahrenheit(sst_anom, data_type = "anomalies"),
         hw_thresh_f = as_fahrenheit(mhw_thresh-seas, data_type = "anomalies"),
         cs_thresh_f = as_fahrenheit(mcs_thresh-seas, data_type = "anomalies")) %>% 
  filter(time < max(this_season_data$time))



# Plot how unusual this year was
natl_tl <- natl_ts %>% 
  ggplot(aes(flat_date, anom_f)) +
  geom_line(aes(group = yr, linewidth = I(yr_lw), alpha = I(yr_alpha), color = I(yr_col))) +
  geom_texthline(yintercept = 0, label = "1991-2020 Average", linewidth = 1, size = 5) +
  geom_textline(data = filter(natl_ts, yr == 2022), aes(x = flat_date, y = hw_thresh_f), label = "90th Percentile", linewidth = 1, size = 5, linetype = 3) +
  geom_textline(data = filter(natl_ts, yr == 2022), aes(x = flat_date, y = cs_thresh_f), label = "10th Percentile", linewidth = 1, size = 5, linetype = 3) +
  geom_text(
    data = filter(natl_ts, yr == 2023) %>% slice(yday(max(this_season_data$time))-1),
    label = "2023", hjust = 0, vjust = -0.4,
    size = 5, fontface = "bold", color = gmri_cols("orange")) +
  scale_x_date(date_breaks = "1 month", labels = date_format("%b"), 
               expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = number_format(suffix = deg_f)) +
  #theme_gmri() +
  labs(x = "Day of Year", y = "Sea Surface Temperature Anomaly",
       title = "North Atlantic SST Anomalies",
       subtitle = "(0-60N, 0-80W)")  +
  coord_cartesian(clip = "off") +
  
  theme(text = element_text(family = "Avenir")) +
  geom_logo(x_npc = 0.85, y_npc = 1.1, logo_height = 1, height_units = "cm")

natl_tl

```

In a departure from the now-familiar pattern of regionally concentrated warming, much of the attention this year was on large areas in the eastern Atlantic experiencing a large-scale MHW event. This summer scientists sounded the alarm over record setting temperatures for much of the Eastern Atlantic impacting population centers along the European coast and contributing to sweltering temperatures on land.

```{r}
#| label: fig-season-natl-map
#| fig.width: 8
#| fig.height: 8
#| fig-cap: "Map of average SST anomalies for each grid cell in the satellite record for summer 2023 in the North Atlantic. Darker red regions indicate warmer anomalies."

# Set time limits
natl_dates <- c(min(this_season_data$time), max(this_season_data$time))

# Spatial Extent Info
natl_crop_x   <- c(-80, 0)
natl_crop_y   <- c(0, 60)

# Expanded area as bbox
natl_area <- structure(
    c(natl_crop_x, 
      natl_crop_y),  
    class = "bbox",
  crs = 4326) %>% 
  st_as_sfc() %>% 
  st_as_sf()


# Make data window for season
data_window <- data.frame(
  lon = natl_crop_x,
  lat = natl_crop_y,
  time = natl_dates)

# Load data - Temperature Anomalies
natl_anoms_c <- oisst_window_load(
  data_window = data_window, 
  anomalies = T, 
  climate_ref = "1991-2020",
  box_location = "cloudstorage") %>% 
  stack()



# Make a map of just this season, across 
natl_mean <- calc(natl_anoms_c, mean, na.rm = T)
natl_mean_f <- as_fahrenheit(natl_mean, data_type = "anomalies")



# Mapping in absolute units:

# Set Plot legend limits
temp_limits <- c(-6, 6)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")

natl_map <- ggplot() +
  geom_stars(
  data = st_as_stars(natl_mean_f)) +
  geom_sf(data = world_sf, fill = "gray90", linewidth = .25) +
  scale_fill_distiller(
    palette = "RdBu", 
    direction = -1, 
    labels = label_number(suffix = deg_f),
    na.value = "transparent", 
    limit = temp_limits,
    breaks = temp_breaks,
    oob = scales::oob_squish) +
  map_theme(
    text = element_text(family = "Avenir"),
    legend.position = "bottom") +
  coord_sf(xlim = c(-80, 0), 
           ylim = c(0, 60), 
           expand = F) +
  guides("fill" = guide_colorbar(
    title = expression("Surface Temperature Anomaly"),
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(5, "in"), show.limits = T,
    frame.colour = "black",
    ticks.colour = "black")) +
  labs(title = str_c("Seasonal Temperature Anomaly\n", params$season, " ", params$year))

natl_map

```

### Data Sources:

> NOAA_ERSST_V5 data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.ersst.v5.html.

> NOAA High Resolution SST data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.highres.html.

### Citing This Work

If you would like to cite this report, please use:

> Gulf of Maine Research Institute. 2022. Gulf of Maine Warming Update: `r params$season` `r params$year`

```{r}
#| label: figure-saving
#| echo: false


# Folder for Comms Team Update
comm_folder <- cs_path(
  "root", "Program Communications/Climate Center — Program Communications/Warming Updates/Visuals/")
update_folder <- str_c(comm_folder, params$season, " ", params$year, "/")

# # For testing locally
# comm_folder <- here::here("fig_testing/")


# Export Figures
if(params$save_figures){
  
  # Prevents tiny fonts when saving
  showtext::showtext_opts(dpi=300) 
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, 
         filename = str_c(update_folder, "GOM_Extent.png"), 
         height = unit(4, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  
  # Weekly Report Table
  gtsave(data = week_summ_table %>% 
    opt_table_font(
      font = list(google_font(name = "Avenir"))), 
    filename = str_c(update_folder, "weekly_summary_table.png"))
  
  # Monthly Report Table
  gtsave(
    data = month_summ_table %>% 
      opt_table_font(font = list(google_font(name = "Avenir"))), 
    filename = str_c(update_folder, "monthly_summary_table.png"))
  
  
  # Seasonal Rates Plot
  ggsave(plot = global_rate_plot, 
         filename = str_c(update_folder, "Seasonal_rates_plot.png"), 
         height = unit(2.5, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  
  # Seasonal Temp Rankings
  ggsave(plot = temp_rankings_p, 
         filename = str_c(update_folder, "Seasonal_temp_ranks_plot.png"), 
         height = unit(3, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)

  
  # Heatwave Temperature Plot
  ggsave(plot = hw_temp_p, 
         filename = str_c(update_folder, "Heatwave_temp_plot.png"), 
         height = unit(2.5, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  
  # Heatwave Anomaly Plot
  ggsave(plot = hw_anom_p, 
         filename = str_c(update_folder, "Heatwave_anom_plot.png"), 
         height = unit(2.5, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  # heatwave heatmap
  ggsave(plot = heatmap_p, 
         filename = str_c(update_folder, "Heatwave_Heatmap.png"), 
         height = unit(4, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  
  # Season Map
  ggsave(plot = season_map, 
         filename = str_c(update_folder, "Seasonal_anom_map.png"), 
         height = unit(4, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  # monthly maps
  ggsave(plot = monthly_maps,
         filename = str_c(update_folder, "Monthly_anom_maps.png"), 
         height = unit(2.5, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  
  # North Atlantic Plots:
  ggsave(plot = natl_tl,
         filename = str_c(update_folder, "north_atlantic_timelines.png"), 
         height = unit(2.5, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
  # North atlantic Map
  ggsave(plot = natl_map,
         filename = str_c(update_folder, "north_atlantic_map.png"), 
         height = unit(4, "in"),
         width = unit(4, "in"),
         dpi = "retina", 
         bg = "transparent", 
         scale = 2)
  
 


# Weekly Report Table html
gtsave(
  data = week_summ_table %>% 
    opt_table_font(font = list(google_font(name = "Avenir"))), 
  filename = str_c(update_folder, "weekly_summary_table.html"))

# Monthly Report Table html
gtsave(
  data = month_summ_table %>% 
    opt_table_font(font = list(google_font(name = "Avenir"))), 
  filename = str_c(update_folder, "monthly_summary_table.html"))
  
  
# For HTML
# Add this to table tag as inline style to center:
#  style="margin-left:auto; margin-right:auto;"
# Or add it to the .gt_table class controls


 
}


```

```{r}
#| label: data-save
#| echo: false

####  Saving the Data  ####

if(params$save_data){
  

  # Rename so there is 0 chance of confusion
  save_season_avg <- seasonal_avgs %>% 
    select(
      year = yr,
      months = season,
      temp_c = mean_temp,
      temp_f = temp_f,
      climate_avg_c = mean_clim,
      climate_avg_f = clim_f,
      temp_anom_c = mean_anom,
      temp_anom_f = anom_f) %>% 
    mutate(season = params$season, .before = "months") %>% 
    mutate(across(where(is.numeric), round,2))
   
  
  # Save locally
  update_name <- str_c(here("R/markdown_reports/seasonal_update_data/"),
                       "Gulf-of-Maine_SST_",
                       params$season,
                       "_Averages_GMRI_",
                       str_remove_all(Sys.Date(), "[-]"),
                       ".csv")
  write_csv(save_season_avg, 
            file = update_name)
}
```

```{r}
#| results: asis
insert_gmri_footer()
```
