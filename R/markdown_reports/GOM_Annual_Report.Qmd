---
title: "Gulf of Maine Warming Update: 2022 the Regions Second Warmest Year"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  Characteristizing anoither year for rising regional temperatures
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
execute: 
  echo: false
  message: false
  warning: false
  comment: ""
  fig.align: center
params: 
  report_year: 2022
  in_celsius: FALSE
  save_figures: 
    label: "Save Figures?" 
    value: FALSE
---

```{r}
#| label: setup
#| include: false

####  Packages  ####
{library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(rgeoboundaries)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggthemes)
library(ggstream)
library(ggforce)
library(geomtextpath)
library(ggHoriPlot)
library(tidytext)}

#---------- Support Functions
suppressPackageStartupMessages( source(here("R/oisst_support_funs.R"), verbose = FALSE) )
suppressPackageStartupMessages( source(here("R/temp_report_support.R"), verbose = FALSE) )


#----------- Paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     box_location = "cloudstorage")

# Folder for Comms Team Update
comm_folder <- cs_path("root", "Program Communications/Climate Center — Program Communications/Warming Updates/Visuals/")

# Folder based on year
save_location <- str_c(comm_folder, "Annual ", params$report_year,"/")


#----------- Parameters

# Set the year for the report:
report_yr <- params$report_year

# # Box Location to save hi-res images
# save_location <- cs_path("root", "GoM Seasonal Climate Update/annual_update_figures")


#----------- Components

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
region_extent <- read_sf(poly_path)

# Pull extents for the region for cropping
crop_x <- st_bbox(region_extent)[c(1,3)]
crop_y <- st_bbox(region_extent)[c(2,4)]

# Expand the area out to see the larger patterns, Used as plot limits
crop_x_expanded <- crop_x + c(-2.25, 2.25)
crop_y_expanded <- crop_y + c(-0.75, 0.75)

# Make a new extent for cropping to larger area
sfc <- make_cropbox(xlims = crop_x_expanded, ylims = crop_y_expanded)

# Coastline Shapes
# new_england <- ne_states("united states of america", returnclass = "sf")
new_england <- gb_adm1(country = "usa", type = "sscgs")
canada      <- ne_states("canada", returnclass = "sf")
world_sf    <- ne_countries(returnclass = "sf")
greenland   <- ne_states(country = "greenland", returnclass = "sf")

# Adding Logo to plots
logo_path <- paste0(system.file("stylesheets", package = "gmRi"), "/gmri_logo.png")
lab_logo <- magick::image_read(logo_path)


```



```{r}
#| label: add-css
#| results: asis
#| echo: false

gmRi::use_gmri_style_rmd(css = "gmri_rmarkdown.css")
```



```{r}
#| label: load-timeseries

# Load the timeseries
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6)


# Clean up the data - add labels
region_timeseries <- region_timeseries %>% 
  mutate(time = as.Date(time)) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:report_yr))



# Summarize by year to return mean annual anomalies and variance
annual_summary <- region_timeseries %>% 
  group_by(year) %>% 
  temperature_summaries() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(area_wtd_anom > 0, "Hot", "Cold"))


# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries, 
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2011-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Data for the Report Year Only
report_yr_only <- region_hw %>% 
  filter(year(time) == report_yr)

# Set up the date within a year for Heatmap
base_date <- as.Date("2000-01-01")
region_hw <- region_hw %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev))




# # Global Temperature Anomalies
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time)) %>% 
  filter(between(year, 1982, report_yr)) %>% 
  supplement_season_info()

# summarize by year again
global_summary <- global_anoms %>% 
  group_by(year) %>% 
  temperature_summaries() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(area_wtd_anom > 0, "Hot", "Cold"))
```


```{r}
#| label: report-yr-text

# Values I need up front for text

# average annual sst, its anomaly value:
report_annual_temp <- round(mean(report_yr_only$sst_f, na.rm = T), 2)
report_annual_anom <- round(mean(report_yr_only$anom_f, na.rm = T), 2)

# What rank this year was
report_rank <- filter(annual_summary, year == report_yr) %>% pull(sst_rank)

# Record holder year's temperature
record_year_temp <- filter(annual_summary, sst_rank == 1) %>% pull(sst_f)

# Note on how the seasons ranked:
season_ranks <- region_timeseries %>% 
  supplement_season_info() %>% 
  split(.$season_eng) %>% 
  map_dfr(~ .x %>% 
    group_by(year, season_eng) %>% 
    temperature_summaries()) %>% 
    filter(year == report_yr)

# add some acknowledgement of the extreme characteristics:
```



```{r}
#| label: all-years-summary

# Get the overall average and build labels
all_year_avgs <- annual_summary %>% 
  summarise(avg_temp_c = mean(area_wtd_sst),
            avg_temp_f = mean(area_wtd_f),
            avg_anom_c = mean(area_wtd_anom),
            avg_anom_f = mean(area_wtd_anom_f),            
            .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))

```



With an annual average sea surface temperature (SST) of `r report_annual_temp`°F — more than `r report_annual_anom`°F above normal — the Gulf of Maine experienced its `r report_rank`nd warmest year on record in `r report_yr`. The region ranked in the top 3 warmest temperatures across all seasons, with the most extreme temperatures occurring in November.



## Annual Sea Surface Temperatures



```{r}
#| label: warming-rates-generation


####  Run Warming Rate regressions  ####
rate_data <- list(
  "GoM All F" = get_decadal_rates(
    temp_df = annual_summary, 
    temp_col = "area_wtd_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "GoM", 
    degree_c = F),
  "Global All F" = get_decadal_rates(
    temp_df = global_summary, 
    temp_col = "area_wtd_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "Global", 
    degree_c = F))



# Build Regression Equation Labels
eq_all_f    <- rate_data[["GoM All F"]][["eq_label"]]
eq_global_f <- rate_data[["Global All F"]][["eq_label"]]

```




The annual average SST in the Gulf of Maine for `r report_yr` was `r report_annual_temp`°F; this was `r report_annual_anom`°F above the long-term (i.e., 1982-2011) average. This year fell short of the previous warmest year on record — 2021 — by a remarkable `r round(record_year_temp-report_annual_temp, 2)`°F. `r report_yr` was the second hottest year on record for the Gulf of Maine, shifting the 1982-`r report_yr` warming rate to `r str_c(rate_data[["GoM All F"]][["decadal_rate"]], "\u00b0F / Decade")`.  Since the early 1980s, the rate of warming in the Gulf of Maine has been nearly triple that of the world’s oceans (@fig-global-comparison). 





```{r}
#| label: fig-global-comparison
#| fig-cap: "A timeseries of annual average sea surface temperature anomalies for the Gulf of Maine (solid black line) from 1982 through 2021, illustrating that 2021 was the warmest year on record. Long-term trendlines for the Gulf of Maine (blue) and the entire globe (green) show how much more quickly the Gulf of Maine is warming compared to the rest of the world."


# Fahrenheit plot
temp_simplified <- global_rate_comparison(
  annual_summary_dat = annual_summary, 
  global_summary_dat = global_summary, 
  eq_all = str_remove(eq_all_f, "1982-2022"), 
  eq_global = str_remove(eq_global_f, "1982-2022"), 
  temp_units = "F",
  region_label = "Gulf of Maine") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.115, y_npc = -0.175, logo_height = 1, height_units = "cm")

# add logo
temp_simplified 

```

The rate of warming in the region vary throughout the year. Comparisons across the four seasons (@fig-seasons-comparison) reveal that the Gulf of Maine is warming fastest during the Summer and Fall months (~4x the global average), nearly twice the rate seen during the spring (~2x the global average).


```{r}
#| label: fig-seasons-comparison
#| fig-cap: "Four timeseries panels of the annual averages for each season (solid black lines) for the Gulf of Maine. Decadal trends are overlayed to compare decadal trends in the Gulf of Maine (blue) and the entire globe (green). Rates are much faster in the Gulf of Maine across all seasons, with the smallest difference in rates during the spring."
#| fig.width: 8
#| fig.height: 7


# Pull the data out by season: annual_summary steps but for each season
season_summary <- region_timeseries %>% 
  group_by(season_yr, season_eng) %>% 
  temperature_summaries()

global_season_summary <- global_anoms %>% 
  group_by(season_yr, season_eng) %>% 
  temperature_summaries() 




# Think we can Facet, but then the stupid rates won't be there...
season_avgs <- bind_rows(
  list(
    "Gulf of Maine" = season_summary,
    "Global" = global_season_summary), 
  .id = "Region") %>% 
  mutate(
    season_eng = factor(season_eng, levels = c("Spring", "Summer", "Fall", "Winter")))


# Decadal Rates Function
rate_calc <- function(.data){
   annual_lm <- lm(anom_f ~ season_yr, data = .data)
    rate_x <- round(coef(annual_lm)["season_yr"] * 10, 2)
    eq_lab <- paste0(": ", rate_x, deg_f, " / Decade")
    mutate(.data, rate_eq = eq_lab)
}


# Run the numbers to make the label
season_avgs <- season_avgs %>% 
  group_by(Region, season_eng) %>% 
  group_map( ~rate_calc(.), .keep = TRUE) %>% 
  bind_rows() %>% 
  mutate(rate_eq = str_c(Region, rate_eq))



# Make the four panels:
season_panels <- season_avgs %>% 
  split(.$season_eng) %>% 
  imap(function(x, y){
    
    season_p <- ggplot(x, aes(season_yr, anom_f)) +
      geom_line( data = filter(x, Region == "Gulf of Maine"), linewidth = 1, linetype = 1) +
      geom_point(data = filter(x, Region == "Gulf of Maine"), size = 1.5) +
      stat_smooth(
        aes(color = rate_eq), 
        method = "lm", 
        formula = y~x, 
        linetype = 1, 
        linewidth = 1.5, 
        alpha = 0.8,
        se = FALSE) +
      facet_wrap(~season_eng, ncol = 2) +
      scale_color_manual(values = c(gmri_cols("green"), gmri_cols("blue"))) +
      scale_y_continuous(labels = number_format(suffix = deg_f)) +
      theme(
        legend.position = c(0.35, 0.8),
        legend.background = element_rect(color = "black", fill = "white")) +
      labs(
        x = "Year", 
        y = "SST Anomaly",
        color = str_c(y, " Trend (1982-2022)"))
    
    if(y == "Winter"){
      season_p <- season_p +
        geom_point(data = filter(x, season_yr == 2022, Region == "Gulf of Maine"), aes(season_yr, anom_f),
                   shape = 21, color = "black", fill = "white", size = 1.5)
    }
    
    season_p
      
  })


# Assemble the plot
panel_plot <- (season_panels$Spring |season_panels$Summer) / (season_panels$Fall | season_panels$Winter) + plot_annotation(caption = "Winter temperatures for 2022 are not complete and will change through the end of February 2023.") &
  theme(plot.margin = margin(t = 0.5, b = 0.5, r = 0.75, l = 0.75))

panel_plot
grid::grid.raster(lab_logo, x = 0.08, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
```


There can be significant spatial variability in annually-averaged SST patterns. The Gulf of Maine in `r report_yr` illustrated this fact with the region southeast of Georges Bank experiencing the highest SST anomalies (@fig-new-england-map). This area is more susceptible to large-scale variability in major oceanic currents, such as the relative influence of the Gulf Stream versus the Labrador Current, than other areas of the Gulf of Maine.


```{r}
#| label: fig-new-england-map
#| fig-cap: "Map of annual average sea surface temperature anomalies in 2021. The box outlined by the black dashed line denotes the region of study for the analysis presented throughout this report."
#| fig.height: 6


# Set time limits to get data
annual_dates <- as.Date(
  c(str_c(report_yr,"-01-01"), str_c(report_yr,"-12-31")))

# Make data window for the year
data_window <- data.frame(lon = c(-81, -54.5),
                          lat = c(33.5, 50),
                          time = annual_dates)

# Load data, stack and tidy
ne_anoms <- oisst_window_load(
    data_window = data_window,
    anomalies = T,
    box_location = "cloudstorage") %>%  
  stack()

# Convert to F
ne_anoms_f <- calc(ne_anoms, function(x) as_fahrenheit(x, data_type = "anomalies")) %>% 
  setNames(names(ne_anoms))

# Process the yearly average
ne_annual_anom_f <- mean(ne_anoms_f, na.rm = T)



# Color limit for palettes
temp_limits <- c(-6, 6)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")


# Make it a stars class to plot with ggplot
ne_anoms_st <- st_as_stars(ne_annual_anom_f)

#### 1. Map the Anomalies in Space
annual_gom_map <- ggplot() +
  geom_stars(data = ne_anoms_st) +
  geom_sf(data = new_england, fill = "gray90", size = .25) +
  geom_sf(data = canada, fill = "gray90", size = .25) +
  geom_sf(data = greenland, fill = "gray90", size = .25) +
  geom_sf(data = region_extent, 
          color = "black", 
          linetype = 2, size = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits, 
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  coord_sf(xlim = c(-78, -56.5), ylim = c(37.8, 48)) +
  labs(title = str_c(report_yr, ": Average Temperature Anomalies"),
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  map_theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0))+
  guides("fill" = guide_colorbar(
    title = "Average Temperature Anomaly ",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
annual_gom_map
grid::grid.raster(lab_logo, x = 0.1, y = 0.06, just = c('left', 'bottom'), height = unit(1, "cm"))


```

Looking at these spatial patterns at a seasonal level (@fig-four-season-maps) shows just how "patchy" these pockets of above-average temperatures can be. In the spring months the areas to the south and south east of the Gulf of Maine are pocketed with a mixture of both above and below average water masses. During the summer months we can see that the water within the Gulf of Maine itself and the deeper waters just south of Georges Bank are higher than the surrounding areas. In the fall and winter the Gulf of Maine becomes less of a heat island itself, but remains hot as bands of elevated temperature water masses move up the coast nearby.


```{r}
#| label: fig-four-season-maps
#| fig-cap: "Map of each season's average sea surface temperature in 2022. Winter data is still ongoing and is subject to future changes in sea surface temperature."
#| fig.width: 8
#| fig.height: 6

# Four Season Panels

# Process the stack into the four seasons (winter will be ongoing, make a note, its fine):
# Set time limits
season_dates <- list(
  "Spring" = distinct(filter(report_yr_only, season_eng == "Spring"), time) %>% pull(time),
  "Summer" = distinct(filter(report_yr_only, season_eng == "Summer"), time) %>% pull(time),
  "Fall"   = distinct(filter(report_yr_only, season_eng == "Fall"), time) %>% pull(time),
  "Winter" = distinct(filter(report_yr_only, season_eng == "Winter"), time) %>% pull(time)
)

# Grab the dates for each, process the mean 
season_stacks <- map(season_dates, function(x){
  dates_x <- str_c("X", str_replace_all(x, "-", "."))
  which_dates <- which(names(ne_anoms_f)  %in% dates_x)
  month_mean <- mean(ne_anoms_f[[which_dates]], na.rm = T)
  
})


# Assemble Panels Again:
season_panel_maps <- imap(season_stacks, function(x, seasn){
  
  season_df <- data.frame("season" = seasn)
  ne_season_st <- st_as_stars(x)
  season_map <- ggplot(data = season_df) +
    geom_stars(data = ne_season_st) +
    geom_sf(data = new_england, fill = "gray90", size = .25) +
    geom_sf(data = canada, fill = "gray90", size = .25) +
    geom_sf(data = greenland, fill = "gray90", size = .25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, size = 1,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdBu", 
                         na.value = "transparent", 
                         limit = temp_limits, 
                         labels = temp_labels,
                         oob = scales::oob_squish) +
    coord_sf(xlim = c(-78, -56.5), ylim = c(37.8, 48)) +
    labs() +
    facet_wrap(~season) +
    map_theme(
      legend.position = "bottom",
      legend.title = element_text(angle = 0))+
    guides("fill" = guide_colorbar(
      title = "Average Temperature Anomaly ",
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) 

# Show figure
season_map
})



# Put them together and format them
season_panels_all <- (season_panel_maps$Spring | season_panel_maps$Summer)/(season_panel_maps$Fall | season_panel_maps$Winter) +
  plot_layout(guides = "collect") & 
  theme(legend.position = 'bottom', 
        plot.margin = margin(t = 0, b = 0, r = 0.5, l = 0.5)) 

# Display them
season_panels_all + plot_annotation(caption = "Winter temperatures still being collected, numbers subject to future changes.")
grid::grid.raster(lab_logo, x = 0.08, y = 0.04, just = c('left', 'bottom'), height = unit(1, "cm"))

```


When we compare `r report_yr` to other unusually warm years in the Gulf of Maine, we see that in absolute terms it was roughly half a degree from 2021's record year. When we look at the deviation from the long-term average SST (i.e., the annual SST anomaly), the last decade stands out (@fig-yr-ranks). `r report_yr` continues a pattern that began in 2010 of sustained above-average temperatures. With the exception of 2019 (ranked 13th), all of the last ten years remain in the top 10 for SST.

```{r}
#| label: fig-yr-ranks
#| fig-cap: "Bar plot ranking the top 5 annual sea surface temperature (SST) values and their equivelant SST anomalies. Absolute temperatures displayed in text with the corresponding year."




# Plot the top 5 warmest years
temp_rankings_p <- annual_summary %>% 
  filter(sst_rank <= 10) %>% 
  mutate(flag_year = ifelse(year == report_yr, "flag", "unflag"),
         sst_rank =  fct_rev(factor(sst_rank))) %>% 
  ggplot() +
  geom_col(aes(x = anom_f, y = sst_rank, fill = flag_year)) +
  # Year Labels
  geom_text(
    mapping = aes(x = 0, y = sst_rank, label = str_c(sst_rank, ".  ", year)),
    hjust = -.1,
    color = 'white',
    fontface = "bold") +
  # Temperature Labels
  geom_text(
    mapping = aes(x = anom_f, y = sst_rank, label = str_c(round(sst_f,2), deg_f), group = sst_rank),
    hjust = 1.05,
    color = 'white',
    fontface = "bold") +
  scale_x_continuous(
    labels = number_format(suffix = deg_f), 
    expand = expansion(mult = c(0,0.15))) +
  scale_fill_manual(values = c("flag" = as.character(gmri_cols("orange")), 
                                "unflag" = as.character(gmri_cols("gmri blue")))) +
  labs(x = "Annually Averaged Temperature Anomaly",
       y = NULL,
       title = str_c("Ten Hottest Years in the Gulf of Maine"),
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(hjust = 1, face = "bold"),
        axis.ticks.y = element_blank(),
        plot.margin = margin(t = 20, l = 10, r = 5, b = 5)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.15, logo_height = 1, height_units = "cm")

temp_rankings_p


```

## Worldwide Temperatures

It was not just the Gulf of Maine that experienced exceptional warmth in `r report_yr`, however. According to NOAA, `r report_yr` was the **add_value** warmest year on record for the contiguous United States and the **add_value** warmest year globally. The figure below (@fig-global-anomalies) shows annual average SST anomalies for oceans all over the world in `r report_yr`. While much of the Southern Ocean and expanses of the southeastern Pacific off South America were anomalously cool (a feature of La Niña conditions), most of the world’s oceans experienced unusually warm temperatures in `r report_yr`. This is particularly true for James Bay in Canada, the Labrador Sea, the Baltic Sea, and a swath from ~35 °N to ~45 °N across ocean basins — a region that includes the Gulf of Maine.


```{r}
#| label: global-anom-raster-prep

# Load and format the anomalies for the year:

# Set time limits
annual_dates <- as.Date(c(
  str_c(report_yr,"-01-01"), str_c(report_yr,"-12-31")))

# Make data window for season
global_data_window <- data.frame(lon = c(-360, 180),
                          lat = c(-90, 90),
                          time = annual_dates)

# Load data
global_anoms <- oisst_window_load(
  data_window = global_data_window, 
  anomalies = T, 
  box_location = "cloudstorage")

# Stack and tidy
global_anoms <- stack(global_anoms)
global_anoms <- setExtent(global_anoms, extent(c(0, 360, -90, 90)))
global_anoms <- rotate(global_anoms)


# Change to F
global_anoms_f <- calc(global_anoms, function(x) as_fahrenheit(x, data_type = "anomalies"))

# Get Average for the year
global_anom_mean_f <- mean(global_anoms_f, na.rm = T)


```


```{r}
#| label: fig-global-anomalies
#| fig-cap: "Map of annual average sea surface temperature anomalies for the world’s oceans in 2022."
#| fig.width: 8
#| fig.height: 6

# Make it a stars class to plot with ggplot
global_anoms_st <- st_as_stars(global_anom_mean_f)

#### 1. Map the Anomalies in Space
annual_anom_map <- ggplot() +
  geom_stars(data = global_anoms_st) +
  geom_sf(data = world_sf, fill = "gray90", size = .25) +
  scale_y_continuous(breaks = seq(-90, 90, by = 30)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits, 
                       breaks = temp_breaks,
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  labs(title = str_c(report_yr, ": Average Temperature Anomalies"),
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  coord_sf(expand = FALSE) +
  map_theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  guides("fill" = guide_colorbar(
    title = "Average Temperature Anomaly ",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
annual_anom_map
grid::grid.raster(lab_logo, x = 0.08, y = 0.08, just = c('left', 'bottom'), height = unit(1, "cm"))
```



## Daily Sea Surface Temperatures

The annual cycle of SST in the Gulf of Maine exhibits a familiar pattern with low temperatures in March and high temperatures in August (@fig-annual_hw_timeseries). The average difference between the annual maximum SST in August and the annual minimum SST in March is **add_value** °F. In `r report_yr`, the difference between the maximum SST (**add_date**, **add_value** °F) and minimum SST (**add_date**, **add_value** °F) was **add_value** °F, with daily SST anomaly values never falling below +**add_value** °F and reaching as high as +**add_value** °F above the long-term average.

## Record Setting Daily Temperatures


The figure below shows the highest recorded SST values for every day of the year in the Gulf of Maine. Record-setting days that occurred in `r report_yr` are denoted with red dots (@fig-hottest-days). Indeed, record-setting daily high SSTs in the Gulf of Maine were set for more than 1/2 of all days in November and December. The most daily records were set in November, which experienced record high SSTs for 24/30 or 80% of the month. In total, `r report_yr` set 169 record high temperature days in the Gulf of Maine; stated another way, nearly 46% of days in `r report_yr` experienced record high SSTs in the Gulf of Maine.

```{r}
#| label: fig-hottest-days
#| fig-cap: "Timeseries of the record high daily sea surface temperature in the Gulf of Maine for every day of the year. Record-breaking temperatures that were observed in `r report_yr` are denoted with red dots; when a record-breaking temperature for a given day was observed in any other year, that daily record is in gray."


# New hottest daily temps - maybe scratch

# Grab the hottest day for each day of the year
hottest_days <- region_hw %>% 
  group_by(doy) %>% 
  slice_max(order_by = sst_anom, n = 1) %>% 
  ungroup() 


# Total Number in report_yr
hottest_report_yr <- hottest_days %>% 
  count(yr) %>% 
  filter(yr == report_yr) %>% 
  pull(n)


# # Daily Record Temperatures
hottest_days <- hottest_days %>%
  mutate(
    record_period = case_when(
      yr == report_yr ~ as.character(report_yr),
      yr < report_yr & yr > 2000 ~ "Since 2010",
      yr < 2000 ~ "Before 2000"),
    flat_date = as.Date(str_c(report_yr, "-01-01")) + (doy - 1))

hottest_days_plot <- ggplot() +
  geom_point(data = filter(hottest_days, record_period != report_yr), aes(x = flat_date, y = sst_f, color = record_period), alpha = 0.5, size = 1) +
  geom_point(data = filter(hottest_days, record_period == report_yr), aes(x = flat_date, y = sst_f, color = record_period), size = 1.5) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = number_format(suffix = deg_f)) +
  scale_color_manual(values = c("darkred", "black", gmri_cols("orange"))) +
  labs(x = "Day of the Year",
       y = "Sea Surface Temperature",
       title = "Hottest Days on Record",
       subtitle = "Gulf of Maine",
       color = "Record Setting Year",
       caption = str_c("Temperature data covers period of 1982-", report_yr))  +
   theme(legend.position = c(0.15, 0.75),
         legend.background = element_rect(color = "black", fill = "white")) +
  guides(color = guide_legend(title.position = "top", title.hjust = 0.5))  +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.175, logo_height = 1, height_units = "cm")


hottest_days_plot
```


```{r}
#| label: fig-percent-records-bars
#| fig-cap: "A bar plot showing the percentage of days during each month in 2022 when a record-high temperature was observed in the Gulf of Maine (e.g., 80% — 24 days — of November were new record-setting high temperatures)."
#| fig.height: 4

# Fraction of each month setting records


# What days set records in report_yr
records_report_yr <- hottest_days %>% 
  filter(yr == report_yr) %>% #count(month)
  mutate(record_temp = TRUE) %>% 
  select(yr, time, sst, seas, sst_anom, record_temp)


# What percent of days in month were records:
record_percents <- region_hw %>% 
  filter(yr == report_yr) %>% 
  full_join(records_report_yr) %>% 
  mutate(record_temp = ifelse(record_temp == TRUE, TRUE, FALSE)) %>% 
  group_by(yr, month) %>% 
  summarise(n_days = n(),
            n_records = sum(record_temp, na.rm = T),
            .groups = "drop") %>% 
  mutate(percent_records = (n_records / n_days),
         highlight_oct = ifelse(month == "Nov", "flag", "filler")) %>% 
  ggplot(aes(month, percent_records, #fill = highlight_oct)#, 
             alpha = highlight_oct)
         ) +
  geom_col() +
  # scale_fill_grey() +
  geom_col(fill = as.character(gmri_cols("orange"))) +
  scale_alpha_manual(values = c("flag" = 1, "filler" = 0.4)) +
  scale_y_continuous(labels = percent_format(), limits = c(0,1), expand = expansion(add = c(0,0))) +
  theme(legend.position = "none") +
  labs(x = "Month", 
       y = "Fraction of the Month", 
       title = str_c(report_yr, ": Record Warm Daily Temperatures"),
       subtitle = "Large fraction of Nov. & Dec. dates set all-time highs for the Gulf of Maine ")   +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.18, logo_height = 1, height_units = "cm")


record_percents

```

## More Persistant, Intense Heatwaves


A marine heatwave (MHW) is defined as a period when there are 5 or more consecutive days when the observed SST is greater than the 90th percentile of the long-term average for that day. In the figure below, the long-term average is illustrated with the gray dashed line and the threshold for being a MHW day is illustrated by the dashed red line. The solid red line in the figure shows the observed SST for that day.

The Gulf of Maine met the criteria for MHW status for **add_value** days in `r report_yr`. While the warmest temperatures of the year were experienced in August (as we would expect from the climatology for the region), the largest temperature anomalies were observed during the last days of November, when they breached **add_value** °F above the long-term average.

```{r}
#| label: fig-annual_hw_timeseries
#| fig.height: 4
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Gulf of Maine extending from January 1 through November 30, 2022. Black lines representing the long-term (i.e., 1982 – 2011) average SST, the 10th percentile, and 90th percentile for a given day in the Gulf of Maine are labelled to indicate climatological reference points; a solid line (red for marine heatwave or blue for a non-event) indicate the observed SST this year; red and blue shading illustrates how far the observed SST falls from the climatological mean."
#| fig-alt: "A line chart shows the average sea surface temperature for each day of the year, and overlaid against it are notably smoother black lines representing the long-term mean, 10th percentile, and 90th percentile temperatures for those same days of the year. The area between the mean and the observed temperature is filled in with a solid color to indicate whether that day meets marine heatwave criteris. The observed temperatures for 2022 are above the 90th percentile for nearly the entire year, with the exception of two periods less than a week long in June and October."


# annual heatwave timeseries


# Show MHW Status Through the Year:
hw_temp_p <- year_hw_temps_two(year_hw_dat = report_yr_only, temp_units = "F") + 
  labs(
    title = str_c("Gulf of Maine SST: ", params$report_year))  +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.1, logo_height = 1, height_units = "cm")
hw_temp_p

```


Comparing daily SST anomalies and MHW status for `r report_yr` to the longer-term record — as in the figure below — it becomes clear that the frequency, duration, and intensity of MHWs has not only increased in the past decade, but reached a peak last year. Under historical levels of natural variability in the region, hot and cold SST anomalies tend to balance out within a year or over several years. What is being observed in the Gulf of Maine, however, is a loss of that balance: larger fractions of recent years are experiencing above average temperatures and cold spells are becoming vanishingly rare.


```{r}
#| label: fig-mhw-heatmap
#| fig-cap: "Heat map of daily SST anomalies from the beginning of 1982 through the fall of 2022. Not only do more large warm anomalies (darker reds) appear more frequently in recent years, but the frequency and duration of marine heatwave events (black lines) in the Gulf of Maine has become more pronounced in the past decade."
#| fig-alt: "A figure displays the temperatures for each day of year as a colored stripe, organized with a row for each day such that the day of year aligns vertically. The lower two-thirds has a roughly equal balance between colors for warm (red) and cold (blue) temperature anomalies. The top third of the image is almost completely red as temperature anomalies rarely fall below the long-term average. Black dots are overlaid onto days that meet the criteria for a heatwave, they are rare in the lower section and common in the red section."
#| fig.height: 8


# Heatmap


# All years:
heatmap_p <- region_hw %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2022) +
  labs(title = "Gulf of Maine Heatwave Record",
       y = "Year",
       x = "Month") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.05, logo_height = 1, height_units = "cm")

heatmap_p + labs(caption = "")
```

## Warming Rate

GMRI research was the first to reveal that the Gulf of Maine has been warming faster than the vast majority of the world’s ocean. The figure below updates this historical analysis by including data for `r report_yr`. Indeed, the story has not changed: it’s clear that the Gulf of Maine is warming faster than ~98% of the world’s ocean. The reason why this is so important is because the rate of change can have profound consequences for the biology of individual species and for entire food webs. These aspects are areas of ongoing work (and captured well in the recent IPCC Working Group II report on impacts, adaptation, and vulnerability).

```{r}
#| label: warming-rate-raster-load


# # 1. Warming Rates and Rankings
rates_path <- str_c(oisst_path, "warming_rates/annual_warming_rates1982to2022.nc")
rates_nc <- stack(rates_path, varname = "annual_warming_rate")
ranks_nc <- stack(rates_path, varname = "rate_percentile")



# Get the rank information that go with each area
ranks_masked <- mask_nc(ranks_nc, region_extent)
rates_masked <- mask_nc(rates_nc, region_extent)
region_ranks <- get_masked_vals(masked_ranks = ranks_masked, 
                                masked_rates = rates_masked, 
                                in_fahrenheit = T)


# Prep it for text input.
avg_rank <- region_ranks$`Mean Rank` * 100
avg_rate <- region_ranks$`Mean Rate`
low_rank <- region_ranks$`Min Rank` * 100
low_rate <- region_ranks$`Min Rate`
top_rank <- region_ranks$`Max Rank` * 100
top_rank <- ifelse(top_rank == 100, "greater than or equal to 99.5", top_rank)
top_rate <- region_ranks$`Max Rate`
```


```{r}
#| label: fig-warming-rank-map
#| fig-cap: "Maps of the northwest atlantic and global rate of warming displayed as their relative percentiles."
#| column: page-inset-left
#| fig.width: 8

# Map of fastest Warming Regions:

# Idea: Global Map & Highlighted Regions
# Fix Colors


# for an expanded view need to use the global ranks
world_rank_stars <- st_as_stars(rotate(ranks_nc))

# Reclassify raster into 10% Bins
world_ranks_binned <- world_rank_stars %>% 
  mutate(
    rank = Annual.Sea.Surface.Temperature.Warming.Rate.Rank,
    rank_bin = cut(rank, breaks = seq(0, 1, by = 0.1))) %>% 
  select(-c(rank, Annual.Sea.Surface.Temperature.Warming.Rate.Rank))

# # Define the number of colors you want
# nb.cols <- 10
# mycolors <- RColorBrewer::brewer.pal(n = 10, "Reds")


# Northeast Shelf
global_ranks_zoom <- ggplot() +
  geom_stars(data = world_ranks_binned) +
  geom_sf(data = new_england, color = "white", fill = "gray30", size = .05) +
  geom_sf(data = canada, color = "white", fill = "gray30", size = .05) +
  geom_sf(data = greenland, color = "white", fill = "gray30", size = .05) +
  scale_y_continuous(breaks = seq(-90, 90, by = 5)) +
  scale_x_continuous(breaks = seq(-180, 180, by = 10))+
  scale_fill_brewer(palette = "Spectral", direction = -1, na.value = "transparent") +
  # scale_fill_viridis_d(option = "viridis", direction = 1, na.value = "transparent", na.translate = FALSE) +
  map_theme() +
  coord_sf(
    xlim = c("xmin" = -77, "xmax" = -50),
    ylim = c("ymin" = 32, "ymax" = 48),
    expand = T) +
  guides("fill" = guide_colorsteps(
    title = str_c("Warming Rate Percentile: 1982-", report_yr),
    title.position = "top", 
    title.hjust = 0.5,
    barwidth = unit(2.5, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 


# Global View
global_ranks <- ggplot() +
  geom_stars(data = world_ranks_binned) +
  geom_sf(data = world_sf, color = "white", fill = "gray30", size = .1) +
  scale_fill_brewer(palette = "Spectral", direction = -1, na.value = "transparent") +
  # scale_fill_viridis_d(option = "viridis", direction = 1, na.value = "transparent", na.translate = FALSE) +
  map_theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  coord_sf(expand = F) +
  scale_y_continuous(breaks = seq(-90, 90, by = 30)) +
  guides("fill" = guide_colorsteps(
    title = str_c("Warming Rate Percentile: 1982-", report_yr),
    title.position = "top", 
    title.hjust = 0.5,
    barwidth = unit(2.5, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 


# plot map
ranks_global_figure <- (global_ranks_zoom | global_ranks ) + 
  plot_annotation(title = "Global SST Change Rankings", 
                  caption = "Data Source: OISSTv2") +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")


# plot patchwork
ranks_global_figure
grid::grid.raster(lab_logo, x = 0.115, y = 0.115, just = c('left', 'bottom'), height = unit(1, "cm"))

```


## Concluding Thoughts:

In recent years, SSTs in the Gulf of Maine (and adjacent waters) have increased and the rate of warming has accelerated. Research suggests there are two major factors at play, one oceanographic and one atmospheric:

1. **Oceanographic:** The Gulf of Maine is influenced by two primary oceanic currents: the Labrador Current and the Gulf Stream. Historically, a stronger southward flow of the Labrador Current has kept the heat transported northward along the U.S. east coast by the Gulf Stream further out to sea. But changes are occurring in the interplay between the Labrador Current and Gulf Stream. More Arctic-origin freshwater from melting sea ice and land-based ice is constricting the southward flow of the Labrador Current, which is also allowing the Gulf Stream to spread out more at lower latitudes around the Gulf of Maine. This is allowing warmer water to “spill over” into the Gulf of Maine.


2. **Atmospheric:** The North Atlantic Oscillation — a large-scale pattern of natural variability in the atmosphere — has been in a “positive phase” more frequently over the past 10-15 years, meaning a more zonal (i.e., west-to-east) atmospheric pattern has dominated in the region. The relative decrease in “waviness” of the jet stream inhibits more consistent intrusions of cooler, Arctic air into the region.
The relative contribution of these two climatological drivers may vary through time, but the result (in sea surface temperature terms) is similar: a warmer Gulf of Maine.

**A Note on Data Sources**     

 * NOAA High Resolution SST data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.highres.html.    

**Recommended Citation:**    

> Gulf of Maine Research Institute. 2022. Gulf of Maine Warming Update: 2022 . https://gmri.org/stories/warming-22











---
# OLD ASSETS:



##  Temperature Anomaly Horizons

One way to think about the severity of these changes is to think about temperature horizons. A temperature horizon captures how long temperatures remain above certain thresholds. Each threshold is designated its own temperature, and in this way we can see how long within a year temperatures remained: 1 to 2 or as much as 4$^oC$ above normal.  



```{r}
#| label: fig-horizons-all
#| fig-cap: "Temperature anomaly horizons for all years of available satellite data (1982-2022). Horizons display how long temperatures were above certain thresholds (horizon width) and are colored by the strength of these events."
#| fig-alt: "Horizon plot of all years and their temperature anomaly horizons"
#| fig.height: 8
#| fig.width: 8

# Filter outliers beyond 25th and 75th quantile
cutpoints <- region_hw %>% 
  mutate(
    outlier = between(
      anom_f,
      quantile(anom_f, 0.25, na.rm = T)-
        1.5 * IQR(anom_f, na.rm = T),
      quantile(anom_f, 0.75, na.rm = T)+
        1.5 * IQR(anom_f, na.rm = T))) %>% 
  filter(outlier)

# Set origin
ori <- 0

# Manually pick cut points
sca <- seq(-5, 5, length.out = 9)
sca_bins <- str_c(sca[1:(length(sca)-1)], " to ", sca[2:length(sca)], "\u00b0F")
sca_labels <- rev(sca_bins)



# Plot Horizon Plot Using All Years
gom_annual_horizons <- anom_horizon_plot(
    grid_data = filter(region_hw, yr <= report_yr), 
    origin = ori, 
    scale_cutpoints = sca) +
  labs(title = "Temperature Anomaly Horizons",
       x = "Month",
       subtitle = "How deviation from the norm has become the new-normal",
       caption = "Climatatological Reference Period: 1982-2011") 


# Plot it
gom_annual_horizons

```

## Comparing the Gulf's Two Hottest Years

If we pull the horizons of our two hottest years on record it makes it easier to contrast where either one experienced acute high temperature events, and where there were sustained periods of above average temperatures.

Early into `r report_yr` it was apparent that the year was on-par with the previous title-holder for warmest year on record.


```{r}
#| label: fig-hottest-year-horizons
#| fig-cap: "Two horizon plots compare the timing and duration of elevated temperatures in the two warmest years on record, 2021 and now 2022. The width of a color horizon indicates the duration that temperatures were above that threshold."
#| fig-alt: "Single year horizon plots comparing 2021 and 2022"
#| fig.height: 6

# cut out outliers and set cutpoints
cutpoints_2 <- region_hw %>% 
  filter(year %in% c(2021, report_yr)) %>% 
  mutate(
    outlier = between(
      anom_f,
      quantile(anom_f, 0.25, na.rm=T)-
        1.5*IQR(anom_f, na.rm=T),
      quantile(anom_f, 0.75, na.rm=T)+
        1.5*IQR(anom_f, na.rm=T))) %>% 
  filter(outlier)



# 2021
hori_2021 <- region_hw %>% 
  filter(year == "2021") %>% 
  anom_horizon_plot(scale_cutpoints = cutpoints_2) +
  facet_wrap(~year, strip.position = "top")
  
# report_yr
hori_report_yr <- region_hw %>% filter(year == report_yr) %>% 
  anom_horizon_plot(scale_cutpoints = cutpoints_2) +
  facet_wrap(~year, strip.position = "top") +
  theme(plot.caption = element_text(colour = "gray25", size = 6)) +
  labs(x = "Month",
       caption = "Climatatological Reference Period: 1982-2011")

# Put them together as one figure
comparison_horizons <- hori_2021 / hori_report_yr + 
  plot_layout(guides = "collect")

# Do a bunch of formatting
comparison_horizons <- comparison_horizons &
  theme(
    plot.margin = margin(t = 0, r = 0.5, b = 0, l = 0.5),
          
    #Legend
    legend.position = "top",
    legend.key.height = unit(.5, "lines"),
    legend.key.width = unit(3.75, "lines")) &
   guides(fill = guide_legend(title = "Temperature Anomaly",
                              title.hjust = 0.5, 
                              title.position = "top",
                              label.position = "bottom", 
                              nrow = 1, 
                              byrow = T, reverse = T)) &
  plot_annotation(title = "Comparing the Gulf of Maine's Two Hottest Years", 
                  subtitle = "Duration of temperature anomaly horizons, colored by their strength")




# Plot it
comparison_horizons
grid::grid.raster(lab_logo, x = 0.04, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
  
```


## Losing the Balance Between Hot and Cold

Another way to visualize the climate transition that we are observing is by looking at the fraction of each year spent in different temperature ranges. Under a steady climate we would expect over the long-term to spend similar amounts of the year experiencing relatively warm & cold temperatures. These periods would balance themselves out and we would on-average have experienced something similar to the long-term climate.

What we have been seeing in the Gulf of Maine recently has lost that sense of balance. Larger fractions of the year are shared by above average temperatures & cold spell events are becoming vanishingly rare.


```{r}
#| label: fig-streamplot
#| fig-cap: "A streamplot shows the fraction of each year on record that temperature anomalies fell within ranges further from the climate reference period average. Since 2010 the Gulf of Maine's temperatures shifted rapidly outside of this expected range and a large fraction of the year is now 2 degrees or more above that average (red)."
#| fig-alt: "Streamplot tracking fraction of each year spent in varying degrees of temperature anomalies"



# Set Factor Order for Bins
bin_order <- c(
  "Less than -2", 
  "-2 to -1",
  "Within 1",
  "1 to 2", 
  "Greater than 2")

# Set Colors
bin_colors <- RColorBrewer::brewer.pal(n = length(bin_order), 
                                       name = "RdBu")
bin_colors <- rev(bin_colors)

# Count Days in Bins
day_types <- region_hw %>% 
  mutate(
    `Less than -2`   = if_else(anom_f <= -2, TRUE, FALSE),
    `-2 to -1`     = if_else(between(anom_f, -2, -1), TRUE, FALSE),
    `Within 1`     = if_else(between(anom_f, -1, 1), TRUE, FALSE),
    `1 to 2`       = if_else(between(anom_f, 1, 2), TRUE, FALSE),
    `Greater than 2` = if_else(anom_f >= 2, TRUE, FALSE)) %>% 
  group_by(yr) %>% 
  summarise(
    `Less than -2`   = sum(`Less than -2`, na.rm = T),
     `-2 to -1`    = sum(`-2 to -1`, na.rm = T),
    `Within 1`     = sum(`Within 1`, na.rm = T),
    `1 to 2`       = sum(`1 to 2`, na.rm = T),
    `Greater than 2` = sum(`Greater than 2`, na.rm = T),
    .groups = "drop") %>% 
  pivot_longer(cols = "Less than -2":"Greater than 2", 
               names_to = "Anomaly Strength", 
               values_to = "day_total", 
               values_drop_na = FALSE) %>% 
  mutate(day_total = if_else(is.na(day_total), 0L, day_total),
         `Anomaly Strength` = factor(`Anomaly Strength`, levels = bin_order))






# Plot the Streamplot
hw_streamplot <- ggplot(day_types, aes(yr, y = day_total, fill = `Anomaly Strength`)) +
  geom_stream(type = "proportion") +
  scale_x_continuous(breaks = seq(1980,2030, by = 10), 
                     minor_breaks = seq(1975, 2030, by = 5), 
                     expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = scales::percent_format(), 
                     expand = expansion(add = c(0,0))) + 
  scale_fill_manual(values = setNames(bin_colors, bin_order)) + 
  labs(y = "Percent of Year", x = "Year", fill = "", 
       title = "A Warmer Gulf of Maine",
       subtitle = "An increasing fraction of each year experiencing warm temperature anomalies",
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  theme(
    legend.position = "top",
    legend.key.height = unit(.5, "lines"),
    legend.key.width = unit(3.75, "lines"),
    plot.margin = unit(c(.5,1,.3,.5), "cm"),
    plot.title.position = "plot",
    legend.margin = margin(c(7,0,0,0)),
    legend.justification = "center") +
   guides(fill = guide_legend(title = "Temperature Anomaly \u00b0F",
                             title.hjust = 0.5,
                             title.position = "left",
                             label.position = "bottom",
                             nrow = 1,
                             byrow = T)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.115, logo_height = 1, height_units = "cm")


# Show figure
hw_streamplot  
```










```{r}
#| label: figure-saving
#| results: hide


####  Saving Figures  ####
if(params$save_figures){
  
  
  # simplified temperature plot
  ggsave(plot = temp_simplified, filename = str_c(save_location, "oisst_simple_trends.png"),
         dpi = "retina", bg = "white")
  
  
  
  # report_yr Record daily temperatures
  ggsave(plot = hottest_days_plot,
         filename = str_c(save_location, report_yr, "_hottest_days.png"),
         dpi = "retina", bg = "white")
  
  # Percentage of record temperatures bars
  ggsave(plot = record_percents,
         filename = str_c(save_location, report_yr, "_percent_record_bars.png"),
         dpi = "retina", bg = "white")
  
  
  
  # Full Year Temperatures
  ggsave(plot = hw_temp_p, filename = str_c(save_location, "oisst_lastyr_temps.png"),
         dpi = "retina", bg = "white")
  
  
  
  # Full Year Anomalies
  ggsave(plot = hw_anom_p, filename = str_c(save_location, "oisst_lastyr_anoms.png"),
         dpi = "retina", bg = "white")
  
  
  
  # Full year timeline of temps and anomalies
  ggsave(plot = year_timeline, filename = str_c(save_location, "oisst_lastyr_timeline.png"),
         dpi = "retina", bg = "white")
  
  
  # Heatwave status heatmap
  ggsave(plot = heatwave_heatmap, filename = str_c(save_location, "oisst_gom_heatmap.png"),
         dpi = "retina", bg = "white")
  
  
  # All year temperature horizons
  ggsave(plot = gom_annual_horizons, filename = str_c(save_location, "oisst_gom_horizons.png"),
         dpi = "retina", bg = "white")
  
  
  # report_yr | 2021 horizons
  ggsave(plot = comparison_horizons, filename = str_c(save_location, "gom_hottest_horizons.png"),
         dpi = "retina", bg = "white")
  
  
  # streamplot
  ggsave(plot = hw_streamplot, filename = str_c(save_location, "gom_anomaly_streamplot.png"),
         dpi = "retina", bg = "white")
  
  
  # record years panels
  ggsave(plot = hottest_yr_panels, 
         filename = str_c(save_location, "gom_hottest_year_panels.png"),
         dpi = "retina", bg = "white")
  
  # Annual Temperature Anomalies Map(s)
  ggsave(plot = annual_gom_map, 
         filename = str_c(save_location, "gom_annual_anom_map.png"),
         dpi = "retina", bg = "white")
  
  # Global version
  ggsave(plot = annual_anom_map, 
         filename = str_c(save_location, "global_annual_anom_map.png"),
         dpi = "retina", bg = "white")
  
  # Ranks maps
  ggsave(plot = ranks_map, filename = str_c(save_location, "record_years_map.png"),
         dpi = "retina", bg = "white")
  
  
  # northeast warmest years
  ggsave(plot = northeast_records, filename = str_c(save_location, "record_years_ne_map.png"),
         dpi = "retina", bg = "white")
  
  
  # Global warming rates
  ggsave(plot = rates_global_figure, filename = str_c(save_location, "global_rates_map.png"),
         dpi = "retina", bg = "white")
  
  
  # global warming rankings
  ggsave(plot = ranks_global_figure, filename = str_c(save_location, "global_ranks_map.png"),
         dpi = "retina", bg = "white")
  
  # top 20% rankings
  ggsave(plot = top_ranks_figure, filename = str_c(save_location, "ranks_top20.png"),
         dpi = "retina", bg = "white")
  
  
  
  # LME Report Table
  gtsave(data = lme_rank_table, 
         filename = str_c(save_location, "lme_warming_table.png"))


  
  
  
  
}



  
```




```{r}
#| results: asis
insert_gmri_footer()
```

