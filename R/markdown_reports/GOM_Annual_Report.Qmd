---
title: "Gulf of Maine Warming Update: 2022 the Regions Second Warmest Year"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  Documenting one more year in a decade of above-average regional temperatures
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
execute: 
  echo: false
  message: false
  warning: false
  comment: ""
  fig.align: center
params: 
  report_year: 2022
  in_celsius: FALSE
  save_figures: 
    label: "Save Figures?" 
    value: TRUE
---

```{r}
#| label: code-setup
#| include: false

####  Packages  ####
{
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(rgeoboundaries)
library(scales)
library(sf)
library(stars)
library(gmRi)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(tidyverse)
library(ggthemes)
library(ggstream)
library(ggforce)
library(geomtextpath)
library(ggHoriPlot)
# library(tidytext)
}

#---------- Support Functions
suppressPackageStartupMessages( source(here("R/oisst_support_funs.R"), verbose = FALSE) )
suppressPackageStartupMessages( source(here("R/temp_report_support.R"), verbose = FALSE) )


#----------- Paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# File paths for various extents based on "apershing_gulf_of_maine"
region_paths <- get_timeseries_paths(region_group = "gmri_sst_focal_areas", 
                                     box_location = "cloudstorage")

# Folder for Comms Team Update
comm_folder <- cs_path("root", "Program Communications/Climate Center — Program Communications/Warming Updates/Visuals/")

# Folder based on year
save_location <- str_c(comm_folder, "Annual ", params$report_year,"/")


#----------- Parameters

# Set the year for the report:
report_yr <- params$report_year

# # Box Location to save hi-res images
# save_location <- cs_path("root", "GoM Seasonal Climate Update/annual_update_figures")


#----------- Components

# Timeseries Path
timeseries_path <- region_paths[["apershing_gulf_of_maine"]][["timeseries_path"]]

# Polygon Path
poly_path <- region_paths[["apershing_gulf_of_maine"]][["shape_path"]]
region_extent <- read_sf(poly_path)

# Pull extents for the region for cropping
crop_x <- st_bbox(region_extent)[c(1,3)]
crop_y <- st_bbox(region_extent)[c(2,4)]

# Expand the area out to see the larger patterns, Used as plot limits
crop_x_expanded <- crop_x + c(-2.25, 2.25)
crop_y_expanded <- crop_y + c(-0.75, 0.75)

# Make a new extent for cropping to larger area
sfc <- make_cropbox(xlims = crop_x_expanded, ylims = crop_y_expanded)

# Projection to use for everything
master_crs <- st_crs("EPSG:4326")

# Coastline Shapes
canada      <- ne_states("canada", returnclass = "sf") %>% st_transform(master_crs)
new_england <- gb_adm1(country = "usa", type = "sscgs")  %>% st_transform(master_crs)
world_sf    <- ne_countries(returnclass = "sf")  %>% st_transform(master_crs)
greenland   <- ne_states(country = "greenland", returnclass = "sf") %>% st_transform(master_crs)

# Adding Logo to plots
logo_path <- paste0(system.file("stylesheets", package = "gmRi"), "/gmri_logo.png")
lab_logo <- magick::image_read(logo_path)


```


```{r}
#| label: code-add-css
#| results: asis
#| echo: false

gmRi::use_gmri_style_rmd(css = "gmri_rmarkdown.css")
```



Over the past decade, scientists at the Gulf of Maine Research Institute have led a body of research that highlights the rapid pace of warming in the Gulf of Maine. To keep you informed, we share seasonal and annual updates about conditions in the Gulf of Maine.

For analyses like these that characterize environmental conditions for a particular area—in this case, the Gulf of Maine—it is important to be clear about the spatial extent that defines the region of study; different domain boundaries could produce different results. The spatial area we use to define the “Gulf of Maine” is displayed in @fig-map, and has remained consistent throughout our seasonal and annual warming updates. 


```{r}
#| label: fig-map
#| fig.width: 8
#| fig.height: 8
#| fig.cap: "Spatial domain used for Gulf of Maine SST analyses. Dotted line denotes region of study for this analysis.  Depth contours are colored at 100m intervals to a maximum of 600m, deeper blues indicate deeper water depths."
#| fig.alt: "An overhead view of the Gulf of Maine region. Landmasses and political boundaries for the United States and Canada are displayed. A blue dotted line outlining a box with a transparent blue fill is shown to demark where satellite data for the analysis has been used."
#| 

# Load the bounding box for Andy's GOM to show they align
region_extent <- st_read(poly_path, quiet = TRUE)


# Map the Gulf of Maine with Bathymetry
gom_extent_p <- map_study_area_color(
  region_extent = region_extent,
  new_england_sf = new_england,
  canada_sf = canada,
  greenland_sf = greenland) +
  labs(title = "Gulf of Maine Study Area")


# Show figure
gom_extent_p
```



```{r}
#| label: bathymetry-details

# This work to plot but the detail takes forever with ggplot the more we zoom out
# Add the bottom contours:
bathy <- raster(str_c(cs_path("res","Bathy/"), "ETOPO1/NEShelf_Etopo1_bathy.tiff")) 

# Or make terra for ggplot using tidyterra
elev_terra <- terra::rast(bathy)


# If we go north a touch we can use the NE state outlines
old_england <- ne_states("united states of america", returnclass = "sf")


# Attempts at upgrading the new map
area_labs<- tribble(
  ~"label",              ~"lat", ~"lon", ~"angle", ~"color",
  "Georges\nBank",       41.15, -67.75,  0,        "black",        
  "Jordan\nBasin",       43.5,   -67.5,  0,        "black", 
  "Wilkinson\nBasin",    42.29,  -69.2,  0,        "black", 
  "Northeast\nChannel",  42.385,  -66.2,  0,        "black", 
  "Scotian\nShelf",      43.675, -63.2, 0,        "black", 
  "Mid-Atlantic\nBight", 40,   -72.6,  0,        "black", 
  "Laurentian Channel",  46.3,   -58.2,  310,      "black" )
  

# # Make the map
# ggplot() +
#   tidyterra::geom_spatraster_contour_filled(
#     data = elev_terra,
#     breaks = c(seq(0,-400,-100), -500, -1000, -1500,  -8000),
#     show.legend = T) +
#   # tidyterra::geom_spatraster_contour(
#   #   data = elev_terra,
#   #   breaks = seq(0,-400,-100),
#   #   alpha = 0.75) +
#   geom_sf(data = old_england, fill = "gray90", linewidth = .15) +
#   geom_sf(data = canada, fill = "gray90", linewidth = .15) +
#   geom_sf(data = greenland, fill = "gray90", linewidth = .15) +
#   geom_text(data = area_labs, aes(lon, lat, label = label, angle = angle), size = 3, color = "black") +
#   geom_sf(data = region_extent,
#           color = "black",
#           linetype = 2, linewidth = 0.5,
#           fill = "transparent") +
#   scale_fill_brewer(palette = "Blues", direction = 1) +
#   scale_y_continuous(breaks = seq(30, 50, by = 2)) +
#   coord_sf(xlim = c(-78, -56.5), ylim = c(38.5, 48)) +
#   map_theme(legend.position = "bottom") +
#   guides(fill = guide_colorsteps(
#     title = "Depth", 
#     title.position = "top", 
#     title.hjust = 0.5, 
#     barwidth = unit(4, "in"), 
#     frame.colour = "black", 
#     ticks.colour = "black",
#     show.limits = T)) +
#   labs(x = "", y = "", title = "Gulf of Maine Study Area")

```

```{r}
#| label: code-load-timeseries

# Load the timeseries
region_timeseries <- read_csv(timeseries_path, 
                              col_types = cols(), 
                              guess_max = 1e6)


# Clean up the data - add labels
region_timeseries <- region_timeseries %>% 
  mutate(time = as.Date(time)) %>% 
  distinct(time, .keep_all = T) %>% 
  supplement_season_info() %>% 
  filter(year %in% c(1982:report_yr))



# Summarize by year to return mean annual anomalies and variance
annual_summary <- region_timeseries %>% 
  group_by(year) %>% 
  temperature_summaries() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(area_wtd_anom > 0, "Hot", "Cold"))


# Get heatwave statuses for each day:
# Uses area weighted sst by default
region_hw <- pull_heatwave_events(
  temperature_timeseries = region_timeseries, 
  threshold = 90, 
  clim_ref_period = c("1982-01-01", "2011-12-31")) %>% 
  supplement_hw_data() %>% 
  filter(doy != 366)


# Data for the Report Year Only
report_yr_only <- region_hw %>% 
  filter(year(time) == report_yr)

# Set up the date within a year for Heatmap
base_date <- as.Date("2000-01-01")
region_hw <- region_hw %>% 
  mutate(year = year(time),
         yday = yday(time),
         flat_date = as.Date(yday-1, origin = base_date),
         yr_rev = factor(year),
         yr_rev = fct_rev(yr_rev))


# # Global Temperature Anomalies
global_anoms <- read_csv(
    paste0(oisst_path, "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = year(time)) %>% 
  filter(between(year, 1982, report_yr)) %>% 
  supplement_season_info()

# summarize by year again
global_summary <- global_anoms %>% 
  group_by(year) %>% 
  temperature_summaries() %>% 
  mutate(yr_as_dtime = as.Date(paste0(year, "-07-02")),
         anom_direction = ifelse(area_wtd_anom > 0, "Hot", "Cold"))
```




```{r}
#| label: code-all-data-summary

# Get the overall average and build labels
all_year_avgs <- annual_summary %>% 
  summarise(avg_temp_c = mean(area_wtd_sst),
            avg_temp_f = mean(area_wtd_f),
            avg_anom_c = mean(area_wtd_anom),
            avg_anom_f = mean(area_wtd_anom_f),            
            .groups = "drop") %>% 
  mutate(temp_label = str_c(round(avg_temp_c, 2), " \u00b0C  |  ", round(avg_temp_f, 2), " \u00b0F"))

```



```{r}
#| label: txt-report-yr-records

# Values I need up front for text

# average annual sst, its anomaly value:
report_annual_temp <- round(mean(report_yr_only$sst_f, na.rm = T), 2)
report_annual_anom <- round(mean(report_yr_only$anom_f, na.rm = T), 2)

# What rank this year was
report_rank <- filter(annual_summary, year == report_yr) %>% pull(sst_rank)
global_report_rank <- filter(global_summary, year == report_yr) %>% pull(sst_rank)

# Record holder year's temperature
record_year_temp <- filter(annual_summary, sst_rank == 1) %>% pull(sst_f)

# Note on how the seasons ranked:
month_ranks <- region_timeseries %>% 
  supplement_season_info() %>% 
  split(.$month) %>% 
  map_dfr(~ .x %>% 
    group_by(year, month) %>% 
    temperature_summaries()) %>% 
    filter(year == report_yr)


# How many days in this year meet mhw criteria
# add some acknowledgement of the extreme characteristics:
hw_criteria <- report_yr_only %>% pull(mhw_event) %>% sum()
```

## Highlights from Another Remarkably Warm Year


 * With an annual average sea surface temperature (SST) of `r report_annual_temp`°F — more than `r report_annual_anom`°F above normal — the Gulf of Maine experienced its `r report_rank`nd warmest year on record in `r report_yr`. This year fell short of the previous warmest year on record — 2021 — `r round(record_year_temp-report_annual_temp, 2)`°F, but was record-breaking in a number of regards. 

 * In nine of the twelve months this year, average monthly SST was within the top 3 warmest among all years on record. 
 
 * The most extreme temperatures in 2022 occurred in November and December, each setting new records for highest monthly average SST in the Gulf of Maine.

 * The “coolest” monthly average temperature anomalies for 2022 occurred during July and September, but were still within the top ten for each of those months when compared to the full 40-year dataset (ranked 8th and 6th, respectively). 
 
 * SSTs in 2022 were consistent with the long-term trend of increasingly warm conditions driven primarily by anthropogenic climate change. 




## Annual Sea Surface Temperature Trends



```{r}
#| label: code-warming-rates


####  Run Warming Rate regressions  ####
rate_data <- list(
  "GoM All F" = get_decadal_rates(
    temp_df = annual_summary, 
    temp_col = "area_wtd_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "GoM", 
    degree_c = F),
  "Global All F" = get_decadal_rates(
    temp_df = global_summary, 
    temp_col = "area_wtd_f", 
    year_col = "year", 
    year_lim = c(1982, report_yr), 
    area_name = "Global Ocean", 
    degree_c = F))



# Build Regression Equation Labels
eq_all_f    <- rate_data[["GoM All F"]][["eq_label"]]
eq_global_f <- rate_data[["Global All F"]][["eq_label"]]

```


Since the early 1980s, the rate of warming in the Gulf of Maine `r str_c(rate_data[["GoM All F"]][["decadal_rate"]], "\u00b0F / Decade")` has been more than triple that of the world’s oceans (`r str_c(rate_data[["Global All F"]][["decadal_rate"]], "\u00b0F / Decade")` @fig-global-comparison). The precise causes of the pronounced jump in annual average SSTs in the region from 2009 to 2012 remains an area of active research, but the sustained warm conditions suggest a regime shift in the influence of major ocean currents (i.e., Gulf Stream vs Labrador Current) in the Gulf of Maine. While a long-term increase in SSTs is expected as a result of human-caused climate change, we also expect each year to be influenced by large-scale patterns of natural variability, particularly on sub-global (i.e., regional) scales. SST conditions in the Gulf of Maine for `r report_yr` retain the region’s distinction as being one of the fastest warming ocean regions on the planet; including the `r report_yr` data shows that the Gulf of Maine is warming faster than 97% of the world’s ocean surface. 


```{r}
#| label: fig-global-comparison
#| fig-cap: "A timeseries of annual average sea surface temperature anomalies for the Gulf of Maine (solid black line) from 1982 through 2022, illustrating that 2022 was the 2nd warmest year on record. Long-term trendlines for the Gulf of Maine (blue) and the entire globe (green) show how much more quickly the Gulf of Maine is warming compared to the rest of the world."


# Fahrenheit plot
temp_simplified <- global_rate_comparison(
  annual_summary_dat = annual_summary, 
  global_summary_dat = global_summary, 
  eq_all = str_remove(eq_all_f, "1982-2022"), 
  eq_global = str_remove(eq_global_f, "1982-2022"), 
  temp_units = "F",
  region_label = "Gulf of Maine") +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.115, y_npc = -0.175, logo_height = 1, height_units = "cm")

# add logo
temp_simplified 

```



Zooming in to sub-annual timescales reveals some interesting patterns: the observed rate of warming in the Gulf of Maine varies throughout the year. Comparisons across the four quarters of the year  (@fig-seasons-comparison) reveal that the Gulf of Maine is warming fastest during July-September (~4x the global ocean average)—almost twice the rate seen during January-June (~3x the global ocean average).



```{r}
#| label: fig-seasons-comparison
#| fig-cap: "Four timeseries panels of the annual averages for 3-month periods (solid black lines) for the Gulf of Maine. Decadal trends are overlaid to compare decadal trends in the Gulf of Maine (blue) and the entire globe (green). Rates are much faster in the Gulf of Maine across all periods, with the smallest difference in rates during January-March."
#| fig.width: 8
#| fig.height: 7


# Pull the data out by season: annual_summary steps but for each season
season_summary <- region_timeseries %>% 
  mutate(
    month_groups = case_when(
      month %in% c("Jan", "Feb", "Ma")   ~ "January - March",
      month %in% c("Apr", "May", "Jun")  ~ "April - June",
      month %in% c("Jul", "Aug", "Sep")  ~ "July - September",
      month %in% c("Oct", "Nov", "Dec")  ~ "October - December")) %>% 
  group_by(yr, month_groups) %>% 
  temperature_summaries()

global_season_summary <- global_anoms %>% 
  mutate(
    month_groups = case_when(
      month %in% c("Jan", "Feb", "Ma")   ~ "January - March",
      month %in% c("Apr", "May", "Jun")  ~ "April - June",
      month %in% c("Jul", "Aug", "Sep")  ~ "July - September",
      month %in% c("Oct", "Nov", "Dec")  ~ "October - December")) %>% 
  group_by(yr, month_groups) %>% 
  temperature_summaries() 




# Think we can Facet, but then the stupid rates won't be there...
season_avgs <- bind_rows(
  list(
    "Gulf of Maine" = season_summary,
    "Global Ocean" = global_season_summary), 
  .id = "Region") %>% 
  mutate(month_groups = factor(month_groups,
    levels = c("January - March", "April - June", "July - September", "October - December")))


# Decadal Rates Function
rate_calc <- function(.data){
   annual_lm <- lm(anom_f ~ yr, data = .data)
    rate_x <- round(coef(annual_lm)["yr"] * 10, 2)
    eq_lab <- paste0(": ", rate_x, deg_f, " / Decade")
    mutate(.data, rate_eq = eq_lab)
}


# Run the numbers to make the label
season_avgs <- season_avgs %>% 
  group_by(Region, month_groups) %>% 
  group_map( ~rate_calc(.), .keep = TRUE) %>% 
  bind_rows() %>% 
  mutate(rate_eq = str_c(Region, rate_eq))



# Make the four panels:
season_panels <- season_avgs %>% 
  split(.$month_groups) %>% 
  imap(function(x, y){
    
    season_p <- ggplot(x, aes(yr, anom_f)) +
      geom_line( data = filter(x, Region == "Gulf of Maine"), linewidth = 1, linetype = 1) +
      geom_point(data = filter(x, Region == "Gulf of Maine"), size = 1.5) +
      stat_smooth(
        aes(color = rate_eq), 
        method = "lm", 
        formula = y~x, 
        linetype = 1, 
        linewidth = 1.5, 
        alpha = 0.8,
        se = FALSE) +
      facet_wrap(~month_groups, ncol = 2) +
      scale_color_manual(values = c(gmri_cols("green"), gmri_cols("blue"))) +
      scale_y_continuous(labels = number_format(suffix = deg_f)) +
      theme(
        legend.position = c(0.35, 0.8),
        legend.background = element_rect(color = "black", fill = "white")) +
      labs(
        x = "Year", 
        y = "SST Anomaly",
        color = str_c(y, " Trend (1982-2022)"))
    
    if(y == "Winter"){
      season_p <- season_p +
        geom_point(data = filter(x, yr == 2022, Region == "Gulf of Maine"), aes(yr, anom_f),
                   shape = 21, color = "black", fill = "white", size = 1.5)}
    
    # Return the plot
    season_p
      
  })


# Assemble the plot
panel_plot <- (season_panels$`January - March` |season_panels$`April - June`) / (season_panels$`July - September` | season_panels$`October - December`) + plot_annotation(caption = "") &
  theme(plot.margin = margin(t = 1, b = 1, r = 1, l = 1))

panel_plot
grid::grid.raster(lab_logo, x = 0.08, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
```


In addition to the sub-annual (or temporal) variation, there can also be significant spatial variability in annually-averaged SST patterns. The Gulf of Maine illustrated this fact, with the region southeast of Georges Bank exhibiting the highest annual average SST anomalies (@fig-new-england-map). This area is more susceptible than other areas in the region of study to large-scale variability in major oceanic currents, such as the relative influence of the Gulf Stream versus the Labrador Current.


```{r}
#| label: fig-new-england-map
#| fig-cap: "Map of annual average sea surface temperature anomalies in 2021. The box outlined by the black dashed line denotes the region of study for the analysis presented throughout this report."
#| fig.height: 6


# Set time limits to get data
annual_dates <- as.Date(
  c(str_c(report_yr,"-01-01"), str_c(report_yr,"-12-31")))

# Make data window for the year
data_window <- data.frame(lon = c(-81, -54.5),
                          lat = c(33.5, 50),
                          time = annual_dates)

# Load data, stack and tidy
ne_anoms <- oisst_window_load(
    data_window = data_window,
    anomalies = T,
    box_location = "cloudstorage") %>%  
  stack()

# Convert to F
ne_anoms_f <- calc(ne_anoms, function(x) as_fahrenheit(x, data_type = "anomalies")) %>% 
  setNames(names(ne_anoms))

# Process the yearly average
ne_annual_anom_f <- mean(ne_anoms_f, na.rm = T)



# Color limit for palettes
temp_limits <- c(-6, 6)
temp_breaks <- c(temp_limits[1], temp_limits[1]/2,  0, temp_limits[2]/2, temp_limits[2])
temp_labels <- str_c(c(str_c("< ", temp_limits[1]), temp_limits[1]/2, 0, temp_limits[2]/2, str_c("> ", temp_limits[2])), "\u00b0F")


# Make it a stars class to plot with ggplot
ne_anoms_st <- st_as_stars(ne_annual_anom_f)



#### 1. Map the Anomalies in Space
annual_gom_map <- ggplot() +
  geom_stars(data = ne_anoms_st) +
  tidyterra::geom_spatraster_contour(
    data = elev_terra,
    breaks = seq(0,-200,-100),
    alpha = 0.75) +
  geom_sf(data = new_england, fill = "gray90", linewidth = .15) +
  geom_sf(data = canada, fill = "gray90", linewidth = .15) +
  geom_sf(data = greenland, fill = "gray90", linewidth = .15) +
  geom_sf(data = region_extent,
          color = "black",
          linetype = 2, linewidth = 1,
          fill = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits, 
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  coord_sf(xlim = c(-78, -56.5), ylim = c(37.8, 48)) +
  labs(title = str_c(report_yr, ": Average Temperature Anomalies"),
       caption = "Anomalies calculated using 1982-2011 climatology.\n100m & 200m contours overlaid to show bathymetric details.") +
  map_theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0))+
  guides("fill" = guide_colorbar(
    title = "Average Temperature Anomaly ",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
annual_gom_map
grid::grid.raster(lab_logo, x = 0.1, y = 0.06, just = c('left', 'bottom'), height = unit(1, "cm"))


```

Looking at these spatial patterns across the annual quarters of `r report_yr` (@fig-four-season-maps) shows not only the large spatial variability in SST conditions, but also how that spatial variability can, itself, vary significantly over the course of the year. While the open ocean beyond Georges Bank exhibits significant spatial and temporal variability, @fig-four-season-maps also illustrates that the Gulf of Maine experiences more consistent SST conditions spatially and temporally (i.e., the entire region is anomalously warm throughout the year and the warmest areas tend to be those that are most heavily influenced by inflow from the Northeast Channel—the deep valley south of Nova Scotia and just off the northeast tip of Georges Bank). 


```{r}
#| label: fig-four-season-maps
#| fig-cap: "Maps of the  3-month averages in sea surface temperature anomalies in 2022."
#| fig.width: 8
#| fig.height: 6

# Four Season Panels

# Process the stack into the four 3-month averages
# Set time limits
season_dates <- list(
  "January - March" = distinct(filter(report_yr_only, month %in% c("Jan", "Feb", "Mar")), time) %>% pull(time),
  "April - June" = distinct(filter(report_yr_only, month %in% c("Apr", "May", "Jun")), time) %>% pull(time),
  "July - September"   = distinct(filter(report_yr_only, month %in% c("Jul", "Aug", "Sep")), time) %>% pull(time),
  "October - December" = distinct(filter(report_yr_only, month %in% c("Oct", "Nov", "Dec")), time) %>% pull(time)
)

# Grab the dates for each, process the mean 
season_stacks <- map(season_dates, function(x){
  dates_x <- str_c("X", str_replace_all(x, "-", "."))
  which_dates <- which(names(ne_anoms_f)  %in% dates_x)
  month_mean <- mean(ne_anoms_f[[which_dates]], na.rm = T)
  
})


# Assemble Panels Again:
season_panel_maps <- imap(season_stacks, function(x, seasn){
  
  season_df <- data.frame("season" = seasn)
  ne_season_st <- st_as_stars(x)
  season_map <- ggplot(data = season_df) +
    geom_stars(data = ne_season_st) +
    tidyterra::geom_spatraster_contour(
      data = elev_terra,
      breaks = seq(0,-200,-100),
      alpha = 0.75) +
    geom_sf(data = new_england, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = canada, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = greenland, fill = "gray90", 
            linewidth = .25) +
    geom_sf(data = region_extent, 
            color = "black", 
            linetype = 2, 
            linewidth = 1,
            fill = "transparent") +
    scale_y_continuous(breaks = seq(30, 50, by = 2)) +
    scale_fill_distiller(palette = "RdBu", 
                         na.value = "transparent", 
                         limit = temp_limits, 
                         labels = temp_labels,
                         oob = scales::oob_squish) +
    coord_sf(xlim = c(-78, -56.5), ylim = c(37.8, 48)) +
    facet_wrap(~season) +
    map_theme(
      legend.position = "bottom",
      legend.title = element_text(angle = 0))+
    guides("fill" = guide_colorbar(
      title = "Average Temperature Anomaly ",
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(3, "in"),
      frame.colour = "black",
      ticks.colour = "black")) 

# Show figure
season_map
})



# Put them together and format them
season_panels_all <- (season_panel_maps$`January - March` | season_panel_maps$`April - June`)/(season_panel_maps$`July - September` | season_panel_maps$`October - December`) +
  plot_layout(guides = "collect") & 
  theme(legend.position = 'bottom', 
        plot.margin = margin(t = 1, b = 1, r = 1, l = 1)) 

# Display them
season_panels_all + plot_annotation(caption = "100m & 200m contours overlaid to show bathymetric details.")
grid::grid.raster(lab_logo, x = 0.08, y = 0.04, just = c('left', 'bottom'), height = unit(1, "cm"))

```


## Annual Average 2022 SST Compared to Historical Conditions

When we compare the annual average SST in the Gulf of Maine for `r report_yr` (`r str_c(report_annual_temp, deg_f)`) to other years, we can see it narrowly beat out 2012 as the second warmest year on record. When we look at the deviation from the long-term average SST (i.e., the annual SST anomaly), the last decade stands out for its exceptional warmth (@fig-yr-ranks). `r report_yr` extends a pattern that began in 2010 of sustained above-average temperatures. With the exception of 2019 (ranked 13th), every one of the last ten years remains in the top 10 warmest years on record.


```{r}
#| label: fig-yr-ranks
#| fig-cap: "A ranking of the top 10 annual SST values [bars] and those years' respective SST anomalies [x-axis]."


# Plot the top 5 warmest years
temp_rankings_p <- annual_summary %>% 
  filter(sst_rank <= 10) %>% 
  mutate(flag_year = ifelse(year == report_yr, "flag", "unflag"),
         sst_rank =  fct_rev(factor(sst_rank))) %>% 
  ggplot() +
  geom_col(aes(x = anom_f, y = sst_rank, fill = flag_year)) +
  # Year Labels
  geom_text(
    mapping = aes(x = 0, y = sst_rank, label = str_c(sst_rank, ".  ", year)),
    hjust = -.1,
    color = 'white',
    fontface = "bold") +
  # Temperature Labels
  geom_text(
    mapping = aes(x = anom_f, y = sst_rank, label = str_c(round(sst_f,2), deg_f), group = sst_rank),
    hjust = 1.05,
    color = 'white',
    fontface = "bold") +
  scale_x_continuous(
    labels = number_format(suffix = deg_f), 
    expand = expansion(mult = c(0,0.15))) +
  scale_fill_manual(values = c("flag" = as.character(gmri_cols("orange")), 
                                "unflag" = as.character(gmri_cols("gmri blue")))) +
  labs(x = "Annually Averaged Temperature Anomaly",
       y = NULL,
       title = str_c("Ten Hottest Years in the Gulf of Maine"),
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0),
        legend.position = "none", 
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(hjust = 1, face = "bold"),
        axis.ticks.y = element_blank(),
        plot.margin = margin(t = 20, l = 10, r = 5, b = 5)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.15, logo_height = 1, height_units = "cm")

temp_rankings_p
```

## Comparison to Global Temperatures

It was not just the Gulf of Maine that experienced exceptional warmth in `r report_yr`, however. Globally, `r report_yr` was the `r global_report_rank`rd warmest year for sea surface temperatures, and [6th-warmest year for combined land & ocean temperatures.](https://www.noaa.gov/news/2022-was-worlds-6th-warmest-year-on-record). @fig-global-anomalies shows annual average SST anomalies for oceans all over the world in `r report_yr`. While much of the Southern Ocean and expanses of the southeastern Pacific were anomalously cool (a general feature of La Niña conditions), most of the world’s oceans experienced unusually warm temperatures in `r report_yr`. This is particularly true for northern midlatitudes, especially the northwestern Pacific (off Japan) and along the Eastern Seaboard of the United States—a region that includes the Gulf of Maine. 



```{r}
#| label: code-global-anom-prep

# Load and format the anomalies for the year:

# Set time limits
annual_dates <- as.Date(c(
  str_c(report_yr,"-01-01"), str_c(report_yr,"-12-31")))

# Make data window for season
global_data_window <- data.frame(lon = c(-360, 180),
                          lat = c(-90, 90),
                          time = annual_dates)

# Load data
global_anoms <- oisst_window_load(
  data_window = global_data_window, 
  anomalies = T, 
  box_location = "cloudstorage")

# Stack and tidy
global_anoms <- stack(global_anoms)
global_anoms <- setExtent(global_anoms, extent(c(0, 360, -90, 90)))
global_anoms <- rotate(global_anoms)


# Change to F
global_anoms_f <- calc(global_anoms, function(x) as_fahrenheit(x, data_type = "anomalies"))

# Get Average for the year
global_anom_mean_f <- mean(global_anoms_f, na.rm = T)


```


```{r}
#| label: fig-global-anomalies
#| fig-cap: "Map of annual average sea surface temperature anomalies for the world’s oceans in 2022."
#| fig.width: 8
#| fig.height: 6

# Make it a stars class to plot with ggplot
global_anoms_st <- st_as_stars(global_anom_mean_f)

#### 1. Map the Anomalies in Space
annual_anom_map <- ggplot() +
  geom_stars(data = global_anoms_st) +
  geom_sf(data = world_sf, fill = "gray90", linewidth = .25) +
  scale_y_continuous(breaks = seq(-90, 90, by = 30)) +
  scale_fill_distiller(palette = "RdBu", 
                       na.value = "transparent", 
                       limit = temp_limits, 
                       breaks = temp_breaks,
                       labels = temp_labels,
                       oob = scales::oob_squish) +
  labs(title = str_c(report_yr, ": Average Temperature Anomalies"),
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  coord_sf(expand = FALSE) +
  map_theme(
    legend.position = "bottom",
    legend.title = element_text(angle = 0),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  guides("fill" = guide_colorbar(
    title = "Average Temperature Anomaly ",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(3, "in"),
    frame.colour = "black",
    ticks.colour = "black")) 

# Show figure
annual_anom_map
grid::grid.raster(lab_logo, x = 0.08, y = 0.08, just = c('left', 'bottom'), height = unit(1, "cm"))
```



## Daily Sea Surface Temperatures

```{r}
#| label: txt-extreme-events

# typical range
seasonal_cycle_min <- min(report_yr_only$seas_f)
seasonal_cycle_max <- max(report_yr_only$seas_f)
seasonal_range <- round(seasonal_cycle_max - seasonal_cycle_min, 2)

# report_yr range
report_yr_min <- min(report_yr_only$sst_f)
report_yr_min_anom <- round(min(report_yr_only$anom_f), 2)
report_yr_min_date <- format(report_yr_only$time[report_yr_only$sst_f == report_yr_min], "%b-%d")
report_yr_max <- max(report_yr_only$sst_f)
report_yr_max_date <- format(report_yr_only$time[report_yr_only$sst_f == report_yr_max], "%b-%d")
report_yr_max_anom <- max(report_yr_only$anom_f)
report_yr_max_anom_date <- format(report_yr_only$time[report_yr_only$anom_f == report_yr_max_anom], "%b-%d")
report_yr_range <- round(report_yr_max - report_yr_min, 2)
report_yr_max <- round(report_yr_max, 2)
report_yr_max_anom <- round(report_yr_max_anom, 2)
report_yr_min <- round(report_yr_min, 2)
```


The annual cycle of SST in the Gulf of Maine exhibits a pattern common to regions in the Northern Hemisphere, with the lowest temperatures observed in March and the highest values observed in August (@fig-annual-hw-timeseries). Daily SST anomalies in `r report_yr` never fell below +`r report_yr_min_anom` °F compared to the long-term (1982-2011) average and reached as high as high as `r floor(report_yr_max_anom)` °F above the long-term average. The largest temperature anomalies were observed during November, which also turned out to be the warmest November on record (as highlighted in our [Fall 2022 update](https://www.gmri.org/stories/gulf-of-maine-warming-update-fall-2022/)). @fig-annual-hw-timeseries also illustrates that, in `r report_yr`, 353 days experienced SST anomalies that exceeded the threshold for being considered marine heatwaves, or MHW (more on MHWs below, including @fig-mhw-heatmap)


```{r}
#| label: fig-annual-hw-timeseries
#| fig.height: 4
#| fig-cap: "A timeseries of marine heatwave (MHW) conditions in the Gulf of Maine extending from January 1 through December 301 2022. Black lines representing the long-term (i.e., 1982 – 2011) average SST, the 10th percentile (i.e., cold spell threshold), and 90th percentile (i.e., heatwave threshold) for a given day in the Gulf of Maine are labeled to indicate climatological reference points. A solid line (red for marine heatwave or blue for a non-heatwave day) indicate the observed SST for each day; red and blue shading illustrates whether each day is considered part of a MHW event."
#| fig-alt: "A line chart shows the average sea surface temperature for each day of the year, and overlaid against it are notably smoother black lines representing the long-term mean, 10th percentile, and 90th percentile temperatures for those same days of the year. The area between the mean and the observed temperature is filled in with a solid color to indicate whether that day meets marine heatwave criteris. The observed temperatures for 2022 are above the 90th percentile for nearly the entire year, with the exception of two periods less than a week long in June and October."


# annual heatwave timeseries


# Show MHW Status Through the Year:
hw_temp_p <- year_hw_temps_two(year_hw_dat = report_yr_only, temp_units = "F") + 
  labs(
    title = str_c("Gulf of Maine SST: ", params$report_year))  +
  scale_x_date(date_labels = "%b", date_breaks = "1 month", expand = expansion(add = c(0,0))) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.125, logo_height = 1, height_units = "cm")
hw_temp_p

```



Daily SST values in `r report_yr` were some of the highest ever recorded in the Gulf of Maine.Record daily high SSTs were set for more than half of all days in November and December, with new records set in all months but July (@fig-percent-record-bars). The most daily records in a single month occurred in November, which experienced record high SSTs for 24 of the month’s 30 days. In total, record high daily temperatures were reached on 169 days in `r report_yr`— stated another way: nearly 46% of the year experienced record high SSTs.


```{r}
#| label: code-hottest-days
#| eval: true
#| fig-cap: "Timeseries of the record high daily sea surface temperature in the Gulf of Maine for every day of the year. Record-breaking temperatures that were observed in `r report_yr` are denoted with red dots; when a record-breaking temperature for a given day was observed in any other year, that daily record is in gray."

# New hottest daily temps - maybe scratch
# Grab the hottest day for each day of the year
hottest_days <- region_hw %>% 
  group_by(doy) %>% 
  slice_max(order_by = sst_anom, n = 1) %>% 
  ungroup() 

# Total Number in report_yr
hottest_report_yr <- hottest_days %>% 
  count(yr) %>% 
  filter(yr == report_yr) %>% 
  pull(n)

# # Daily Record Temperatures
hottest_days <- hottest_days %>%
  mutate(
    record_period = case_when(
      yr == report_yr ~ as.character(report_yr),
      yr < report_yr & yr > 2000 ~ "Since 2010",
      yr < 2000 ~ "Before 2000"),
    flat_date = as.Date(str_c(report_yr, "-01-01")) + (doy - 1))
```




```{r}
#| label: fig-percent-record-bars
#| fig-cap: "An illustration of the percentage of days during each month in 2022 when a record-high temperature was observed in the Gulf of Maine (e.g., 80% — 24 days — of November were new record-setting high temperatures)."
#| fig.height: 4

# Fraction of each month that were set


# What days set records in report_yr
records_report_yr <- hottest_days %>% 
  filter(yr == report_yr) %>% #count(month)
  mutate(record_temp = TRUE) %>% 
  select(yr, time, sst, seas, sst_anom, record_temp)


# What percent of days in month were records:
record_percents <- region_hw %>% 
  filter(yr == report_yr) %>% 
  full_join(records_report_yr) %>% 
  mutate(record_temp = ifelse(record_temp == TRUE, TRUE, FALSE)) %>% 
  group_by(yr, month) %>% 
  summarise(n_days = n(),
            n_records = sum(record_temp, na.rm = T),
            .groups = "drop") %>% 
  mutate(percent_records = (n_records / n_days),
         highlight_oct = ifelse(month == "Nov", "flag", "filler"))
  

# Build the plot
fig_percents <- ggplot(record_percents, aes(month, percent_records, alpha = highlight_oct)) +
  geom_col() +
  geom_col(fill = as.character(gmri_cols("orange"))) +
  geom_text(
    mapping = aes(x = month, y = percent_records, label = str_c(round(percent_records,2)*100, "%")),
    vjust = -.5,
    color = 'black',
    fontface = "bold") +
  scale_alpha_manual(values = c("flag" = 1, "filler" = 0.4)) +
  scale_y_continuous(labels = percent_format(), limits = c(0,1), expand = expansion(add = c(0,0))) +
  theme(legend.position = "none") +
  labs(x = "Month", 
       y = "Fraction of the Month", 
       title = str_c(report_yr, ": Record Warm Daily Temperatures"),
       subtitle = "Large fraction of Nov. & Dec. dates set all-time highs for the Gulf of Maine ")   +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.125, logo_height = 1, height_units = "cm")


# Show plot
fig_percents

```

## More Persistent, Intense Heatwaves in Recent Years


A marine heatwave (MHW) is defined as a period when there are five or more consecutive days when the observed SST is greater than the 90th percentile of the long-term average for that day. Gaps of 2 days or less in this threshold do not constitute a break in the MHW event. @fig-annual-hw-timeseries  illustrates that the Gulf of Maine met the criteria for experiencing a MHW for `r hw_criteria` days in `r report_yr` (or 97% of the year). Superimposing MHW status (black line) over the full timeseries of daily SST anomalies (blue/white/red shading) (@fig-annual-hw-timeseries) reveals that the frequency, duration, and intensity of MHWs has increased in the past decade. 


In a world without human-caused climate change, we would expect, positive (warm) and negative (cool) SST anomalies to more or less balance out over the span of several years, as various patterns of natural climate variability alternate having a dominant influence on Earth’s climate (e.g., La Niña vs El Niño). What is being observed in the Gulf of Maine (and elsewhere around the world), however, is a loss of that balance: larger fractions of recent years are experiencing above average temperatures and cold spells are becoming vanishingly rare.




```{r}
#| label: fig-mhw-heatmap
#| fig-cap: "Heat map of daily SST anomalies from the beginning of 1982 through the end of 2022. Not only do more large warm anomalies (darker reds) appear more frequently in recent years, but the frequency and duration of marine heatwave events (black lines) in the Gulf of Maine has become more pronounced in the past decade."
#| fig-alt: "A figure displays the temperatures for each day of year as a colored stripe, organized with a row for each day such that the day of year aligns vertically. The lower two-thirds has a roughly equal balance between colors for warm (red) and cold (blue) temperature anomalies. The top third of the image is almost completely red as temperature anomalies rarely fall below the long-term average. Black dots are overlaid onto days that meet the criteria for a heatwave, they are rare in the lower section and common in the red section."
#| fig.height: 8


# Heatmap: All years:
heatmap_p <- region_hw %>% 
  heatwave_heatmap_plot(temp_units = "F", start_yr = 1981, end_yr = 2022) +
  labs(title = "Gulf of Maine Heatwave Record",
       y = "Year",
       x = "Month") +
  theme(legend.position = "bottom",
        legend.title = element_text(angle = 0),
        plot.margin = margin(b = 0, t = 20)) +
  guides(fill = guide_colorbar(
    title = "Sea Surface Temperature Anomaly",
    title.position = "top", 
    title.hjust = 0.5, barwidth = unit(3.5, "in"), 
    barheight = unit(0.5, "cm"), 
    frame.colour = "black", 
    ticks.colour = "black")) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.9, y_npc = 1.05, logo_height = 1, height_units = "cm")

heatmap_p + labs(caption = "")
```

## Forthcoming Methodological Changes to GMRI SST Updates

These seasonal and annual temperature updates rely on a climatological reference period—referred to as a “normal” in the climate science community—against which we calculate anomalies. Starting with our next update, we will be adjusting this “normal” period in our calculations. To date, we have used 1982-2011 as the 30-year climatological reference period, and going forward, we will be using 1991-2020 as our climatological reference period. 


This update is standard practice: as time progresses, more data are collected, and new 30-year “normals” can be calculated every decade. However, since the period of 1991-2020 was warmer than 1982-2011, we can expect warm anomalies to be lower than those we report in this and prior updates. To be clear, this result will be merely an artifact of the shifting reference period, not an indication that warming in the Gulf of Maine has decreased. 


In addition, we will be modifying how we characterize and communicate about marine heatwaves. The concept of a marine heatwave emerged as a way to communicate a rare phenomenon where temperatures were much higher than historical conditions for a defined duration of time. As temperatures increase globally, SST observations that were once rare have become more common. Understanding this pattern, scientists now are considering new ways to define and communicate about marine heatwaves. GMRI scientists are part of this evolving discussion in the international scientific community, and we will incorporate alternative approaches for characterizing marine heatwaves in future updates. We are producing a technical report to explain these changes in greater detail. Its availability will be announced on our website and linked in our 2023 SST updates. 

 

---

**A Note on Data Sources**    

The figures in this report are created using remotely-sensed satellite data as part of publicly funded research efforts. Satellite SST data was obtained from NOAA’s National Center for Environmental Information (NCEI), with all maps and figures displaying NOAA’s Optimum Interpolation Sea Surface Temperature Data.


 * NOAA High Resolution SST data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.highres.html.    

**Recommended Citation:**    

> Gulf of Maine Research Institute. 2022. Gulf of Maine Warming Update: 2022. https://gmri.org/stories/warming-22





---
# OLD ASSETS:



##  Temperature Anomaly Horizons

One way to think about the severity of these changes is to think about temperature horizons. A temperature horizon captures how long temperatures remain above certain thresholds. Each threshold is designated its own temperature, and in this way we can see how long within a year temperatures remained: 1 to 2 or as much as 4$^oC$ above normal.  



```{r}
#| label: fig-horizons-all
#| fig-cap: "Temperature anomaly horizons for all years of available satellite data (1982-2022). Horizons display how long temperatures were above certain thresholds (horizon width) and are colored by the strength of these events."
#| fig-alt: "Horizon plot of all years and their temperature anomaly horizons"
#| fig.height: 8
#| fig.width: 8

# Filter outliers beyond 25th and 75th quantile
cutpoints <- region_hw %>% 
  mutate(
    outlier = between(
      anom_f,
      quantile(anom_f, 0.25, na.rm = T)-
        1.5 * IQR(anom_f, na.rm = T),
      quantile(anom_f, 0.75, na.rm = T)+
        1.5 * IQR(anom_f, na.rm = T))) %>% 
  filter(outlier)

# Set origin
ori <- 0

# Manually pick cut points
sca <- seq(-5, 5, length.out = 9)
sca_bins <- str_c(sca[1:(length(sca)-1)], " to ", sca[2:length(sca)], "\u00b0F")
sca_labels <- rev(sca_bins)



# Plot Horizon Plot Using All Years
gom_annual_horizons <- anom_horizon_plot(
    grid_data = filter(region_hw, yr <= report_yr), 
    origin = ori, 
    scale_cutpoints = sca) +
  labs(title = "Temperature Anomaly Horizons",
       x = "Month",
       subtitle = "How deviation from the norm has become the new-normal",
       caption = "Climatatological Reference Period: 1982-2011") 


# Plot it
gom_annual_horizons

```

## Comparing the Gulf's Two Hottest Years

If we pull the horizons of our two hottest years on record it makes it easier to contrast where either one experienced acute high temperature events, and where there were sustained periods of above average temperatures.

Early into `r report_yr` it was apparent that the year was on-par with the previous title-holder for warmest year on record.


```{r}
#| label: fig-hottest-year-horizons
#| fig-cap: "Two horizon plots compare the timing and duration of elevated temperatures in the two warmest years on record, 2021 and now 2022. The width of a color horizon indicates the duration that temperatures were above that threshold."
#| fig-alt: "Single year horizon plots comparing 2021 and 2022"
#| fig.height: 6

# cut out outliers and set cutpoints
cutpoints_2 <- region_hw %>% 
  filter(year %in% c(2021, report_yr)) %>% 
  mutate(
    outlier = between(
      anom_f,
      quantile(anom_f, 0.25, na.rm=T)-
        1.5*IQR(anom_f, na.rm=T),
      quantile(anom_f, 0.75, na.rm=T)+
        1.5*IQR(anom_f, na.rm=T))) %>% 
  filter(outlier)



# 2021
hori_2021 <- region_hw %>% 
  filter(year == "2021") %>% 
  anom_horizon_plot(scale_cutpoints = cutpoints_2) +
  facet_wrap(~year, strip.position = "top")  +
  labs(y = "")
  
# report_yr
hori_report_yr <- region_hw %>% filter(year == report_yr) %>% 
  anom_horizon_plot(scale_cutpoints = cutpoints_2) +
  facet_wrap(~year, strip.position = "top") +
  theme(plot.caption = element_text(colour = "gray25", size = 6)) +
  labs(x = "Month",
       y = "",
       caption = "Climatatological Reference Period: 1982-2011")

# Put them together as one figure
comparison_horizons <- hori_2021 / hori_report_yr + 
  plot_layout(guides = "collect")

# Do a bunch of formatting
comparison_horizons <- comparison_horizons &
  theme(
    plot.margin = margin(t = 0, r = 0.5, b = 0, l = 0.5),
          
    #Legend
    legend.position = "top",
    legend.key.height = unit(.5, "lines"),
    legend.key.width = unit(3.75, "lines")) &
   guides(fill = guide_legend(
     title = "Temperature Anomaly",
     title.hjust = 0.5, 
     title.position = "top",
     label.position = "bottom", 
     nrow = 1, 
     byrow = T, 
     reverse = T)) &
  plot_annotation(
    title = "Comparing the Gulf of Maine's Two Hottest Years", 
    subtitle = "Duration of temperature anomaly horizons, colored by their strength")




# Plot it
comparison_horizons
grid::grid.raster(lab_logo, x = 0.04, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
  
```


## The Balance of Hot and Cold

Another way to visualize the climate transition that we are observing is by looking at the fraction of each year spent in different temperature ranges. Under a steady climate we would expect over the long-term to spend similar amounts of the year experiencing relatively warm & cold temperatures. These periods would balance themselves out and we would on-average have experienced something similar to the long-term climate.

What we have been seeing in the Gulf of Maine recently has lost that sense of balance. Larger fractions of the year are shared by above average temperatures & cold spell events are becoming vanishingly rare.


```{r}
#| label: fig-streamplot
#| fig-cap: "A streamplot shows the fraction of each year on record that temperature anomalies fell within ranges further from the climate reference period average. Since 2010 the Gulf of Maine's temperatures shifted rapidly outside of this expected range and a large fraction of the year is now 2 degrees or more above that average (red)."
#| fig-alt: "Streamplot tracking fraction of each year spent in varying degrees of temperature anomalies"



# Set Factor Order for Bins
bin_order <- c(
  "Less than -2", 
  "-2 to -1",
  "Within 1",
  "1 to 2", 
  "Greater than 2")

# Set Colors
bin_colors <- RColorBrewer::brewer.pal(n = length(bin_order), 
                                       name = "RdBu")
bin_colors <- rev(bin_colors)

# Count Days in Bins
day_types <- region_hw %>% 
  mutate(
    `Less than -2`   = if_else(anom_f <= -2, TRUE, FALSE),
    `-2 to -1`     = if_else(between(anom_f, -2, -1), TRUE, FALSE),
    `Within 1`     = if_else(between(anom_f, -1, 1), TRUE, FALSE),
    `1 to 2`       = if_else(between(anom_f, 1, 2), TRUE, FALSE),
    `Greater than 2` = if_else(anom_f >= 2, TRUE, FALSE)) %>% 
  group_by(yr) %>% 
  summarise(
    `Less than -2`   = sum(`Less than -2`, na.rm = T),
     `-2 to -1`    = sum(`-2 to -1`, na.rm = T),
    `Within 1`     = sum(`Within 1`, na.rm = T),
    `1 to 2`       = sum(`1 to 2`, na.rm = T),
    `Greater than 2` = sum(`Greater than 2`, na.rm = T),
    .groups = "drop") %>% 
  pivot_longer(cols = "Less than -2":"Greater than 2", 
               names_to = "Anomaly Strength", 
               values_to = "day_total", 
               values_drop_na = FALSE) %>% 
  mutate(day_total = if_else(is.na(day_total), 0L, day_total),
         `Anomaly Strength` = factor(`Anomaly Strength`, levels = bin_order))






# Plot the Streamplot
hw_streamplot <- ggplot(day_types, aes(yr, y = day_total, fill = `Anomaly Strength`)) +
  geom_stream(type = "proportion") +
  scale_x_continuous(breaks = seq(1980,2030, by = 10), 
                     minor_breaks = seq(1975, 2030, by = 5), 
                     expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = scales::percent_format(), 
                     expand = expansion(add = c(0,0))) + 
  scale_fill_manual(values = setNames(bin_colors, bin_order)) + 
  labs(y = "Percent of Year", x = "Year", fill = "", 
       title = "A Warmer Gulf of Maine",
       subtitle = "An increasing fraction of each year experiencing warm temperature anomalies",
       caption = "Anomalies calculated using 1982-2011 climatology.") +
  theme(
    legend.position = "top",
    legend.key.height = unit(.5, "lines"),
    legend.key.width = unit(3.75, "lines"),
    plot.margin = unit(c(.5,1,.3,.5), "cm"),
    plot.title.position = "plot",
    legend.margin = margin(c(7,0,0,0)),
    legend.justification = "center") +
   guides(fill = guide_legend(title = "Temperature Anomaly \u00b0F",
                             title.hjust = 0.5,
                             title.position = "left",
                             label.position = "bottom",
                             nrow = 1,
                             byrow = T)) +
  coord_cartesian(clip = "off") +
  geom_logo(x_npc = 0.1, y_npc = -0.115, logo_height = 1, height_units = "cm")


# Show figure
hw_streamplot  
```










```{r}
#| label: figure-saving
#| results: hide


####  Saving Figures  ####
if(params$save_figures){
  
  
  
  # Gom Extent Map
  ggsave(plot = gom_extent_p, 
         filename = str_c(save_location, "GOM_Extent.png"), 
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "transparent")
  
  
  # Gom VS Global - annual trends
  ggsave(plot = temp_simplified, filename = str_c(save_location, "gom_and_global_trends_annual.jpeg"),
         height = unit(6, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  # GOM vs Global - quarterly trends
  ggsave(plot = panel_plot, filename = str_c(save_location, "gom_and_global_trends_seasonal.jpeg"),
         height = unit(8, "in"),
         width = unit(10, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  
  # Annual Temperature Anomalies Map(s)
  ggsave(plot = annual_gom_map, 
         filename = str_c(save_location, "gom_annual_anom_map.jpeg"),
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  # seasonal Temperature Anomalies Map(s)
  ggsave(plot = season_panels_all, 
         filename = str_c(save_location, "gom_seasonal_anom_map.jpeg"),
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  # Ranking of warmest years
  ggsave(plot = temp_rankings_p, 
         filename = str_c(save_location, "Annual_temp_ranks_plot.png"),
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
    # Global Anomaly Map
    ggsave(plot = annual_anom_map, 
           filename = str_c(save_location, "global_annual_anom_map.jpeg"),
           height = unit(5, "in"),
           width = unit(8, "in"),
           dpi = "retina", 
           bg = "white")
  
  
  
  # # Record daily temperatures plot
  # ggsave(plot = hottest_days_plot,
  #        filename = str_c(save_location, report_yr, "_hottest_days.jpeg"),
  #        height = unit(5, "in"),
  #        width = unit(8, "in"),
  #        dpi = "retina", 
  #        bg = "white")
  
  
  
  # Percentage of months that set record temperatures bars
  ggsave(plot = fig_percents,
         filename = str_c(save_location, report_yr, "_percent_record_bars.jpeg"),
         height = unit(4, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  
  # Full Year Temperature Timeseries
  ggsave(plot = hw_temp_p, filename = str_c(save_location, "oisst_lastyr_temps.jpeg"),
         height = unit(5, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  
  # Heatwave status heatmap
  ggsave(plot = heatmap_p, filename = str_c(save_location, "oisst_gom_heatmap.jpeg"),
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
  
  
  
  # # global warming rankings
  # ggsave(plot = ranks_global_figure, filename = str_c(save_location, "global_ranks_map.jpeg"),
  #        height = unit(5, "in"),
  #        width = unit(8, "in"),
  #        dpi = "retina", 
  #        bg = "white")
  




    # All year temperature horizons
  ggsave(plot = gom_annual_horizons, filename = str_c(save_location, "oisst_gom_horizons.jpeg"),
         height = unit(8, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")


  # # report_yr | 2021 horizons
  # ggsave(plot = comparison_horizons, filename = str_c(save_location, "gom_hottest_horizons.jpeg"),
  #        dpi = "retina", bg = "white")
  
  # streamplot
  ggsave(plot = hw_streamplot, filename = str_c(save_location, "gom_anomaly_streamplot.jpeg"),
         height = unit(6, "in"),
         width = unit(8, "in"),
         dpi = "retina", 
         bg = "white")
  
  
}



  
```



```{r}
#| label: additional-figures
#| eval: false

# Load ragg for re-scaling
library(ragg)



# make a lcal save path
new_save <- here::here("local_data", report_yr)

# Re-size them for large plotting
# temp_simplified: 6x8
# panel plot: 8x10



#-------JPEG

# Gom VS Global - annual
ragg::agg_jpeg(filename = str_c(new_save, "gom_and_global_trends_annual.jpeg"), 
              height = 18, 
              width = 24, 
              units = "in",
              res = 320, 
              scaling = 2)
plot(temp_simplified)
invisible(dev.off())


# GOM vs Global - Seasons
ragg::agg_jpeg(filename = str_c(new_save, "gom_and_global_trends_seasonal.jpeg"), 
              height = 24, 
              width = 30, 
              units = "in",
              res = 320, 
              scaling = 3)
plot(panel_plot)
grid::grid.raster(lab_logo, x = 0.08, y = 0.01, just = c('left', 'bottom'), height = unit(1, "cm"))
invisible(dev.off())


```



```{r}
#| results: asis
insert_gmri_footer()
```

