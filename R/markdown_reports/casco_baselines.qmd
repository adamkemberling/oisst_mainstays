---
title: "Casco Baselines"
author: "Adam Kemberling"
url: "https://github.com/adamkemberling"
affiliation: "Gulf of Maine Research Institute"
affiliation_url: "https://www.gmri.org"
description: | 
  Exploring how the Temperatures of the Gulf of Maine Interact with Biological Limits
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    toc: true
    self-contained: true
execute: 
  echo: false
  warning: false
  message: false
  comment: ""
  fig.align: center
---

# Objectives:

Look at what kind of seasonality changes we can track for Casco Bay.
  
  
  
## Load Packages


```{r}
#| label: packages
#| include: false
#| echo: false
#| warning: false

####  Packages  ####
library(lubridate)
library(raster)
library(here)
library(rnaturalearth)
library(scales)
library(stars)
library(sf)
library(heatwaveR)
library(gt)
library(gtExtras)
library(patchwork)
library(showtext)
library(gmRi)
library(rcartocolor)
library(tidyverse)

# Support Functions
source(here("R/oisst_support_funs.R"), verbose = FALSE)
source(here("R/temp_report_support.R"), verbose = FALSE)

# Box paths
oisst_path <- cs_path("res", "OISST/oisst_mainstays")

# Polygons for mapping
new_england <- ne_states("united states of america", returnclass = "sf")

```



```{r}
#| label: style-sheet
#| results: asis

# Use GMRI style
use_gmri_style_rmd()

```




```{r}
#| label: fonts-config
#| echo: false

# # Using Raleway Font because it works
# sysfonts::font_add_google("Raleway")

# Path to the directory containing the font file (replace with your actual path)
font_dir <- paste0(system.file("stylesheets", package = "gmRi"), "/GMRI_fonts/Avenir/")

# Register the font
font_add(
  family = "Avenir",
  file.path(font_dir, "LTe50342.ttf"),
  bold = file.path(font_dir, "LTe50340.ttf"),
  italic = file.path(font_dir, "LTe50343.ttf"),
  bolditalic = file.path(font_dir, "LTe50347.ttf"))

# Load the font
showtext::showtext_auto()

# Prevents tiny fonts when saving
showtext::showtext_opts(dpi=300) 
```
  
## Read in the data



```{r}
# Want the data in grid form

# Set time limits
sst_dates <- as.Date(c("2000-01-01", "2020-12-31"))

# Spatial Extent Info
crop_x <- c("xmin" = -70.340, "xmax" = -69.806)
crop_y <- c("ymin" = 43.583, "ymax" = 43.869 )


# Make data window for season
data_window <- data.frame(
  lon = crop_x,
  lat = crop_y,
  time = sst_dates)

# Load data - Temperatures
sst_nc <- oisst_window_load(
  data_window = data_window,
  anomalies = F,
  climate_ref = "1991-2020",
  box_location = "cloudstorage")
```


### SST Coverage Map

Not looking good...

```{r}
ggplot() +
  geom_stars(data = st_as_stars(sst_nc[["2012"]][[2]])) +
  geom_sf(data = new_england) +
  scale_fill_distiller(na.value = "transparent") +
  coord_sf(xlim = crop_x, ylim = crop_y)
```


### National Data Buoy Center

This data was downloaded from here:
https://www.ndbc.noaa.gov/download_data.php?filename=casm1h2022.txt.gz&dir=data/historical/stdmet/ 

But can also be obtained from here: If the portal worked
https://tidesandcurrents.noaa.gov/stationhome.html?id=8418150

Or could use {noaaoceans}

```{r}
# Read yearly tables
bdat <- list.files(here::here("local_data/portland_buoy"), full.names = T) %>%
  map_dfr(~read_table(
    .x , 
    col_types = cols(
      `#YY` = col_character(),
      MM    = col_character(),
      DD    = col_character(),
      hh    = col_character(),
      mm    = col_character(),
      WDIR  = col_character(),
      WSPD  = col_character(),
      GST   = col_character(),
      WVHT  = col_character(),
      DPD   = col_character(),
      APD   = col_character(),
      MWD   = col_character(),
      PRES  = col_character(),
      ATMP  = col_character(),
      WTMP  = col_character(),
      DEWP  = col_character(),
      VIS   = col_character(),
      TIDE  = col_character()
)))



# Clean up the inconsistent column names
bdat <- bdat %>%
  mutate(
    `#YY` = as.character(`#YY`),
    PRES = as.character(PRES),
    WDIR = as.character(WDIR)) %>%
  mutate(
    YYYY = ifelse(is.na(YYYY) & !is.na(`#YY`),`#YY`, YYYY),
    BAR = ifelse(is.na(BAR) & !is.na(PRES),PRES, BAR),
    WD = ifelse(is.na(WD) & !is.na(WDIR), WDIR, WD),
    MM = ifelse(is.na(MM) & !is.na(mm), mm, MM),
    date = as.Date(str_c(YYYY, MM, DD, sep = "-")))  %>%
  select(-c(`#YY`, PRES, WDIR, mm)) %>% 
  filter(YYYY != "#yr")%>% 
  mutate(
    YYYY = as.numeric(YYYY),
    WSPD  = as.numeric(WSPD),
    GST   = as.numeric(GST),
    WVHT  = as.numeric(WVHT),
    DPD   = as.numeric(DPD),
    APD   = as.numeric(APD),
    MWD   = as.numeric(MWD),
    ATMP  = as.numeric(ATMP),
    WTMP  = as.numeric(WTMP),
    DEWP  = as.numeric(DEWP),
    VIS   = as.numeric(VIS),
    TIDE  = as.numeric(TIDE),
    # So apparently 9999 etc is used as NA
    # Make 99's actual NA's
    WD    = ifelse(WD == 999, NA, WD),
    WSPD  = ifelse(WSPD == 99, NA, WSPD),
    GST   = ifelse(GST == 99, NA, GST),
    WVHT  = ifelse(WVHT == 99, NA, WVHT),
    DPD   = ifelse(DPD == 99, NA, DPD),
    APD   = ifelse(APD == 99, NA, APD),
    MWD   = ifelse(MWD == 999, NA, MWD),
    BAR   = ifelse(BAR == 9999, NA, BAR),
    ATMP  = ifelse(ATMP == 999, NA, ATMP),
    WTMP  = ifelse(WTMP == 999, NA, WTMP),
    DEWP  = ifelse(DEWP == 999, NA, DEWP),
    VIS   = ifelse(VIS == 99, NA, VIS),
    TIDE  = ifelse(TIDE == 99, NA, TIDE))



```

### Water Temperature in Portland Harbor

```{r}
# Seasonal Cycle
ggplot(bdat) +
  geom_line(aes(date, WTMP))


# Distibution of temperatures
bdat %>% 
  filter(YYYY > 2013) %>% 
ggplot() +
  geom_boxplot(aes(WTMP, YYYY, group = YYYY))

# Changes to min/max
bdat %>% 
  group_by(YYYY) %>% 
  summarise(
    min_temp = min(WTMP, na.rm = T),
    max_temp = max(WTMP, na.rm = T),
    mu_temp = mean(WTMP, na.rm = T)
  )
```

# Sampling Period
May - September CBASS study period
Usually second week in June, but sometimes in late may


## Baseline Things we Should have a handle on:

 - Herring Population Trends
 - Lobster
 - Stratification Trends
 - Maine Coastal Current Behavior

 

8 most frequent species in CBASS
herring, alewife, green crab, 
silverside, mummichog, winter flounder


## How to help Katie

Could do some feature engineering of water temperature information to make it species specific:
 - Growth degree days
 - days within species preferred, days outside
 - 
 
 
# MURSST

If we can get data inside casco bay:
 - define the seasonal cycle
 - characterize any regions that are warming faster or holding heat
 - Identify cases when this might impact phenology
 
# FVCOM




